var Libp2p=(()=>{var RH=Object.create;var id=Object.defineProperty;var CH=Object.getOwnPropertyDescriptor;var DH=Object.getOwnPropertyNames;var BH=Object.getPrototypeOf,PH=Object.prototype.hasOwnProperty;var BA=r=>{throw TypeError(r)};var LH=(r,e,t)=>e in r?id(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Vi=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),pt=(r,e)=>{for(var t in e)id(r,t,{get:e[t],enumerable:!0})},PA=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of DH(e))!PH.call(r,s)&&s!==t&&id(r,s,{get:()=>e[s],enumerable:!(n=CH(e,s))||n.enumerable});return r};var go=(r,e,t)=>(t=r!=null?RH(BH(r)):{},PA(e||!r||!r.__esModule?id(t,"default",{value:r,enumerable:!0}):t,r)),kH=r=>PA(id({},"__esModule",{value:!0}),r);var l=(r,e,t)=>LH(r,typeof e!="symbol"?e+"":e,t),$5=(r,e,t)=>e.has(r)||BA("Cannot "+t);var V=(r,e,t)=>($5(r,e,"read from private field"),t?t.call(r):e.get(r)),ne=(r,e,t)=>e.has(r)?BA("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),le=(r,e,t,n)=>($5(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t),ee=(r,e,t)=>($5(r,e,"access private method"),t);var rs=(r,e,t,n)=>({set _(s){le(r,e,s,t)},get _(){return V(r,e,n)}});var Nb=Vi(jd=>{(function(){var r,e,t,n,s,o,i,a;a=function(c){var u,f,h,d;return u=(c&255<<24)>>>24,f=(c&255<<16)>>>16,h=(c&65280)>>>8,d=c&255,[u,f,h,d].join(".")},i=function(c){var u,f,h,d,p,y;for(u=[],h=d=0;d<=3&&c.length!==0;h=++d){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}y=e(c),p=y[0],f=y[1],c=c.substring(f),u.push(p)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),o=t("a"),s=t("A"),e=function(c){var u,f,h,d,p;for(d=0,u=10,f="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,u=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,u=8,f="7")),p=h;h<c.length;){if("0"<=c[h]&&c[h]<=f)d=d*u+(t(c[h])-n)>>>0;else if(u===16)if("a"<=c[h]&&c[h]<="f")d=d*u+(10+t(c[h])-o)>>>0;else if("A"<=c[h]&&c[h]<="F")d=d*u+(10+t(c[h])-s)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");h++}if(h===p)throw new Error("empty octet");return[d,h]},r=(function(){function c(u,f){var h,d,p,y;if(typeof u!="string")throw new Error("Missing `net' parameter");if(f||(y=u.split("/",2),u=y[0],f=y[1]),f||(f=32),typeof f=="string"&&f.indexOf(".")>-1){try{this.maskLong=i(f)}catch(x){throw h=x,new Error("Invalid mask: "+f)}for(d=p=32;p>=0;d=--p)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(f||f===0)this.bitmask=parseInt(f,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(i(u)&this.maskLong)>>>0}catch(x){throw h=x,new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+f);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(i(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var f,h,d;for(d=i(this.first),h=i(this.last),f=0;d<=h;)u(a(d),d,f),f++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),jd.ip2long=i,jd.long2ip=a,jd.Netmask=r}).call(jd)});var lB=Vi((Oye,tw)=>{"use strict";var GZ=Object.prototype.hasOwnProperty,Ur="~";function Y0(){}Object.create&&(Y0.prototype=Object.create(null),new Y0().__proto__||(Ur=!1));function WZ(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function cB(r,e,t,n,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var o=new WZ(t,n||r,s),i=Ur?Ur+e:e;return r._events[i]?r._events[i].fn?r._events[i]=[r._events[i],o]:r._events[i].push(o):(r._events[i]=o,r._eventsCount++),r}function qg(r,e){--r._eventsCount===0?r._events=new Y0:delete r._events[e]}function Sr(){this._events=new Y0,this._eventsCount=0}Sr.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)GZ.call(t,n)&&e.push(Ur?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Sr.prototype.listeners=function(e){var t=Ur?Ur+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,o=n.length,i=new Array(o);s<o;s++)i[s]=n[s].fn;return i};Sr.prototype.listenerCount=function(e){var t=Ur?Ur+e:e,n=this._events[t];return n?n.fn?1:n.length:0};Sr.prototype.emit=function(e,t,n,s,o,i){var a=Ur?Ur+e:e;if(!this._events[a])return!1;var c=this._events[a],u=arguments.length,f,h;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,s),!0;case 5:return c.fn.call(c.context,t,n,s,o),!0;case 6:return c.fn.call(c.context,t,n,s,o,i),!0}for(h=1,f=new Array(u-1);h<u;h++)f[h-1]=arguments[h];c.fn.apply(c.context,f)}else{var d=c.length,p;for(h=0;h<d;h++)switch(c[h].once&&this.removeListener(e,c[h].fn,void 0,!0),u){case 1:c[h].fn.call(c[h].context);break;case 2:c[h].fn.call(c[h].context,t);break;case 3:c[h].fn.call(c[h].context,t,n);break;case 4:c[h].fn.call(c[h].context,t,n,s);break;default:if(!f)for(p=1,f=new Array(u-1);p<u;p++)f[p-1]=arguments[p];c[h].fn.apply(c[h].context,f)}}return!0};Sr.prototype.on=function(e,t,n){return cB(this,e,t,n,!1)};Sr.prototype.once=function(e,t,n){return cB(this,e,t,n,!0)};Sr.prototype.removeListener=function(e,t,n,s){var o=Ur?Ur+e:e;if(!this._events[o])return this;if(!t)return qg(this,o),this;var i=this._events[o];if(i.fn)i.fn===t&&(!s||i.once)&&(!n||i.context===n)&&qg(this,o);else{for(var a=0,c=[],u=i.length;a<u;a++)(i[a].fn!==t||s&&!i[a].once||n&&i[a].context!==n)&&c.push(i[a]);c.length?this._events[o]=c.length===1?c[0]:c:qg(this,o)}return this};Sr.prototype.removeAllListeners=function(e){var t;return e?(t=Ur?Ur+e:e,this._events[t]&&qg(this,t)):(this._events=new Y0,this._eventsCount=0),this};Sr.prototype.off=Sr.prototype.removeListener;Sr.prototype.addListener=Sr.prototype.on;Sr.prefixed=Ur;Sr.EventEmitter=Sr;typeof tw<"u"&&(tw.exports=Sr)});var hw=Vi((c5e,wB)=>{wB.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(o,i){t[o]=i,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(o){return t[o]!==void 0||n[o]!==void 0},remove:function(o){t[o]!==void 0&&(t[o]=void 0),n[o]!==void 0&&(n[o]=void 0)},get:function(o){var i=t[o];if(i!==void 0)return i;if((i=n[o])!==void 0)return s(o,i),i},set:function(o,i){t[o]!==void 0?t[o]=i:s(o,i)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var Ik=Vi(Xf=>{"use strict";var eJ="[object ArrayBuffer]",ci=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===eJ}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),s=r.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let o=0;o<n.length;o++)if(n[o]!==s[o])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let i of t)n+=i.byteLength;let s=new Uint8Array(n),o=0;for(let i of t){let a=this.toUint8Array(i);s.set(a,o),o+=a.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}},iE="string",tJ=/^[0-9a-f\s]+$/i,rJ=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,nJ=/^[a-zA-Z0-9-_]+$/,y4=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){let t=ci.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return decodeURIComponent(escape(n))}},zn=class{static toString(e,t=!1){let n=ci.toArrayBuffer(e),s=new DataView(n),o="";for(let i=0;i<n.byteLength;i+=2){let a=s.getUint16(i,t);o+=String.fromCharCode(a)}return o}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let o=0;o<e.length;o++)s.setUint16(o*2,e.charCodeAt(o),t);return n}},b4=class r{static isHex(e){return typeof e===iE&&tJ.test(e)}static isBase64(e){return typeof e===iE&&rJ.test(e)}static isBase64Url(e){return typeof e===iE&&nJ.test(e)}static ToString(e,t="utf8"){let n=ci.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return zn.toString(n,!0);case"utf16":case"utf16be":return zn.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return zn.fromString(e,!0);case"utf16":case"utf16be":return zn.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=ci.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return y4.fromString(e);case"utf16":case"utf16be":return zn.fromString(e);case"utf16le":case"usc2":return zn.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return y4.toString(e);case"utf16":case"utf16be":return zn.toString(e);case"utf16le":case"usc2":return zn.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){let t=ci.toUint8Array(e),n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){let t=ci.toUint8Array(e),n="",s=t.length;for(let o=0;o<s;o++){let i=t[o];i<16&&(n+="0"),n+=i.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){let o=t.slice(s,s+2);n[s/2]=parseInt(o,16)}return n.buffer}static ToUtf16String(e,t=!1){return zn.toString(e,t)}static FromUtf16String(e,t=!1){return zn.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};b4.DEFAULT_UTF8_ENCODING="utf8";function sJ(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let s=arguments[n];for(let o in s)t[o]=s[o]}return t}function oJ(...r){let e=r.map(s=>s.byteLength).reduce((s,o)=>s+o),t=new Uint8Array(e),n=0;return r.map(s=>new Uint8Array(s)).forEach(s=>{for(let o of s)t[n++]=o}),t.buffer}function iJ(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<r.byteLength;s++)if(t[s]!==n[s])return!1;return!0}Xf.BufferSourceConverter=ci;Xf.Convert=b4;Xf.assign=sJ;Xf.combine=oJ;Xf.isEqual=iJ});var vO=Vi(S6=>{"use strict";Object.defineProperty(S6,"__esModule",{value:!0});var QE=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},v6=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let s=new QE;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:o=>s.push(o),stop:()=>s.stop(),fail:o=>s.fail(o),on:(o,i)=>{s.eventHandlers[o]=i}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};S6.EventIterator=v6;S6.default=v6});var SO=Vi(X1=>{"use strict";Object.defineProperty(X1,"__esModule",{value:!0});var JE=vO();X1.EventIterator=JE.EventIterator;function dee(r,e,t){return new JE.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}X1.subscribe=dee;X1.default=JE.EventIterator});var LO=Vi((URe,PO)=>{function mee(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}PO.exports=mee});var QF=Vi((dHe,jF)=>{"use strict";function wt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}wt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};wt.prototype.get=function(e){return this.peekAt(e)};wt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};wt.prototype.peekFront=function(){return this.peek()};wt.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(wt.prototype,"length",{get:function(){return this.size()}});wt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};wt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};wt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};wt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};wt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};wt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var o=this._list[t],i;if(e<n/2){for(i=e;i>0;i--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(i=n-1-e;i>0;i--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return o}}};wt.prototype.remove=function(e,t){var n=e,s,o=t;if(n===(n|0)&&this._head!==this._tail){var i=this.size(),a=this._list.length;if(!(n>=i||n<-i||t<1)){if(n<0&&(n+=i),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=i)return s=this.toArray(),this.clear(),s;n+t>i&&(t=i-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===i){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<i/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;o>0;)this._list[n=n-1+a&this._capacityMask]=void 0,o--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=i-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;o>0;)this._list[n=n+1+a&this._capacityMask]=void 0,o--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};wt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var o,i,a,c=arguments.length,u=this._list.length,f=2;if(!s||n<s/2){for(i=new Array(n),o=0;o<n;o++)i[o]=this._list[this._head+o&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+u&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+u&this._capacityMask);c>f;)this.unshift(arguments[--c]);for(o=n;o>0;o--)this.unshift(i[o-1])}else{i=new Array(s-(n+t));var h=i.length;for(o=0;o<h;o++)i[o]=this._list[this._head+n+t+o&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+u&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-h+u&this._capacityMask);f<c;)this.push(arguments[f++]);for(o=0;o<h;o++)this.push(i[o])}return a}else return this.remove(n,t)}};wt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};wt.prototype.isEmpty=function(){return this._head===this._tail};wt.prototype.toArray=function(){return this._copyArray(!1)};wt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var s=0;s<t;s++)this._list[s]=e[s]};wt.prototype._copyArray=function(e,t){var n=this._list,s=n.length,o=this.length;if(t=t|o,t==o&&this._head<this._tail)return this._list.slice(this._head,this._tail);var i=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<s;c++)i[a++]=n[c];for(c=0;c<this._tail;c++)i[a++]=n[c]}else for(c=this._head;c<this._tail;c++)i[a++]=n[c];return i};wt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};wt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};wt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};jF.exports=wt});var foe={};pt(foe,{bootstrap:()=>gA,circuitRelayServer:()=>Ty,circuitRelayTransport:()=>My,createLibp2p:()=>Bw,fetch:()=>RA,generateKeyPair:()=>a6,gossipsub:()=>K_,identify:()=>v_,kadDHT:()=>mA,mplex:()=>AA,multiaddr:()=>xe,noise:()=>Z1,peerIdFromBytes:()=>Wt,peerIdFromString:()=>Qe,ping:()=>TA,removePrivateAddressesMapper:()=>Xh,removePublicAddressesMapper:()=>a5,webRTC:()=>jE,webRTCDirect:()=>XE,webSockets:()=>rv,wsFilters:()=>j1,yamux:()=>L_});var LA=Symbol.for("@libp2p/connection");var G5=Symbol.for("@libp2p/content-routing");var ad=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};l(ad,"name","AbortError");var be=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};l(be,"name","InvalidParametersError");var lc=class extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}};l(lc,"name","InvalidPublicKeyError");var eu=class extends Error{constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}};l(eu,"name","InvalidPrivateKeyError");var Hi=class extends Error{constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}};l(Hi,"name","ConnectionClosedError");var cd=class extends Error{constructor(e="Not found"){super(e),this.name="NotFoundError"}};l(cd,"name","NotFoundError");var uc=class extends Error{constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}};l(uc,"name","InvalidPeerIdError");var yo=class extends Error{constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};l(yo,"name","InvalidMultiaddrError");var ld=class extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}};l(ld,"name","InvalidCIDError");var ud=class extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};l(ud,"name","InvalidMultihashError");var fd=class extends Error{constructor(e="Timed out"){super(e),this.name="TimeoutError"}};l(fd,"name","TimeoutError");var Ps=class extends Error{constructor(e="Not started"){super(e),this.name="NotStartedError"}};l(Ps,"name","NotStartedError");var fc=class extends Error{constructor(e="Dial error"){super(e),this.name="DialError"}};l(fc,"name","DialError");var tu=class extends Error{constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}};l(tu,"name","LimitedConnectionError");var hd=class extends Error{constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}};l(hd,"name","TooManyInboundProtocolStreamsError");var dd=class extends Error{constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}};l(dd,"name","TooManyOutboundProtocolStreamsError");var bo=class extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};l(bo,"name","UnsupportedKeyTypeError");var g2=class extends Event{constructor(t,n,s){super("close",s);l(this,"error");l(this,"local");this.error=n,this.local=t}};var W5=Symbol.for("@libp2p/peer-discovery");var y2=Symbol.for("@libp2p/peer-id");function kA(r){return!!r?.[y2]}var Y5=Symbol.for("@libp2p/peer-routing");var Z5="keep-alive";function b2(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function NA(...r){let e=[];for(let t of r)b2(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function OA(...r){let e=[];for(let t of r)b2(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var pd;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(pd||(pd={}));var Ls,Je=class extends EventTarget{constructor(){super();ne(this,Ls,new Map);}listenerCount(t){let n=V(this,Ls).get(t);return n==null?0:n.length}addEventListener(t,n,s){super.addEventListener(t,n,s);let o=V(this,Ls).get(t);o==null&&(o=[],V(this,Ls).set(t,o)),o.push({callback:n,once:(s!==!0&&s!==!1&&s?.once)??!1})}removeEventListener(t,n,s){super.removeEventListener(t.toString(),n??null,s);let o=V(this,Ls).get(t);o!=null&&(o=o.filter(({callback:i})=>i!==n),V(this,Ls).set(t,o))}dispatchEvent(t){let n=super.dispatchEvent(t),s=V(this,Ls).get(t.type);return s==null||(s=s.filter(({once:o})=>!o),V(this,Ls).set(t.type,s)),n}safeDispatchEvent(t,n={}){return this.dispatchEvent(new CustomEvent(t,n))}};Ls=new WeakMap;var md=Symbol.for("@libp2p/service-capabilities"),X5=Symbol.for("@libp2p/service-dependencies");var t8={};pt(t8,{base58btc:()=>ie,base58flickr:()=>VH});var Qoe=new Uint8Array(0);function MA(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function wo(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function UA(r){return new TextEncoder().encode(r)}function KA(r){return new TextDecoder().decode(r)}function NH(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),f=Math.log(256)/Math.log(a);function h(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var x=0,b=0,_=0,v=y.length;_!==v&&y[_]===0;)_++,x++;for(var w=(v-_)*f+1>>>0,R=new Uint8Array(w);_!==v;){for(var N=y[_],O=0,F=w-1;(N!==0||O<b)&&F!==-1;F--,O++)N+=256*R[F]>>>0,R[F]=N%a>>>0,N=N/a>>>0;if(N!==0)throw new Error("Non-zero carry");b=O,_++}for(var A=w-b;A!==w&&R[A]===0;)A++;for(var E=c.repeat(x);A<w;++A)E+=r.charAt(R[A]);return E}function d(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var x=0;if(y[x]!==" "){for(var b=0,_=0;y[x]===c;)b++,x++;for(var v=(y.length-x)*u+1>>>0,w=new Uint8Array(v);y[x];){var R=t[y.charCodeAt(x)];if(R===255)return;for(var N=0,O=v-1;(R!==0||N<_)&&O!==-1;O--,N++)R+=a*w[O]>>>0,w[O]=R%256>>>0,R=R/256>>>0;if(R!==0)throw new Error("Non-zero carry");_=N,x++}if(y[x]!==" "){for(var F=v-_;F!==v&&w[F]===0;)F++;for(var A=new Uint8Array(b+(v-F)),E=b;F!==v;)A[E++]=w[F++];return A}}}function p(y){var x=d(y);if(x)return x;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:d,decode:p}}var OH=NH,MH=OH,VA=MH;var j5=class{constructor(e,t,n){l(this,"name");l(this,"prefix");l(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Q5=class{constructor(e,t,n){l(this,"name");l(this,"prefix");l(this,"baseDecode");l(this,"prefixCodePoint");this.name=e,this.prefix=t;let s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return HA(this,e)}},J5=class{constructor(e){l(this,"decoders");this.decoders=e}or(e){return HA(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function HA(r,e){return new J5({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var e8=class{constructor(e,t,n,s){l(this,"name");l(this,"prefix");l(this,"baseEncode");l(this,"baseDecode");l(this,"encoder");l(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new j5(e,t,n),this.decoder=new Q5(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function ru({name:r,prefix:e,encode:t,decode:n}){return new e8(r,e,t,n)}function qi({name:r,prefix:e,alphabet:t}){let{encode:n,decode:s}=VA(t,r);return ru({prefix:e,name:r,encode:n,decode:o=>wo(s(o))})}function UH(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;let o=new Uint8Array(s*t/8|0),i=0,a=0,c=0;for(let u=0;u<s;++u){let f=e[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|f,i+=t,i>=8&&(i-=8,o[c++]=255&a>>i)}if(i>=t||(255&a<<8-i)!==0)throw new SyntaxError("Unexpected end of data");return o}function KH(r,e,t){let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i!==0&&(o+=e[s&a<<t-i]),n)for(;(o.length*t&7)!==0;)o+="=";return o}function FH(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function xt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let s=FH(n);return ru({prefix:e,name:r,encode(o){return KH(o,n,t)},decode(o){return UH(o,s,t,r)}})}var ie=qi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),VH=qi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var r8={};pt(r8,{base32:()=>yr,base32hex:()=>$H,base32hexpad:()=>WH,base32hexpadupper:()=>YH,base32hexupper:()=>GH,base32pad:()=>qH,base32padupper:()=>zH,base32upper:()=>HH,base32z:()=>ZH});var yr=xt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),HH=xt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),qH=xt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),zH=xt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),$H=xt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),GH=xt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),WH=xt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),YH=xt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ZH=xt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var n8={};pt(n8,{base36:()=>gd,base36upper:()=>XH});var gd=qi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),XH=qi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var kt={};pt(kt,{Digest:()=>hc,create:()=>ot,decode:()=>mt,equals:()=>o8,hasCode:()=>mq});var jH=$A,qA=128,QH=127,JH=~QH,eq=Math.pow(2,31);function $A(r,e,t){e=e||[],t=t||0;for(var n=t;r>=eq;)e[t++]=r&255|qA,r/=128;for(;r&JH;)e[t++]=r&255|qA,r>>>=7;return e[t]=r|0,$A.bytes=t-n+1,e}var tq=s8,rq=128,zA=127;function s8(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw s8.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&zA)<<s:(i&zA)*Math.pow(2,s),s+=7}while(i>=rq);return s8.bytes=o-n,t}var nq=Math.pow(2,7),sq=Math.pow(2,14),oq=Math.pow(2,21),iq=Math.pow(2,28),aq=Math.pow(2,35),cq=Math.pow(2,42),lq=Math.pow(2,49),uq=Math.pow(2,56),fq=Math.pow(2,63),hq=function(r){return r<nq?1:r<sq?2:r<oq?3:r<iq?4:r<aq?5:r<cq?6:r<lq?7:r<uq?8:r<fq?9:10},dq={encode:jH,decode:tq,encodingLength:hq},pq=dq,yd=pq;function bd(r,e=0){return[yd.decode(r,e),yd.decode.bytes]}function nu(r,e,t=0){return yd.encode(r,e,t),e}function su(r){return yd.encodingLength(r)}function ot(r,e){let t=e.byteLength,n=su(r),s=n+su(t),o=new Uint8Array(s+t);return nu(r,o,0),nu(t,o,n),o.set(e,s),new hc(r,t,e,o)}function mt(r){let e=wo(r),[t,n]=bd(e),[s,o]=bd(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new hc(t,s,i,e)}function o8(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&MA(r.bytes,t.bytes)}}var hc=class{constructor(e,t,n,s){l(this,"code");l(this,"size");l(this,"digest");l(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=s}};function mq(r,e){return r.code===e}function GA(r,e){let{bytes:t,version:n}=r;return n===0?yq(t,i8(r),e??ie.encoder):bq(t,i8(r),e??yr.encoder)}var WA=new WeakMap;function i8(r){let e=WA.get(r);if(e==null){let t=new Map;return WA.set(r,t),t}return e}var ZA,se=class r{constructor(e,t,n,s){l(this,"code");l(this,"version");l(this,"multihash");l(this,"bytes");l(this,"/");l(this,ZA,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==wd)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==wq)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=ot(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&o8(e.multihash,n.multihash)}toString(e){return GA(this,e)}toJSON(){return{"/":GA(this)}}link(){return this}[(ZA=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i??YA(n,s,o.bytes))}else if(t[xq]===!0){let{version:n,multihash:s,code:o}=t,i=mt(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==wd)throw new Error(`Version 0 CID must use dag-pb (code: ${wd}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=YA(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,wd,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=wo(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new hc(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[h,d]=bd(e.subarray(t));return t+=d,h},s=n(),o=wd;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),u=t+c,f=u-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:f,size:u}}static parse(e,t){let[n,s]=gq(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return i8(o).set(n,e),o}};function gq(r,e){switch(r[0]){case"Q":{let t=e??ie;return[ie.prefix,t.decode(`${ie.prefix}${r}`)]}case ie.prefix:{let t=e??ie;return[ie.prefix,t.decode(r)]}case yr.prefix:{let t=e??yr;return[yr.prefix,t.decode(r)]}case gd.prefix:{let t=e??gd;return[gd.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function yq(r,e,t){let{prefix:n}=t;if(n!==ie.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s}function bq(r,e,t){let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s}var wd=112,wq=18;function YA(r,e,t){let n=su(r),s=n+su(e),o=new Uint8Array(s+t.byteLength);return nu(r,o,0),nu(e,o,n),o.set(t,s),o}var xq=Symbol.for("@ipld/js-cid/CID");var a8={};pt(a8,{identity:()=>ge});var XA=0,Eq="identity",jA=wo;function vq(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return ot(XA,jA(r))}var ge={code:XA,name:Eq,encode:jA,digest:vq};function j(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function fe(r=0){return new Uint8Array(r)}function pe(r=0){return new Uint8Array(r)}function we(r,e){e==null&&(e=r.reduce((s,o)=>s+o.length,0));let t=pe(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return t}var eI=Symbol.for("@achingbrain/uint8arraylist");function QA(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function x2(r){return!!r?.[eI]}var JA,Z=class r{constructor(...e){l(this,"bufs");l(this,"length");l(this,JA,!0);this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[(JA=eI,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(x2(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(x2(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=QA(this.bufs,e);return t.buf[t.index]}set(e,t){let n=QA(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(x2(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return we(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:we(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),o=new r;return o.length=s,o.bufs=[...n],o}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],s=0;for(let o=0;o<this.bufs.length;o++){let i=this.bufs[o],a=s,c=a+i.byteLength;if(s=c,e>=c)continue;let u=e>=a&&e<c,f=t>a&&t<=c;if(u&&f){if(e===a&&t===c){n.push(i);break}let h=e-a;n.push(i.subarray(h,h+(t-e)));break}if(u){if(e===0){n.push(i);continue}n.push(i.subarray(e-a));continue}if(f){if(t===c){n.push(i);break}n.push(i.subarray(0,t-a));break}n.push(i)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!x2(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let o=256,i=new Int32Array(o);for(let h=0;h<o;h++)i[h]=-1;for(let h=0;h<s;h++)i[n[h]]=h;let a=i,c=this.byteLength-n.byteLength,u=n.byteLength-1,f;for(let h=t;h<=c;h+=f){f=0;for(let d=u;d>=0;d--){let p=this.get(h+d);if(n[d]!==p){f=Math.max(1,d-a[p]);break}}if(f===0)return h}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=pe(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=fe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=fe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=fe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=pe(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=fe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=fe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=fe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=fe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=fe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!j(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((s,o)=>s+o.byteLength,0)),n.length=t,n}};var c8={};pt(c8,{base10:()=>_q});var _q=qi({prefix:"9",name:"base10",alphabet:"0123456789"});var l8={};pt(l8,{base16:()=>Aq,base16upper:()=>Iq});var Aq=xt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Iq=xt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var u8={};pt(u8,{base2:()=>Tq});var Tq=xt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var f8={};pt(f8,{base256emoji:()=>Pq});var tI=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Rq=tI.reduce((r,e,t)=>(r[t]=e,r),[]),Cq=tI.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function Dq(r){return r.reduce((e,t)=>(e+=Rq[t],e),"")}function Bq(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let s=Cq[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}var Pq=ru({prefix:"\u{1F680}",name:"base256emoji",encode:Dq,decode:Bq});var h8={};pt(h8,{base64:()=>dc,base64pad:()=>Lq,base64url:()=>xo,base64urlpad:()=>kq});var dc=xt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Lq=xt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),xo=xt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),kq=xt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var d8={};pt(d8,{base8:()=>Nq});var Nq=xt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var p8={};pt(p8,{identity:()=>Oq});var Oq=ru({prefix:"\0",name:"identity",encode:r=>KA(r),decode:r=>UA(r)});var Uie=new TextEncoder,Kie=new TextDecoder;var y8={};pt(y8,{sha256:()=>Ee,sha512:()=>Fq});var Kq=20;function g8({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:s}){return new m8(r,e,t,n,s)}var m8=class{constructor(e,t,n,s,o){l(this,"name");l(this,"code");l(this,"encode");l(this,"minDigestLength");l(this,"maxDigestLength");this.name=e,this.code=t,this.encode=n,this.minDigestLength=s??Kq,this.maxDigestLength=o}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){let n=this.encode(e);return n instanceof Uint8Array?rI(n,this.code,t?.truncate):n.then(s=>rI(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}};function rI(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return ot(e,r)}function sI(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var Ee=g8({name:"sha2-256",code:18,encode:sI("SHA-256")}),Fq=g8({name:"sha2-512",code:19,encode:sI("SHA-512")});var Qr={...p8,...u8,...d8,...c8,...l8,...r8,...n8,...t8,...h8,...f8},Qie={...y8,...a8};function iI(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var oI=iI("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),b8=iI("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=pe(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Vq={utf8:oI,"utf-8":oI,hex:Qr.base16,latin1:b8,ascii:b8,binary:b8,...Qr},E2=Vq;function H(r,e="utf8"){let t=E2[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function z(r,e="utf8"){let t=E2[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var Hq=parseInt("11111",2),w8=parseInt("10000000",2),qq=parseInt("01111111",2),aI={0:xd,1:xd,2:zq,3:Wq,4:Yq,5:Gq,6:$q,16:xd,22:xd,48:xd};function Eo(r,e={offset:0}){let t=r[e.offset]&Hq;if(e.offset++,aI[t]!=null)return aI[t](r,e);throw new Error("No decoder for tag "+t)}function Ed(r,e){let t=0;if((r[e.offset]&w8)===w8){let n=r[e.offset]&qq,s="0x";e.offset++;for(let o=0;o<n;o++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function xd(r,e){Ed(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=Eo(r,e);if(n===null)break;t.push(n)}return t}function zq(r,e){let t=Ed(r,e),n=e.offset,s=e.offset+t,o=[];for(let i=n;i<s;i++)i===n&&r[i]===0||o.push(r[i]);return e.offset+=t,Uint8Array.from(o)}function $q(r,e){let t=Ed(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let o=0,i=0;s<40?(o=0,i=s):s<80?(o=1,i=s-40):(o=2,i=s-80);let a=`${o}.${i}`,c=[];for(;e.offset<n;){let u=r[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let f=0;for(let h=0;h<c.length;h++)f+=c[h]<<h*7;a+=`.${f}`,c=[]}}return a}function Gq(r,e){return e.offset++,null}function Wq(r,e){let t=Ed(r,e),n=r[e.offset];e.offset++;let s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function Yq(r,e){let t=Ed(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Zq(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new Z;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function v2(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=Zq(r.byteLength);return new Z(Uint8Array.from([e.byteLength|w8]),e)}function Pr(r){let e=new Z,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Z(Uint8Array.from([2]),v2(e),e)}function vd(r){let e=Uint8Array.from([0]),t=new Z(e,r);return new Z(Uint8Array.from([3]),v2(t),t)}function cI(r){return new Z(Uint8Array.from([4]),v2(r),r)}function ns(r,e=48){let t=new Z;for(let n of r)t.append(n);return new Z(Uint8Array.from([e]),v2(t),t)}async function lI(r="P-256"){let e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function uI(r,e,t){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();let s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function fI(r,e,t,n){let s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let o=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),o}var Xq=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),jq=Uint8Array.from([6,5,43,129,4,0,34]),Qq=Uint8Array.from([6,5,43,129,4,0,35]),Jq={ext:!0,kty:"EC",crv:"P-256"},ez={ext:!0,kty:"EC",crv:"P-384"},tz={ext:!0,kty:"EC",crv:"P-521"},x8=32,E8=48,v8=66;function S8(r){let e=Eo(r);return hI(e)}function hI(r){let e=r[1][1][0],t=1,n,s;if(e.byteLength===x8*2+1)return n=z(e.subarray(t,t+x8),"base64url"),s=z(e.subarray(t+x8),"base64url"),new pc({...Jq,key_ops:["verify"],x:n,y:s});if(e.byteLength===E8*2+1)return n=z(e.subarray(t,t+E8),"base64url"),s=z(e.subarray(t+E8),"base64url"),new pc({...ez,key_ops:["verify"],x:n,y:s});if(e.byteLength===v8*2+1)return n=z(e.subarray(t,t+v8),"base64url"),s=z(e.subarray(t+v8),"base64url"),new pc({...tz,key_ops:["verify"],x:n,y:s});throw new be(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function dI(r){return ns([Pr(Uint8Array.from([1])),cI(H(r.d??"","base64url")),ns([mI(r.crv)],160),ns([vd(new Z(Uint8Array.from([4]),H(r.x??"","base64url"),H(r.y??"","base64url")))],161)]).subarray()}function pI(r){return ns([Pr(Uint8Array.from([1])),ns([mI(r.crv)],160),ns([vd(new Z(Uint8Array.from([4]),H(r.x??"","base64url"),H(r.y??"","base64url")))],161)]).subarray()}function mI(r){if(r==="P-256")return Xq;if(r==="P-384")return jq;if(r==="P-521")return Qq;throw new be(`Invalid curve ${r}`)}async function gI(r="P-256"){let e=await lI(r);return new S2(e.privateKey)}var pc=class{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=pI(this.jwk)),this._raw}toMultihash(){return ge.digest(ou(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}async verify(e,t,n){return fI(this.jwk,t,e,n)}},S2=class{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"publicKey");l(this,"_raw");this.jwk=e,this.publicKey=new pc({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=dI(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}async sign(e,t){return uI(this.jwk,e,t)}};function mc(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function ks(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function Se(r,e,t=""){let n=mc(r),s=r?.length,o=e!==void 0;if(!n||o&&s!==e){let i=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return r}function _2(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");ks(r.outputLen),ks(r.blockLen)}function iu(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function bI(r,e){Se(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function So(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function A2(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function ss(r,e){return r<<32-e|r>>>e}var wI=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",rz=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function _o(r){if(Se(r),wI)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=rz[r[t]];return e}var vo={_0:48,_9:57,A:65,F:70,a:97,f:102};function yI(r){if(r>=vo._0&&r<=vo._9)return r-vo._0;if(r>=vo.A&&r<=vo.F)return r-(vo.A-10);if(r>=vo.a&&r<=vo.f)return r-(vo.a-10)}function Ao(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(wI)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let s=0,o=0;s<t;s++,o+=2){let i=yI(r.charCodeAt(o)),a=yI(r.charCodeAt(o+1));if(i===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}function Jr(...r){let e=0;for(let n=0;n<r.length;n++){let s=r[n];Se(s),e+=s.length}let t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let o=r[n];t.set(o,s),s+=o.length}return t}function _8(r,e={}){let t=(s,o)=>r(o).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function zi(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var A8=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function xI(r,e,t){return r&e^~r&t}function EI(r,e,t){return r&e^r&t^e&t}var Sd=class{constructor(e,t,n,s){l(this,"blockLen");l(this,"outputLen");l(this,"padOffset");l(this,"isLE");l(this,"buffer");l(this,"view");l(this,"finished",!1);l(this,"length",0);l(this,"pos",0);l(this,"destroyed",!1);this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=A2(this.buffer)}update(e){iu(this),Se(e);let{view:t,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=A2(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){iu(this),bI(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;t[i++]=128,So(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let h=i;h<s;h++)t[h]=0;n.setBigUint64(s-8,BigInt(this.length*8),o),this.process(n,0);let a=A2(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let u=c/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)a.setUint32(4*h,f[h],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Io=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var ir=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var I2=BigInt(4294967295),vI=BigInt(32);function nz(r,e=!1){return e?{h:Number(r&I2),l:Number(r>>vI&I2)}:{h:Number(r>>vI&I2)|0,l:Number(r&I2)|0}}function SI(r,e=!1){let t=r.length,n=new Uint32Array(t),s=new Uint32Array(t);for(let o=0;o<t;o++){let{h:i,l:a}=nz(r[o],e);[n[o],s[o]]=[i,a]}return[n,s]}var I8=(r,e,t)=>r>>>t,T8=(r,e,t)=>r<<32-t|e>>>t,gc=(r,e,t)=>r>>>t|e<<32-t,yc=(r,e,t)=>r<<32-t|e>>>t,_d=(r,e,t)=>r<<64-t|e>>>t-32,Ad=(r,e,t)=>r>>>t-32|e<<64-t;function Ns(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var _I=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),AI=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,II=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),TI=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,RI=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),CI=(r,e,t,n,s,o)=>e+t+n+s+o+(r/2**32|0)|0;var oz=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),$i=new Uint32Array(64),R8=class extends Sd{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)$i[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){let d=$i[h-15],p=$i[h-2],y=ss(d,7)^ss(d,18)^d>>>3,x=ss(p,17)^ss(p,19)^p>>>10;$i[h]=x+$i[h-7]+y+$i[h-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:u,H:f}=this;for(let h=0;h<64;h++){let d=ss(a,6)^ss(a,11)^ss(a,25),p=f+d+xI(a,c,u)+oz[h]+$i[h]|0,x=(ss(n,2)^ss(n,13)^ss(n,22))+EI(n,s,o)|0;f=u,u=c,c=a,a=i+p|0,i=o,o=s,s=n,n=p+x|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(n,s,o,i,a,c,u,f)}roundClean(){So($i)}destroy(){this.set(0,0,0,0,0,0,0,0),So(this.buffer)}},C8=class extends R8{constructor(){super(32);l(this,"A",Io[0]|0);l(this,"B",Io[1]|0);l(this,"C",Io[2]|0);l(this,"D",Io[3]|0);l(this,"E",Io[4]|0);l(this,"F",Io[5]|0);l(this,"G",Io[6]|0);l(this,"H",Io[7]|0)}};var DI=SI(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),iz=DI[0],az=DI[1],Gi=new Uint32Array(80),Wi=new Uint32Array(80),D8=class extends Sd{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:u,El:f,Fh:h,Fl:d,Gh:p,Gl:y,Hh:x,Hl:b}=this;return[e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b]}set(e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=f|0,this.Fh=h|0,this.Fl=d|0,this.Gh=p|0,this.Gl=y|0,this.Hh=x|0,this.Hl=b|0}process(e,t){for(let w=0;w<16;w++,t+=4)Gi[w]=e.getUint32(t),Wi[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){let R=Gi[w-15]|0,N=Wi[w-15]|0,O=gc(R,N,1)^gc(R,N,8)^I8(R,N,7),F=yc(R,N,1)^yc(R,N,8)^T8(R,N,7),A=Gi[w-2]|0,E=Wi[w-2]|0,L=gc(A,E,19)^_d(A,E,61)^I8(A,E,6),U=yc(A,E,19)^Ad(A,E,61)^T8(A,E,6),B=II(F,U,Wi[w-7],Wi[w-16]),I=TI(B,O,L,Gi[w-7],Gi[w-16]);Gi[w]=I|0,Wi[w]=B|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:u,Dl:f,Eh:h,El:d,Fh:p,Fl:y,Gh:x,Gl:b,Hh:_,Hl:v}=this;for(let w=0;w<80;w++){let R=gc(h,d,14)^gc(h,d,18)^_d(h,d,41),N=yc(h,d,14)^yc(h,d,18)^Ad(h,d,41),O=h&p^~h&x,F=d&y^~d&b,A=RI(v,N,F,az[w],Wi[w]),E=CI(A,_,R,O,iz[w],Gi[w]),L=A|0,U=gc(n,s,28)^_d(n,s,34)^_d(n,s,39),B=yc(n,s,28)^Ad(n,s,34)^Ad(n,s,39),I=n&o^n&a^o&a,g=s&i^s&c^i&c;_=x|0,v=b|0,x=p|0,b=y|0,p=h|0,y=d|0,{h,l:d}=Ns(u|0,f|0,E|0,L|0),u=a|0,f=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let m=_I(L,B,g);n=AI(m,E,U,I),s=m|0}({h:n,l:s}=Ns(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=Ns(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=Ns(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l:f}=Ns(this.Dh|0,this.Dl|0,u|0,f|0),{h,l:d}=Ns(this.Eh|0,this.El|0,h|0,d|0),{h:p,l:y}=Ns(this.Fh|0,this.Fl|0,p|0,y|0),{h:x,l:b}=Ns(this.Gh|0,this.Gl|0,x|0,b|0),{h:_,l:v}=Ns(this.Hh|0,this.Hl|0,_|0,v|0),this.set(n,s,o,i,a,c,u,f,h,d,p,y,x,b,_,v)}roundClean(){So(Gi,Wi)}destroy(){So(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},B8=class extends D8{constructor(){super(64);l(this,"Ah",ir[0]|0);l(this,"Al",ir[1]|0);l(this,"Bh",ir[2]|0);l(this,"Bl",ir[3]|0);l(this,"Ch",ir[4]|0);l(this,"Cl",ir[5]|0);l(this,"Dh",ir[6]|0);l(this,"Dl",ir[7]|0);l(this,"Eh",ir[8]|0);l(this,"El",ir[9]|0);l(this,"Fh",ir[10]|0);l(this,"Fl",ir[11]|0);l(this,"Gh",ir[12]|0);l(this,"Gl",ir[13]|0);l(this,"Hh",ir[14]|0);l(this,"Hl",ir[15]|0)}};var au=_8(()=>new C8,A8(1));var BI=_8(()=>new B8,A8(3));var L8=BigInt(0),P8=BigInt(1);function To(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function PI(r){if(typeof r=="bigint"){if(!T2(r))throw new Error("positive bigint expected, got "+r)}else ks(r);return r}function Id(r){let e=PI(r).toString(16);return e.length&1?"0"+e:e}function LI(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?L8:BigInt("0x"+r)}function cu(r){return LI(_o(r))}function bc(r){return LI(_o(C2(Se(r)).reverse()))}function R2(r,e){ks(e),r=PI(r);let t=Ao(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function k8(r,e){return R2(r,e).reverse()}function C2(r){return Uint8Array.from(r)}var T2=r=>typeof r=="bigint"&&L8<=r;function cz(r,e,t){return T2(r)&&T2(e)&&T2(t)&&e<=r&&r<t}function Td(r,e,t,n){if(!cz(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function N8(r){let e;for(e=0;r>L8;r>>=P8,e+=1);return e}var Rd=r=>(P8<<BigInt(r))-P8;function kI(r,e,t){if(ks(r,"hashLen"),ks(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=b=>new Uint8Array(b),s=Uint8Array.of(),o=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=n(r),u=n(r),f=0,h=()=>{c.fill(1),u.fill(0),f=0},d=(...b)=>t(u,Jr(c,...b)),p=(b=s)=>{u=d(o,b),c=d(),b.length!==0&&(u=d(i,b),c=d())},y=()=>{if(f++>=a)throw new Error("drbg: tried max amount of iterations");let b=0,_=[];for(;b<e;){c=d();let v=c.slice();_.push(v),b+=c.length}return Jr(..._)};return(b,_)=>{h(),p(b);let v;for(;!(v=_(y()));)p();return h(),v}}function Yi(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,i,a){let c=r[o];if(a&&c===void 0)return;let u=typeof c;if(u!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${u}`)}let s=(o,i)=>Object.entries(o).forEach(([a,c])=>n(a,c,i));s(e,!1),s(t,!0)}function lu(r){let e=new WeakMap;return(t,...n)=>{let s=e.get(t);if(s!==void 0)return s;let o=r(t,...n);return e.set(t,o),o}}var Lr=BigInt(0),Ut=BigInt(1),wc=BigInt(2),MI=BigInt(3),UI=BigInt(4),KI=BigInt(5),lz=BigInt(7),FI=BigInt(8),uz=BigInt(9),VI=BigInt(16);function St(r,e){let t=r%e;return t>=Lr?t:e+t}function it(r,e,t){let n=r;for(;e-- >Lr;)n*=n,n%=t;return n}function NI(r,e){if(r===Lr)throw new Error("invert: expected non-zero number");if(e<=Lr)throw new Error("invert: expected positive modulus, got "+e);let t=St(r,e),n=e,s=Lr,o=Ut,i=Ut,a=Lr;for(;t!==Lr;){let u=n/t,f=n%t,h=s-i*u,d=o-a*u;n=t,t=f,s=i,o=a,i=h,a=d}if(n!==Ut)throw new Error("invert: does not exist");return St(s,e)}function M8(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function HI(r,e){let t=(r.ORDER+Ut)/UI,n=r.pow(e,t);return M8(r,n,e),n}function fz(r,e){let t=(r.ORDER-KI)/FI,n=r.mul(e,wc),s=r.pow(n,t),o=r.mul(e,s),i=r.mul(r.mul(o,wc),s),a=r.mul(o,r.sub(i,r.ONE));return M8(r,a,e),a}function hz(r){let e=uu(r),t=qI(r),n=t(e,e.neg(e.ONE)),s=t(e,n),o=t(e,e.neg(n)),i=(r+lz)/VI;return(a,c)=>{let u=a.pow(c,i),f=a.mul(u,n),h=a.mul(u,s),d=a.mul(u,o),p=a.eql(a.sqr(f),c),y=a.eql(a.sqr(h),c);u=a.cmov(u,f,p),f=a.cmov(d,h,y);let x=a.eql(a.sqr(f),c),b=a.cmov(u,f,x);return M8(a,b,c),b}}function qI(r){if(r<MI)throw new Error("sqrt is not defined for small field");let e=r-Ut,t=0;for(;e%wc===Lr;)e/=wc,t++;let n=wc,s=uu(r);for(;OI(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return HI;let o=s.pow(n,e),i=(e+Ut)/wc;return function(c,u){if(c.is0(u))return u;if(OI(c,u)!==1)throw new Error("Cannot find square root");let f=t,h=c.mul(c.ONE,o),d=c.pow(u,e),p=c.pow(u,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let y=1,x=c.sqr(d);for(;!c.eql(x,c.ONE);)if(y++,x=c.sqr(x),y===f)throw new Error("Cannot find square root");let b=Ut<<BigInt(f-y-1),_=c.pow(h,b);f=y,h=c.sqr(_),d=c.mul(d,h),p=c.mul(p,_)}return p}}function dz(r){return r%UI===MI?HI:r%FI===KI?fz:r%VI===uz?hz(r):qI(r)}var zI=(r,e)=>(St(r,e)&Ut)===Ut,pz=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function U8(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=pz.reduce((n,s)=>(n[s]="function",n),e);return Yi(r,t),r}function mz(r,e,t){if(t<Lr)throw new Error("invalid exponent, negatives unsupported");if(t===Lr)return r.ONE;if(t===Ut)return e;let n=r.ONE,s=e;for(;t>Lr;)t&Ut&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Ut;return n}function Cd(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),o=r.inv(s);return e.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),o),n}function OI(r,e){let t=(r.ORDER-Ut)/wc,n=r.pow(e,t),s=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function gz(r,e){e!==void 0&&ks(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var O8=class{constructor(e,t={}){l(this,"ORDER");l(this,"BITS");l(this,"BYTES");l(this,"isLE");l(this,"ZERO",Lr);l(this,"ONE",Ut);l(this,"_lengths");l(this,"_sqrt");l(this,"_mod");if(e<=Lr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:s,nByteLength:o}=gz(e,n);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return St(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return Lr<=e&&e<this.ORDER}is0(e){return e===Lr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Ut)===Ut}neg(e){return St(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return St(e*e,this.ORDER)}add(e,t){return St(e+t,this.ORDER)}sub(e,t){return St(e-t,this.ORDER)}mul(e,t){return St(e*t,this.ORDER)}pow(e,t){return mz(this,e,t)}div(e,t){return St(e*NI(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return NI(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=dz(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?k8(e,this.BYTES):R2(e,this.BYTES)}fromBytes(e,t=!1){Se(e);let{_lengths:n,BYTES:s,isLE:o,ORDER:i,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let u=new Uint8Array(s);u.set(e,o?0:u.length-e.length),e=u}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=o?bc(e):cu(e);if(a&&(c=St(c,i)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return Cd(this,e)}cmov(e,t,n){return n?t:e}};function uu(r,e={}){return new O8(r,e)}function $I(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function K8(r){let e=$I(r);return e+Math.ceil(e/2)}function F8(r,e,t=!1){Se(r);let n=r.length,s=$I(e),o=K8(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let i=t?bc(r):cu(r),a=St(i,e-Ut)+Ut;return t?k8(a,s):R2(a,s)}var fu=BigInt(0),xc=BigInt(1);function Dd(r,e){let t=e.negate();return r?t:e}function Ec(r,e){let t=Cd(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function ZI(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function V8(r,e){ZI(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,o=Rd(r),i=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function GI(r,e,t){let{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=t,a=Number(r&s),c=r>>i;a>n&&(a-=o,c+=xc);let u=e*n,f=u+Math.abs(a)-1,h=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:f,isZero:h,isNeg:d,isNegF:p,offsetF:u}}var H8=new WeakMap,XI=new WeakMap;function q8(r){return XI.get(r)||1}function WI(r){if(r!==fu)throw new Error("invalid wNAF")}var hu=class{constructor(e,t){l(this,"BASE");l(this,"ZERO");l(this,"Fn");l(this,"bits");this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>fu;)t&xc&&(n=n.add(s)),s=s.double(),t>>=xc;return n}precomputeWindow(e,t){let{windows:n,windowSize:s}=V8(t,this.bits),o=[],i=e,a=i;for(let c=0;c<n;c++){a=i,o.push(a);for(let u=1;u<s;u++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=V8(e,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:p}=GI(n,a,i);n=c,f?o=o.add(Dd(d,t[p])):s=s.add(Dd(h,t[u]))}return WI(n),{p:s,f:o}}wNAFUnsafe(e,t,n,s=this.ZERO){let o=V8(e,this.bits);for(let i=0;i<o.windows&&n!==fu;i++){let{nextN:a,offset:c,isZero:u,isNeg:f}=GI(n,i,o);if(n=a,!u){let h=t[c];s=s.add(f?h.negate():h)}}return WI(n),s}getPrecomputes(e,t,n){let s=H8.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),H8.set(t,s))),s}cached(e,t,n){let s=q8(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){let o=q8(e);return o===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),t,s)}createCache(e,t){ZI(t,this.bits),XI.set(e,t),H8.delete(e)}hasCache(e){return q8(e)!==1}};function jI(r,e,t,n){let s=e,o=r.ZERO,i=r.ZERO;for(;t>fu||n>fu;)t&xc&&(o=o.add(s)),n&xc&&(i=i.add(s)),s=s.double(),t>>=xc,n>>=xc;return{p1:o,p2:i}}function YI(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return U8(e),e}else return uu(r,{isLE:t})}function D2(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let u=e[c];if(!(typeof u=="bigint"&&u>fu))throw new Error(`CURVE.${c} must be positive bigint`)}let s=YI(e.p,t.Fp,n),o=YI(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}function B2(r,e){return function(n){let s=r(n);return{secretKey:s,publicKey:e(s)}}}var Zi=BigInt(0),Kt=BigInt(1),z8=BigInt(2),yz=BigInt(8);function bz(r,e,t,n){let s=r.sqr(t),o=r.sqr(n),i=r.add(r.mul(e.a,s),o),a=r.add(r.ONE,r.mul(e.d,r.mul(s,o)));return r.eql(i,a)}function QI(r,e={}){let t=D2("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i}=o;Yi(e,{},{uvRatio:"function"});let a=z8<<BigInt(s.BYTES*8)-Kt,c=_=>n.create(_),u=e.uvRatio||((_,v)=>{try{return{isValid:!0,value:n.sqrt(n.div(_,v))}}catch{return{isValid:!1,value:Zi}}});if(!bz(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function f(_,v,w=!1){let R=w?Kt:Zi;return Td("coordinate "+_,v,R,a),v}function h(_){if(!(_ instanceof y))throw new Error("EdwardsPoint expected")}let d=lu((_,v)=>{let{X:w,Y:R,Z:N}=_,O=_.is0();v==null&&(v=O?yz:n.inv(N));let F=c(w*v),A=c(R*v),E=n.mul(N,v);if(O)return{x:Zi,y:Kt};if(E!==Kt)throw new Error("invZ was invalid");return{x:F,y:A}}),p=lu(_=>{let{a:v,d:w}=o;if(_.is0())throw new Error("bad point: ZERO");let{X:R,Y:N,Z:O,T:F}=_,A=c(R*R),E=c(N*N),L=c(O*O),U=c(L*L),B=c(A*v),I=c(L*c(B+E)),g=c(U+c(w*c(A*E)));if(I!==g)throw new Error("bad point: equation left != right (1)");let m=c(R*N),S=c(O*F);if(m!==S)throw new Error("bad point: equation left != right (2)");return!0}),b=class b{constructor(v,w,R,N){l(this,"X");l(this,"Y");l(this,"Z");l(this,"T");this.X=f("x",v),this.Y=f("y",w),this.Z=f("z",R,!0),this.T=f("t",N),Object.freeze(this)}static CURVE(){return o}static fromAffine(v){if(v instanceof b)throw new Error("extended point not allowed");let{x:w,y:R}=v||{};return f("x",w),f("y",R),new b(w,R,Kt,c(w*R))}static fromBytes(v,w=!1){let R=n.BYTES,{a:N,d:O}=o;v=C2(Se(v,R,"point")),To(w,"zip215");let F=C2(v),A=v[R-1];F[R-1]=A&-129;let E=bc(F),L=w?a:n.ORDER;Td("point.y",E,Zi,L);let U=c(E*E),B=c(U-Kt),I=c(O*U-N),{isValid:g,value:m}=u(B,I);if(!g)throw new Error("bad point: invalid y coordinate");let S=(m&Kt)===Kt,T=(A&128)!==0;if(!w&&m===Zi&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(m=c(-m)),b.fromAffine({x:m,y:E})}static fromHex(v,w=!1){return b.fromBytes(Ao(v),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(v=8,w=!0){return x.createCache(this,v),w||this.multiply(z8),this}assertValidity(){p(this)}equals(v){h(v);let{X:w,Y:R,Z:N}=this,{X:O,Y:F,Z:A}=v,E=c(w*A),L=c(O*N),U=c(R*A),B=c(F*N);return E===L&&U===B}is0(){return this.equals(b.ZERO)}negate(){return new b(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:v}=o,{X:w,Y:R,Z:N}=this,O=c(w*w),F=c(R*R),A=c(z8*c(N*N)),E=c(v*O),L=w+R,U=c(c(L*L)-O-F),B=E+F,I=B-A,g=E-F,m=c(U*I),S=c(B*g),T=c(U*g),P=c(I*B);return new b(m,S,P,T)}add(v){h(v);let{a:w,d:R}=o,{X:N,Y:O,Z:F,T:A}=this,{X:E,Y:L,Z:U,T:B}=v,I=c(N*E),g=c(O*L),m=c(A*R*B),S=c(F*U),T=c((N+O)*(E+L)-I-g),P=S-m,C=S+m,k=c(g-w*I),D=c(T*P),M=c(C*k),q=c(T*k),W=c(P*C);return new b(D,M,W,q)}subtract(v){return this.add(v.negate())}multiply(v){if(!s.isValidNot0(v))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:w,f:R}=x.cached(this,v,N=>Ec(b,N));return Ec(b,[w,R])[0]}multiplyUnsafe(v,w=b.ZERO){if(!s.isValid(v))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return v===Zi?b.ZERO:this.is0()||v===Kt?this:x.unsafe(this,v,R=>Ec(b,R),w)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return x.unsafe(this,o.n).is0()}toAffine(v){return d(this,v)}clearCofactor(){return i===Kt?this:this.multiplyUnsafe(i)}toBytes(){let{x:v,y:w}=this.toAffine(),R=n.toBytes(w);return R[R.length-1]|=v&Kt?128:0,R}toHex(){return _o(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(b,"BASE",new b(o.Gx,o.Gy,Kt,c(o.Gx*o.Gy))),l(b,"ZERO",new b(Zi,Kt,Kt,Zi)),l(b,"Fp",n),l(b,"Fn",s);let y=b,x=new hu(y,s.BITS);return y.BASE.precompute(8),y}function JI(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Yi(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:s,Fp:o,Fn:i}=r,a=t.randomBytes||zi,c=t.adjustScalarBytes||(A=>A),u=t.domain||((A,E,L)=>{if(To(L,"phflag"),E.length||L)throw new Error("Contexts/pre-hash are not supported");return A});function f(A){return i.create(bc(A))}function h(A){let E=w.secretKey;Se(A,w.secretKey,"secretKey");let L=Se(e(A),2*E,"hashedSecretKey"),U=c(L.slice(0,E)),B=L.slice(E,2*E),I=f(U);return{head:U,prefix:B,scalar:I}}function d(A){let{head:E,prefix:L,scalar:U}=h(A),B=s.multiply(U),I=B.toBytes();return{head:E,prefix:L,scalar:U,point:B,pointBytes:I}}function p(A){return d(A).pointBytes}function y(A=Uint8Array.of(),...E){let L=Jr(...E);return f(e(u(L,Se(A,void 0,"context"),!!n)))}function x(A,E,L={}){A=Se(A,void 0,"message"),n&&(A=n(A));let{prefix:U,scalar:B,pointBytes:I}=d(E),g=y(L.context,U,A),m=s.multiply(g).toBytes(),S=y(L.context,m,I,A),T=i.create(g+S*B);if(!i.isValid(T))throw new Error("sign failed: invalid s");let P=Jr(m,i.toBytes(T));return Se(P,w.signature,"result")}let b={zip215:!0};function _(A,E,L,U=b){let{context:B,zip215:I}=U,g=w.signature;A=Se(A,g,"signature"),E=Se(E,void 0,"message"),L=Se(L,w.publicKey,"publicKey"),I!==void 0&&To(I,"zip215"),n&&(E=n(E));let m=g/2,S=A.subarray(0,m),T=bc(A.subarray(m,g)),P,C,k;try{P=r.fromBytes(L,I),C=r.fromBytes(S,I),k=s.multiplyUnsafe(T)}catch{return!1}if(!I&&P.isSmallOrder())return!1;let D=y(B,C.toBytes(),P.toBytes(),E);return C.add(P.multiplyUnsafe(D)).subtract(k).clearCofactor().is0()}let v=o.BYTES,w={secretKey:v,publicKey:v,signature:2*v,seed:v};function R(A=a(w.seed)){return Se(A,w.seed,"seed")}function N(A){return mc(A)&&A.length===i.BYTES}function O(A,E){try{return!!r.fromBytes(A,E)}catch{return!1}}let F={getExtendedPublicKey:d,randomSecretKey:R,isValidSecretKey:N,isValidPublicKey:O,toMontgomery(A){let{y:E}=r.fromBytes(A),L=w.publicKey,U=L===32;if(!U&&L!==57)throw new Error("only defined for 25519 and 448");let B=U?o.div(Kt+E,Kt-E):o.div(E-Kt,E+Kt);return o.toBytes(B)},toMontgomerySecret(A){let E=w.secretKey;Se(A,E);let L=e(A.subarray(0,E));return c(L).subarray(0,E)}};return Object.freeze({keygen:B2(R,p),getPublicKey:p,sign:x,verify:_,utils:F,Point:r,lengths:w})}var wz=BigInt(1),eT=BigInt(2);var xz=BigInt(5),Ez=BigInt(8),$8=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),vz={p:$8,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Ez,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Sz(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),o=$8,a=r*r%o*r%o,c=it(a,eT,o)*a%o,u=it(c,wz,o)*r%o,f=it(u,xz,o)*u%o,h=it(f,e,o)*f%o,d=it(h,t,o)*h%o,p=it(d,n,o)*d%o,y=it(p,s,o)*p%o,x=it(y,s,o)*p%o,b=it(x,e,o)*f%o;return{pow_p_5_8:it(b,eT,o)*r%o,b2:a}}function _z(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var tT=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function Az(r,e){let t=$8,n=St(e*e*e,t),s=St(n*n*e,t),o=Sz(r*s).pow_p_5_8,i=St(r*n*o,t),a=St(e*i*i,t),c=i,u=St(i*tT,t),f=a===r,h=a===St(-r,t),d=a===St(-r*tT,t);return f&&(i=c),(h||d)&&(i=u),zI(i,t)&&(i=St(-i,t)),{isValid:f||h,value:i}}var Iz=QI(vz,{uvRatio:Az});function Tz(r){return JI(Iz,BI,Object.assign({adjustScalarBytes:_z},r))}var Bd=Tz({});var Pd=class extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}},Ld=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},P2=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var rT={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new P2("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var en=rT;var L2=32,kd=64,G8=32;var du,nT=(async()=>{try{return await en.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function sT(){let r=Bd.utils.randomSecretKey(),e=Bd.getPublicKey(r);return{privateKey:Pz(r,e),publicKey:e}}async function Rz(r,e){let t;r.length===kd?t=r.subarray(0,32):t=r;let n={crv:"Ed25519",kty:"OKP",x:z(r.subarray(32),"base64url"),d:z(t,"base64url"),ext:!0,key_ops:["sign"]},s=await en.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),o=await en.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(o,0,o.byteLength)}function Cz(r,e){let t=r.subarray(0,G8);return Bd.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function oT(r,e){return du==null&&(du=await nT),du?Rz(r,e):Cz(r,e)}async function Dz(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await en.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await en.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function Bz(r,e,t){return Bd.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function iT(r,e,t){return du==null&&(du=await nT),du?Dz(r,e,t):Bz(r,e,t)}function Pz(r,e){let t=new Uint8Array(kd);for(let n=0;n<G8;n++)t[n]=r[n],t[G8+n]=e[n];return t}function pu(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Nd=class{constructor(e){l(this,"type","Ed25519");l(this,"raw");this.raw=N2(e,L2)}toMultihash(){return ge.digest(ou(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let s=iT(this.raw,t,e);return pu(s)?s.then(o=>(n?.signal?.throwIfAborted(),o)):s}},k2=class{constructor(e,t){l(this,"type","Ed25519");l(this,"raw");l(this,"publicKey");this.raw=N2(e,kd),this.publicKey=new Nd(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();let n=oT(this.raw,e);return pu(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}};function W8(r){return r=N2(r,L2),new Nd(r)}async function cT(){let{privateKey:r,publicKey:e}=sT();return new k2(r,e)}function N2(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new be(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var Lz=Math.pow(2,7),kz=Math.pow(2,14),Nz=Math.pow(2,21),Y8=Math.pow(2,28),Z8=Math.pow(2,35),X8=Math.pow(2,42),j8=Math.pow(2,49),qe=128,br=127;function ce(r){if(r<Lz)return 1;if(r<kz)return 2;if(r<Nz)return 3;if(r<Y8)return 4;if(r<Z8)return 5;if(r<X8)return 6;if(r<j8)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Et(r,e,t=0){switch(ce(r)){case 8:e[t++]=r&255|qe,r/=128;case 7:e[t++]=r&255|qe,r/=128;case 6:e[t++]=r&255|qe,r/=128;case 5:e[t++]=r&255|qe,r/=128;case 4:e[t++]=r&255|qe,r>>>=7;case 3:e[t++]=r&255|qe,r>>>=7;case 2:e[t++]=r&255|qe,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function Oz(r,e,t=0){switch(ce(r)){case 8:e.set(t++,r&255|qe),r/=128;case 7:e.set(t++,r&255|qe),r/=128;case 6:e.set(t++,r&255|qe),r/=128;case 5:e.set(t++,r&255|qe),r/=128;case 4:e.set(t++,r&255|qe),r>>>=7;case 3:e.set(t++,r&255|qe),r>>>=7;case 2:e.set(t++,r&255|qe),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function gn(r,e){let t=r[e],n=0;if(n+=t&br,t<qe||(t=r[e+1],n+=(t&br)<<7,t<qe)||(t=r[e+2],n+=(t&br)<<14,t<qe)||(t=r[e+3],n+=(t&br)<<21,t<qe)||(t=r[e+4],n+=(t&br)*Y8,t<qe)||(t=r[e+5],n+=(t&br)*Z8,t<qe)||(t=r[e+6],n+=(t&br)*X8,t<qe)||(t=r[e+7],n+=(t&br)*j8,t<qe))return n;throw new RangeError("Could not decode varint")}function Mz(r,e){let t=r.get(e),n=0;if(n+=t&br,t<qe||(t=r.get(e+1),n+=(t&br)<<7,t<qe)||(t=r.get(e+2),n+=(t&br)<<14,t<qe)||(t=r.get(e+3),n+=(t&br)<<21,t<qe)||(t=r.get(e+4),n+=(t&br)*Y8,t<qe)||(t=r.get(e+5),n+=(t&br)*Z8,t<qe)||(t=r.get(e+6),n+=(t&br)*X8,t<qe)||(t=r.get(e+7),n+=(t&br)*j8,t<qe))return n;throw new RangeError("Could not decode varint")}function je(r,e,t=0){return e==null&&(e=pe(ce(r))),e instanceof Uint8Array?Et(r,e,t):Oz(r,e,t)}function Nt(r,e=0){return r instanceof Uint8Array?gn(r,e):Mz(r,e)}var Q8=new Float32Array([-0]),Xi=new Uint8Array(Q8.buffer);function lT(r,e,t){Q8[0]=r,e[t]=Xi[0],e[t+1]=Xi[1],e[t+2]=Xi[2],e[t+3]=Xi[3]}function uT(r,e){return Xi[0]=r[e],Xi[1]=r[e+1],Xi[2]=r[e+2],Xi[3]=r[e+3],Q8[0]}var J8=new Float64Array([-0]),wr=new Uint8Array(J8.buffer);function fT(r,e,t){J8[0]=r,e[t]=wr[0],e[t+1]=wr[1],e[t+2]=wr[2],e[t+3]=wr[3],e[t+4]=wr[4],e[t+5]=wr[5],e[t+6]=wr[6],e[t+7]=wr[7]}function hT(r,e){return wr[0]=r[e],wr[1]=r[e+1],wr[2]=r[e+2],wr[3]=r[e+3],wr[4]=r[e+4],wr[5]=r[e+5],wr[6]=r[e+6],wr[7]=r[e+7],J8[0]}var Uz=BigInt(Number.MAX_SAFE_INTEGER),Kz=BigInt(Number.MIN_SAFE_INTEGER),yn=class r{constructor(e,t){l(this,"lo");l(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return vc;if(e<Uz&&e>Kz)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>dT&&(s=0n,++n>dT&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return vc;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):vc}},vc=new yn(0,0);vc.toBigInt=function(){return 0n};vc.zzEncode=vc.zzDecode=function(){return this};vc.length=function(){return 1};var dT=4294967296n;function pT(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function mT(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function eb(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function os(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function O2(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var tb=class{constructor(e){l(this,"buf");l(this,"pos");l(this,"len");l(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,os(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw os(this,4);return O2(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw os(this,4);return O2(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw os(this,4);let e=uT(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw os(this,4);let e=hT(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw os(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return mT(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw os(this,e);this.pos+=e}else do if(this.pos>=this.len)throw os(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new yn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw os(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw os(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw os(this,8);let e=O2(this.buf,this.pos+=4),t=O2(this.buf,this.pos+=4);return new yn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=gn(this.buf,this.pos);return this.pos+=ce(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function rb(r){return new tb(r instanceof Uint8Array?r:r.subarray())}function M2(r,e,t){let n=rb(r);return e.decode(n,void 0,t)}function nb(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return pe(i);s+i>e&&(n=pe(e),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var Sc=class{constructor(e,t,n){l(this,"fn");l(this,"len");l(this,"next");l(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}};function sb(){}var ib=class{constructor(e){l(this,"head");l(this,"tail");l(this,"len");l(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},Fz=nb();function Vz(r){return globalThis.Buffer!=null?pe(r):Fz(r)}var Md=class{constructor(){l(this,"len");l(this,"head");l(this,"tail");l(this,"states");this.len=0,this.head=new Sc(sb,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Sc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new ab((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(U2,10,yn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=yn.fromBigInt(e);return this._push(U2,t.length(),t)}uint64Number(e){return this._push(Et,ce(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=yn.fromBigInt(e).zzEncode();return this._push(U2,t.length(),t)}sint64Number(e){let t=yn.fromNumber(e).zzEncode();return this._push(U2,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(ob,1,e?1:0)}fixed32(e){return this._push(Od,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=yn.fromBigInt(e);return this._push(Od,4,t.lo)._push(Od,4,t.hi)}fixed64Number(e){let t=yn.fromNumber(e);return this._push(Od,4,t.lo)._push(Od,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(lT,4,e)}double(e){return this._push(fT,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(ob,1,0):this.uint32(t)._push(qz,t,e)}string(e){let t=pT(e);return t!==0?this.uint32(t)._push(eb,t,e):this._push(ob,1,0)}fork(){return this.states=new ib(this),this.head=this.tail=new Sc(sb,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Sc(sb,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=Vz(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function ob(r,e,t){e[t]=r&255}function Hz(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var ab=class extends Sc{constructor(t,n){super(Hz,t,n);l(this,"next");this.next=void 0}};function U2(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Od(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function qz(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Md.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(zz,e,r),this},Md.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push($z,e,r),this});function zz(r,e,t){e.set(r,t)}function $z(r,e,t){r.length<40?eb(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(H(r),t)}function cb(){return new Md}function K2(r,e){let t=cb();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var mu;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(mu||(mu={}));function F2(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function lb(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(o,i){let a=e(o);i.int32(a)},n=function(o){let i=o.int32();return e(i)};return F2("enum",mu.VARINT,t,n)}function V2(r,e){return F2("message",mu.LENGTH_DELIMITED,r,e)}var _t;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(_t||(_t={}));var ub;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(ub||(ub={}));(function(r){r.codec=()=>lb(ub)})(_t||(_t={}));var Os;(function(r){let e;r.codec=()=>(e==null&&(e=V2((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),_t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=_t.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>K2(t,r.codec()),r.decode=(t,n)=>M2(t,r.codec(),n)})(Os||(Os={}));var fb;(function(r){let e;r.codec=()=>(e==null&&(e=V2((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),_t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=_t.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>K2(t,r.codec()),r.decode=(t,n)=>M2(t,r.codec(),n)})(fb||(fb={}));function gu(r){if(isNaN(r)||r<=0)throw new be("random bytes length must be a Number bigger than 0");return zi(r)}var Kd={};pt(Kd,{MAX_RSA_KEY_SIZE:()=>hb,generateRSAKeyPair:()=>Eb,jwkToJWKKeyPair:()=>ET,jwkToPkcs1:()=>Zz,jwkToPkix:()=>gb,jwkToRSAPrivateKey:()=>xb,pkcs1MessageToJwk:()=>pb,pkcs1MessageToRSAPrivateKey:()=>yb,pkcs1ToJwk:()=>Yz,pkcs1ToRSAPrivateKey:()=>xT,pkixMessageToJwk:()=>mb,pkixMessageToRSAPublicKey:()=>wb,pkixToJwk:()=>Xz,pkixToRSAPublicKey:()=>bb});var yu=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Kd.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return se.createV1(114,this._multihash)}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return wT(this.jwk,t,e,n)}},Ud=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"publicKey");this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Kd.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}sign(e,t){return bT(this.jwk,e,t)}};var hb=8192,db=18,Gz=1062,Wz=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function Yz(r){let e=Eo(r);return pb(e)}function pb(r){return{n:z(r[1],"base64url"),e:z(r[2],"base64url"),d:z(r[3],"base64url"),p:z(r[4],"base64url"),q:z(r[5],"base64url"),dp:z(r[6],"base64url"),dq:z(r[7],"base64url"),qi:z(r[8],"base64url"),kty:"RSA"}}function Zz(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new be("JWK was missing components");return ns([Pr(Uint8Array.from([0])),Pr(H(r.n,"base64url")),Pr(H(r.e,"base64url")),Pr(H(r.d,"base64url")),Pr(H(r.p,"base64url")),Pr(H(r.q,"base64url")),Pr(H(r.dp,"base64url")),Pr(H(r.dq,"base64url")),Pr(H(r.qi,"base64url"))]).subarray()}function Xz(r){let e=Eo(r,{offset:0});return mb(e)}function mb(r){let e=Eo(r[1],{offset:0});return{kty:"RSA",n:z(e[0],"base64url"),e:z(e[1],"base64url")}}function gb(r){if(r.n==null||r.e==null)throw new be("JWK was missing components");return ns([Wz,vd(ns([Pr(H(r.n,"base64url")),Pr(H(r.e,"base64url"))]))]).subarray()}function xT(r){let e=Eo(r);return yb(e)}function yb(r){let e=pb(r);return xb(e)}function bb(r,e){if(r.byteLength>=Gz)throw new lc("Key size is too large");let t=Eo(r,{offset:0});return wb(t,r,e)}function wb(r,e,t){let n=mb(r);if(t==null){let s=au(Os.encode({Type:_t.RSA,Data:e}));t=ot(db,s)}return new yu(n,t)}function xb(r){if(ST(r)>hb)throw new be("Key size is too large");let e=ET(r),t=au(Os.encode({Type:_t.RSA,Data:gb(e.publicKey)})),n=ot(db,t);return new Ud(e.privateKey,new yu(e.publicKey,n))}async function Eb(r){if(r>hb)throw new be("Key size is too large");let e=await vT(r),t=au(Os.encode({Type:_t.RSA,Data:gb(e.publicKey)})),n=ot(db,t);return new Ud(e.privateKey,new yu(e.publicKey,n))}function ET(r){if(r==null)throw new be("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function vT(r,e){let t=await en.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await jz(t,e);return{privateKey:n[0],publicKey:n[1]}}async function bT(r,e,t){let n=await en.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let s=await en.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function wT(r,e,t,n){let s=await en.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let o=await en.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),o}async function jz(r,e){if(r.privateKey==null||r.publicKey==null)throw new be("Private and public key are required");let t=await Promise.all([en.get().subtle.exportKey("jwk",r.privateKey),en.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function ST(r){if(r.kty!=="RSA")throw new be("invalid key type");if(r.n==null)throw new be("invalid key modulus");return H(r.n,"base64url").length*8}var H2=class{constructor(e,t){l(this,"oHash");l(this,"iHash");l(this,"blockLen");l(this,"outputLen");l(this,"finished",!1);l(this,"destroyed",!1);if(_2(e),Se(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),So(s)}update(e){return iu(this),this.iHash.update(e),this}digestInto(e){iu(this),Se(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},vb=(r,e,t)=>new H2(r,e).update(t).digest();vb.create=(r,e)=>new H2(r,e);var _T=(r,e)=>(r+(r>=0?e:-e)/AT)/e;function Qz(r,e,t){let[[n,s],[o,i]]=e,a=_T(i*r,t),c=_T(-s*r,t),u=r-a*n-c*o,f=-a*s-c*i,h=u<Ro,d=f<Ro;h&&(u=-u),d&&(f=-f);let p=Rd(Math.ceil(N8(t)/2))+bu;if(u<Ro||u>=p||f<Ro||f>=p)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:u,k2neg:d,k2:f}}function _b(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function Sb(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return To(t.lowS,"lowS"),To(t.prehash,"prehash"),t.format!==void 0&&_b(t.format),t}var Ab=class extends Error{constructor(e=""){super(e)}},ji={Err:Ab,_tlv:{encode:(r,e)=>{let{Err:t}=ji;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,s=Id(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?Id(s.length/2|128):"";return Id(r)+o+s+e},decode(r,e){let{Err:t}=ji,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let s=e[n++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let f of u)i=i<<8|f;if(n+=c,i<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+i);if(a.length!==i)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(r){let{Err:e}=ji;if(r<Ro)throw new e("integer: negative integers are not allowed");let t=Id(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=ji;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return cu(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=ji,s=Se(r,void 0,"signature"),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:u,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){let{_tlv:e,_int:t}=ji,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),o=n+s;return e.encode(48,o)}},Ro=BigInt(0),bu=BigInt(1),AT=BigInt(2),q2=BigInt(3),Jz=BigInt(4);function IT(r,e={}){let t=D2("weierstrass",r,e),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i,n:a}=o;Yi(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let u=RT(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(I,g,m){let{x:S,y:T}=g.toAffine(),P=n.toBytes(S);if(To(m,"isCompressed"),m){f();let C=!n.isOdd(T);return Jr(TT(C),P)}else return Jr(Uint8Array.of(4),P,n.toBytes(T))}function d(I){Se(I,void 0,"Point");let{publicKey:g,publicKeyUncompressed:m}=u,S=I.length,T=I[0],P=I.subarray(1);if(S===g&&(T===2||T===3)){let C=n.fromBytes(P);if(!n.isValid(C))throw new Error("bad point: is not on curve, wrong x");let k=x(C),D;try{D=n.sqrt(k)}catch(W){let G=W instanceof Error?": "+W.message:"";throw new Error("bad point: is not on curve, sqrt error"+G)}f();let M=n.isOdd(D);return(T&1)===1!==M&&(D=n.neg(D)),{x:C,y:D}}else if(S===m&&T===4){let C=n.BYTES,k=n.fromBytes(P.subarray(0,C)),D=n.fromBytes(P.subarray(C,C*2));if(!b(k,D))throw new Error("bad point: is not on curve");return{x:k,y:D}}else throw new Error(`bad point: got length ${S}, expected compressed=${g} or uncompressed=${m}`)}let p=e.toBytes||h,y=e.fromBytes||d;function x(I){let g=n.sqr(I),m=n.mul(g,I);return n.add(n.add(m,n.mul(I,o.a)),o.b)}function b(I,g){let m=n.sqr(g),S=x(I);return n.eql(m,S)}if(!b(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let _=n.mul(n.pow(o.a,q2),Jz),v=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(_,v)))throw new Error("bad curve params: a or b");function w(I,g,m=!1){if(!n.isValid(g)||m&&n.is0(g))throw new Error(`bad point coordinate ${I}`);return g}function R(I){if(!(I instanceof E))throw new Error("Weierstrass Point expected")}function N(I){if(!c||!c.basises)throw new Error("no endo");return Qz(I,c.basises,s.ORDER)}let O=lu((I,g)=>{let{X:m,Y:S,Z:T}=I;if(n.eql(T,n.ONE))return{x:m,y:S};let P=I.is0();g==null&&(g=P?n.ONE:n.inv(T));let C=n.mul(m,g),k=n.mul(S,g),D=n.mul(T,g);if(P)return{x:n.ZERO,y:n.ZERO};if(!n.eql(D,n.ONE))throw new Error("invZ was invalid");return{x:C,y:k}}),F=lu(I=>{if(I.is0()){if(e.allowInfinityPoint&&!n.is0(I.Y))return;throw new Error("bad point: ZERO")}let{x:g,y:m}=I.toAffine();if(!n.isValid(g)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!b(g,m))throw new Error("bad point: equation left != right");if(!I.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function A(I,g,m,S,T){return m=new E(n.mul(m.X,I),m.Y,m.Z),g=Dd(S,g),m=Dd(T,m),g.add(m)}let B=class B{constructor(g,m,S){l(this,"X");l(this,"Y");l(this,"Z");this.X=w("x",g),this.Y=w("y",m,!0),this.Z=w("z",S),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){let{x:m,y:S}=g||{};if(!g||!n.isValid(m)||!n.isValid(S))throw new Error("invalid affine point");if(g instanceof B)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(S)?B.ZERO:new B(m,S,n.ONE)}static fromBytes(g){let m=B.fromAffine(y(Se(g,void 0,"point")));return m.assertValidity(),m}static fromHex(g){return B.fromBytes(Ao(g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,m=!0){return U.createCache(this,g),m||this.multiply(q2),this}assertValidity(){F(this)}hasEvenY(){let{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.eql(n.mul(m,k),n.mul(P,T)),M=n.eql(n.mul(S,k),n.mul(C,T));return D&&M}negate(){return new B(this.X,n.neg(this.Y),this.Z)}double(){let{a:g,b:m}=o,S=n.mul(m,q2),{X:T,Y:P,Z:C}=this,k=n.ZERO,D=n.ZERO,M=n.ZERO,q=n.mul(T,T),W=n.mul(P,P),G=n.mul(C,C),$=n.mul(T,P);return $=n.add($,$),M=n.mul(T,C),M=n.add(M,M),k=n.mul(g,M),D=n.mul(S,G),D=n.add(k,D),k=n.sub(W,D),D=n.add(W,D),D=n.mul(k,D),k=n.mul($,k),M=n.mul(S,M),G=n.mul(g,G),$=n.sub(q,G),$=n.mul(g,$),$=n.add($,M),M=n.add(q,q),q=n.add(M,q),q=n.add(q,G),q=n.mul(q,$),D=n.add(D,q),G=n.mul(P,C),G=n.add(G,G),q=n.mul(G,$),k=n.sub(k,q),M=n.mul(G,W),M=n.add(M,M),M=n.add(M,M),new B(k,D,M)}add(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.ZERO,M=n.ZERO,q=n.ZERO,W=o.a,G=n.mul(o.b,q2),$=n.mul(m,P),X=n.mul(S,C),Q=n.mul(T,k),J=n.add(m,S),Y=n.add(P,C);J=n.mul(J,Y),Y=n.add($,X),J=n.sub(J,Y),Y=n.add(m,T);let re=n.add(P,k);return Y=n.mul(Y,re),re=n.add($,Q),Y=n.sub(Y,re),re=n.add(S,T),D=n.add(C,k),re=n.mul(re,D),D=n.add(X,Q),re=n.sub(re,D),q=n.mul(W,Y),D=n.mul(G,Q),q=n.add(D,q),D=n.sub(X,q),q=n.add(X,q),M=n.mul(D,q),X=n.add($,$),X=n.add(X,$),Q=n.mul(W,Q),Y=n.mul(G,Y),X=n.add(X,Q),Q=n.sub($,Q),Q=n.mul(W,Q),Y=n.add(Y,Q),$=n.mul(X,Y),M=n.add(M,$),$=n.mul(re,Y),D=n.mul(J,D),D=n.sub(D,$),$=n.mul(J,X),q=n.mul(re,q),q=n.add(q,$),new B(D,M,q)}subtract(g){return this.add(g.negate())}is0(){return this.equals(B.ZERO)}multiply(g){let{endo:m}=e;if(!s.isValidNot0(g))throw new Error("invalid scalar: out of range");let S,T,P=C=>U.cached(this,C,k=>Ec(B,k));if(m){let{k1neg:C,k1:k,k2neg:D,k2:M}=N(g),{p:q,f:W}=P(k),{p:G,f:$}=P(M);T=W.add($),S=A(m.beta,q,G,C,D)}else{let{p:C,f:k}=P(g);S=C,T=k}return Ec(B,[S,T])[0]}multiplyUnsafe(g){let{endo:m}=e,S=this;if(!s.isValid(g))throw new Error("invalid scalar: out of range");if(g===Ro||S.is0())return B.ZERO;if(g===bu)return S;if(U.hasCache(this))return this.multiply(g);if(m){let{k1neg:T,k1:P,k2neg:C,k2:k}=N(g),{p1:D,p2:M}=jI(B,S,P,k);return A(m.beta,D,M,T,C)}else return U.unsafe(S,g)}toAffine(g){return O(this,g)}isTorsionFree(){let{isTorsionFree:g}=e;return i===bu?!0:g?g(B,this):U.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:g}=e;return i===bu?this:g?g(B,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return To(g,"isCompressed"),this.assertValidity(),p(B,this,g)}toHex(g=!0){return _o(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(B,"BASE",new B(o.Gx,o.Gy,n.ONE)),l(B,"ZERO",new B(n.ZERO,n.ONE,n.ZERO)),l(B,"Fp",n),l(B,"Fn",s);let E=B,L=s.BITS,U=new hu(E,e.endo?Math.ceil(L/2):L);return E.BASE.precompute(8),E}function TT(r){return Uint8Array.of(r?2:3)}function RT(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function e$(r,e={}){let{Fn:t}=r,n=e.randomBytes||zi,s=Object.assign(RT(r.Fp,t),{seed:K8(t.ORDER)});function o(p){try{let y=t.fromBytes(p);return t.isValidNot0(y)}catch{return!1}}function i(p,y){let{publicKey:x,publicKeyUncompressed:b}=s;try{let _=p.length;return y===!0&&_!==x||y===!1&&_!==b?!1:!!r.fromBytes(p)}catch{return!1}}function a(p=n(s.seed)){return F8(Se(p,s.seed,"seed"),t.ORDER)}function c(p,y=!0){return r.BASE.multiply(t.fromBytes(p)).toBytes(y)}function u(p){let{secretKey:y,publicKey:x,publicKeyUncompressed:b}=s;if(!mc(p)||"_lengths"in t&&t._lengths||y===x)return;let _=Se(p,void 0,"key").length;return _===x||_===b}function f(p,y,x=!0){if(u(p)===!0)throw new Error("first arg must be private key");if(u(y)===!1)throw new Error("second arg must be public key");let b=t.fromBytes(p);return r.fromBytes(y).multiply(b).toBytes(x)}let h={isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a},d=B2(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:d,Point:r,utils:h,lengths:s})}function CT(r,e,t={}){_2(e),Yi(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||zi,s=t.hmac||((g,m)=>vb(e,g,m)),{Fp:o,Fn:i}=r,{ORDER:a,BITS:c}=i,{keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p}=e$(r,t),y={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},x=a*AT<o.ORDER;function b(g){let m=a>>bu;return g>m}function _(g,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${g}: out of range 1..Point.Fn.ORDER`);return m}function v(){if(x)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(g,m){_b(m);let S=p.signature,T=m==="compact"?S:m==="recovered"?S+1:void 0;return Se(g,T)}class R{constructor(m,S,T){l(this,"r");l(this,"s");l(this,"recovery");if(this.r=_("r",m),this.s=_("s",S),T!=null){if(v(),![0,1,2,3].includes(T))throw new Error("invalid recovery id");this.recovery=T}Object.freeze(this)}static fromBytes(m,S=y.format){w(m,S);let T;if(S==="der"){let{r:D,s:M}=ji.toSig(Se(m));return new R(D,M)}S==="recovered"&&(T=m[0],S="compact",m=m.subarray(1));let P=p.signature/2,C=m.subarray(0,P),k=m.subarray(P,P*2);return new R(i.fromBytes(C),i.fromBytes(k),T)}static fromHex(m,S){return this.fromBytes(Ao(m),S)}assertRecovery(){let{recovery:m}=this;if(m==null)throw new Error("invalid recovery id: must be present");return m}addRecoveryBit(m){return new R(this.r,this.s,m)}recoverPublicKey(m){let{r:S,s:T}=this,P=this.assertRecovery(),C=P===2||P===3?S+a:S;if(!o.isValid(C))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let k=o.toBytes(C),D=r.fromBytes(Jr(TT((P&1)===0),k)),M=i.inv(C),q=O(Se(m,void 0,"msgHash")),W=i.create(-q*M),G=i.create(T*M),$=r.BASE.multiplyUnsafe(W).add(D.multiplyUnsafe(G));if($.is0())throw new Error("invalid recovery: point at infinify");return $.assertValidity(),$}hasHighS(){return b(this.s)}toBytes(m=y.format){if(_b(m),m==="der")return Ao(ji.hexFromSig(this));let{r:S,s:T}=this,P=i.toBytes(S),C=i.toBytes(T);return m==="recovered"?(v(),Jr(Uint8Array.of(this.assertRecovery()),P,C)):Jr(P,C)}toHex(m){return _o(this.toBytes(m))}}let N=t.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");let S=cu(m),T=m.length*8-c;return T>0?S>>BigInt(T):S},O=t.bits2int_modN||function(m){return i.create(N(m))},F=Rd(c);function A(g){return Td("num < 2^"+c,g,Ro,F),i.toBytes(g)}function E(g,m){return Se(g,void 0,"message"),m?Se(e(g),void 0,"prehashed message"):g}function L(g,m,S){let{lowS:T,prehash:P,extraEntropy:C}=Sb(S,y);g=E(g,P);let k=O(g),D=i.fromBytes(m);if(!i.isValidNot0(D))throw new Error("invalid private key");let M=[A(D),A(k)];if(C!=null&&C!==!1){let $=C===!0?n(p.secretKey):C;M.push(Se($,void 0,"extraEntropy"))}let q=Jr(...M),W=k;function G($){let X=N($);if(!i.isValidNot0(X))return;let Q=i.inv(X),J=r.BASE.multiply(X).toAffine(),Y=i.create(J.x);if(Y===Ro)return;let re=i.create(Q*i.create(W+Y*D));if(re===Ro)return;let sr=(J.x===Y?0:2)|Number(J.y&bu),or=re;return T&&b(re)&&(or=i.neg(re),sr^=1),new R(Y,or,x?void 0:sr)}return{seed:q,k2sig:G}}function U(g,m,S={}){let{seed:T,k2sig:P}=L(g,m,S);return kI(e.outputLen,i.BYTES,s)(T,P).toBytes(S.format)}function B(g,m,S,T={}){let{lowS:P,prehash:C,format:k}=Sb(T,y);if(S=Se(S,void 0,"publicKey"),m=E(m,C),!mc(g)){let D=g instanceof R?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+D)}w(g,k);try{let D=R.fromBytes(g,k),M=r.fromBytes(S);if(P&&D.hasHighS())return!1;let{r:q,s:W}=D,G=O(m),$=i.inv(W),X=i.create(G*$),Q=i.create(q*$),J=r.BASE.multiplyUnsafe(X).add(M.multiplyUnsafe(Q));return J.is0()?!1:i.create(J.x)===q}catch{return!1}}function I(g,m,S={}){let{prehash:T}=Sb(S,y);return m=E(m,T),R.fromBytes(g,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p,Point:r,sign:U,verify:B,recoverPublicKey:I,Signature:R,hash:e})}var Tb={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},t$={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var DT=BigInt(2);function r$(r){let e=Tb.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,f=u*u*r%e,h=it(f,t,e)*f%e,d=it(h,t,e)*f%e,p=it(d,DT,e)*u%e,y=it(p,s,e)*p%e,x=it(y,o,e)*y%e,b=it(x,a,e)*x%e,_=it(b,c,e)*b%e,v=it(_,a,e)*x%e,w=it(v,t,e)*f%e,R=it(w,i,e)*y%e,N=it(R,n,e)*u%e,O=it(N,DT,e);if(!Ib.eql(Ib.sqr(O),r))throw new Error("Cannot find square root");return O}var Ib=uu(Tb.p,{sqrt:r$}),n$=IT(Tb,{Fp:Ib,endo:t$}),is=CT(n$,au);function BT(r,e,t){let n=Ee.digest(e instanceof Uint8Array?e:e.subarray());if(pu(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),is.sign(s,r,{prehash:!1,format:"der"}))).catch(s=>{throw s.name==="AbortError"?s:new Pd(String(s))});try{return is.sign(n.digest,r,{prehash:!1,format:"der"})}catch(s){throw new Pd(String(s))}}function PT(r,e,t,n){let s=Ee.digest(t instanceof Uint8Array?t:t.subarray());if(pu(s))return s.then(({digest:o})=>(n?.signal?.throwIfAborted(),is.verify(e,o,r,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new Ld(String(o))});try{return n?.signal?.throwIfAborted(),is.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(o){throw new Ld(String(o))}}var Fd=class{constructor(e){l(this,"type","secp256k1");l(this,"raw");l(this,"_key");this._key=NT(e),this.raw=LT(this._key)}toMultihash(){return ge.digest(ou(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return PT(this._key,t,e,n)}},z2=class{constructor(e,t){l(this,"type","secp256k1");l(this,"raw");l(this,"publicKey");this.raw=kT(e),this.publicKey=new Fd(t??OT(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}sign(e,t){return BT(this.raw,e,t)}};function Rb(r){return new Fd(r)}async function MT(){let r=s$();return new z2(r)}function LT(r){return is.Point.fromBytes(r).toBytes()}function kT(r){try{return is.getPublicKey(r,!0),r}catch(e){throw new eu(String(e))}}function NT(r){try{return is.Point.fromBytes(r),r}catch(e){throw new lc(String(e))}}function OT(r){try{return is.getPublicKey(r,!0)}catch(e){throw new eu(String(e))}}function s$(){return is.utils.randomSecretKey()}async function UT(r,e){if(r==="Ed25519")return cT();if(r==="secp256k1")return MT();if(r==="RSA")return Eb(o$(e));if(r==="ECDSA")return gI(i$(e));throw new bo}function KT(r,e){let{Type:t,Data:n}=Os.decode(r),s=n??new Uint8Array;switch(t){case _t.RSA:return bb(s,e);case _t.Ed25519:return W8(s);case _t.secp256k1:return Rb(s);case _t.ECDSA:return S8(s);default:throw new bo}}function FT(r){let{Type:e,Data:t}=Os.decode(r.digest),n=t??new Uint8Array;switch(e){case _t.Ed25519:return W8(n);case _t.secp256k1:return Rb(n);case _t.ECDSA:return S8(n);default:throw new bo}}function ou(r){return Os.encode({Type:_t[r.type],Data:r.raw})}function o$(r){return r==null?2048:parseInt(r,10)}function i$(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new be("Unsupported curve, should be P-256, P-384 or P-521")}var zT=Symbol.for("nodejs.util.inspect.custom"),a$=114,VT,Vd=class{constructor(e){l(this,"type");l(this,"multihash");l(this,"publicKey");l(this,"string");l(this,VT,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ie.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return se.createV1(a$,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return j(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return j(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(VT=y2,zT)](){return`PeerId(${this.toString()})`}},Hd=class extends Vd{constructor(t){super({...t,type:"RSA"});l(this,"type","RSA");l(this,"publicKey");this.publicKey=t.publicKey}},qd=class extends Vd{constructor(t){super({...t,type:"Ed25519"});l(this,"type","Ed25519");l(this,"publicKey");this.publicKey=t.publicKey}},zd=class extends Vd{constructor(t){super({...t,type:"secp256k1"});l(this,"type","secp256k1");l(this,"publicKey");this.publicKey=t.publicKey}},c$=2336,HT,qT,$d=class{constructor(e){l(this,"type","url");l(this,"multihash");l(this,"publicKey");l(this,"url");l(this,HT,!0);this.url=e.toString(),this.multihash=ge.digest(H(this.url))}[(qT=zT,HT=y2,qT)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return se.createV1(c$,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=z(e)),e.toString()===this.toString())}};var l$=114,$T=2336;function Ms(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=mt(ie.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return f$(se.parse(r));if(e==null)throw new be('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=mt(e.decode(r))}return $2(t)}function u$(r){if(r.type==="Ed25519")return new qd({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new zd({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new Hd({multihash:r.toCID().multihash,publicKey:r});throw new bo}function GT(r){return u$(r.publicKey)}function $2(r){if(d$(r))return new Hd({multihash:r});if(h$(r))try{let e=FT(r);if(e.type==="Ed25519")return new qd({multihash:r,publicKey:e});if(e.type==="secp256k1")return new zd({multihash:r,publicKey:e})}catch{let t=z(r.digest);return new $d(new URL(t))}throw new ud("Supplied PeerID Multihash is invalid")}function f$(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==l$&&r.code!==$T)throw new ld("Supplied PeerID CID is invalid");if(r.code===$T){let e=z(r.multihash.digest);return new $d(new URL(e))}return $2(r.multihash)}function h$(r){return r.code===ge.code}function d$(r){return r.code===Ee.code}async function WT(r){if(r.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new be("Private network is enforced, but no protector was provided");return r}function p$(r,e){if(typeof r=="string")return m$(r);if(typeof r=="number")return b$(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var G2=p$;function m$(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,s=parseFloat(t),o=n.toLowerCase();switch(o){case"years":case"year":case"yrs":case"yr":case"y":return s*315576e5;case"months":case"month":case"mo":return s*26298e5;case"weeks":case"week":case"w":return s*6048e5;case"days":case"day":case"d":return s*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return s*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return s*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return s*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw Error(`Unknown unit "${o}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function g$(r){let e=Math.abs(r);return e>=315576e5?`${Math.round(r/315576e5)}y`:e>=26298e5?`${Math.round(r/26298e5)}mo`:e>=6048e5?`${Math.round(r/6048e5)}w`:e>=864e5?`${Math.round(r/864e5)}d`:e>=36e5?`${Math.round(r/36e5)}h`:e>=6e4?`${Math.round(r/6e4)}m`:e>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function y$(r){let e=Math.abs(r);return e>=315576e5?_c(r,e,315576e5,"year"):e>=26298e5?_c(r,e,26298e5,"month"):e>=6048e5?_c(r,e,6048e5,"week"):e>=864e5?_c(r,e,864e5,"day"):e>=36e5?_c(r,e,36e5,"hour"):e>=6e4?_c(r,e,6e4,"minute"):e>=1e3?_c(r,e,1e3,"second"):`${r} ms`}function b$(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?y$(r):g$(r)}function _c(r,e,t,n){let s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function Cb(r){t.debug=t,t.default=t,t.coerce=c,t.disable=o,t.enable=s,t.enabled=i,t.humanize=G2,t.destroy=u,Object.keys(r).forEach(f=>{t[f]=r[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let h=0;for(let d=0;d<f.length;d++)h=(h<<5)-h+f.charCodeAt(d),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(f,h){let d,p=null,y,x;function b(..._){if(!b.enabled)return;let v=b,w=Number(new Date),R=w-(d||w);v.diff=R,v.prev=d,v.curr=w,d=w,_[0]=t.coerce(_[0]),typeof _[0]!="string"&&_.unshift("%O");let N=0;_[0]=_[0].replace(/%([a-zA-Z%])/g,(F,A)=>{if(F==="%%")return"%";N++;let E=t.formatters[A];if(typeof E=="function"){let L=_[N];F=E.call(v,L),_.splice(N,1),N--}return F}),t.formatArgs.call(v,_),h?.onLog!=null&&h.onLog(..._),(v.log||t.log).apply(v,_)}return b.namespace=f,b.useColors=t.useColors(),b.color=t.selectColor(f),b.extend=n,b.destroy=t.destroy,Object.defineProperty(b,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(y!==t.namespaces&&(y=t.namespaces,x=t.enabled(f)),x),set:_=>{p=_}}),typeof t.init=="function"&&t.init(b),b}function n(f,h){let d=t(this.namespace+(typeof h>"u"?":":h)+f);return d.log=this.log,d}function s(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];let h,d=(typeof f=="string"?f:"").split(/[\s,]+/),p=d.length;for(h=0;h<p;h++)d[h]&&(f=d[h].replace(/\*/g,".*?"),f[0]==="-"?t.skips.push(new RegExp("^"+f.substr(1)+"$")):t.names.push(new RegExp("^"+f+"$")))}function o(){let f=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),f}function i(f){if(f[f.length-1]==="*")return!0;let h,d;for(h=0,d=t.skips.length;h<d;h++)if(t.skips[h].test(f))return!1;for(h=0,d=t.names.length;h<d;h++)if(t.names[h].test(f))return!0;return!1}function a(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function c(f){return f instanceof Error?f.stack??f.message:f}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var W2=A$(),w$=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function x$(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function E$(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+G2(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}var v$=console.debug??console.log??(()=>{});function S$(r){try{r?W2?.setItem("debug",r):W2?.removeItem("debug")}catch{}}function _$(){let r;try{r=W2?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function A$(){try{return localStorage}catch{}}function I$(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var YT=Cb({formatArgs:E$,save:S$,load:_$,useColors:x$,setupFormatters:I$,colors:w$,storage:W2,log:v$});var rn=YT;rn.formatters.b=r=>r==null?"undefined":ie.baseEncode(r);rn.formatters.t=r=>r==null?"undefined":yr.baseEncode(r);rn.formatters.m=r=>r==null?"undefined":dc.baseEncode(r);rn.formatters.p=r=>r==null?"undefined":r.toString();rn.formatters.c=r=>r==null?"undefined":r.toString();rn.formatters.k=r=>r==null?"undefined":r.toString();rn.formatters.a=r=>r==null?"undefined":r.toString();function ZT(r,e=""){let t=XT(r.message),n=XT(r.stack);return t!=null&&n!=null?n.includes(t)?`${n.split(`
`).join(`
${e}`)}`:`${t}
${e}${n.split(`
`).join(`
${e}`)}`:n!=null?`${n.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${r.toString()}`}function T$(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}function jT(r,e=""){if(T$(r)){let t=ZT(r,e);return r.errors.length>0?(e=`${e}    `,t+=`
${e}${r.errors.map(n=>`${jT(n,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return ZT(r,e)}rn.formatters.e=r=>r==null?"undefined":jT(r);function R$(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Y2(r){return{forComponent(e){return QT(e,r)}}}function QT(r,e){let t=R$(`${r}:trace`);return rn.enabled(`${r}:trace`)&&rn.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=rn(`${r}:trace`,e)),Object.assign(rn(r,e),{error:rn(`${r}:error`,e),trace:t,newScope:n=>QT(`${r}:${n}`,e)})}function XT(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function Ac(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function Z2(r){let e=mt(ie.decode(`z${r}`));return $2(e)}var Co=class{constructor(e){l(this,"map");if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Ac(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Ac(this.map.values(),e=>e.key)}values(){return Ac(this.map.values(),e=>e.value)}get size(){return this.map.size}};var Ic=class r{constructor(e){l(this,"set");if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Ac(this.set.entries(),e=>{let t=Z2(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=Z2(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Ac(this.set.values(),e=>Z2(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};var Us=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};l(Us,"name","AbortError");var Tc=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};l(Tc,"name","InvalidParametersError");var Db={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},JT={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},eR=new globalThis.TextEncoder;function C$(r,e){let t=Db[e],n=JT[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function D$(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=Db[e],s=JT[e],o=r;for(;o.length>0;){let i=eR.encodeInto(o,t);o=o.slice(i.read);for(let a=0;a<i.written;a++)s^=BigInt(t[a]),s=BigInt.asUintN(e,s*n)}return s}function Rc(r,{size:e=32,utf8Buffer:t}={}){if(!Db[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return D$(r,e,t);r=eR.encode(r)}return C$(r,e)}var Gd={hash:r=>Number(Rc(r,{size:32})),hashV:(r,e)=>B$(Gd.hash(r,e))};function B$(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),H(e,"base16")}var Bb=64,as=class{constructor(e,t,n,s=2){l(this,"fp");l(this,"h");l(this,"seed");if(s>Bb)throw new TypeError("Invalid Fingerprint Size");let o=t.hashV(e,n),i=fe(s);for(let a=0;a<i.length;a++)i[a]=o[a];i.length===0&&(i[0]=7),this.fp=i,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?j(this.fp,e.fp):!1}};function Cc(r,e){return Math.floor(Math.random()*(e-r))+r}var Dc=class{constructor(e){l(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof as))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof as))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof as))throw new TypeError("Invalid Fingerprint");let t=Cc(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof as))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var P$=500,Wd=class{constructor(e){l(this,"bucketSize");l(this,"filterSize");l(this,"fingerprintSize");l(this,"buckets");l(this,"count");l(this,"hash");l(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Gd,this.seed=e.seed??Cc(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=H(e));let t=new as(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new Dc(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new Dc(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;let o=[n,s],i=o[Cc(0,o.length-1)];this.buckets[i]==null&&(this.buckets[i]=new Dc(this.bucketSize));for(let a=0;a<P$;a++){let c=this.buckets[i].swap(t);if(c!=null&&(i=(i^c.hash())%this.filterSize,this.buckets[i]==null&&(this.buckets[i]=new Dc(this.bucketSize)),this.buckets[i].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=H(e));let t=new as(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;let o=(n^t.hash())%this.filterSize;return this.buckets[o]?.has(t)??!1}remove(e){typeof e=="string"&&(e=H(e));let t=new as(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;let o=(n^t.hash())%this.filterSize,i=this.buckets[o]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},L$={1:.5,2:.84,4:.95,8:.98};function k$(r=.001){return r>.002?2:r>1e-5?4:8}function tR(r,e=.001){let t=k$(e),n=L$[t],s=Math.round(r/n),o=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),Bb);return{filterSize:s,bucketSize:t,fingerprintSize:o}}var X2=class{constructor(e){l(this,"filterSize");l(this,"bucketSize");l(this,"fingerprintSize");l(this,"scale");l(this,"filterSeries");l(this,"hash");l(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Gd,this.seed=e.seed??Cc(0,Math.pow(2,10)),this.filterSeries=[new Wd({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=H(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Wd({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=H(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=H(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function Yd(r,e=.001,t){return new X2({...tR(r,e),...t??{}})}function De(r){let e=r.getComponents(),t={},n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new Tc(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}var j2=class{constructor(){l(this,"index",0);l(this,"input","")}new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let o=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",u=2**(8*s)-1;for(;;){let f=this.readAtomically(()=>{let h=this.readChar();if(h===void 0)return;let d=Number.parseInt(h,e);if(!Number.isNaN(d))return d});if(f===void 0)break;if(o*=e,o+=f,o>u||(i+=1,t!==void 0&&i>t))return}if(i!==0)return!n&&c&&i>1?void 0:o})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let s=n*2;if(n<t.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return t[s]=i[0],t[s+1]=i[1],t[s+2]=i[2],t[s+3]=i[3],[s+4,!0]}let o=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(o===void 0)return[s,!1];t[s]=o>>8,t[s+1]=o&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let o=new Uint8Array(14),i=16-(n+2),[a]=e(o.subarray(0,i));return t.set(o.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var rR=45,N$=15,wu=new j2;function Q2(r){if(!(r.length>N$))return wu.new(r).parseWith(()=>wu.readIPv4Addr())}function J2(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>rR))return wu.new(r).parseWith(()=>wu.readIPv6Addr())}function xu(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>rR)return;let t=wu.new(r).parseWith(()=>wu.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function nR(r,e,t){let n=0;for(let s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function sR(r,e,t,n){let s=0;for(let o of r)if(!(s<t)){if(s>n)break;if(o!==e[s])return!1;s++}return!0}function Pb(r){switch(r.length){case Bc:return r.join(".");case Pc:{let e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function oR(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function iR(r){let e="0x";for(let t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}var Bc=4,Pc=16,jfe=parseInt("0xFFFF",16),O$=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Zd(r,e){e.length===Pc&&r.length===Bc&&nR(e,0,11)&&(e=e.slice(12)),e.length===Bc&&r.length===Pc&&sR(r,O$,0,11)&&(r=r.slice(12));let t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");let n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function aR(r,e){if(typeof e=="string"&&(e=xu(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function Lb(r){let[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Bc,s=Q2(e);if(s==null&&(n=Pc,s=J2(e),s==null))throw new Error("Failed to parse given CIDR: "+r);let o=parseInt(t,10);if(Number.isNaN(o)||String(o).length!==t.length||o<0||o>n*8)throw new Error("Failed to parse given CIDR: "+r);let i=kb(o,8*n);return{network:Zd(s,i),mask:i}}function kb(r,e){if(e!==8*Bc&&e!==8*Pc)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");let t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}var Lc=class{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=Lb(e));else{let n=xu(e);if(n==null)throw new Error("Failed to parse network");t=String(t);let s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){let o=xu(t);if(o==null)throw new Error("Failed to parse mask");this.mask=o}else this.mask=kb(s,8*n.length);this.network=Zd(n,this.mask)}}contains(e){return aR({network:this.network,mask:this.mask},e)}toString(){let e=oR(this.mask),t=e!==-1?String(e):iR(this.mask);return Pb(this.network)+"/"+t}};function cR(r){try{let e=De(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function lR(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Xd(r){try{let e=De(r);switch(e.type){case"ip4":case"ip6":return lR(e.host);default:return!1}}catch{return!1}}function ar(r){try{return De(r),!0}catch{return!1}}function gt(r){return!!Q2(r)}function Nn(r){return!!J2(r)}var uR=go(Nb(),1),M$=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],U$=M$.map(r=>new uR.Netmask(r));function Ob(r){for(let e of U$)if(e.contains(r))return!0;return!1}function K$(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function F$(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Ob(s)}function V$(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function H$(r){let e=r.split(":"),t=e[e.length-1];return Ob(t)}function q$(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Eu(r){if(gt(r))return Ob(r);if(K$(r))return F$(r);if(V$(r))return H$(r);if(Nn(r))return q$(r)}function Do(r){try{let e=De(r);switch(e.type){case"ip4":case"ip6":return Eu(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}function ue(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var em=class{constructor(e){l(this,"buffer");l(this,"mask");l(this,"top");l(this,"btm");l(this,"next");if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},vu=class{constructor(e={}){l(this,"size");l(this,"hwm");l(this,"head");l(this,"tail");this.hwm=e.splitLimit??16,this.head=new em(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new em(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var Mb=class extends Error{constructor(t,n){super(t??"The operation was aborted");l(this,"type");l(this,"code");this.type="aborted",this.code=n??"ABORT_ERR"}};function We(r={}){return z$(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function z$(r,e){e=e??{};let t=e.onEnd,n=new vu,s,o,i,a=ue(),c=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((b,_)=>{o=v=>{o=null,n.push(v);try{b(r(n))}catch(w){_(w)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ue()})}},u=b=>o!=null?o(b):(n.push(b),s),f=b=>(n=new vu,o!=null?o({error:b}):(n.push({error:b}),s)),h=b=>{if(i)return s;if(e?.objectMode!==!0&&b?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:b})},d=b=>i?s:(i=!0,b!=null?f(b):u({done:!0})),p=()=>(n=new vu,d(),{done:!0}),y=b=>(d(b),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:p,throw:y,push:h,end:d,get readableLength(){return n.size},onEmpty:async b=>{let _=b?.signal;if(_?.throwIfAborted(),n.isEmpty())return;let v,w;_!=null&&(v=new Promise((R,N)=>{w=()=>{N(new Mb)},_.addEventListener("abort",w)}));try{await Promise.race([a.promise,v])}finally{w!=null&&_!=null&&_?.removeEventListener("abort",w)}}},t==null)return s;let x=s;return s={[Symbol.asyncIterator](){return this},next(){return x.next()},throw(b){return x.throw(b),t!=null&&(t(b),t=void 0),{done:!0}},return(){return x.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(b){return x.end(b),t!=null&&(t(b),t=void 0),s},get readableLength(){return x.readableLength},onEmpty:b=>x.onEmpty(b)},s}var Qi=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Ub=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},fR=r=>globalThis.DOMException===void 0?new Ub(r):new DOMException(r),hR=r=>{let e=r.reason===void 0?fR("This operation was aborted."):r.reason;return e instanceof Error?e:fR(e)};function bn(r,e){let{milliseconds:t,fallback:n,message:s,customTimers:o={setTimeout,clearTimeout}}=e,i,a,u=new Promise((f,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:p}=e;p.aborted&&h(hR(p)),a=()=>{h(hR(p))},p.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,h);return}let d=new Qi;i=o.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(p){h(p)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?f():s instanceof Error?h(s):(d.message=s??`Promise timed out after ${t} milliseconds`,h(d))},t),(async()=>{try{f(await r)}catch(p){h(p)}})()}).finally(()=>{u.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return u.clear=()=>{o.clearTimeout.call(void 0,i),i=void 0},u}var $$=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function G$(r,e,t){let n,s=new Promise((o,i)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:u,removeListener:f}=$$(r),h=async(...p)=>{let y=t.multiArgs?p:p[0];if(t.filter)try{if(!await t.filter(y))return}catch(x){n(),i(x);return}c.push(y),t.count===c.length&&(n(),o(c))},d=(...p)=>{n(),i(t.rejectionMultiArgs?p:p[0])};n=()=>{for(let p of a)f(p,h);for(let p of t.rejectionEvents)a.includes(p)||f(p,d)};for(let p of a)u(p,h);for(let p of t.rejectionEvents)a.includes(p)||u(p,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(c)});if(s.cancel=n,typeof t.timeout=="number"){let o=bn(s,{milliseconds:t.timeout});return o.cancel=()=>{n(),o.clear()},o}return s}function Su(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=G$(r,e,t),s=n.then(o=>o[0]);return s.cancel=n.cancel,s}function Qd(r,e){let t,n=function(){let s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var tm=class extends Error{constructor(t="Rate limit exceeded",n){super(t);l(this,"remainingPoints");l(this,"msBeforeNext");l(this,"consumedPoints");l(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=n.remainingPoints,this.msBeforeNext=n.msBeforeNext,this.consumedPoints=n.consumedPoints,this.isFirstInDuration=n.isFirstInDuration}},Jd=class extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};l(Jd,"name","QueueFullError");var Ji=class extends Error{constructor(){super(...arguments);l(this,"name","UnexpectedEOFError")}};l(Ji,"name","UnexpectedEOFError");function W$(r){return r.reason}async function rm(r,e,t){if(e==null)return r;let n=t?.translateError??W$;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((o,i)=>{s=()=>{i(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}var nm=class{constructor(e){l(this,"deferred");l(this,"signal");this.signal=e,this.deferred=ue(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Us)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Y$(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var sm=class{constructor(e,t){l(this,"id");l(this,"fn");l(this,"options");l(this,"recipients");l(this,"status");l(this,"timeline");l(this,"controller");this.id=Y$(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Us),this.cleanup())}async join(e={}){let t=new nm(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await rm(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var _u=class extends Je{constructor(t={}){super();l(this,"concurrency");l(this,"maxSize");l(this,"queue");l(this,"pending");l(this,"sort");l(this,"paused");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,t.metricName!=null&&t.metrics?.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=t.sort,this.queue=[],this.emitEmpty=Qd(this.emitEmpty.bind(this),1),this.emitIdle=Qd(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let n of this.queue)if(n.status==="queued"){t=n;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let n=0;n<this.queue.length;n++)if(this.queue[n]===t){this.queue.splice(n,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,n){if(n?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Jd;let s=new sm(t,n);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(n).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===s){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Us)}),this.clear()}async onEmpty(t){this.size!==0&&await Su(this,"empty",t)}async onSizeLessThan(t,n){this.size<t||await Su(this,"next",{...n,filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Su(this,"idle",t)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let n=We({objectMode:!0}),s=u=>{u!=null?this.abort():this.clear(),n.end(u)},o=u=>{u.detail!=null&&n.push(u.detail)},i=u=>{s(u.detail.error)},a=()=>{s()},c=()=>{s(new Us("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("failure",i),this.addEventListener("idle",a),t?.signal?.addEventListener("abort",c);try{yield*n}finally{this.removeEventListener("completed",o),this.removeEventListener("failure",i),this.removeEventListener("idle",a),t?.signal?.removeEventListener("abort",c),s()}}};function At(r){let e=new globalThis.AbortController;function t(){let o=r.filter(i=>i?.aborted===!0).map(i=>i?.reason).pop();e.abort(o);for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let o of r){if(o?.aborted===!0){t();break}o?.addEventListener!=null&&o.addEventListener("abort",t)}function n(){for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}let s=e.signal;return s.clear=n,s}var Au=class{constructor(e){l(this,"movingAverage");l(this,"variance");l(this,"deviation");l(this,"forecast");l(this,"timeSpan");l(this,"previousTime");this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),s=e-this.movingAverage,o=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*o),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}};var Z$=1.2,X$=2,j$=5e3,Q$=6e4,J$=5e3,om=class{constructor(e={}){l(this,"success");l(this,"failure");l(this,"next");l(this,"metric");l(this,"timeoutMultiplier");l(this,"failureMultiplier");l(this,"minTimeout");l(this,"maxTimeout");let t=e.interval??J$;this.success=new Au(t),this.failure=new Au(t),this.next=new Au(t),this.failureMultiplier=e.failureMultiplier??X$,this.timeoutMultiplier=e.timeoutMultiplier??Z$,this.minTimeout=e.minTimeout??j$,this.maxTimeout=e.maxTimeout??Q$,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);let n=AbortSignal.timeout(t),s=At([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};function eG(r){return r.reason}async function dR(r,e,t){if(e==null)return r;let n=t?.translateError??eG;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((o,i)=>{s=()=>{i(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}var Kb=class{constructor(){l(this,"readNext");l(this,"haveNext");l(this,"ended");l(this,"nextResult");l(this,"error");this.ended=!1,this.readNext=ue(),this.haveNext=ue()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ue(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ue(),await dR(this.readNext.promise,t?.signal,t)}};function pR(){return new Kb}function tG(r){return r[Symbol.asyncIterator]!=null}async function rG(r,e,t){try{await Promise.all(r.map(async n=>{for await(let s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*nG(r){let e=new AbortController,t=pR();rG(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*sG(r){for(let e of r)yield*e}function oG(...r){let e=[];for(let t of r)tG(t)||e.push(t);return e.length===r.length?sG(e):nG(r)}var Bo=oG;function at(r,...e){if(r==null)throw new Error("Empty pipeline");if(Fb(r)){let n=r;r=()=>n.source}else if(gR(r)||mR(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&Fb(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Fb(t[n])&&(t[n]=aG(t[n]));return iG(...t)}var iG=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},mR=r=>r?.[Symbol.asyncIterator]!=null,gR=r=>r?.[Symbol.iterator]!=null,Fb=r=>r==null?!1:r.sink!=null&&r.source!=null,aG=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=We({objectMode:!0});t.then(()=>{n.end()},i=>{n.end(i)});let s,o=r.source;if(mR(o))s=async function*(){yield*o,n.end()};else if(gR(o))s=function*(){yield*o,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Bo(n,s())}return r.source};var cG=4194304,e0=class extends Error{constructor(){super(...arguments);l(this,"name","UnwrappedError")}};l(e0,"name","UnwrappedError");var Hb=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MSG_LENGTH")}},qb=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthError");l(this,"code","ERR_MSG_DATA_TOO_LONG")}},zb=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthLengthError");l(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function lG(r){return typeof r?.closeRead=="function"}function uG(r){return typeof r?.close=="function"}function Vb(r){return lG(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:uG(r)?r.status!=="open":!1}function fG(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function $b(r,e){let t=e?.maxBufferSize??cG,n=new Z,s,o=!1;if(!fG(r))throw new Tc("Argument should be a Stream or a Multiaddr");let i=f=>{if(n.append(f.data),n.byteLength>t){let h=n.byteLength;n.consume(n.byteLength),s?.reject(new Error(`Read buffer overflow - ${h} > ${t}`))}s?.resolve()};r.addEventListener("message",i);let a=f=>{f.error!=null?s?.reject(f.error):s?.resolve()};r.addEventListener("close",a);let c=()=>{s?.resolve()};r.addEventListener("remoteCloseWrite",c);let u={readBuffer:n,async read(f){if(o===!0)throw new e0("Stream was unwrapped");if(Vb(r)){if(f?.bytes==null)return null;if(n.byteLength<f.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,f.bytes),new Ji(`Unexpected EOF - stream closed after reading ${n.byteLength}/${f.bytes} bytes`)}let h=f?.bytes??1;for(s=Promise.withResolvers();;){if(n.byteLength>=h){s.resolve();break}if(await rm(s.promise,f?.signal),Vb(r)){if(n.byteLength===0&&f?.bytes==null)return null;break}s=Promise.withResolvers()}let d=f?.bytes??n.byteLength;if(n.byteLength<d){if(Vb(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,d),new Ji(`Unexpected EOF - stream closed while reading ${n.byteLength}/${d} bytes`);return u.read(f)}let p=n.sublist(0,d);return n.consume(d),p},async write(f,h){if(o===!0)throw new e0("Stream was unwrapped");r.send(f)||await Su(r,"drain",{signal:h?.signal,rejectionEvents:["close"]})},unwrap(){return o||(o=!0,r.removeEventListener("message",i),r.removeEventListener("close",a),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return u}function im(r,e={}){let t=$b(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=ce(e.maxDataLength));let n=e?.lengthDecoder??Nt,s=e?.lengthEncoder??je;return{async read(i){let a=-1,c=new Z;for(;;){let f=await t.read({...i,bytes:1});if(f==null)break;c.append(f);try{a=n(c)}catch(h){if(h instanceof RangeError)continue;throw h}if(a<0)throw new Hb("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new zb(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new qb(`Message length too long - ${a} > ${e.maxDataLength}`);let u=await t.read({...i,bytes:a});if(u==null)throw r.log.error("tried to read %d bytes but the stream closed",a),new Ji(`Unexpected EOF - tried to read ${a} bytes but the stream closed`);if(u.byteLength!==a)throw r.log.error("read %d/%d bytes before the stream closed",u.byteLength,a),new Ji(`Unexpected EOF - read ${u.byteLength}/${a} bytes before the stream closed`);return u},async write(i,a){await t.write(new Z(s(i.byteLength),i),a)},async writeV(i,a){let c=new Z(...i.flatMap(u=>[s(u.byteLength),u]));await t.write(c,a)},unwrap(){return t.unwrap()}}}var am=class extends _u{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var cm=class extends _u{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};var lm=class{constructor(e={}){l(this,"memoryStorage");l(this,"points");l(this,"duration");l(this,"blockDuration");l(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new Gb}consume(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,t,o);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+t&&(i=this.memoryStorage.set(s,i.consumedPoints,this.blockDuration)),new tm("Rate limit exceeded",i);return i}penalty(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,t,o);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,-t,o);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(e,t){let n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){let s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},Gb=class{constructor(){l(this,"storage");this.storage=new Map}incrby(e,t,n){let s=this.storage.get(e);if(s!=null){let o=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||o>0?(s.value+=t,{remainingPoints:0,msBeforeNext:o,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let s=n*1e3,o=this.storage.get(e);o!=null&&clearTimeout(o.timeoutId);let i={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,i),s>0&&(i.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),i.timeoutId.unref!=null&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:i.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};var Wb=class extends Map{constructor(t){super();l(this,"metric");let{name:n,metrics:s}=t;this.metric=s.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){let n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function xr(r){let{name:e,metrics:t}=r,n;return t!=null?n=new Wb({name:e,metrics:t}):n=new Map,n}var Be=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};l(Be,"name","InvalidParametersError");var kc=class extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}};l(kc,"name","InvalidPublicKeyError");var Iu=class extends Error{constructor(e="Not found"){super(e),this.name="NotFoundError"}};l(Iu,"name","NotFoundError");var t0=class extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}};l(t0,"name","InvalidCIDError");var r0=class extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};l(r0,"name","InvalidMultihashError");var ea=class extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};l(ea,"name","UnsupportedKeyTypeError");var um=Symbol.for("@libp2p/peer-id");function Tu(r){return!!r?.[um]}var hG=parseInt("11111",2),Yb=parseInt("10000000",2),dG=parseInt("01111111",2),yR={0:n0,1:n0,2:pG,3:yG,4:bG,5:gG,6:mG,16:n0,22:n0,48:n0};function Po(r,e={offset:0}){let t=r[e.offset]&hG;if(e.offset++,yR[t]!=null)return yR[t](r,e);throw new Error("No decoder for tag "+t)}function s0(r,e){let t=0;if((r[e.offset]&Yb)===Yb){let n=r[e.offset]&dG,s="0x";e.offset++;for(let o=0;o<n;o++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function n0(r,e){s0(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=Po(r,e);if(n===null)break;t.push(n)}return t}function pG(r,e){let t=s0(r,e),n=e.offset,s=e.offset+t,o=[];for(let i=n;i<s;i++)i===n&&r[i]===0||o.push(r[i]);return e.offset+=t,Uint8Array.from(o)}function mG(r,e){let t=s0(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let o=0,i=0;s<40?(o=0,i=s):s<80?(o=1,i=s-40):(o=2,i=s-80);let a=`${o}.${i}`,c=[];for(;e.offset<n;){let u=r[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let f=0;for(let h=0;h<c.length;h++)f+=c[h]<<h*7;a+=`.${f}`,c=[]}}return a}function gG(r,e){return e.offset++,null}function yG(r,e){let t=s0(r,e),n=r[e.offset];e.offset++;let s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function bG(r,e){let t=s0(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function wG(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new Z;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Zb(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=wG(r.byteLength);return new Z(Uint8Array.from([e.byteLength|Yb]),e)}function nn(r){let e=new Z,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Z(Uint8Array.from([2]),Zb(e),e)}function fm(r){let e=Uint8Array.from([0]),t=new Z(e,r);return new Z(Uint8Array.from([3]),Zb(t),t)}function ta(r,e=48){let t=new Z;for(let n of r)t.append(n);return new Z(Uint8Array.from([e]),Zb(t),t)}async function bR(r,e,t,n){let s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let o=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),o}var xG=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),EG=Uint8Array.from([6,5,43,129,4,0,34]),vG=Uint8Array.from([6,5,43,129,4,0,35]),SG={ext:!0,kty:"EC",crv:"P-256"},_G={ext:!0,kty:"EC",crv:"P-384"},AG={ext:!0,kty:"EC",crv:"P-521"},Xb=32,jb=48,Qb=66;function Jb(r){let e=Po(r);return wR(e)}function wR(r){let e=r[1][1][0],t=1,n,s;if(e.byteLength===Xb*2+1)return n=z(e.subarray(t,t+Xb),"base64url"),s=z(e.subarray(t+Xb),"base64url"),new Ru({...SG,key_ops:["verify"],x:n,y:s});if(e.byteLength===jb*2+1)return n=z(e.subarray(t,t+jb),"base64url"),s=z(e.subarray(t+jb),"base64url"),new Ru({..._G,key_ops:["verify"],x:n,y:s});if(e.byteLength===Qb*2+1)return n=z(e.subarray(t,t+Qb),"base64url"),s=z(e.subarray(t+Qb),"base64url"),new Ru({...AG,key_ops:["verify"],x:n,y:s});throw new Be(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function xR(r){return ta([nn(Uint8Array.from([1])),ta([IG(r.crv)],160),ta([fm(new Z(Uint8Array.from([4]),H(r.x??"","base64url"),H(r.y??"","base64url")))],161)]).subarray()}function IG(r){if(r==="P-256")return xG;if(r==="P-384")return EG;if(r==="P-521")return vG;throw new Be(`Invalid curve ${r}`)}var Ru=class{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=xR(this.jwk)),this._raw}toMultihash(){return ge.digest(On(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}async verify(e,t,n){return bR(this.jwk,t,e,n)}};function Nc(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Ks(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function _e(r,e,t=""){let n=Nc(r),s=r?.length,o=e!==void 0;if(!n||o&&s!==e){let i=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return r}function hm(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Ks(r.outputLen),Ks(r.blockLen)}function Cu(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function vR(r,e){_e(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function ko(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function dm(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function cs(r,e){return r<<32-e|r>>>e}var SR=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",TG=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function No(r){if(_e(r),SR)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=TG[r[t]];return e}var Lo={_0:48,_9:57,A:65,F:70,a:97,f:102};function ER(r){if(r>=Lo._0&&r<=Lo._9)return r-Lo._0;if(r>=Lo.A&&r<=Lo.F)return r-(Lo.A-10);if(r>=Lo.a&&r<=Lo.f)return r-(Lo.a-10)}function Oo(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(SR)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let s=0,o=0;s<t;s++,o+=2){let i=ER(r.charCodeAt(o)),a=ER(r.charCodeAt(o+1));if(i===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}function sn(...r){let e=0;for(let n=0;n<r.length;n++){let s=r[n];_e(s),e+=s.length}let t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let o=r[n];t.set(o,s),s+=o.length}return t}function e7(r,e={}){let t=(s,o)=>r(o).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Du(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var t7=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function _R(r,e,t){return r&e^~r&t}function AR(r,e,t){return r&e^r&t^e&t}var o0=class{constructor(e,t,n,s){l(this,"blockLen");l(this,"outputLen");l(this,"padOffset");l(this,"isLE");l(this,"buffer");l(this,"view");l(this,"finished",!1);l(this,"length",0);l(this,"pos",0);l(this,"destroyed",!1);this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=dm(this.buffer)}update(e){Cu(this),_e(e);let{view:t,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=dm(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Cu(this),vR(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;t[i++]=128,ko(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let h=i;h<s;h++)t[h]=0;n.setBigUint64(s-8,BigInt(this.length*8),o),this.process(n,0);let a=dm(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let u=c/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)a.setUint32(4*h,f[h],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Mo=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var cr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var pm=BigInt(4294967295),IR=BigInt(32);function RG(r,e=!1){return e?{h:Number(r&pm),l:Number(r>>IR&pm)}:{h:Number(r>>IR&pm)|0,l:Number(r&pm)|0}}function TR(r,e=!1){let t=r.length,n=new Uint32Array(t),s=new Uint32Array(t);for(let o=0;o<t;o++){let{h:i,l:a}=RG(r[o],e);[n[o],s[o]]=[i,a]}return[n,s]}var r7=(r,e,t)=>r>>>t,n7=(r,e,t)=>r<<32-t|e>>>t,Oc=(r,e,t)=>r>>>t|e<<32-t,Mc=(r,e,t)=>r<<32-t|e>>>t,i0=(r,e,t)=>r<<64-t|e>>>t-32,a0=(r,e,t)=>r>>>t-32|e<<64-t;function Fs(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var RR=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),CR=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,DR=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),BR=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,PR=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),LR=(r,e,t,n,s,o)=>e+t+n+s+o+(r/2**32|0)|0;var DG=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ra=new Uint32Array(64),s7=class extends o0{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)ra[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){let d=ra[h-15],p=ra[h-2],y=cs(d,7)^cs(d,18)^d>>>3,x=cs(p,17)^cs(p,19)^p>>>10;ra[h]=x+ra[h-7]+y+ra[h-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:u,H:f}=this;for(let h=0;h<64;h++){let d=cs(a,6)^cs(a,11)^cs(a,25),p=f+d+_R(a,c,u)+DG[h]+ra[h]|0,x=(cs(n,2)^cs(n,13)^cs(n,22))+AR(n,s,o)|0;f=u,u=c,c=a,a=i+p|0,i=o,o=s,s=n,n=p+x|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(n,s,o,i,a,c,u,f)}roundClean(){ko(ra)}destroy(){this.set(0,0,0,0,0,0,0,0),ko(this.buffer)}},o7=class extends s7{constructor(){super(32);l(this,"A",Mo[0]|0);l(this,"B",Mo[1]|0);l(this,"C",Mo[2]|0);l(this,"D",Mo[3]|0);l(this,"E",Mo[4]|0);l(this,"F",Mo[5]|0);l(this,"G",Mo[6]|0);l(this,"H",Mo[7]|0)}};var kR=TR(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),BG=kR[0],PG=kR[1],na=new Uint32Array(80),sa=new Uint32Array(80),i7=class extends o0{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:u,El:f,Fh:h,Fl:d,Gh:p,Gl:y,Hh:x,Hl:b}=this;return[e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b]}set(e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=f|0,this.Fh=h|0,this.Fl=d|0,this.Gh=p|0,this.Gl=y|0,this.Hh=x|0,this.Hl=b|0}process(e,t){for(let w=0;w<16;w++,t+=4)na[w]=e.getUint32(t),sa[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){let R=na[w-15]|0,N=sa[w-15]|0,O=Oc(R,N,1)^Oc(R,N,8)^r7(R,N,7),F=Mc(R,N,1)^Mc(R,N,8)^n7(R,N,7),A=na[w-2]|0,E=sa[w-2]|0,L=Oc(A,E,19)^i0(A,E,61)^r7(A,E,6),U=Mc(A,E,19)^a0(A,E,61)^n7(A,E,6),B=DR(F,U,sa[w-7],sa[w-16]),I=BR(B,O,L,na[w-7],na[w-16]);na[w]=I|0,sa[w]=B|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:u,Dl:f,Eh:h,El:d,Fh:p,Fl:y,Gh:x,Gl:b,Hh:_,Hl:v}=this;for(let w=0;w<80;w++){let R=Oc(h,d,14)^Oc(h,d,18)^i0(h,d,41),N=Mc(h,d,14)^Mc(h,d,18)^a0(h,d,41),O=h&p^~h&x,F=d&y^~d&b,A=PR(v,N,F,PG[w],sa[w]),E=LR(A,_,R,O,BG[w],na[w]),L=A|0,U=Oc(n,s,28)^i0(n,s,34)^i0(n,s,39),B=Mc(n,s,28)^a0(n,s,34)^a0(n,s,39),I=n&o^n&a^o&a,g=s&i^s&c^i&c;_=x|0,v=b|0,x=p|0,b=y|0,p=h|0,y=d|0,{h,l:d}=Fs(u|0,f|0,E|0,L|0),u=a|0,f=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let m=RR(L,B,g);n=CR(m,E,U,I),s=m|0}({h:n,l:s}=Fs(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=Fs(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=Fs(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l:f}=Fs(this.Dh|0,this.Dl|0,u|0,f|0),{h,l:d}=Fs(this.Eh|0,this.El|0,h|0,d|0),{h:p,l:y}=Fs(this.Fh|0,this.Fl|0,p|0,y|0),{h:x,l:b}=Fs(this.Gh|0,this.Gl|0,x|0,b|0),{h:_,l:v}=Fs(this.Hh|0,this.Hl|0,_|0,v|0),this.set(n,s,o,i,a,c,u,f,h,d,p,y,x,b,_,v)}roundClean(){ko(na,sa)}destroy(){ko(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},a7=class extends i7{constructor(){super(64);l(this,"Ah",cr[0]|0);l(this,"Al",cr[1]|0);l(this,"Bh",cr[2]|0);l(this,"Bl",cr[3]|0);l(this,"Ch",cr[4]|0);l(this,"Cl",cr[5]|0);l(this,"Dh",cr[6]|0);l(this,"Dl",cr[7]|0);l(this,"Eh",cr[8]|0);l(this,"El",cr[9]|0);l(this,"Fh",cr[10]|0);l(this,"Fl",cr[11]|0);l(this,"Gh",cr[12]|0);l(this,"Gl",cr[13]|0);l(this,"Hh",cr[14]|0);l(this,"Hl",cr[15]|0)}};var Bu=e7(()=>new o7,t7(1));var NR=e7(()=>new a7,t7(3));var l7=BigInt(0),c7=BigInt(1);function Uo(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function OR(r){if(typeof r=="bigint"){if(!mm(r))throw new Error("positive bigint expected, got "+r)}else Ks(r);return r}function c0(r){let e=OR(r).toString(16);return e.length&1?"0"+e:e}function MR(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?l7:BigInt("0x"+r)}function Pu(r){return MR(No(r))}function Uc(r){return MR(No(ym(_e(r)).reverse()))}function gm(r,e){Ks(e),r=OR(r);let t=Oo(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function u7(r,e){return gm(r,e).reverse()}function ym(r){return Uint8Array.from(r)}var mm=r=>typeof r=="bigint"&&l7<=r;function LG(r,e,t){return mm(r)&&mm(e)&&mm(t)&&e<=r&&r<t}function l0(r,e,t,n){if(!LG(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function f7(r){let e;for(e=0;r>l7;r>>=c7,e+=1);return e}var u0=r=>(c7<<BigInt(r))-c7;function UR(r,e,t){if(Ks(r,"hashLen"),Ks(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=b=>new Uint8Array(b),s=Uint8Array.of(),o=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=n(r),u=n(r),f=0,h=()=>{c.fill(1),u.fill(0),f=0},d=(...b)=>t(u,sn(c,...b)),p=(b=s)=>{u=d(o,b),c=d(),b.length!==0&&(u=d(i,b),c=d())},y=()=>{if(f++>=a)throw new Error("drbg: tried max amount of iterations");let b=0,_=[];for(;b<e;){c=d();let v=c.slice();_.push(v),b+=c.length}return sn(..._)};return(b,_)=>{h(),p(b);let v;for(;!(v=_(y()));)p();return h(),v}}function oa(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,i,a){let c=r[o];if(a&&c===void 0)return;let u=typeof c;if(u!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${u}`)}let s=(o,i)=>Object.entries(o).forEach(([a,c])=>n(a,c,i));s(e,!1),s(t,!0)}function Lu(r){let e=new WeakMap;return(t,...n)=>{let s=e.get(t);if(s!==void 0)return s;let o=r(t,...n);return e.set(t,o),o}}var kr=BigInt(0),Ft=BigInt(1),Kc=BigInt(2),VR=BigInt(3),HR=BigInt(4),qR=BigInt(5),kG=BigInt(7),zR=BigInt(8),NG=BigInt(9),$R=BigInt(16);function It(r,e){let t=r%e;return t>=kr?t:e+t}function ct(r,e,t){let n=r;for(;e-- >kr;)n*=n,n%=t;return n}function KR(r,e){if(r===kr)throw new Error("invert: expected non-zero number");if(e<=kr)throw new Error("invert: expected positive modulus, got "+e);let t=It(r,e),n=e,s=kr,o=Ft,i=Ft,a=kr;for(;t!==kr;){let u=n/t,f=n%t,h=s-i*u,d=o-a*u;n=t,t=f,s=i,o=a,i=h,a=d}if(n!==Ft)throw new Error("invert: does not exist");return It(s,e)}function d7(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function GR(r,e){let t=(r.ORDER+Ft)/HR,n=r.pow(e,t);return d7(r,n,e),n}function OG(r,e){let t=(r.ORDER-qR)/zR,n=r.mul(e,Kc),s=r.pow(n,t),o=r.mul(e,s),i=r.mul(r.mul(o,Kc),s),a=r.mul(o,r.sub(i,r.ONE));return d7(r,a,e),a}function MG(r){let e=ku(r),t=WR(r),n=t(e,e.neg(e.ONE)),s=t(e,n),o=t(e,e.neg(n)),i=(r+kG)/$R;return(a,c)=>{let u=a.pow(c,i),f=a.mul(u,n),h=a.mul(u,s),d=a.mul(u,o),p=a.eql(a.sqr(f),c),y=a.eql(a.sqr(h),c);u=a.cmov(u,f,p),f=a.cmov(d,h,y);let x=a.eql(a.sqr(f),c),b=a.cmov(u,f,x);return d7(a,b,c),b}}function WR(r){if(r<VR)throw new Error("sqrt is not defined for small field");let e=r-Ft,t=0;for(;e%Kc===kr;)e/=Kc,t++;let n=Kc,s=ku(r);for(;FR(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return GR;let o=s.pow(n,e),i=(e+Ft)/Kc;return function(c,u){if(c.is0(u))return u;if(FR(c,u)!==1)throw new Error("Cannot find square root");let f=t,h=c.mul(c.ONE,o),d=c.pow(u,e),p=c.pow(u,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let y=1,x=c.sqr(d);for(;!c.eql(x,c.ONE);)if(y++,x=c.sqr(x),y===f)throw new Error("Cannot find square root");let b=Ft<<BigInt(f-y-1),_=c.pow(h,b);f=y,h=c.sqr(_),d=c.mul(d,h),p=c.mul(p,_)}return p}}function UG(r){return r%HR===VR?GR:r%zR===qR?OG:r%$R===NG?MG(r):WR(r)}var YR=(r,e)=>(It(r,e)&Ft)===Ft,KG=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function p7(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=KG.reduce((n,s)=>(n[s]="function",n),e);return oa(r,t),r}function FG(r,e,t){if(t<kr)throw new Error("invalid exponent, negatives unsupported");if(t===kr)return r.ONE;if(t===Ft)return e;let n=r.ONE,s=e;for(;t>kr;)t&Ft&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Ft;return n}function f0(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),o=r.inv(s);return e.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),o),n}function FR(r,e){let t=(r.ORDER-Ft)/Kc,n=r.pow(e,t),s=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function VG(r,e){e!==void 0&&Ks(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var h7=class{constructor(e,t={}){l(this,"ORDER");l(this,"BITS");l(this,"BYTES");l(this,"isLE");l(this,"ZERO",kr);l(this,"ONE",Ft);l(this,"_lengths");l(this,"_sqrt");l(this,"_mod");if(e<=kr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:s,nByteLength:o}=VG(e,n);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return It(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return kr<=e&&e<this.ORDER}is0(e){return e===kr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Ft)===Ft}neg(e){return It(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return It(e*e,this.ORDER)}add(e,t){return It(e+t,this.ORDER)}sub(e,t){return It(e-t,this.ORDER)}mul(e,t){return It(e*t,this.ORDER)}pow(e,t){return FG(this,e,t)}div(e,t){return It(e*KR(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return KR(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=UG(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?u7(e,this.BYTES):gm(e,this.BYTES)}fromBytes(e,t=!1){_e(e);let{_lengths:n,BYTES:s,isLE:o,ORDER:i,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let u=new Uint8Array(s);u.set(e,o?0:u.length-e.length),e=u}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=o?Uc(e):Pu(e);if(a&&(c=It(c,i)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return f0(this,e)}cmov(e,t,n){return n?t:e}};function ku(r,e={}){return new h7(r,e)}function ZR(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function m7(r){let e=ZR(r);return e+Math.ceil(e/2)}function g7(r,e,t=!1){_e(r);let n=r.length,s=ZR(e),o=m7(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let i=t?Uc(r):Pu(r),a=It(i,e-Ft)+Ft;return t?u7(a,s):gm(a,s)}var Nu=BigInt(0),Fc=BigInt(1);function h0(r,e){let t=e.negate();return r?t:e}function Vc(r,e){let t=f0(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function JR(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function y7(r,e){JR(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,o=u0(r),i=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function XR(r,e,t){let{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=t,a=Number(r&s),c=r>>i;a>n&&(a-=o,c+=Fc);let u=e*n,f=u+Math.abs(a)-1,h=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:f,isZero:h,isNeg:d,isNegF:p,offsetF:u}}var b7=new WeakMap,eC=new WeakMap;function w7(r){return eC.get(r)||1}function jR(r){if(r!==Nu)throw new Error("invalid wNAF")}var Ou=class{constructor(e,t){l(this,"BASE");l(this,"ZERO");l(this,"Fn");l(this,"bits");this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>Nu;)t&Fc&&(n=n.add(s)),s=s.double(),t>>=Fc;return n}precomputeWindow(e,t){let{windows:n,windowSize:s}=y7(t,this.bits),o=[],i=e,a=i;for(let c=0;c<n;c++){a=i,o.push(a);for(let u=1;u<s;u++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=y7(e,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:p}=XR(n,a,i);n=c,f?o=o.add(h0(d,t[p])):s=s.add(h0(h,t[u]))}return jR(n),{p:s,f:o}}wNAFUnsafe(e,t,n,s=this.ZERO){let o=y7(e,this.bits);for(let i=0;i<o.windows&&n!==Nu;i++){let{nextN:a,offset:c,isZero:u,isNeg:f}=XR(n,i,o);if(n=a,!u){let h=t[c];s=s.add(f?h.negate():h)}}return jR(n),s}getPrecomputes(e,t,n){let s=b7.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),b7.set(t,s))),s}cached(e,t,n){let s=w7(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){let o=w7(e);return o===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),t,s)}createCache(e,t){JR(t,this.bits),eC.set(e,t),b7.delete(e)}hasCache(e){return w7(e)!==1}};function tC(r,e,t,n){let s=e,o=r.ZERO,i=r.ZERO;for(;t>Nu||n>Nu;)t&Fc&&(o=o.add(s)),n&Fc&&(i=i.add(s)),s=s.double(),t>>=Fc,n>>=Fc;return{p1:o,p2:i}}function QR(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return p7(e),e}else return ku(r,{isLE:t})}function bm(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let u=e[c];if(!(typeof u=="bigint"&&u>Nu))throw new Error(`CURVE.${c} must be positive bigint`)}let s=QR(e.p,t.Fp,n),o=QR(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}function wm(r,e){return function(n){let s=r(n);return{secretKey:s,publicKey:e(s)}}}var ia=BigInt(0),Vt=BigInt(1),x7=BigInt(2),HG=BigInt(8);function qG(r,e,t,n){let s=r.sqr(t),o=r.sqr(n),i=r.add(r.mul(e.a,s),o),a=r.add(r.ONE,r.mul(e.d,r.mul(s,o)));return r.eql(i,a)}function rC(r,e={}){let t=bm("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i}=o;oa(e,{},{uvRatio:"function"});let a=x7<<BigInt(s.BYTES*8)-Vt,c=_=>n.create(_),u=e.uvRatio||((_,v)=>{try{return{isValid:!0,value:n.sqrt(n.div(_,v))}}catch{return{isValid:!1,value:ia}}});if(!qG(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function f(_,v,w=!1){let R=w?Vt:ia;return l0("coordinate "+_,v,R,a),v}function h(_){if(!(_ instanceof y))throw new Error("EdwardsPoint expected")}let d=Lu((_,v)=>{let{X:w,Y:R,Z:N}=_,O=_.is0();v==null&&(v=O?HG:n.inv(N));let F=c(w*v),A=c(R*v),E=n.mul(N,v);if(O)return{x:ia,y:Vt};if(E!==Vt)throw new Error("invZ was invalid");return{x:F,y:A}}),p=Lu(_=>{let{a:v,d:w}=o;if(_.is0())throw new Error("bad point: ZERO");let{X:R,Y:N,Z:O,T:F}=_,A=c(R*R),E=c(N*N),L=c(O*O),U=c(L*L),B=c(A*v),I=c(L*c(B+E)),g=c(U+c(w*c(A*E)));if(I!==g)throw new Error("bad point: equation left != right (1)");let m=c(R*N),S=c(O*F);if(m!==S)throw new Error("bad point: equation left != right (2)");return!0}),b=class b{constructor(v,w,R,N){l(this,"X");l(this,"Y");l(this,"Z");l(this,"T");this.X=f("x",v),this.Y=f("y",w),this.Z=f("z",R,!0),this.T=f("t",N),Object.freeze(this)}static CURVE(){return o}static fromAffine(v){if(v instanceof b)throw new Error("extended point not allowed");let{x:w,y:R}=v||{};return f("x",w),f("y",R),new b(w,R,Vt,c(w*R))}static fromBytes(v,w=!1){let R=n.BYTES,{a:N,d:O}=o;v=ym(_e(v,R,"point")),Uo(w,"zip215");let F=ym(v),A=v[R-1];F[R-1]=A&-129;let E=Uc(F),L=w?a:n.ORDER;l0("point.y",E,ia,L);let U=c(E*E),B=c(U-Vt),I=c(O*U-N),{isValid:g,value:m}=u(B,I);if(!g)throw new Error("bad point: invalid y coordinate");let S=(m&Vt)===Vt,T=(A&128)!==0;if(!w&&m===ia&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(m=c(-m)),b.fromAffine({x:m,y:E})}static fromHex(v,w=!1){return b.fromBytes(Oo(v),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(v=8,w=!0){return x.createCache(this,v),w||this.multiply(x7),this}assertValidity(){p(this)}equals(v){h(v);let{X:w,Y:R,Z:N}=this,{X:O,Y:F,Z:A}=v,E=c(w*A),L=c(O*N),U=c(R*A),B=c(F*N);return E===L&&U===B}is0(){return this.equals(b.ZERO)}negate(){return new b(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:v}=o,{X:w,Y:R,Z:N}=this,O=c(w*w),F=c(R*R),A=c(x7*c(N*N)),E=c(v*O),L=w+R,U=c(c(L*L)-O-F),B=E+F,I=B-A,g=E-F,m=c(U*I),S=c(B*g),T=c(U*g),P=c(I*B);return new b(m,S,P,T)}add(v){h(v);let{a:w,d:R}=o,{X:N,Y:O,Z:F,T:A}=this,{X:E,Y:L,Z:U,T:B}=v,I=c(N*E),g=c(O*L),m=c(A*R*B),S=c(F*U),T=c((N+O)*(E+L)-I-g),P=S-m,C=S+m,k=c(g-w*I),D=c(T*P),M=c(C*k),q=c(T*k),W=c(P*C);return new b(D,M,W,q)}subtract(v){return this.add(v.negate())}multiply(v){if(!s.isValidNot0(v))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:w,f:R}=x.cached(this,v,N=>Vc(b,N));return Vc(b,[w,R])[0]}multiplyUnsafe(v,w=b.ZERO){if(!s.isValid(v))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return v===ia?b.ZERO:this.is0()||v===Vt?this:x.unsafe(this,v,R=>Vc(b,R),w)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return x.unsafe(this,o.n).is0()}toAffine(v){return d(this,v)}clearCofactor(){return i===Vt?this:this.multiplyUnsafe(i)}toBytes(){let{x:v,y:w}=this.toAffine(),R=n.toBytes(w);return R[R.length-1]|=v&Vt?128:0,R}toHex(){return No(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(b,"BASE",new b(o.Gx,o.Gy,Vt,c(o.Gx*o.Gy))),l(b,"ZERO",new b(ia,Vt,Vt,ia)),l(b,"Fp",n),l(b,"Fn",s);let y=b,x=new Ou(y,s.BITS);return y.BASE.precompute(8),y}function nC(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');oa(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:s,Fp:o,Fn:i}=r,a=t.randomBytes||Du,c=t.adjustScalarBytes||(A=>A),u=t.domain||((A,E,L)=>{if(Uo(L,"phflag"),E.length||L)throw new Error("Contexts/pre-hash are not supported");return A});function f(A){return i.create(Uc(A))}function h(A){let E=w.secretKey;_e(A,w.secretKey,"secretKey");let L=_e(e(A),2*E,"hashedSecretKey"),U=c(L.slice(0,E)),B=L.slice(E,2*E),I=f(U);return{head:U,prefix:B,scalar:I}}function d(A){let{head:E,prefix:L,scalar:U}=h(A),B=s.multiply(U),I=B.toBytes();return{head:E,prefix:L,scalar:U,point:B,pointBytes:I}}function p(A){return d(A).pointBytes}function y(A=Uint8Array.of(),...E){let L=sn(...E);return f(e(u(L,_e(A,void 0,"context"),!!n)))}function x(A,E,L={}){A=_e(A,void 0,"message"),n&&(A=n(A));let{prefix:U,scalar:B,pointBytes:I}=d(E),g=y(L.context,U,A),m=s.multiply(g).toBytes(),S=y(L.context,m,I,A),T=i.create(g+S*B);if(!i.isValid(T))throw new Error("sign failed: invalid s");let P=sn(m,i.toBytes(T));return _e(P,w.signature,"result")}let b={zip215:!0};function _(A,E,L,U=b){let{context:B,zip215:I}=U,g=w.signature;A=_e(A,g,"signature"),E=_e(E,void 0,"message"),L=_e(L,w.publicKey,"publicKey"),I!==void 0&&Uo(I,"zip215"),n&&(E=n(E));let m=g/2,S=A.subarray(0,m),T=Uc(A.subarray(m,g)),P,C,k;try{P=r.fromBytes(L,I),C=r.fromBytes(S,I),k=s.multiplyUnsafe(T)}catch{return!1}if(!I&&P.isSmallOrder())return!1;let D=y(B,C.toBytes(),P.toBytes(),E);return C.add(P.multiplyUnsafe(D)).subtract(k).clearCofactor().is0()}let v=o.BYTES,w={secretKey:v,publicKey:v,signature:2*v,seed:v};function R(A=a(w.seed)){return _e(A,w.seed,"seed")}function N(A){return Nc(A)&&A.length===i.BYTES}function O(A,E){try{return!!r.fromBytes(A,E)}catch{return!1}}let F={getExtendedPublicKey:d,randomSecretKey:R,isValidSecretKey:N,isValidPublicKey:O,toMontgomery(A){let{y:E}=r.fromBytes(A),L=w.publicKey,U=L===32;if(!U&&L!==57)throw new Error("only defined for 25519 and 448");let B=U?o.div(Vt+E,Vt-E):o.div(E-Vt,E+Vt);return o.toBytes(B)},toMontgomerySecret(A){let E=w.secretKey;_e(A,E);let L=e(A.subarray(0,E));return c(L).subarray(0,E)}};return Object.freeze({keygen:wm(R,p),getPublicKey:p,sign:x,verify:_,utils:F,Point:r,lengths:w})}var zG=BigInt(1),sC=BigInt(2);var $G=BigInt(5),GG=BigInt(8),E7=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),WG={p:E7,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:GG,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function YG(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),o=E7,a=r*r%o*r%o,c=ct(a,sC,o)*a%o,u=ct(c,zG,o)*r%o,f=ct(u,$G,o)*u%o,h=ct(f,e,o)*f%o,d=ct(h,t,o)*h%o,p=ct(d,n,o)*d%o,y=ct(p,s,o)*p%o,x=ct(y,s,o)*p%o,b=ct(x,e,o)*f%o;return{pow_p_5_8:ct(b,sC,o)*r%o,b2:a}}function ZG(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var oC=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function XG(r,e){let t=E7,n=It(e*e*e,t),s=It(n*n*e,t),o=YG(r*s).pow_p_5_8,i=It(r*n*o,t),a=It(e*i*i,t),c=i,u=It(i*oC,t),f=a===r,h=a===It(-r,t),d=a===It(-r*oC,t);return f&&(i=c),(h||d)&&(i=u),YR(i,t)&&(i=It(-i,t)),{isValid:f||h,value:i}}var jG=rC(WG,{uvRatio:XG});function QG(r){return nC(jG,NR,Object.assign({adjustScalarBytes:ZG},r))}var iC=QG({});var d0=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},xm=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var aC={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new xm("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var Mn=aC;var Em=32;var v7,JG=(async()=>{try{return await Mn.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function eW(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await Mn.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Mn.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function tW(r,e,t){return iC.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function cC(r,e,t){return v7==null&&(v7=await JG),v7?eW(r,e,t):tW(r,e,t)}function vm(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Sm=class{constructor(e){l(this,"type","Ed25519");l(this,"raw");this.raw=S7(e,Em)}toMultihash(){return ge.digest(On(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let s=cC(this.raw,t,e);return vm(s)?s.then(o=>(n?.signal?.throwIfAborted(),o)):s}};function _7(r){return r=S7(r,Em),new Sm(r)}function S7(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Be(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var A7=new Float32Array([-0]),aa=new Uint8Array(A7.buffer);function uC(r,e,t){A7[0]=r,e[t]=aa[0],e[t+1]=aa[1],e[t+2]=aa[2],e[t+3]=aa[3]}function fC(r,e){return aa[0]=r[e],aa[1]=r[e+1],aa[2]=r[e+2],aa[3]=r[e+3],A7[0]}var I7=new Float64Array([-0]),Er=new Uint8Array(I7.buffer);function hC(r,e,t){I7[0]=r,e[t]=Er[0],e[t+1]=Er[1],e[t+2]=Er[2],e[t+3]=Er[3],e[t+4]=Er[4],e[t+5]=Er[5],e[t+6]=Er[6],e[t+7]=Er[7]}function dC(r,e){return Er[0]=r[e],Er[1]=r[e+1],Er[2]=r[e+2],Er[3]=r[e+3],Er[4]=r[e+4],Er[5]=r[e+5],Er[6]=r[e+6],Er[7]=r[e+7],I7[0]}var nW=BigInt(Number.MAX_SAFE_INTEGER),sW=BigInt(Number.MIN_SAFE_INTEGER),wn=class r{constructor(e,t){l(this,"lo");l(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Hc;if(e<nW&&e>sW)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>pC&&(s=0n,++n>pC&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return Hc;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Hc}},Hc=new wn(0,0);Hc.toBigInt=function(){return 0n};Hc.zzEncode=Hc.zzDecode=function(){return this};Hc.length=function(){return 1};var pC=4294967296n;function mC(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function gC(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function T7(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function ls(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function _m(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var R7=class{constructor(e){l(this,"buf");l(this,"pos");l(this,"len");l(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,ls(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw ls(this,4);return _m(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw ls(this,4);return _m(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw ls(this,4);let e=fC(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw ls(this,4);let e=dC(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw ls(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return gC(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw ls(this,e);this.pos+=e}else do if(this.pos>=this.len)throw ls(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new wn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw ls(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw ls(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw ls(this,8);let e=_m(this.buf,this.pos+=4),t=_m(this.buf,this.pos+=4);return new wn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=gn(this.buf,this.pos);return this.pos+=ce(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function C7(r){return new R7(r instanceof Uint8Array?r:r.subarray())}function Nr(r,e,t){let n=C7(r);return e.decode(n,void 0,t)}function D7(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return pe(i);s+i>e&&(n=pe(e),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var qc=class{constructor(e,t,n){l(this,"fn");l(this,"len");l(this,"next");l(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}};function B7(){}var L7=class{constructor(e){l(this,"head");l(this,"tail");l(this,"len");l(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},oW=D7();function iW(r){return globalThis.Buffer!=null?pe(r):oW(r)}var m0=class{constructor(){l(this,"len");l(this,"head");l(this,"tail");l(this,"states");this.len=0,this.head=new qc(B7,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new qc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new k7((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Am,10,wn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=wn.fromBigInt(e);return this._push(Am,t.length(),t)}uint64Number(e){return this._push(Et,ce(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=wn.fromBigInt(e).zzEncode();return this._push(Am,t.length(),t)}sint64Number(e){let t=wn.fromNumber(e).zzEncode();return this._push(Am,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(P7,1,e?1:0)}fixed32(e){return this._push(p0,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=wn.fromBigInt(e);return this._push(p0,4,t.lo)._push(p0,4,t.hi)}fixed64Number(e){let t=wn.fromNumber(e);return this._push(p0,4,t.lo)._push(p0,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(uC,4,e)}double(e){return this._push(hC,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(P7,1,0):this.uint32(t)._push(cW,t,e)}string(e){let t=mC(e);return t!==0?this.uint32(t)._push(T7,t,e):this._push(P7,1,0)}fork(){return this.states=new L7(this),this.head=this.tail=new qc(B7,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new qc(B7,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=iW(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function P7(r,e,t){e[t]=r&255}function aW(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var k7=class extends qc{constructor(t,n){super(aW,t,n);l(this,"next");this.next=void 0}};function Am(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function p0(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function cW(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(m0.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(lW,e,r),this},m0.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(uW,e,r),this});function lW(r,e,t){e.set(r,t)}function uW(r,e,t){r.length<40?T7(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(H(r),t)}function N7(){return new m0}function Or(r,e){let t=N7();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Mu;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Mu||(Mu={}));function Im(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function O7(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(o,i){let a=e(o);i.int32(a)},n=function(o){let i=o.int32();return e(i)};return Im("enum",Mu.VARINT,t,n)}function Mr(r,e){return Im("message",Mu.LENGTH_DELIMITED,r,e)}var zc=class extends Error{constructor(){super(...arguments);l(this,"code","ERR_MAX_LENGTH");l(this,"name","MaxLengthError")}},g0=class extends Error{constructor(){super(...arguments);l(this,"code","ERR_MAX_SIZE");l(this,"name","MaxSizeError")}};var Tt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Tt||(Tt={}));var M7;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(M7||(M7={}));(function(r){r.codec=()=>O7(M7)})(Tt||(Tt={}));var Vs;(function(r){let e;r.codec=()=>(e==null&&(e=Mr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Tt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=Tt.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Or(t,r.codec()),r.decode=(t,n)=>Nr(t,r.codec(),n)})(Vs||(Vs={}));var U7;(function(r){let e;r.codec=()=>(e==null&&(e=Mr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Tt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=Tt.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Or(t,r.codec()),r.decode=(t,n)=>Nr(t,r.codec(),n)})(U7||(U7={}));var b0={};pt(b0,{MAX_RSA_KEY_SIZE:()=>K7,generateRSAKeyPair:()=>vC,jwkToJWKKeyPair:()=>SC,jwkToPkcs1:()=>pW,jwkToPkix:()=>q7,jwkToRSAPrivateKey:()=>W7,pkcs1MessageToJwk:()=>V7,pkcs1MessageToRSAPrivateKey:()=>z7,pkcs1ToJwk:()=>dW,pkcs1ToRSAPrivateKey:()=>EC,pkixMessageToJwk:()=>H7,pkixMessageToRSAPublicKey:()=>G7,pkixToJwk:()=>mW,pkixToRSAPublicKey:()=>$7});var Uu=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=b0.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return se.createV1(114,this._multihash)}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return xC(this.jwk,t,e,n)}},y0=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"publicKey");this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=b0.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}sign(e,t){return wC(this.jwk,e,t)}};var K7=8192,F7=18,fW=1062,hW=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function dW(r){let e=Po(r);return V7(e)}function V7(r){return{n:z(r[1],"base64url"),e:z(r[2],"base64url"),d:z(r[3],"base64url"),p:z(r[4],"base64url"),q:z(r[5],"base64url"),dp:z(r[6],"base64url"),dq:z(r[7],"base64url"),qi:z(r[8],"base64url"),kty:"RSA"}}function pW(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new Be("JWK was missing components");return ta([nn(Uint8Array.from([0])),nn(H(r.n,"base64url")),nn(H(r.e,"base64url")),nn(H(r.d,"base64url")),nn(H(r.p,"base64url")),nn(H(r.q,"base64url")),nn(H(r.dp,"base64url")),nn(H(r.dq,"base64url")),nn(H(r.qi,"base64url"))]).subarray()}function mW(r){let e=Po(r,{offset:0});return H7(e)}function H7(r){let e=Po(r[1],{offset:0});return{kty:"RSA",n:z(e[0],"base64url"),e:z(e[1],"base64url")}}function q7(r){if(r.n==null||r.e==null)throw new Be("JWK was missing components");return ta([hW,fm(ta([nn(H(r.n,"base64url")),nn(H(r.e,"base64url"))]))]).subarray()}function EC(r){let e=Po(r);return z7(e)}function z7(r){let e=V7(r);return W7(e)}function $7(r,e){if(r.byteLength>=fW)throw new kc("Key size is too large");let t=Po(r,{offset:0});return G7(t,r,e)}function G7(r,e,t){let n=H7(r);if(t==null){let s=Bu(Vs.encode({Type:Tt.RSA,Data:e}));t=ot(F7,s)}return new Uu(n,t)}function W7(r){if(AC(r)>K7)throw new Be("Key size is too large");let e=SC(r),t=Bu(Vs.encode({Type:Tt.RSA,Data:q7(e.publicKey)})),n=ot(F7,t);return new y0(e.privateKey,new Uu(e.publicKey,n))}async function vC(r){if(r>K7)throw new Be("Key size is too large");let e=await _C(r),t=Bu(Vs.encode({Type:Tt.RSA,Data:q7(e.publicKey)})),n=ot(F7,t);return new y0(e.privateKey,new Uu(e.publicKey,n))}function SC(r){if(r==null)throw new Be("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function _C(r,e){let t=await Mn.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await gW(t,e);return{privateKey:n[0],publicKey:n[1]}}async function wC(r,e,t){let n=await Mn.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let s=await Mn.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function xC(r,e,t,n){let s=await Mn.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let o=await Mn.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),o}async function gW(r,e){if(r.privateKey==null||r.publicKey==null)throw new Be("Private and public key are required");let t=await Promise.all([Mn.get().subtle.exportKey("jwk",r.privateKey),Mn.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function AC(r){if(r.kty!=="RSA")throw new Be("invalid key type");if(r.n==null)throw new Be("invalid key modulus");return H(r.n,"base64url").length*8}var Tm=class{constructor(e,t){l(this,"oHash");l(this,"iHash");l(this,"blockLen");l(this,"outputLen");l(this,"finished",!1);l(this,"destroyed",!1);if(hm(e),_e(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),ko(s)}update(e){return Cu(this),this.iHash.update(e),this}digestInto(e){Cu(this),_e(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Y7=(r,e,t)=>new Tm(r,e).update(t).digest();Y7.create=(r,e)=>new Tm(r,e);var IC=(r,e)=>(r+(r>=0?e:-e)/TC)/e;function yW(r,e,t){let[[n,s],[o,i]]=e,a=IC(i*r,t),c=IC(-s*r,t),u=r-a*n-c*o,f=-a*s-c*i,h=u<Ko,d=f<Ko;h&&(u=-u),d&&(f=-f);let p=u0(Math.ceil(f7(t)/2))+Ku;if(u<Ko||u>=p||f<Ko||f>=p)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:u,k2neg:d,k2:f}}function X7(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function Z7(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Uo(t.lowS,"lowS"),Uo(t.prehash,"prehash"),t.format!==void 0&&X7(t.format),t}var j7=class extends Error{constructor(e=""){super(e)}},ca={Err:j7,_tlv:{encode:(r,e)=>{let{Err:t}=ca;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,s=c0(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?c0(s.length/2|128):"";return c0(r)+o+s+e},decode(r,e){let{Err:t}=ca,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let s=e[n++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let f of u)i=i<<8|f;if(n+=c,i<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+i);if(a.length!==i)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(r){let{Err:e}=ca;if(r<Ko)throw new e("integer: negative integers are not allowed");let t=c0(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=ca;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Pu(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=ca,s=_e(r,void 0,"signature"),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:u,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){let{_tlv:e,_int:t}=ca,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),o=n+s;return e.encode(48,o)}},Ko=BigInt(0),Ku=BigInt(1),TC=BigInt(2),Rm=BigInt(3),bW=BigInt(4);function RC(r,e={}){let t=bm("weierstrass",r,e),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i,n:a}=o;oa(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let u=DC(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(I,g,m){let{x:S,y:T}=g.toAffine(),P=n.toBytes(S);if(Uo(m,"isCompressed"),m){f();let C=!n.isOdd(T);return sn(CC(C),P)}else return sn(Uint8Array.of(4),P,n.toBytes(T))}function d(I){_e(I,void 0,"Point");let{publicKey:g,publicKeyUncompressed:m}=u,S=I.length,T=I[0],P=I.subarray(1);if(S===g&&(T===2||T===3)){let C=n.fromBytes(P);if(!n.isValid(C))throw new Error("bad point: is not on curve, wrong x");let k=x(C),D;try{D=n.sqrt(k)}catch(W){let G=W instanceof Error?": "+W.message:"";throw new Error("bad point: is not on curve, sqrt error"+G)}f();let M=n.isOdd(D);return(T&1)===1!==M&&(D=n.neg(D)),{x:C,y:D}}else if(S===m&&T===4){let C=n.BYTES,k=n.fromBytes(P.subarray(0,C)),D=n.fromBytes(P.subarray(C,C*2));if(!b(k,D))throw new Error("bad point: is not on curve");return{x:k,y:D}}else throw new Error(`bad point: got length ${S}, expected compressed=${g} or uncompressed=${m}`)}let p=e.toBytes||h,y=e.fromBytes||d;function x(I){let g=n.sqr(I),m=n.mul(g,I);return n.add(n.add(m,n.mul(I,o.a)),o.b)}function b(I,g){let m=n.sqr(g),S=x(I);return n.eql(m,S)}if(!b(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let _=n.mul(n.pow(o.a,Rm),bW),v=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(_,v)))throw new Error("bad curve params: a or b");function w(I,g,m=!1){if(!n.isValid(g)||m&&n.is0(g))throw new Error(`bad point coordinate ${I}`);return g}function R(I){if(!(I instanceof E))throw new Error("Weierstrass Point expected")}function N(I){if(!c||!c.basises)throw new Error("no endo");return yW(I,c.basises,s.ORDER)}let O=Lu((I,g)=>{let{X:m,Y:S,Z:T}=I;if(n.eql(T,n.ONE))return{x:m,y:S};let P=I.is0();g==null&&(g=P?n.ONE:n.inv(T));let C=n.mul(m,g),k=n.mul(S,g),D=n.mul(T,g);if(P)return{x:n.ZERO,y:n.ZERO};if(!n.eql(D,n.ONE))throw new Error("invZ was invalid");return{x:C,y:k}}),F=Lu(I=>{if(I.is0()){if(e.allowInfinityPoint&&!n.is0(I.Y))return;throw new Error("bad point: ZERO")}let{x:g,y:m}=I.toAffine();if(!n.isValid(g)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!b(g,m))throw new Error("bad point: equation left != right");if(!I.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function A(I,g,m,S,T){return m=new E(n.mul(m.X,I),m.Y,m.Z),g=h0(S,g),m=h0(T,m),g.add(m)}let B=class B{constructor(g,m,S){l(this,"X");l(this,"Y");l(this,"Z");this.X=w("x",g),this.Y=w("y",m,!0),this.Z=w("z",S),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){let{x:m,y:S}=g||{};if(!g||!n.isValid(m)||!n.isValid(S))throw new Error("invalid affine point");if(g instanceof B)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(S)?B.ZERO:new B(m,S,n.ONE)}static fromBytes(g){let m=B.fromAffine(y(_e(g,void 0,"point")));return m.assertValidity(),m}static fromHex(g){return B.fromBytes(Oo(g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,m=!0){return U.createCache(this,g),m||this.multiply(Rm),this}assertValidity(){F(this)}hasEvenY(){let{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.eql(n.mul(m,k),n.mul(P,T)),M=n.eql(n.mul(S,k),n.mul(C,T));return D&&M}negate(){return new B(this.X,n.neg(this.Y),this.Z)}double(){let{a:g,b:m}=o,S=n.mul(m,Rm),{X:T,Y:P,Z:C}=this,k=n.ZERO,D=n.ZERO,M=n.ZERO,q=n.mul(T,T),W=n.mul(P,P),G=n.mul(C,C),$=n.mul(T,P);return $=n.add($,$),M=n.mul(T,C),M=n.add(M,M),k=n.mul(g,M),D=n.mul(S,G),D=n.add(k,D),k=n.sub(W,D),D=n.add(W,D),D=n.mul(k,D),k=n.mul($,k),M=n.mul(S,M),G=n.mul(g,G),$=n.sub(q,G),$=n.mul(g,$),$=n.add($,M),M=n.add(q,q),q=n.add(M,q),q=n.add(q,G),q=n.mul(q,$),D=n.add(D,q),G=n.mul(P,C),G=n.add(G,G),q=n.mul(G,$),k=n.sub(k,q),M=n.mul(G,W),M=n.add(M,M),M=n.add(M,M),new B(k,D,M)}add(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.ZERO,M=n.ZERO,q=n.ZERO,W=o.a,G=n.mul(o.b,Rm),$=n.mul(m,P),X=n.mul(S,C),Q=n.mul(T,k),J=n.add(m,S),Y=n.add(P,C);J=n.mul(J,Y),Y=n.add($,X),J=n.sub(J,Y),Y=n.add(m,T);let re=n.add(P,k);return Y=n.mul(Y,re),re=n.add($,Q),Y=n.sub(Y,re),re=n.add(S,T),D=n.add(C,k),re=n.mul(re,D),D=n.add(X,Q),re=n.sub(re,D),q=n.mul(W,Y),D=n.mul(G,Q),q=n.add(D,q),D=n.sub(X,q),q=n.add(X,q),M=n.mul(D,q),X=n.add($,$),X=n.add(X,$),Q=n.mul(W,Q),Y=n.mul(G,Y),X=n.add(X,Q),Q=n.sub($,Q),Q=n.mul(W,Q),Y=n.add(Y,Q),$=n.mul(X,Y),M=n.add(M,$),$=n.mul(re,Y),D=n.mul(J,D),D=n.sub(D,$),$=n.mul(J,X),q=n.mul(re,q),q=n.add(q,$),new B(D,M,q)}subtract(g){return this.add(g.negate())}is0(){return this.equals(B.ZERO)}multiply(g){let{endo:m}=e;if(!s.isValidNot0(g))throw new Error("invalid scalar: out of range");let S,T,P=C=>U.cached(this,C,k=>Vc(B,k));if(m){let{k1neg:C,k1:k,k2neg:D,k2:M}=N(g),{p:q,f:W}=P(k),{p:G,f:$}=P(M);T=W.add($),S=A(m.beta,q,G,C,D)}else{let{p:C,f:k}=P(g);S=C,T=k}return Vc(B,[S,T])[0]}multiplyUnsafe(g){let{endo:m}=e,S=this;if(!s.isValid(g))throw new Error("invalid scalar: out of range");if(g===Ko||S.is0())return B.ZERO;if(g===Ku)return S;if(U.hasCache(this))return this.multiply(g);if(m){let{k1neg:T,k1:P,k2neg:C,k2:k}=N(g),{p1:D,p2:M}=tC(B,S,P,k);return A(m.beta,D,M,T,C)}else return U.unsafe(S,g)}toAffine(g){return O(this,g)}isTorsionFree(){let{isTorsionFree:g}=e;return i===Ku?!0:g?g(B,this):U.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:g}=e;return i===Ku?this:g?g(B,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return Uo(g,"isCompressed"),this.assertValidity(),p(B,this,g)}toHex(g=!0){return No(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(B,"BASE",new B(o.Gx,o.Gy,n.ONE)),l(B,"ZERO",new B(n.ZERO,n.ONE,n.ZERO)),l(B,"Fp",n),l(B,"Fn",s);let E=B,L=s.BITS,U=new Ou(E,e.endo?Math.ceil(L/2):L);return E.BASE.precompute(8),E}function CC(r){return Uint8Array.of(r?2:3)}function DC(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function wW(r,e={}){let{Fn:t}=r,n=e.randomBytes||Du,s=Object.assign(DC(r.Fp,t),{seed:m7(t.ORDER)});function o(p){try{let y=t.fromBytes(p);return t.isValidNot0(y)}catch{return!1}}function i(p,y){let{publicKey:x,publicKeyUncompressed:b}=s;try{let _=p.length;return y===!0&&_!==x||y===!1&&_!==b?!1:!!r.fromBytes(p)}catch{return!1}}function a(p=n(s.seed)){return g7(_e(p,s.seed,"seed"),t.ORDER)}function c(p,y=!0){return r.BASE.multiply(t.fromBytes(p)).toBytes(y)}function u(p){let{secretKey:y,publicKey:x,publicKeyUncompressed:b}=s;if(!Nc(p)||"_lengths"in t&&t._lengths||y===x)return;let _=_e(p,void 0,"key").length;return _===x||_===b}function f(p,y,x=!0){if(u(p)===!0)throw new Error("first arg must be private key");if(u(y)===!1)throw new Error("second arg must be public key");let b=t.fromBytes(p);return r.fromBytes(y).multiply(b).toBytes(x)}let h={isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a},d=wm(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:d,Point:r,utils:h,lengths:s})}function BC(r,e,t={}){hm(e),oa(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||Du,s=t.hmac||((g,m)=>Y7(e,g,m)),{Fp:o,Fn:i}=r,{ORDER:a,BITS:c}=i,{keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p}=wW(r,t),y={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},x=a*TC<o.ORDER;function b(g){let m=a>>Ku;return g>m}function _(g,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${g}: out of range 1..Point.Fn.ORDER`);return m}function v(){if(x)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(g,m){X7(m);let S=p.signature,T=m==="compact"?S:m==="recovered"?S+1:void 0;return _e(g,T)}class R{constructor(m,S,T){l(this,"r");l(this,"s");l(this,"recovery");if(this.r=_("r",m),this.s=_("s",S),T!=null){if(v(),![0,1,2,3].includes(T))throw new Error("invalid recovery id");this.recovery=T}Object.freeze(this)}static fromBytes(m,S=y.format){w(m,S);let T;if(S==="der"){let{r:D,s:M}=ca.toSig(_e(m));return new R(D,M)}S==="recovered"&&(T=m[0],S="compact",m=m.subarray(1));let P=p.signature/2,C=m.subarray(0,P),k=m.subarray(P,P*2);return new R(i.fromBytes(C),i.fromBytes(k),T)}static fromHex(m,S){return this.fromBytes(Oo(m),S)}assertRecovery(){let{recovery:m}=this;if(m==null)throw new Error("invalid recovery id: must be present");return m}addRecoveryBit(m){return new R(this.r,this.s,m)}recoverPublicKey(m){let{r:S,s:T}=this,P=this.assertRecovery(),C=P===2||P===3?S+a:S;if(!o.isValid(C))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let k=o.toBytes(C),D=r.fromBytes(sn(CC((P&1)===0),k)),M=i.inv(C),q=O(_e(m,void 0,"msgHash")),W=i.create(-q*M),G=i.create(T*M),$=r.BASE.multiplyUnsafe(W).add(D.multiplyUnsafe(G));if($.is0())throw new Error("invalid recovery: point at infinify");return $.assertValidity(),$}hasHighS(){return b(this.s)}toBytes(m=y.format){if(X7(m),m==="der")return Oo(ca.hexFromSig(this));let{r:S,s:T}=this,P=i.toBytes(S),C=i.toBytes(T);return m==="recovered"?(v(),sn(Uint8Array.of(this.assertRecovery()),P,C)):sn(P,C)}toHex(m){return No(this.toBytes(m))}}let N=t.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");let S=Pu(m),T=m.length*8-c;return T>0?S>>BigInt(T):S},O=t.bits2int_modN||function(m){return i.create(N(m))},F=u0(c);function A(g){return l0("num < 2^"+c,g,Ko,F),i.toBytes(g)}function E(g,m){return _e(g,void 0,"message"),m?_e(e(g),void 0,"prehashed message"):g}function L(g,m,S){let{lowS:T,prehash:P,extraEntropy:C}=Z7(S,y);g=E(g,P);let k=O(g),D=i.fromBytes(m);if(!i.isValidNot0(D))throw new Error("invalid private key");let M=[A(D),A(k)];if(C!=null&&C!==!1){let $=C===!0?n(p.secretKey):C;M.push(_e($,void 0,"extraEntropy"))}let q=sn(...M),W=k;function G($){let X=N($);if(!i.isValidNot0(X))return;let Q=i.inv(X),J=r.BASE.multiply(X).toAffine(),Y=i.create(J.x);if(Y===Ko)return;let re=i.create(Q*i.create(W+Y*D));if(re===Ko)return;let sr=(J.x===Y?0:2)|Number(J.y&Ku),or=re;return T&&b(re)&&(or=i.neg(re),sr^=1),new R(Y,or,x?void 0:sr)}return{seed:q,k2sig:G}}function U(g,m,S={}){let{seed:T,k2sig:P}=L(g,m,S);return UR(e.outputLen,i.BYTES,s)(T,P).toBytes(S.format)}function B(g,m,S,T={}){let{lowS:P,prehash:C,format:k}=Z7(T,y);if(S=_e(S,void 0,"publicKey"),m=E(m,C),!Nc(g)){let D=g instanceof R?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+D)}w(g,k);try{let D=R.fromBytes(g,k),M=r.fromBytes(S);if(P&&D.hasHighS())return!1;let{r:q,s:W}=D,G=O(m),$=i.inv(W),X=i.create(G*$),Q=i.create(q*$),J=r.BASE.multiplyUnsafe(X).add(M.multiplyUnsafe(Q));return J.is0()?!1:i.create(J.x)===q}catch{return!1}}function I(g,m,S={}){let{prehash:T}=Z7(S,y);return m=E(m,T),R.fromBytes(g,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p,Point:r,sign:U,verify:B,recoverPublicKey:I,Signature:R,hash:e})}var J7={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},xW={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var PC=BigInt(2);function EW(r){let e=J7.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,f=u*u*r%e,h=ct(f,t,e)*f%e,d=ct(h,t,e)*f%e,p=ct(d,PC,e)*u%e,y=ct(p,s,e)*p%e,x=ct(y,o,e)*y%e,b=ct(x,a,e)*x%e,_=ct(b,c,e)*b%e,v=ct(_,a,e)*x%e,w=ct(v,t,e)*f%e,R=ct(w,i,e)*y%e,N=ct(R,n,e)*u%e,O=ct(N,PC,e);if(!Q7.eql(Q7.sqr(O),r))throw new Error("Cannot find square root");return O}var Q7=ku(J7.p,{sqrt:EW}),vW=RC(J7,{Fp:Q7,endo:xW}),Fu=BC(vW,Bu);function LC(r,e,t,n){let s=Ee.digest(t instanceof Uint8Array?t:t.subarray());if(vm(s))return s.then(({digest:o})=>(n?.signal?.throwIfAborted(),Fu.verify(e,o,r,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new d0(String(o))});try{return n?.signal?.throwIfAborted(),Fu.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(o){throw new d0(String(o))}}var Cm=class{constructor(e){l(this,"type","secp256k1");l(this,"raw");l(this,"_key");this._key=NC(e),this.raw=kC(this._key)}toMultihash(){return ge.digest(On(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return LC(this._key,t,e,n)}};function e9(r){return new Cm(r)}function kC(r){return Fu.Point.fromBytes(r).toBytes()}function NC(r){try{return Fu.Point.fromBytes(r),r}catch(e){throw new kc(String(e))}}function Dm(r,e){let{Type:t,Data:n}=Vs.decode(r),s=n??new Uint8Array;switch(t){case Tt.RSA:return $7(s,e);case Tt.Ed25519:return _7(s);case Tt.secp256k1:return e9(s);case Tt.ECDSA:return Jb(s);default:throw new ea}}function OC(r){let{Type:e,Data:t}=Vs.decode(r.digest),n=t??new Uint8Array;switch(e){case Tt.Ed25519:return _7(n);case Tt.secp256k1:return e9(n);case Tt.ECDSA:return Jb(n);default:throw new ea}}function On(r){return Vs.encode({Type:Tt[r.type],Data:r.raw})}var FC=Symbol.for("nodejs.util.inspect.custom"),SW=114,MC,w0=class{constructor(e){l(this,"type");l(this,"multihash");l(this,"publicKey");l(this,"string");l(this,MC,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ie.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return se.createV1(SW,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return j(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return j(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(MC=um,FC)](){return`PeerId(${this.toString()})`}},x0=class extends w0{constructor(t){super({...t,type:"RSA"});l(this,"type","RSA");l(this,"publicKey");this.publicKey=t.publicKey}},E0=class extends w0{constructor(t){super({...t,type:"Ed25519"});l(this,"type","Ed25519");l(this,"publicKey");this.publicKey=t.publicKey}},v0=class extends w0{constructor(t){super({...t,type:"secp256k1"});l(this,"type","secp256k1");l(this,"publicKey");this.publicKey=t.publicKey}},_W=2336,UC,KC,S0=class{constructor(e){l(this,"type","url");l(this,"multihash");l(this,"publicKey");l(this,"url");l(this,UC,!0);this.url=e.toString(),this.multihash=ge.digest(H(this.url))}[(KC=FC,UC=um,KC)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return se.createV1(_W,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=z(e)),e.toString()===this.toString())}};var AW=114,VC=2336;function HC(r){if(r.type==="Ed25519")return new E0({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new v0({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new x0({multihash:r.toCID().multihash,publicKey:r});throw new ea}function t9(r){if(TW(r))return new x0({multihash:r});if(IW(r))try{let e=OC(r);if(e.type==="Ed25519")return new E0({multihash:r,publicKey:e});if(e.type==="secp256k1")return new v0({multihash:r,publicKey:e})}catch{let t=z(r.digest);return new S0(new URL(t))}throw new r0("Supplied PeerID Multihash is invalid")}function Bm(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==AW&&r.code!==VC)throw new t0("Supplied PeerID CID is invalid");if(r.code===VC){let e=z(r.multihash.digest);return new S0(new URL(e))}return t9(r.multihash)}function IW(r){return r.code===ge.code}function TW(r){return r.code===Ee.code}var _0;(function(r){let e;r.codec=()=>(e==null&&(e=Mr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={publicKey:fe(0),payloadType:fe(0),payload:fe(0),signature:fe(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=t.bytes();break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Or(t,r.codec()),r.decode=(t,n)=>Nr(t,r.codec(),n)})(_0||(_0={}));var Pm=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var la=class la{constructor(e){l(this,"publicKey");l(this,"payloadType");l(this,"payload");l(this,"signature");l(this,"marshaled");let{publicKey:t,payloadType:n,payload:s,signature:o}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=o}marshal(){return this.marshaled==null&&(this.marshaled=_0.encode({publicKey:On(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:j(this.marshal(),e.marshal())}async validate(e,t){let n=qC(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}};l(la,"createFromProtobuf",e=>{let t=_0.decode(e),n=Dm(t.publicKey);return new la({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),l(la,"seal",async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let s=e.domain,o=e.codec,i=e.marshal(),a=qC(s,o,i),c=await t.sign(a.subarray(),n);return new la({publicKey:t.publicKey,payloadType:o,payload:i,signature:c})}),l(la,"openAndCertify",async(e,t,n)=>{let s=la.createFromProtobuf(e);if(!await s.validate(t,n))throw new Pm("Envelope signature is not valid for the given domain");return s});var Vu=la,qC=(r,e,t)=>{let n=H(r),s=je(n.byteLength),o=je(e.length),i=je(t.length);return new Z(s,n,o,e,i,t)};var Ht=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMultiaddrError")}};l(Ht,"name","InvalidMultiaddrError");var Hs=class extends Error{constructor(){super(...arguments);l(this,"name","ValidationError")}};l(Hs,"name","ValidationError");var A0=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidParametersError")}};l(A0,"name","InvalidParametersError");var I0=class extends Error{constructor(){super(...arguments);l(this,"name","UnknownProtocolError")}};l(I0,"name","UnknownProtocolError");function n9(r){return e=>z(e,r)}function s9(r){return e=>H(e,r)}function Hu(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function $c(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function zC(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=H(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=$c(n);return we([t,s],t.length+s.length)}function $C(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=yr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=$c(n);return we([t,s],t.length+s.length)}function o9(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=z(e,"base32"),s=Hu(t);return`${n}:${s}`}var i9=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new Ht("Invalid byte value in IP address");e[n]=s}),e},GC=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=gt(t[n]),i;o&&(i=i9(t[n]),t[n]=z(i.subarray(0,2),"base16")),i!=null&&++n<8&&t.splice(n,0,z(i.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let o=parseInt(t[n],16);if(isNaN(o)||o<0||o>65535)throw new Ht("Invalid byte value in IP address");s[e++]=o>>8&255,s[e++]=o&255}return s},WC=function(r){if(r.byteLength!==4)throw new Ht("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},YC=function(r){if(r.byteLength!==16)throw new Ht("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let s=r[n],o=r[n+1],i=`${s.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`;e.push(i)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new Ht(`Invalid IPv6 address "${t}"`)}};function ZC(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Ht(`Invalid IPv6 address "${r}"`)}}var r9=Object.values(Qr).map(r=>r.decoder),RW=(function(){let r=r9[0].or(r9[1]);return r9.slice(2).forEach(e=>r=r.or(e)),r})();function XC(r){return RW.decode(r)}function jC(r){return e=>r.encoder.encode(e)}function CW(r){if(parseInt(r).toString()!==r)throw new Hs("Value must be an integer")}function DW(r){if(r<0)throw new Hs("Value must be a positive integer, or zero")}function BW(r){return e=>{if(e>r)throw new Hs(`Value must be smaller than or equal to ${r}`)}}function PW(...r){return e=>{for(let t of r)t(e)}}var T0=PW(CW,DW,BW(65535));var qt=-1,a9=class{constructor(){l(this,"protocolsByCode",new Map);l(this,"protocolsByName",new Map)}getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new I0(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},Fo=new a9,bY=[{code:4,name:"ip4",size:32,valueToBytes:i9,bytesToValue:WC,validate:r=>{if(!gt(r))throw new Hs(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:$c,bytesToValue:Hu,validate:T0},{code:273,name:"udp",size:16,valueToBytes:$c,bytesToValue:Hu,validate:T0},{code:33,name:"dccp",size:16,valueToBytes:$c,bytesToValue:Hu,validate:T0},{code:41,name:"ip6",size:128,valueToBytes:GC,bytesToValue:YC,stringToValue:ZC,validate:r=>{if(!Nn(r))throw new Hs(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:qt},{code:43,name:"ipcidr",size:8,bytesToValue:n9("base10"),valueToBytes:s9("base10")},{code:53,name:"dns",size:qt},{code:54,name:"dns4",size:qt},{code:55,name:"dns6",size:qt},{code:56,name:"dnsaddr",size:qt},{code:132,name:"sctp",size:16,valueToBytes:$c,bytesToValue:Hu,validate:T0},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:qt,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:qt,bytesToValue:n9("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?s9("base58btc")(r):se.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:o9,valueToBytes:zC},{code:445,name:"onion3",size:296,bytesToValue:o9,valueToBytes:$C},{code:446,name:"garlic64",size:qt},{code:447,name:"garlic32",size:qt},{code:448,name:"tls"},{code:449,name:"sni",size:qt},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:qt,bytesToValue:jC(xo),valueToBytes:XC},{code:480,name:"http"},{code:481,name:"http-path",size:qt,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:qt}];bY.forEach(r=>{Fo.addProtocol(r)});function QC(r){let e=[],t=0;for(;t<r.length;){let n=Nt(r,t),s=Fo.getProtocol(n),o=ce(n),i=wY(s,r,t+o),a=0;i>0&&s.size===qt&&(a=ce(i));let c=o+a+i,u={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(i>0){let f=t+o+a,h=r.subarray(f,f+i);u.value=s.bytesToValue?.(h)??z(h)}e.push(u),t+=c}return e}function JC(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let s=Fo.getProtocol(n.code),o=ce(n.code),i,a=0,c=0;n.value!=null&&(i=s.valueToBytes?.(n.value)??H(n.value),a=i.byteLength,s.size===qt&&(c=ce(a)));let u=new Uint8Array(o+c+a),f=0;Et(n.code,u,f),f+=o,i!=null&&(s.size===qt&&(Et(a,u,f),f+=c),u.set(i,f)),n.bytes=u}t.push(n.bytes),e+=n.bytes.byteLength}return we(t,e)}function eD(r){if(r.charAt(0)!=="/")throw new Ht('String multiaddr must start with "/"');let e=[],t="protocol",n="",s="";for(let o=1;o<r.length;o++){let i=r.charAt(o);i!=="/"&&(t==="protocol"?s+=r.charAt(o):n+=r.charAt(o));let a=o===r.length-1;if(i==="/"||a){let c=Fo.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new Ht(`Component ${s} was missing value`);t="value"}else if(t==="value"){let u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new Ht(`Component ${s} was missing value`);u.value=c.stringToValue?.(n)??n}e.push(u),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new Ht("Incomplete multiaddr");return e}function tD(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=Fo.getProtocol(e.code);if(t==null)throw new Ht(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function wY(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Nt(e,t)}var xY=Symbol.for("nodejs.util.inspect.custom"),l9=Symbol.for("@multiformats/multiaddr");function EY(r){if(r==null&&(r="/"),km(r))return r.getComponents();if(r instanceof Uint8Array)return QC(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),eD(r);if(Array.isArray(r))return r;throw new Ht("Must be a string, Uint8Array, Component[], or another Multiaddr")}var rD,us,zu,$u,qu=class qu{constructor(e="/",t={}){l(this,rD,!0);ne(this,us);ne(this,zu);ne(this,$u);le(this,us,EY(e)),t.validate!==!1&&vY(this)}get bytes(){return V(this,$u)==null&&le(this,$u,JC(V(this,us))),V(this,$u)}toString(){return V(this,zu)==null&&le(this,zu,tD(V(this,us))),V(this,zu)}toJSON(){return this.toString()}getComponents(){return[...V(this,us).map(e=>({...e}))]}encapsulate(e){let t=new qu(e);return new qu([...V(this,us),...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new A0(`Address ${this.toString()} does not contain subaddress: ${t}`);return new qu(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=V(this,us).length-1;n>-1;n--)if(V(this,us)[n].code===e){t=n;break}return new qu(V(this,us).slice(0,t),{validate:!1})}equals(e){return j(this.bytes,e.bytes)}[(rD=l9,xY)](){return`Multiaddr(${this.toString()})`}};us=new WeakMap,zu=new WeakMap,$u=new WeakMap;var Lm=qu;function vY(r){r.getComponents().forEach(e=>{let t=Fo.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function km(r){return!!r?.[l9]}function Gc(r){return new Lm(r)}var nD="libp2p-peer-record",sD=Uint8Array.from([3,1]);var R0;(function(r){let e;(function(n){let s;n.codec=()=>(s==null&&(s=Mr((o,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),o.multiaddr!=null&&o.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(o.multiaddr)),a.lengthDelimited!==!1&&i.ldelim()},(o,i,a={})=>{let c={multiaddr:fe(0)},u=i==null?o.len:o.pos+i;for(;o.pos<u;){let f=o.uint32();f>>>3===1?c.multiaddr=o.bytes():o.skipType(f&7)}return c})),s),n.encode=o=>Or(o,n.codec()),n.decode=(o,i)=>Nr(o,n.codec(),i)})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=Mr((n,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(s.uint32(10),s.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(s.uint32(16),s.uint64(n.seq)),n.addresses!=null)for(let i of n.addresses)s.uint32(26),r.AddressInfo.codec().encode(i,s);o.lengthDelimited!==!1&&s.ldelim()},(n,s,o={})=>{let i={peerId:fe(0),seq:0n,addresses:[]},a=s==null?n.len:n.pos+s;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{i.peerId=n.bytes();break}case 2:{i.seq=n.uint64();break}case 3:{if(o.limits?.addresses!=null&&i.addresses.length===o.limits.addresses)throw new zc('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:o.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return i})),t),r.encode=n=>Or(n,r.codec()),r.decode=(n,s)=>Nr(n,r.codec(),s)})(R0||(R0={}));function oD(r,e){let t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}var Vo=class Vo{constructor(e){l(this,"peerId");l(this,"multiaddrs");l(this,"seqNumber");l(this,"domain",Vo.DOMAIN);l(this,"codec",Vo.CODEC);l(this,"marshaled");let{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=R0.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Vo)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!oD(this.multiaddrs,e.multiaddrs))}};l(Vo,"createFromProtobuf",e=>{let t=R0.decode(e),n=t9(mt(t.peerId)),s=(t.addresses??[]).map(i=>Gc(i.multiaddr)),o=t.seq;return new Vo({peerId:n,multiaddrs:s,seqNumber:o})}),l(Vo,"DOMAIN",nD),l(Vo,"CODEC",sD);var Wc=Vo;function SY(r){return r[Symbol.asyncIterator]!=null}function _Y(r){if(SY(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var C0=_Y;function Nm(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}var D0=class{constructor(e){l(this,"map");if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Nm(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Nm(this.map.values(),e=>e.key)}values(){return Nm(this.map.values(),e=>e.value)}get size(){return this.map.size}};var u9=class extends D0{constructor(t){super();l(this,"metric");let{name:n,metrics:s}=t;this.metric=s.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){let n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function f9(r){let{name:e,metrics:t}=r,n;return t!=null?n=new u9({name:e,metrics:t}):n=new D0,n}var on=class extends Error{constructor(t="The operation was aborted",...n){super(t,...n);l(this,"name","AbortError")}};l(on,"name","AbortError");async function Un(r,e,t,n){let s=new on(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);let o=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((i,a)=>{function c(){d9(t,"abort",h),d9(r,e,u),d9(r,o,f)}let u=d=>{try{if(n?.filter?.(d)===!1)return}catch(p){c(),a(p);return}c(),i(d)},f=d=>{if(c(),d instanceof Error){a(d);return}a(d.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},h=()=>{c(),a(s)};h9(t,"abort",h),h9(r,e,u),h9(r,o,f)})}function h9(r,e,t){r!=null&&(iD(r)?r.addEventListener(e,t):r.addListener(e,t))}function d9(r,e,t){r!=null&&(iD(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function iD(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}var B0=class extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};l(B0,"name","QueueFullError");function AY(r){return r.reason}async function aD(r,e,t){if(e==null)return r;let n=t?.translateError??AY;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((o,i)=>{s=()=>{i(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}var Om=class{constructor(e){l(this,"deferred");l(this,"signal");this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new on)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function IY(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var Mm=class{constructor(e,t){l(this,"id");l(this,"fn");l(this,"options");l(this,"recipients");l(this,"status");l(this,"timeline");l(this,"controller");this.id=IY(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new on),this.cleanup())}async join(e={}){let t=new Om(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await aD(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function p9(r,e){let t,n=function(){let s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var P0=class extends Je{constructor(t={}){super();l(this,"concurrency");l(this,"maxSize");l(this,"queue");l(this,"pending");l(this,"sort");l(this,"autoStart");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=t.autoStart??!0,this.sort=t.sort,this.queue=[],this.emitEmpty=p9(this.emitEmpty.bind(this),1),this.emitIdle=p9(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let n of this.queue)if(n.status==="queued"){t=n;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let n=0;n<this.queue.length;n++)if(this.queue[n]===t){this.queue.splice(n,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(t,n){if(n?.signal?.throwIfAborted(),this.size===this.maxSize)throw new B0;let s=new Mm(t,n);return this.enqueue(s),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),s.join(n).then(o=>(this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===s){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new on)}),this.clear()}async onEmpty(t){this.size!==0&&await Un(this,"empty",t?.signal)}async onSizeLessThan(t,n){this.size<t||await Un(this,"next",n?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Un(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let n=We({objectMode:!0}),s=u=>{u!=null?this.abort():this.clear(),n.end(u)},o=u=>{u.detail!=null&&n.push(u.detail.result)},i=u=>{s(u.detail.error)},a=()=>{s()},c=()=>{s(new on("Queue aborted"))};this.addEventListener("success",o),this.addEventListener("failure",i),this.addEventListener("idle",a),t?.signal?.addEventListener("abort",c);try{yield*n}finally{this.removeEventListener("success",o),this.removeEventListener("failure",i),this.removeEventListener("idle",a),t?.signal?.removeEventListener("abort",c),s()}}};var Um="lock:worker:request-read",Km="lock:worker:abort-read-request",Fm="lock:worker:release-read",Vm="lock:master:grant-read",Hm="lock:master:error-read",qm="lock:worker:request-write",zm="lock:worker:abort-write-request",$m="lock:worker:release-write",Gm="lock:master:grant-write",Wm="lock:master:error-write",Ym="lock:worker:finalize",Zm="mortice",cD={singleProcess:!1};var m9=(r,e,t,n,s,o,i,a,c)=>u=>{if(u.data==null)return;let f={type:u.data.type,name:u.data.name,identifier:u.data.identifier};f.type===s&&r.safeDispatchEvent(t,{detail:{name:f.name,identifier:f.identifier,handler:async()=>{e.postMessage({type:c,name:f.name,identifier:f.identifier}),await new Promise(h=>{let d=p=>{if(p?.data==null)return;let y={type:p.data.type,name:p.data.name,identifier:p.data.identifier};y.type===a&&y.identifier===f.identifier&&(e.removeEventListener("message",d),h())};e.addEventListener("message",d)})},onError:h=>{e.postMessage({type:i,name:f.name,identifier:f.identifier,error:{message:h.message,name:h.name,stack:h.stack}})}}}),f.type===o&&r.safeDispatchEvent(n,{detail:{name:f.name,identifier:f.identifier}}),f.type===Ym&&r.safeDispatchEvent("finalizeRequest",{detail:{name:f.name}})};var lD=(r=10)=>Math.random().toString().substring(2,r+2);var Xm=class{constructor(e){l(this,"name");l(this,"channel");this.name=e,this.channel=new BroadcastChannel(Zm)}readLock(e){return this.sendRequest(Um,Km,Vm,Hm,Fm,e)}writeLock(e){return this.sendRequest(qm,zm,Gm,Wm,$m,e)}finalize(){this.channel.postMessage({type:Ym,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,o,i){i?.signal?.throwIfAborted();let a=lD();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,u)=>{let f=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};i?.signal?.addEventListener("abort",f,{once:!0});let h=d=>{if(d.data?.identifier===a&&(d.data?.type===n&&(this.channel.removeEventListener("message",h),i?.signal?.removeEventListener("abort",f),c(()=>{this.channel.postMessage({type:o,identifier:a,name:this.name})})),d.data.type===s)){this.channel.removeEventListener("message",h),i?.signal?.removeEventListener("abort",f);let p=new Error;d.data.error!=null&&(p.message=d.data.error.message,p.name=d.data.error.name,p.stack=d.data.error.stack),u(p)}};this.channel.addEventListener("message",h)})}};var uD=r=>{if(r=Object.assign({},cD,r),!!globalThis.document||r.singleProcess){let t=new BroadcastChannel(Zm),n=new Je;return t.addEventListener("message",m9(n,t,"requestReadLock","abortReadLockRequest",Um,Km,Hm,Fm,Vm)),t.addEventListener("message",m9(n,t,"requestWriteLock","abortWriteLockRequest",qm,zm,Wm,$m,Gm)),n}return new Xm(r.name)};var Yc=new Map,L0;function fD(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function TY(r){if(L0==null&&(L0=uD(r),!fD(L0))){let e=L0;e.addEventListener("requestReadLock",t=>{let n=t.detail.name,s=t.detail.identifier,o=Yc.get(n);if(o==null)return;let i=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||i.abort()};e.addEventListener("abortReadLockRequest",a),o.readLock({signal:i.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{let n=t.detail.name,s=t.detail.identifier,o=Yc.get(n);if(o==null)return;let i=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||i.abort()};e.addEventListener("abortWriteLockRequest",a),o.writeLock({signal:i.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{let n=t.detail.name,s=Yc.get(n);s?.finalize()})}return L0}async function g9(r,e){let t,n,s=new Promise((i,a)=>{t=i,n=a}),o=()=>{n(new on)};return e?.signal?.addEventListener("abort",o,{once:!0}),r.add(async()=>{await new Promise(i=>{t(()=>{e?.signal?.removeEventListener("abort",o),i()})})},{signal:e?.signal}).catch(i=>{n(i)}),s}var hD=(r,e)=>{let t=Yc.get(r);if(t!=null)return t;let n=TY(e);if(fD(n))return t=n,Yc.set(r,t),t;let s=new P0({concurrency:1}),o;return t={async readLock(i){if(o!=null)return g9(o,i);o=new P0({concurrency:e.concurrency,autoStart:!1});let a=o,c=g9(o,i);return s.add(async()=>{a.start(),await a.onIdle().then(()=>{o===a&&(o=null)})}),c},async writeLock(i){return o=null,g9(s,i)},finalize:()=>{Yc.delete(r)},queue:s},Yc.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t};var RY={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function y9(r){let e=Object.assign({},RY,r);return hD(e.name,e)}var Ho;(function(r){let e;(function(s){let o;s.codec=()=>(o==null&&(o=Mr((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&i.value.byteLength>0&&(a.uint32(18),a.bytes(i.value)),c.lengthDelimited!==!1&&a.ldelim()},(i,a,c={})=>{let u={key:"",value:fe(0)},f=a==null?i.len:i.pos+a;for(;i.pos<f;){let h=i.uint32();switch(h>>>3){case 1:{u.key=i.string();break}case 2:{u.value=i.bytes();break}default:{i.skipType(h&7);break}}}return u})),o),s.encode=i=>Or(i,s.codec()),s.decode=(i,a)=>Nr(i,s.codec(),a)})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(s){let o;s.codec=()=>(o==null&&(o=Mr((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&(a.uint32(18),Qm.codec().encode(i.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(i,a,c={})=>{let u={key:""},f=a==null?i.len:i.pos+a;for(;i.pos<f;){let h=i.uint32();switch(h>>>3){case 1:{u.key=i.string();break}case 2:{u.value=Qm.codec().decode(i,i.uint32(),{limits:c.limits?.value});break}default:{i.skipType(h&7);break}}}return u})),o),s.encode=i=>Or(i,s.codec()),s.decode=(i,a)=>Nr(i,s.codec(),a)})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=Mr((s,o,i={})=>{if(i.lengthDelimited!==!1&&o.fork(),s.addresses!=null)for(let a of s.addresses)o.uint32(10),jm.codec().encode(a,o);if(s.protocols!=null)for(let a of s.protocols)o.uint32(18),o.string(a);if(s.publicKey!=null&&(o.uint32(34),o.bytes(s.publicKey)),s.peerRecordEnvelope!=null&&(o.uint32(42),o.bytes(s.peerRecordEnvelope)),s.metadata!=null&&s.metadata.size!==0)for(let[a,c]of s.metadata.entries())o.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},o);if(s.tags!=null&&s.tags.size!==0)for(let[a,c]of s.tags.entries())o.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},o);s.updated!=null&&(o.uint32(64),o.uint64Number(s.updated)),i.lengthDelimited!==!1&&o.ldelim()},(s,o,i={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=o==null?s.len:s.pos+o;for(;s.pos<c;){let u=s.uint32();switch(u>>>3){case 1:{if(i.limits?.addresses!=null&&a.addresses.length===i.limits.addresses)throw new zc('Decode error - map field "addresses" had too many elements');a.addresses.push(jm.codec().decode(s,s.uint32(),{limits:i.limits?.addresses$}));break}case 2:{if(i.limits?.protocols!=null&&a.protocols.length===i.limits.protocols)throw new zc('Decode error - map field "protocols" had too many elements');a.protocols.push(s.string());break}case 4:{a.publicKey=s.bytes();break}case 5:{a.peerRecordEnvelope=s.bytes();break}case 6:{if(i.limits?.metadata!=null&&a.metadata.size===i.limits.metadata)throw new g0('Decode error - map field "metadata" had too many elements');let f=r.Peer$metadataEntry.codec().decode(s,s.uint32());a.metadata.set(f.key,f.value);break}case 7:{if(i.limits?.tags!=null&&a.tags.size===i.limits.tags)throw new g0('Decode error - map field "tags" had too many elements');let f=r.Peer$tagsEntry.codec().decode(s,s.uint32(),{limits:{value:i.limits?.tags$value}});a.tags.set(f.key,f.value);break}case 8:{a.updated=s.uint64Number();break}default:{s.skipType(u&7);break}}}return a})),n),r.encode=s=>Or(s,r.codec()),r.decode=(s,o)=>Nr(s,r.codec(),o)})(Ho||(Ho={}));var jm;(function(r){let e;r.codec=()=>(e==null&&(e=Mr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={multiaddr:fe(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.multiaddr=t.bytes();break}case 2:{o.isCertified=t.bool();break}case 3:{o.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Or(t,r.codec()),r.decode=(t,n)=>Nr(t,r.codec(),n)})(jm||(jm={}));var Qm;(function(r){let e;r.codec=()=>(e==null&&(e=Mr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={value:0},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.value=t.uint32();break}case 2:{o.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Or(t,r.codec()),r.decode=(t,n)=>Nr(t,r.codec(),n)})(Qm||(Qm={}));function CY(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());let n=Dm(e.publicKey,t);return HC(n)}function dD(r,e,t){let n=Ho.decode(e);return Gu(r,n,t)}function Gu(r,e,t){let n=new Map,s=BigInt(Date.now());for(let[o,i]of e.tags.entries())i.expiry!=null&&i.expiry<s||n.set(o,i);return{...e,id:CY(r,e),addresses:e.addresses.filter(({observed:o})=>o!=null&&o>Date.now()-t).map(({multiaddr:o,isCertified:i})=>({multiaddr:Gc(o),isCertified:i??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function pD(r,e){return DY(r.addresses,e.addresses)&&BY(r.protocols,e.protocols)&&PY(r.publicKey,e.publicKey)&&LY(r.peerRecordEnvelope,e.peerRecordEnvelope)&&kY(r.metadata,e.metadata)&&NY(r.tags,e.tags)}function DY(r,e){return gD(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!j(t.multiaddr,n.multiaddr)))}function BY(r,e){return gD(r,e,(t,n)=>t===n)}function PY(r,e){return mD(r,e)}function LY(r,e){return mD(r,e)}function kY(r,e){return yD(r,e,(t,n)=>j(t,n))}function NY(r,e){return yD(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function mD(r,e){return r==null&&e==null?!0:r!=null&&e!=null?j(r,e):!1}function gD(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function yD(r,e,t){if(r.size!==e.size)return!1;for(let[n,s]of r.entries()){let o=e.get(n);if(o==null||!t(s,o))return!1}return!0}var qo="/",bD=new TextEncoder().encode(qo),Jm=bD[0],eg=class r{constructor(e,t){l(this,"_buf");if(typeof e=="string")this._buf=H(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Jm)throw new Error("Invalid key")}toString(e="utf8"){return z(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(qo))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=bD),this._buf[0]!==Jm){let e=new Uint8Array(this._buf.byteLength+1);e.fill(Jm,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Jm;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;let o=t[s],i=n[s];if(o<i)return!0;if(o>i)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(qo).slice(1)}type(){return OY(this.baseNamespace())}name(){return MY(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(qo)||(e+=qo),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(qo):new r(e.slice(0,-1).join(qo))}child(e){return this.toString()===qo?e:e.toString()===qo?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...UY(e.map(t=>t.namespaces()))])}};function OY(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function MY(r){let e=r.split(":");return e[e.length-1]}function UY(r){return[].concat(...r)}var b9="/peers/";function k0(r){if(!Tu(r)||r.type==null)throw new Be("Invalid PeerId");let e=r.toCID().toString();return new eg(`${b9}${e}`)}async function wD(r,e,t,n,s){let o=new Map;for(let i of t){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=Gc(i.multiaddr)),!km(i.multiaddr))throw new Be("Multiaddr was invalid");if(!await e(r,i.multiaddr,s))continue;let a=i.isCertified??!1,c=i.multiaddr.toString(),u=o.get(c);u!=null?i.isCertified=u.isCertified||a:o.set(c,{multiaddr:i.multiaddr,isCertified:a})}return[...o.values()].sort((i,a)=>i.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:i,multiaddr:a})=>{let c=a.getComponents().find(u=>u.code===421)?.value;return r.equals(c)&&(a=a.decapsulate(Gc(`/p2p/${r}`))),{isCertified:i,multiaddr:a.bytes}})}async function rg(r,e,t,n){if(e==null)throw new Be("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new Be("publicKey bytes do not match peer id publicKey bytes");let s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new Be("peer id did not match existing peer id");let o=s?.addresses??[],i=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,u=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(o=[],e.multiaddrs!=null&&o.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&o.push(...e.addresses)),e.protocols!=null&&(i=new Set(e.protocols)),e.metadata!=null){let d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=tg(d,{validate:xD})}if(e.tags!=null){let d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=tg(d,{validate:ED,map:vD})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&o.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&o.push(...e.addresses),e.protocols!=null&&(i=new Set([...i,...e.protocols])),e.metadata!=null){let d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[p,y]of d)y==null?a.delete(p):a.set(p,y);a=tg([...a.entries()],{validate:xD})}if(e.tags!=null){let d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),p=new Map(c);for(let[y,x]of d)x==null?p.delete(y):p.set(y,x);c=tg([...p.entries()],{validate:ED,map:vD})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}let f;s?.id.publicKey!=null?f=On(s.id.publicKey):e.publicKey!=null?f=On(e.publicKey):r.publicKey!=null&&(f=On(r.publicKey));let h={addresses:await wD(r,n.addressFilter??(async()=>!0),o,n.existingPeer?.peerPB.addresses,n),protocols:[...i.values()].sort((d,p)=>d.localeCompare(p)),metadata:a,tags:c,publicKey:f,peerRecordEnvelope:u};return h.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(p=>j(p.multiaddr,p.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete h.publicKey,h}function tg(r,e){let t=new Map;for(let[n,s]of r)s!=null&&e.validate(n,s);for(let[n,s]of r.sort(([o],[i])=>o.localeCompare(i)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function xD(r,e){if(typeof r!="string")throw new Be("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new Be("Metadata value must be a Uint8Array")}function ED(r,e){if(typeof r!="string")throw new Be("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new Be("Tag value must be an integer");if(e.value<0||e.value>100)throw new Be("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new Be("Tag ttl must be an integer");if(e.ttl<0)throw new Be("Tag ttl must be between greater than 0")}}function vD(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));let n={value:e.value??0};return t!=null&&(n.expiry=t),n}function SD(r){let e=r.toString().split("/")[2],t=se.parse(e,yr);return Bm(t)}function w9(r,e,t){let n=SD(r);return dD(n,e,t)}function KY(r,e){return{prefix:b9,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(w9(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(w9(n.key,n.value,e),w9(s.key,s.value,e)))}}var an,ng,sg,og,ig=class{constructor(e,t={}){ne(this,an);l(this,"peerId");l(this,"datastore");l(this,"locks");l(this,"addressFilter");l(this,"log");l(this,"maxAddressAge");l(this,"maxPeerAge");this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=f9({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:y9({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){let n=this.getLock(e);try{let s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){let n=this.getLock(e);try{let s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(k0(e),t)}async load(e,t){let n=k0(e),s=await this.datastore.get(n,t),o=Ho.decode(s);if(ee(this,an,og).call(this,e,o))throw await this.datastore.delete(n,t),new Iu;return Gu(e,o,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){let s=await ee(this,an,ng).call(this,e,n),o=await rg(e,t,"patch",{...n,addressFilter:this.addressFilter});return ee(this,an,sg).call(this,e,o,s)}async patch(e,t,n){let s=await ee(this,an,ng).call(this,e,n),o=await rg(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return ee(this,an,sg).call(this,e,o,s)}async merge(e,t,n){let s=await ee(this,an,ng).call(this,e,n),o=await rg(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return ee(this,an,sg).call(this,e,o,s)}async*all(e){for await(let{key:t,value:n}of this.datastore.query(KY(e??{},this.maxAddressAge),e)){let s=SD(t);if(s.equals(this.peerId))continue;let o=Ho.decode(n);if(ee(this,an,og).call(this,s,o)){await this.datastore.delete(t,e);continue}yield Gu(s,o,this.peerId.equals(s)?1/0:this.maxAddressAge)}}};an=new WeakSet,ng=async function(e,t){try{let n=k0(e),s=await this.datastore.get(n,t),o=Ho.decode(s);if(ee(this,an,og).call(this,e,o))throw await this.datastore.delete(n,t),new Iu;return{peerPB:o,peer:Gu(e,o,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}},sg=async function(e,t,n,s){t.updated=Date.now();let o=Ho.encode(t);return await this.datastore.put(k0(e),o,s),{peer:Gu(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!pD(t,n.peerPB)}},og=function(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;let n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,o=t.addresses.filter(i=>i.observed!=null&&i.observed>s);return n&&o.length===0};var _D,Wu,ag;_D=Symbol.toStringTag;var x9=class{constructor(e,t={}){ne(this,Wu);l(this,"store");l(this,"events");l(this,"peerId");l(this,"log");l(this,_D,"@libp2p/peer-store");this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new ig(e,t)}async forEach(e,t){for await(let n of this.store.all(t))e(n)}async all(e){return C0(this.store.all(e))}async delete(e,t){let n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){let n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){let s=await this.store.getWriteLock(e,n);try{let o=await this.store.save(e,t,n);return ee(this,Wu,ag).call(this,e,o),o.peer}finally{s?.()}}async patch(e,t,n){let s=await this.store.getWriteLock(e,n);try{let o=await this.store.patch(e,t,n);return ee(this,Wu,ag).call(this,e,o),o.peer}finally{s?.()}}async merge(e,t,n){let s=await this.store.getWriteLock(e,n);try{let o=await this.store.merge(e,t,n);return ee(this,Wu,ag).call(this,e,o),o.peer}finally{s?.()}}async consumePeerRecord(e,t,n){let s=Tu(t)?t:Tu(t?.expectedPeer)?t.expectedPeer:void 0,o=Tu(t)||t===void 0?n:t,i=await Vu.openAndCertify(e,Wc.DOMAIN,o),a=Bm(i.publicKey.toCID());if(s?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,a),!1;let c=Wc.createFromProtobuf(i.payload),u;try{u=await this.get(a,o)}catch(f){if(f.name!=="NotFoundError")throw f}if(u?.peerRecordEnvelope!=null){let f=Vu.createFromProtobuf(u.peerRecordEnvelope),h=Wc.createFromProtobuf(f.payload);if(h.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",h.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(f=>({isCertified:!0,multiaddr:f}))},o),!0}};Wu=new WeakSet,ag=function(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))};function AD(r,e={}){return new x9(r,e)}var zt=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMultiaddrError")}};l(zt,"name","InvalidMultiaddrError");var qs=class extends Error{constructor(){super(...arguments);l(this,"name","ValidationError")}};l(qs,"name","ValidationError");var N0=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidParametersError")}};l(N0,"name","InvalidParametersError");var O0=class extends Error{constructor(){super(...arguments);l(this,"name","UnknownProtocolError")}};l(O0,"name","UnknownProtocolError");function v9(r){return e=>z(e,r)}function S9(r){return e=>H(e,r)}function Yu(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Zc(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function ID(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=H(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=Zc(n);return we([t,s],t.length+s.length)}function TD(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=yr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=Zc(n);return we([t,s],t.length+s.length)}function _9(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=z(e,"base32"),s=Yu(t);return`${n}:${s}`}var A9=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new zt("Invalid byte value in IP address");e[n]=s}),e},RD=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=gt(t[n]),i;o&&(i=A9(t[n]),t[n]=z(i.subarray(0,2),"base16")),i!=null&&++n<8&&t.splice(n,0,z(i.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let o=parseInt(t[n],16);if(isNaN(o)||o<0||o>65535)throw new zt("Invalid byte value in IP address");s[e++]=o>>8&255,s[e++]=o&255}return s},CD=function(r){if(r.byteLength!==4)throw new zt("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},DD=function(r){if(r.byteLength!==16)throw new zt("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let s=r[n],o=r[n+1],i=`${s.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`;e.push(i)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new zt(`Invalid IPv6 address "${t}"`)}};function BD(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new zt(`Invalid IPv6 address "${r}"`)}}var E9=Object.values(Qr).map(r=>r.decoder),FY=(function(){let r=E9[0].or(E9[1]);return E9.slice(2).forEach(e=>r=r.or(e)),r})();function PD(r){return FY.decode(r)}function LD(r){return e=>r.encoder.encode(e)}function VY(r){if(parseInt(r).toString()!==r)throw new qs("Value must be an integer")}function HY(r){if(r<0)throw new qs("Value must be a positive integer, or zero")}function qY(r){return e=>{if(e>r)throw new qs(`Value must be smaller than or equal to ${r}`)}}function zY(...r){return e=>{for(let t of r)t(e)}}var M0=zY(VY,HY,qY(65535));var $t=-1,I9=class{constructor(){l(this,"protocolsByCode",new Map);l(this,"protocolsByName",new Map)}getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new O0(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},zo=new I9,oZ=[{code:4,name:"ip4",size:32,valueToBytes:A9,bytesToValue:CD,validate:r=>{if(!gt(r))throw new qs(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Zc,bytesToValue:Yu,validate:M0},{code:273,name:"udp",size:16,valueToBytes:Zc,bytesToValue:Yu,validate:M0},{code:33,name:"dccp",size:16,valueToBytes:Zc,bytesToValue:Yu,validate:M0},{code:41,name:"ip6",size:128,valueToBytes:RD,bytesToValue:DD,stringToValue:BD,validate:r=>{if(!Nn(r))throw new qs(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:$t},{code:43,name:"ipcidr",size:8,bytesToValue:v9("base10"),valueToBytes:S9("base10")},{code:53,name:"dns",size:$t},{code:54,name:"dns4",size:$t},{code:55,name:"dns6",size:$t},{code:56,name:"dnsaddr",size:$t},{code:132,name:"sctp",size:16,valueToBytes:Zc,bytesToValue:Yu,validate:M0},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:$t,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:$t,bytesToValue:v9("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?S9("base58btc")(r):se.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:_9,valueToBytes:ID},{code:445,name:"onion3",size:296,bytesToValue:_9,valueToBytes:TD},{code:446,name:"garlic64",size:$t},{code:447,name:"garlic32",size:$t},{code:448,name:"tls"},{code:449,name:"sni",size:$t},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:$t,bytesToValue:LD(xo),valueToBytes:PD},{code:480,name:"http"},{code:481,name:"http-path",size:$t,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:$t}];oZ.forEach(r=>{zo.addProtocol(r)});function kD(r){let e=[],t=0;for(;t<r.length;){let n=Nt(r,t),s=zo.getProtocol(n),o=ce(n),i=iZ(s,r,t+o),a=0;i>0&&s.size===$t&&(a=ce(i));let c=o+a+i,u={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(i>0){let f=t+o+a,h=r.subarray(f,f+i);u.value=s.bytesToValue?.(h)??z(h)}e.push(u),t+=c}return e}function ND(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let s=zo.getProtocol(n.code),o=ce(n.code),i,a=0,c=0;n.value!=null&&(i=s.valueToBytes?.(n.value)??H(n.value),a=i.byteLength,s.size===$t&&(c=ce(a)));let u=new Uint8Array(o+c+a),f=0;Et(n.code,u,f),f+=o,i!=null&&(s.size===$t&&(Et(a,u,f),f+=c),u.set(i,f)),n.bytes=u}t.push(n.bytes),e+=n.bytes.byteLength}return we(t,e)}function OD(r){if(r.charAt(0)!=="/")throw new zt('String multiaddr must start with "/"');let e=[],t="protocol",n="",s="";for(let o=1;o<r.length;o++){let i=r.charAt(o);i!=="/"&&(t==="protocol"?s+=r.charAt(o):n+=r.charAt(o));let a=o===r.length-1;if(i==="/"||a){let c=zo.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new zt(`Component ${s} was missing value`);t="value"}else if(t==="value"){let u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new zt(`Component ${s} was missing value`);u.value=c.stringToValue?.(n)??n}e.push(u),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new zt("Incomplete multiaddr");return e}function MD(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=zo.getProtocol(e.code);if(t==null)throw new zt(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function iZ(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Nt(e,t)}var aZ=Symbol.for("nodejs.util.inspect.custom"),F9=Symbol.for("@multiformats/multiaddr");function cZ(r){if(r==null&&(r="/"),nf(r))return r.getComponents();if(r instanceof Uint8Array)return kD(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),OD(r);if(Array.isArray(r))return r;throw new zt("Must be a string, Uint8Array, Component[], or another Multiaddr")}var UD,fs,tf,rf,ef=class ef{constructor(e="/",t={}){l(this,UD,!0);ne(this,fs);ne(this,tf);ne(this,rf);le(this,fs,cZ(e)),t.validate!==!1&&lZ(this)}get bytes(){return V(this,rf)==null&&le(this,rf,ND(V(this,fs))),V(this,rf)}toString(){return V(this,tf)==null&&le(this,tf,MD(V(this,fs))),V(this,tf)}toJSON(){return this.toString()}getComponents(){return[...V(this,fs).map(e=>({...e}))]}encapsulate(e){let t=new ef(e);return new ef([...V(this,fs),...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new N0(`Address ${this.toString()} does not contain subaddress: ${t}`);return new ef(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=V(this,fs).length-1;n>-1;n--)if(V(this,fs)[n].code===e){t=n;break}return new ef(V(this,fs).slice(0,t),{validate:!1})}equals(e){return j(this.bytes,e.bytes)}[(UD=F9,aZ)](){return`Multiaddr(${this.toString()})`}};fs=new WeakMap,tf=new WeakMap,rf=new WeakMap;var hg=ef;function lZ(r){r.getComponents().forEach(e=>{let t=zo.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function nf(r){return!!r?.[F9]}function yt(r){return new hg(r)}var $o="/",KD=new TextEncoder().encode($o),dg=KD[0],U0=class r{constructor(e,t){l(this,"_buf");if(typeof e=="string")this._buf=H(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==dg)throw new Error("Invalid key")}toString(e="utf8"){return z(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join($o))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=KD),this._buf[0]!==dg){let e=new Uint8Array(this._buf.byteLength+1);e.fill(dg,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===dg;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;let o=t[s],i=n[s];if(o<i)return!0;if(o>i)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split($o).slice(1)}type(){return uZ(this.baseNamespace())}name(){return fZ(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith($o)||(e+=$o),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r($o):new r(e.slice(0,-1).join($o))}child(e){return this.toString()===$o?e:e.toString()===$o?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...hZ(e.map(t=>t.namespaces()))])}};function uZ(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function fZ(r){let e=r.split(":");return e[e.length-1]}function hZ(r){return[].concat(...r)}var sf=class sf extends Error{constructor(t="Not Found"){super(t);l(this,"name",sf.name);l(this,"code",sf.code)}};l(sf,"name","NotFoundError"),l(sf,"code","ERR_NOT_FOUND");var pg=sf;function dZ(r){return r[Symbol.asyncIterator]!=null}function pZ(r){if(dZ(r))return(async()=>{for await(let e of r);})();for(let e of r);}var of=pZ;function mZ(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var af=mZ;function gZ(r){return r[Symbol.asyncIterator]!=null}function yZ(r,e){let t=0;if(gZ(r))return(async function*(){for await(let c of r)await e(c,t++)&&(yield c)})();let n=af(r),{value:s,done:o}=n.next();if(o===!0)return(function*(){})();let i=e(s,t++);if(typeof i.then=="function")return(async function*(){await i&&(yield s);for(let c of n)await e(c,t++)&&(yield c)})();let a=e;return(function*(){i===!0&&(yield s);for(let c of n)a(c,t++)&&(yield c)})()}var Qc=yZ;function bZ(r){return r[Symbol.asyncIterator]!=null}function wZ(r,e){return bZ(r)?(async function*(){yield*(await C0(r)).sort(e)})():(function*(){yield*C0(r).sort(e)})()}var V9=wZ;function xZ(r){return r[Symbol.asyncIterator]!=null}function EZ(r,e){return xZ(r)?(async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}})()}var K0=EZ;var mg=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await of(this.putMany(e,n)),e=[],await of(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let s=e.prefix;n=Qc(n,o=>o.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,o)=>Qc(s,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,o)=>V9(s,o),n)),e.offset!=null){let s=0,o=e.offset;n=Qc(n,()=>s++>=o)}return e.limit!=null&&(n=K0(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let s=e.prefix;n=Qc(n,o=>o.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,o)=>Qc(s,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,o)=>V9(s,o),n)),e.offset!=null){let s=e.offset,o=0;n=Qc(n,()=>o++>=s)}return e.limit!=null&&(n=K0(n,e.limit)),n}};var gg=class extends mg{constructor(){super();l(this,"data");this.data=new Map}put(t,n,s){return s?.signal?.throwIfAborted(),this.data.set(t.toString(),n),t}get(t,n){n?.signal?.throwIfAborted();let s=this.data.get(t.toString());if(s==null)throw new pg;return s}has(t,n){return n?.signal?.throwIfAborted(),this.data.has(t.toString())}delete(t,n){n?.signal?.throwIfAborted(),this.data.delete(t.toString())}*_all(t,n){n?.signal?.throwIfAborted();for(let[s,o]of this.data.entries())yield{key:new U0(s),value:o},n?.signal?.throwIfAborted()}*_allKeys(t,n){n?.signal?.throwIfAborted();for(let s of this.data.keys())yield new U0(s),n?.signal?.throwIfAborted()}};var et=r=>({match:e=>{let t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),me=(r,e)=>({match:t=>{let n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),FD=r=>({match:e=>r.match(e)===!1?e:!1}),Pe=r=>({match:e=>{let t=r.match(e);return t===!1?e:t}}),vr=(...r)=>({match:e=>{let t;for(let n of r){let s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),ze=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e}});function tt(...r){function e(s){if(s==null)return!1;let o=s.getComponents();for(let i of r){let a=i.match(o);if(a===!1)return!1;o=a}return o}function t(s){return e(s)!==!1}function n(s){let o=e(s);return o===!1?!1:o.length===0}return{matchers:r,matches:t,exactMatch:n}}var vZ=me(421),VD=tt(vZ),bg=me(54),wg=me(55),xg=me(56),q9=me(53),d6e=tt(bg,Pe(me(421))),p6e=tt(wg,Pe(me(421))),m6e=tt(xg,Pe(me(421))),g6e=tt(vr(q9,xg,bg,wg),Pe(me(421))),HD=ze(me(4),Pe(me(43))),qD=ze(Pe(me(42)),me(41),Pe(me(43))),z9=vr(HD,qD),Jc=vr(z9,q9,bg,wg,xg),y6e=tt(vr(z9,ze(vr(q9,xg,bg,wg),Pe(me(421))))),$9=tt(HD),G9=tt(qD),b6e=tt(z9),W9=ze(Jc,me(6)),F0=ze(Jc,me(273)),V0=tt(ze(W9,Pe(me(421)))),w6e=tt(F0),Y9=ze(F0,et(460),Pe(me(421))),Eg=ze(F0,et(461),Pe(me(421))),SZ=vr(Y9,Eg),x6e=tt(Y9),zD=tt(Eg),H9=vr(Jc,W9,F0,Y9,Eg),$D=vr(ze(H9,et(477),Pe(me(421)))),el=tt($D),GD=vr(ze(H9,et(478),Pe(me(421))),ze(H9,et(448),Pe(me(449)),et(477),Pe(me(421)))),H0=tt(GD),WD=ze(F0,et(280),Pe(me(466)),Pe(me(466)),Pe(me(421))),Z9=tt(WD),YD=ze(Eg,et(465),Pe(me(466)),Pe(me(466)),Pe(me(421))),X9=tt(YD),yg=vr($D,GD,ze(W9,Pe(me(421))),ze(SZ,Pe(me(421))),ze(Jc,Pe(me(421))),WD,YD,me(421)),E6e=tt(yg),_Z=ze(Pe(yg),et(290),FD(et(281)),Pe(me(421))),tl=tt(_Z),AZ=vr(ze(yg,et(290),et(281),Pe(me(421))),ze(yg,et(281),Pe(me(421))),ze(et(281),Pe(me(421)))),j9=tt(AZ),IZ=vr(ze(Jc,me(6),et(480),Pe(me(421))),ze(Jc,et(480),Pe(me(421)))),v6e=tt(IZ),TZ=ze(Jc,vr(ze(me(6,"443"),et(480)),ze(me(6),et(443)),ze(me(6),et(448),et(480)),ze(et(448),et(480)),et(448),et(443)),Pe(me(421))),S6e=tt(TZ),RZ=vr(ze(me(777),Pe(me(421)))),_6e=tt(RZ),CZ=vr(ze(me(400),Pe(me(421)))),A6e=tt(CZ);var ZD=864e13;var vg=class{constructor(e,t={}){l(this,"log");l(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=xr({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){let t=De(e),n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(let s of this.mappings.values())if(s.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);let s=Eu(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?ZD-Date.now():0,lastVerified:s?ZD-Date.now():void 0})})}remove(e){let t=De(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(let[s,o]of this.mappings.entries())o.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",s,o.domain),this.mappings.delete(s),n=n||o.verified);return n}getAll(e){let t=[];for(let n=0;n<e.length;n++){let s=e[n].multiaddr;if(!ar(s))continue;let o=De(s);for(let[i,a]of this.mappings.entries()){if(o.host!==i)continue;let c=this.maybeAddSNIComponent(s,a.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:a.verified,type:"dns-mapping",expires:a.expires,lastVerified:a.lastVerified}))}}return t}maybeAddSNIComponent(e,t){let n=e.getComponents();for(let s=0;s<n.length;s++)if(n[s].code===448&&n[s+1]?.code!==449)return n.splice(s+1,0,{name:"sni",code:449,value:t}),yt(n)}confirm(e,t){let n=De(e),s=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(s=n.sni);let o=!1;for(let[i,a]of this.mappings.entries())a.domain===s&&(this.log("marking %s to %s DNS mapping as verified",i,a.domain),o=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return o}unconfirm(e,t){let n=De(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;let s=n.sni??n.host,o=!1;for(let[i,a]of this.mappings.entries())a.domain===s&&(this.log("removing verification of %s to %s DNS mapping",i,a.domain),o=o||a.verified,a.verified=!1,a.expires=Date.now()+t);return o}};var Sg=class{constructor(e,t={}){l(this,"log");l(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=xr({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){let t=De(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(let n of this.mappings.values())for(let s of n)if(s.externalIp===t.host)return!0;return!1}add(e,t,n,s=t,o="tcp"){let i=`${e}-${t}-${o}`,a=this.mappings.get(i)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:gt(n)?4:6,protocol:o,verified:!1,expires:0};a.push(c),this.mappings.set(i,a)}remove(e){let t=De(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(let[s,o]of this.mappings.entries()){for(let i=0;i<o.length;i++){let a=o[i];a.externalIp===t.host&&a.externalPort===t.port&&a.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,t.host,t.port,t.protocol),n=n||a.verified,o.splice(i,1),i--)}o.length===0&&this.mappings.delete(s)}return n}getAll(e){let t=[];for(let{multiaddr:n}of e){if(!ar(n))continue;let s=De(n);if(s.type!=="ip4"&&s.type!=="ip6")continue;let o;if(s.protocol==="tcp"?o=`${s.host}-${s.port}-tcp`:s.protocol==="udp"&&(o=`${s.host}-${s.port}-udp`),o==null)continue;let i=this.mappings.get(o);if(i!=null)for(let a of i)t.push({multiaddr:this.maybeOverrideIp(n,a.externalIp,a.externalFamily,a.protocol,a.externalPort),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}maybeOverrideIp(e,t,n,s,o){let i=e.getComponents(),a=i.findIndex(u=>u.code===4||u.code===41),c=i.findIndex(u=>u.name===s);return a>-1&&c>-1?(i[a].value=t,i[a].code=n===4?4:41,i[c].value=`${o}`,yt(i)):e}confirm(e,t){if(!ar(e))return!1;let n=De(e),s=!1;for(let o of this.mappings.values())for(let i of o)i.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",i.internalIp,i.externalIp),s=i.verified,i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now());return s}unconfirm(e,t){if(!ar(e))return!1;let n=De(e),s=!1;for(let o of this.mappings.values())for(let i=0;i<o.length;i++){let a=o[i];a.externalIp===n.host&&a.externalPort===n.port&&a.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,n.host,n.port,n.protocol),s=s||a.verified,a.verified=!1,a.expires=Date.now()+t)}return s}};var DZ={maxObservedAddresses:10},_g=class{constructor(e,t={}){l(this,"log");l(this,"addresses");l(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=xr({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??DZ.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(let t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Do(e)||cR(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:yt(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){let t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){let n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},o=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),o}};var BZ={maxObservedAddresses:10},Ag=class{constructor(e,t={}){l(this,"log");l(this,"addresses");l(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=xr({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??BZ.maxObservedAddresses}get(e,t){if(Do(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};let n=this.toKey(e),s=this.addresses.get(n);return s==null&&(s={verified:!ar(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){let t=this.toKey(e);return this.addresses.has(t)}remove(e){let t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){let n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},o=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),o}unconfirm(e,t){let n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},o=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),o}toKey(e){if(!ar(e))return e.toString();let t=De(e);return`${t.host}-${t.port}-${t.protocol}`}};var XD=6e4,jD={maxObservedAddresses:10,addressVerificationTTL:XD*10,addressVerificationRetry:XD*5},PZ=r=>r;function Q9(r,e){let t=r.getComponents().findLast(n=>n.code===421)?.value;return t!=null&&Ms(t).equals(e)&&(r=r.decapsulate(yt(`/p2p/${e.toString()}`))),r}var QD;QD=Symbol.toStringTag;var Ig=class{constructor(e,t={}){l(this,"log");l(this,"components");l(this,"listen");l(this,"announce");l(this,"appendAnnounce");l(this,"announceFilter");l(this,"observed");l(this,"dnsMappings");l(this,"ipMappings");l(this,"transportAddresses");l(this,"observedAddressFilter");l(this,"addressVerificationTTL");l(this,"addressVerificationRetry");l(this,QD,"@libp2p/address-manager");let{listen:n=[],announce:s=[],appendAnnounce:o=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(i=>i.toString()),this.announce=new Set(s.map(i=>i.toString())),this.appendAnnounce=new Set(o.map(i=>i.toString())),this.observed=new _g(e,t),this.dnsMappings=new vg(e,t),this.ipMappings=new Sg(e,t),this.transportAddresses=new Ag(e,t),this.announceFilter=t.announceFilter??PZ,this.observedAddressFilter=Yd(1024),this.addressVerificationTTL=t.addressVerificationTTL??jD.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??jD.addressVerificationRetry,this._updatePeerStoreAddresses=Qd(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){let e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===421)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>yt(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>yt(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>yt(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){let t=De(e),n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=Q9(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Q9(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Q9(e,this.components.peerId);let n=!1;this.observed.has(e)&&!this.observed.remove(e)&&n&&(n=!1),this.transportAddresses.has(e)&&!this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(e)&&!this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(e)&&!this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{let s=yt(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(yt(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,o="tcp"){this.ipMappings.add(e,t,n,s,o),this.observed.removePrefixed(`/ip${gt(n)?4:6}/${n}/${o}/${s}`)}removePublicAddressMapping(e,t,n,s=t,o="tcp"){this.ipMappings.remove(yt(`/ip${gt(n)?4:6}/${n}/${o}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!ar(e))return!1;let t=De(e);if(t.type!=="ip4"||Eu(t.host)===!0)return!1;let n=this.components.transportManager.getListeners(),s=[o=>el.exactMatch(o)||H0.exactMatch(o),o=>V0.exactMatch(o),o=>zD.exactMatch(o)];for(let o of s){if(!o(e))continue;let i=n.filter(u=>u.getAddrs().filter(f=>De(f).type==="ip4"&&o(f)).length>0);if(i.length!==1)continue;let a=i[0].getAddrs().filter(u=>!Xd(u)).pop();if(a==null)continue;let c=De(a);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}};var JD;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(JD||(JD={}));var Tg=class extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}},Rg=class extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}},cf=class extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}},q0=class extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}},Cg=class extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}},Dg=class extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}},Bg=class extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}},z0=class extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}},Pg=class extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}},Lg=class extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}},kg=class extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}},Ng=class extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}},Og=class extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}},fa=class extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}},rl=class extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}},Mg=class extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}},Ug=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}};var J9=class{constructor(e={}){l(this,"components",{});l(this,"_started",!1);this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Y2())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>b2(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},LZ=["metrics","connectionProtector","dns"],kZ=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function eB(r={}){let e=new J9(r);return new Proxy(e,{get(n,s,o){if(typeof s=="string"&&!kZ.includes(s)){let i=e.components[s];if(i==null&&!LZ.includes(s))throw new Tg(`${s} not set`);return i}return Reflect.get(n,s,o)},set(n,s,o){return typeof s=="string"?e.components[s]=o:Reflect.set(n,s,o),!0}})}function tB(r){let e={};for(let t of Object.values(r.components))for(let n of NZ(t))e[n]=!0;for(let t of Object.values(r.components))for(let n of OZ(t))if(e[n]!==!0)throw new Rg(`Service "${MZ(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function NZ(r){return Array.isArray(r?.[md])?r[md]:[]}function OZ(r){return Array.isArray(r?.[X5])?r[X5]:[]}function MZ(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function rB(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>el.matches(e)?!0:Do(e)),r}var UZ=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function KZ(r,e,t){let n,s=new Promise((o,i)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:u,removeListener:f}=UZ(r),h=async(...p)=>{let y=t.multiArgs?p:p[0];if(t.filter)try{if(!await t.filter(y))return}catch(x){n(),i(x);return}c.push(y),t.count===c.length&&(n(),o(c))},d=(...p)=>{n(),i(t.rejectionMultiArgs?p:p[0])};n=()=>{for(let p of a)f(p,h);for(let p of t.rejectionEvents)a.includes(p)||f(p,d)};for(let p of a)u(p,h);for(let p of t.rejectionEvents)a.includes(p)||u(p,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(c)});if(s.cancel=n,typeof t.timeout=="number"){let o=bn(s,{milliseconds:t.timeout});return o.cancel=()=>{n(),o.clear()},o}return s}function $0(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=KZ(r,e,t),s=n.then(o=>o[0]);return s.cancel=n.cancel,s}var ve=class extends Event{constructor(t,n){super(t);l(this,"type");l(this,"detail");this.type=t,this.detail=n}};function Kg(r){if(kA(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){let n=e[0].getComponents().findLast(s=>s.code===421)?.value;t=n==null?void 0:Ms(n),e.forEach(s=>{if(!nf(s))throw new yo("Invalid multiaddr");let o=s.getComponents().findLast(i=>i.code===421)?.value;if(o==null){if(t!=null)throw new be("Multiaddrs must all have the same peer id or have no peer id")}else{let i=Ms(o);if(t?.equals(i)!==!0)throw new be("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!VD.exactMatch(n)),{peerId:t,multiaddrs:e}}var FZ=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function nB(r,e){let t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??FZ;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function G0(r){let e=De(r),t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new be(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new be(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new Lc(e.host,t)}function ew(r){return!tl.exactMatch(r)}function Fg(r,e,t){if(r==null||e==null)return;let n=e.sort((o,i)=>o.direct?-1:i.direct?1:0).find(o=>o.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(o=>ew(o)))return n}var Vg=class{constructor(e,t={}){l(this,"connectionManager");l(this,"peerStore");l(this,"allow");l(this,"events");l(this,"log");this.allow=(t.allow??[]).map(n=>G0(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;let s=new Co;for(let c of e){let u=c.remotePeer;if(!s.has(u)){s.set(u,0);try{let f=await this.peerStore.get(u);s.set(u,[...f.tags.values()].reduce((h,d)=>h+d.value,0))}catch(f){f.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",f)}}}let o=this.sortConnections(e,s),i=Math.max(t-n,0),a=[];for(let c of o)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(f=>{if(ar(c.remoteAddr)){let h=De(c.remoteAddr);return f.contains(h.host)}return!0})||a.push(c),a.length===i)break;await Promise.all(a.map(async c=>{await nB(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,s)=>{let o=n.timeline.open,i=s.timeline.open;return o<i?1:o>i?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{let o=t.get(n.remotePeer)??0,i=t.get(s.remotePeer)??0;return o>i?1:o<i?-1:0})}};var sB="last-dial-failure",oB="last-dial-success";var iB=100,Hg=50;function VZ(r,e){let t=V0.exactMatch(r.multiaddr),n=V0.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;let s=H0.exactMatch(r.multiaddr),o=H0.exactMatch(e.multiaddr);if(s&&!o)return-1;if(!s&&o)return 1;let i=el.exactMatch(r.multiaddr),a=el.exactMatch(e.multiaddr);if(i&&!a)return-1;if(!i&&a)return 1;let c=j9.exactMatch(r.multiaddr),u=j9.exactMatch(e.multiaddr);if(c&&!u)return-1;if(!c&&u)return 1;let f=Z9.exactMatch(r.multiaddr),h=Z9.exactMatch(e.multiaddr);if(f&&!h)return-1;if(!f&&h)return 1;let d=X9.exactMatch(r.multiaddr),p=X9.exactMatch(e.multiaddr);return d&&!p?-1:!d&&p?1:0}function HZ(r,e){let t=Xd(r.multiaddr),n=Xd(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function qZ(r,e){let t=Do(r.multiaddr),n=Do(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function zZ(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function $Z(r,e){let t=tl.exactMatch(r.multiaddr),n=tl.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function aB(r){return r.sort(VZ).sort(zZ).sort($Z).sort(qZ).sort(HZ)}var W0=class extends AggregateError{constructor(){super(...arguments);l(this,"name","DNSQueryFailedError")}};l(W0,"name","DNSQueryFailedError");var Z0=go(lB(),1);var rw=class r extends Error{constructor(t,n){super(t,n);l(this,"name","TimeoutError");Error.captureStackTrace?.(this,r)}},uB=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function nw(r,e){let{milliseconds:t,fallback:n,message:s,customTimers:o={setTimeout,clearTimeout},signal:i}=e,a,c,f=new Promise((h,d)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(i?.aborted){d(uB(i));return}if(i&&(c=()=>{d(uB(i))},i.addEventListener("abort",c,{once:!0})),r.then(h,d),t===Number.POSITIVE_INFINITY)return;let p=new rw;a=o.setTimeout.call(void 0,()=>{if(n){try{h(n())}catch(y){d(y)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?h():s instanceof Error?d(s):(p.message=s??`Promise timed out after ${t} milliseconds`,d(p))},t)}).finally(()=>{f.clear(),c&&i&&i.removeEventListener("abort",c)});return f.clear=()=>{o.clearTimeout.call(void 0,a),a=void 0},f}function sw(r,e,t){let n=0,s=r.length;for(;s>0;){let o=Math.trunc(s/2),i=n+o;t(r[i],e)<=0?(n=++i,s-=o+1):s=o}return n}var Kn,X0=class{constructor(){ne(this,Kn,[])}enqueue(e,t){let{priority:n=0,id:s}=t??{},o={priority:n,id:s,run:e};if(this.size===0||V(this,Kn)[this.size-1].priority>=n){V(this,Kn).push(o);return}let i=sw(V(this,Kn),o,(a,c)=>c.priority-a.priority);V(this,Kn).splice(i,0,o)}setPriority(e,t){let n=V(this,Kn).findIndex(o=>o.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[s]=V(this,Kn).splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return V(this,Kn).shift()?.run}filter(e){return V(this,Kn).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return V(this,Kn).length}};Kn=new WeakMap;var lf,hs,zs,uf,ff,hf,ha,J0,df,$s,Go,Bt,e1,_r,sl,Wo,Gg,ol,de,fB,hB,dB,pB,mB,ow,iw,gB,zg,aw,cw,$g,nl,yB,j0,lw,Q0=class extends Z0.default{constructor(t){super();ne(this,de);ne(this,lf);ne(this,hs);ne(this,zs,0);ne(this,uf);ne(this,ff,!1);ne(this,hf,!1);ne(this,ha);ne(this,J0,0);ne(this,df,0);ne(this,$s);ne(this,Go);ne(this,Bt);ne(this,e1);ne(this,_r,0);ne(this,sl);ne(this,Wo);ne(this,Gg,1n);ne(this,ol,new Map);l(this,"timeout");if(t={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:X0,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${t.intervalCap?.toString()??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${t.interval?.toString()??""}\` (${typeof t.interval})`);if(le(this,lf,t.carryoverIntervalCount??t.carryoverConcurrencyCount??!1),le(this,hs,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),le(this,uf,t.intervalCap),le(this,ha,t.interval),le(this,Bt,new t.queueClass),le(this,e1,t.queueClass),this.concurrency=t.concurrency,t.timeout!==void 0&&!(Number.isFinite(t.timeout)&&t.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${t.timeout}\` (${typeof t.timeout})`);this.timeout=t.timeout,le(this,Wo,t.autoStart===!1),ee(this,de,yB).call(this)}get concurrency(){return V(this,sl)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);le(this,sl,t),ee(this,de,$g).call(this)}setPriority(t,n){if(typeof n!="number"||!Number.isFinite(n))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${n}\` (${typeof n})`);V(this,Bt).setPriority(t,n)}async add(t,n={}){return n.id??(n.id=(rs(this,Gg)._++).toString()),n={timeout:this.timeout,...n},new Promise((s,o)=>{let i=Symbol(`task-${n.id}`);V(this,Bt).enqueue(async()=>{rs(this,_r)._++,V(this,ol).set(i,{id:n.id,priority:n.priority??0,startTime:Date.now(),timeout:n.timeout});let a;try{try{n.signal?.throwIfAborted()}catch(f){throw V(this,hs)||rs(this,zs)._--,V(this,ol).delete(i),f}let c=t({signal:n.signal});if(n.timeout&&(c=nw(Promise.resolve(c),{milliseconds:n.timeout,message:`Task timed out after ${n.timeout}ms (queue has ${V(this,_r)} running, ${V(this,Bt).size} waiting)`})),n.signal){let{signal:f}=n;c=Promise.race([c,new Promise((h,d)=>{a=()=>{d(f.reason)},f.addEventListener("abort",a,{once:!0})})])}let u=await c;s(u),this.emit("completed",u)}catch(c){o(c),this.emit("error",c)}finally{a&&n.signal?.removeEventListener("abort",a),V(this,ol).delete(i),queueMicrotask(()=>{ee(this,de,dB).call(this)})}},n),this.emit("add"),ee(this,de,zg).call(this)})}async addAll(t,n){return Promise.all(t.map(async s=>this.add(s,n)))}start(){return V(this,Wo)?(le(this,Wo,!1),ee(this,de,$g).call(this),this):this}pause(){le(this,Wo,!0)}clear(){le(this,Bt,new(V(this,e1))),ee(this,de,lw).call(this)}async onEmpty(){V(this,Bt).size!==0&&await ee(this,de,nl).call(this,"empty")}async onSizeLessThan(t){V(this,Bt).size<t||await ee(this,de,nl).call(this,"next",()=>V(this,Bt).size<t)}async onIdle(){V(this,_r)===0&&V(this,Bt).size===0||await ee(this,de,nl).call(this,"idle")}async onPendingZero(){V(this,_r)!==0&&await ee(this,de,nl).call(this,"pendingZero")}async onRateLimit(){this.isRateLimited||await ee(this,de,nl).call(this,"rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await ee(this,de,nl).call(this,"rateLimitCleared")}async onError(){return new Promise((t,n)=>{let s=o=>{this.off("error",s),n(o)};this.on("error",s)})}get size(){return V(this,Bt).size}sizeBy(t){return V(this,Bt).filter(t).length}get pending(){return V(this,_r)}get isPaused(){return V(this,Wo)}get isRateLimited(){return V(this,ff)}get isSaturated(){return V(this,_r)===V(this,sl)&&V(this,Bt).size>0||this.isRateLimited&&V(this,Bt).size>0}get runningTasks(){return[...V(this,ol).values()].map(t=>({...t}))}};lf=new WeakMap,hs=new WeakMap,zs=new WeakMap,uf=new WeakMap,ff=new WeakMap,hf=new WeakMap,ha=new WeakMap,J0=new WeakMap,df=new WeakMap,$s=new WeakMap,Go=new WeakMap,Bt=new WeakMap,e1=new WeakMap,_r=new WeakMap,sl=new WeakMap,Wo=new WeakMap,Gg=new WeakMap,ol=new WeakMap,de=new WeakSet,fB=function(){return V(this,hs)||V(this,zs)<V(this,uf)},hB=function(){return V(this,_r)<V(this,sl)},dB=function(){rs(this,_r)._--,V(this,_r)===0&&this.emit("pendingZero"),ee(this,de,zg).call(this),this.emit("next")},pB=function(){ee(this,de,cw).call(this),ee(this,de,aw).call(this),le(this,Go,void 0)},mB=function(){let t=Date.now();if(V(this,$s)===void 0){let n=V(this,J0)-t;if(n<0){if(V(this,df)>0){let s=t-V(this,df);if(s<V(this,ha))return ee(this,de,ow).call(this,V(this,ha)-s),!0}le(this,zs,V(this,lf)?V(this,_r):0)}else return ee(this,de,ow).call(this,n),!0}return!1},ow=function(t){V(this,Go)===void 0&&le(this,Go,setTimeout(()=>{ee(this,de,pB).call(this)},t))},iw=function(){V(this,$s)&&(clearInterval(V(this,$s)),le(this,$s,void 0))},gB=function(){V(this,Go)&&(clearTimeout(V(this,Go)),le(this,Go,void 0))},zg=function(){if(V(this,Bt).size===0)return ee(this,de,iw).call(this),this.emit("empty"),V(this,_r)===0&&(ee(this,de,gB).call(this),this.emit("idle")),!1;let t=!1;if(!V(this,Wo)){let n=!V(this,de,mB);if(V(this,de,fB)&&V(this,de,hB)){let s=V(this,Bt).dequeue();V(this,hs)||(rs(this,zs)._++,ee(this,de,j0).call(this)),this.emit("active"),le(this,df,Date.now()),s(),n&&ee(this,de,aw).call(this),t=!0}}return t},aw=function(){V(this,hs)||V(this,$s)!==void 0||(le(this,$s,setInterval(()=>{ee(this,de,cw).call(this)},V(this,ha))),le(this,J0,Date.now()+V(this,ha)))},cw=function(){V(this,zs)===0&&V(this,_r)===0&&V(this,$s)&&ee(this,de,iw).call(this),le(this,zs,V(this,lf)?V(this,_r):0),ee(this,de,$g).call(this),ee(this,de,j0).call(this)},$g=function(){for(;ee(this,de,zg).call(this););},nl=async function(t,n){return new Promise(s=>{let o=()=>{n&&!n()||(this.off(t,o),s())};this.on(t,o)})},yB=function(){V(this,hs)||(this.on("add",()=>{V(this,Bt).size>0&&ee(this,de,j0).call(this)}),this.on("next",()=>{ee(this,de,j0).call(this)}))},j0=function(){V(this,hs)||V(this,hf)||(le(this,hf,!0),queueMicrotask(()=>{le(this,hf,!1),ee(this,de,lw).call(this)}))},lw=function(){let t=V(this,ff),n=!V(this,hs)&&V(this,zs)>=V(this,uf)&&V(this,Bt).size>0;n!==t&&(le(this,ff,n),this.emit(n?"rateLimit":"rateLimitCleared"))};function Wg(r){let e=[xn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}var uw=60;function Yg(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:xn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:xn[e.type],TTL:e.TTL??e.ttl??uw,data:e.data instanceof Uint8Array?z(e.data):e.data}))}}var YZ=4;function fw(r,e={}){let t=new Q0({concurrency:e.queryConcurrency??YZ});return async(n,s={})=>{let o=new URLSearchParams;o.set("name",n),Wg(s.types).forEach(a=>{o.append("type",xn[a])}),s.onProgress?.(new ve("dns:query",n));let i=await t.add(async()=>{let a=await fetch(`${r}?${o}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=Yg(await a.json());return s.onProgress?.(new ve("dns:response",c)),c},{signal:s.signal});if(i==null)throw new Error("No DNS response received");return i}}function bB(){return[fw("https://cloudflare-dns.com/dns-query"),fw("https://dns.google/resolve")]}var xB=go(hw(),1);var dw=class{constructor(e){l(this,"lru");this.lru=(0,xB.default)(e)}get(e,t){let n=!0,s=[];for(let o of t){let i=this.getAnswers(e,o);if(i.length===0){n=!1;break}s.push(...i)}if(n)return Yg({answers:s})}getAnswers(e,t){let n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){let o=s.filter(i=>i.expires>Date.now()).map(({expires:i,value:a})=>({...a,TTL:Math.round((i-Date.now())/1e3),type:xn[a.type]}));return o.length===0&&this.lru.remove(n),o}return[]}add(e,t){let n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??uw)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){let n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}};function EB(r){return new dw(r)}var ZZ=1e3,Zg=class{constructor(e){l(this,"resolvers");l(this,"cache");this.resolvers={},this.cache=EB(e.cacheSize??ZZ),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=bB())}async query(e,t={}){let n=Wg(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new ve("dns:cache",s)),s;let o=`${e.split(".").pop()}.`,i=(this.resolvers[o]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of i){if(t.signal?.aborted===!0)break;try{let u=await c(e,{...t,types:n});for(let f of u.Answer)this.cache.add(e,f);return u}catch(u){a.push(u),t.onProgress?.(new ve("dns:error",u))}}throw new W0(a,`DNS lookup of ${e} ${n} failed`)}};var xn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(xn||(xn={}));function vB(r={}){return new Zg(r)}var pw=class{constructor(){l(this,"dns")}canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){let n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];let o=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[xn.TXT]}),i=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(let c of o.Answer){let u=c.data.replace(/["']/g,"").trim().split("=")[1];u!=null&&(i!=null&&!u.includes(i)||a.push(yt(u)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=vB()),this.dns)}},t1=new pw;async function mw(r,e,t){let n=t.depth??0;if(n>(t.maxRecursiveDepth??32))throw new Ug("Max recursive depth reached");let s=!1,o=[];for(let i of Object.values(e))if(i.canResolve(r)){s=!0;let a=await i.resolve(r,t);for(let c of a)o.push(...await mw(c,e,{...t,depth:n+1}))}return s===!1&&o.push(r),o}var r1={maxParallelDials:Hg,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:t1}},Xg=class{constructor(e,t={}){l(this,"queue");l(this,"components");l(this,"addressSorter");l(this,"maxPeerAddrsToDial");l(this,"maxDialQueueLength");l(this,"dialTimeout");l(this,"shutDownController");l(this,"connections");l(this,"log");l(this,"resolvers");this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??r1.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??r1.maxDialQueueLength,this.dialTimeout=t.dialTimeout??r1.dialTimeout,this.connections=t.connections??new Co,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??r1.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new cm({concurrency:t.maxParallelDials??r1.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==ad.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:s}=Kg(e);if(n!=null&&t.force!==!0){let i=Fg(n,this.connections.get(n),s);if(i!=null)return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new ve("dial-queue:already-connected")),i}let o=this.queue.queue.find(i=>{if(n?.equals(i.options.peerId)===!0)return!0;let a=i.options.multiaddrs;if(a==null)return!1;for(let c of s)if(a.has(c.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(let i of s)o.options.multiaddrs.add(i.toString());return t.onProgress?.(new ve("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new fc("Dial queue is full");return this.log("creating dial target for %p",n,s.map(i=>i.toString())),t.onProgress?.(new ve("dial-queue:add-to-dial-queue")),this.queue.add(async i=>{i.onProgress?.(new ve("dial-queue:start-dial"));let a=At([this.shutDownController.signal,i.signal]);try{return await this.dialPeer(i,a)}finally{a.clear()}},{peerId:n,priority:t.priority??ww,multiaddrs:new Set(s.map(i=>i.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){let n=e.peerId,s=e.multiaddrs,o=new Set,i=e.multiaddrs.size===0,a=0,c=0,u=[];for(this.log("starting dial to %p",n);i||s.size>0;){c++,i=!1;let f=[],h=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...h]);let d=await this.calculateMultiaddrs(n,h,{...e,signal:t});for(let p of d){if(o.has(p.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",p.multiaddr,n);continue}f.push(p)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,f.map(p=>p.multiaddr.toString())),e?.onProgress?.(new ve("dial-queue:calculated-addresses",f));for(let p of f){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new fc("Peer had more than maxPeerAddrsToDial");a++;try{let y=await this.components.transportManager.dial(p.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",p.multiaddr);try{await this.components.peerStore.merge(y.remotePeer,{multiaddrs:[y.remoteAddr],metadata:{[oB]:H(Date.now().toString())}})}catch(x){this.log.error("could not update last dial failure key for %p - %e",n,x)}return y}catch(y){if(this.log.error("dial failed to %a - %e",p.multiaddr,y),o.add(p.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[sB]:H(Date.now().toString())}})}catch(x){this.log.error("could not update last dial failure key for %p - %e",n,x)}if(t.aborted)throw new fd(y.message);u.push(y)}}}throw u.length===1?u[0]:new AggregateError(u,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){let s=[...t].map(h=>({multiaddr:yt(h),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new fc("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new z0("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{let h=await this.components.peerStore.get(e);s.push(...h.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:d})=>d.toString()))}catch(h){if(h.name!=="NotFoundError")throw h}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let h=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:d})=>d.toString())),s.push(...h.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(h){h.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,h)}}}let o=(await Promise.all(s.map(async h=>{let d=await mw(h.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return d.length===1&&d[0].equals(h.multiaddr)?h:d.map(p=>({multiaddr:p,isCertified:!1}))}))).flat();if(e!=null){let h=`/p2p/${e.toString()}`;o=o.map(d=>d.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:d.multiaddr.encapsulate(h),isCertified:d.isCertified}:d)}let i=o.filter(h=>{if(this.components.transportManager.dialTransportForMultiaddr(h.multiaddr)==null)return!1;let d=h.multiaddr.getComponents().findLast(p=>p.code===421)?.value;return e!=null&&d!=null?e.equals(d):!0}),a=new Map;for(let h of i){let d=h.multiaddr.toString(),p=a.get(d);if(p!=null){p.isCertified=p.isCertified||h.isCertified||!1;continue}a.set(d,h)}let c=[...a.values()];if(c.length===0)throw new kg("The dial request has no valid addresses");let u=[];for(let h of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(h.multiaddr)||u.push(h);let f=this.addressSorter==null?aB(u):u.sort(this.addressSorter);if(f.length===0)throw new z0("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",o.map(({multiaddr:h})=>h.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",f.map(({multiaddr:h})=>h.toString())),f}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!tl.matches(s.multiaddr))!=null:!0}catch{}return!1}};var XZ=Object.prototype.toString,jZ=r=>XZ.call(r)==="[object Error]",QZ=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function xw(r){if(!(r&&jZ(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;let{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:QZ.has(t)}function JZ(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function jg(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be \u2265 ${t}.`)}}var Ew=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function eX(r,e){let t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1,s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function SB(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function tX({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){let o=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(o instanceof Ew)throw o.originalError;let i=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,a=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:o,attemptNumber:e,retriesLeft:i,retriesConsumed:t});if(await s.onFailedAttempt(c),SB(n,a)<=0)throw o;let u=await s.shouldConsumeRetry(c),f=SB(n,a);if(f<=0||i<=0)throw o;if(o instanceof TypeError&&!xw(o)){if(u)throw o;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw o;if(!u)return s.signal?.throwIfAborted(),!1;let h=eX(t,s),d=Math.min(h,f);return s.signal?.throwIfAborted(),d>0&&await new Promise((p,y)=>{let x=()=>{clearTimeout(b),s.signal?.removeEventListener("abort",x),y(s.signal.reason)},b=setTimeout(()=>{s.signal?.removeEventListener("abort",x),p()},d);s.unref&&b.unref?.(),s.signal?.addEventListener("abort",x,{once:!0})}),s.signal?.throwIfAborted(),!0}async function vw(r,e={}){if(e={...e},JZ(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??(e.retries=10),e.factor??(e.factor=2),e.minTimeout??(e.minTimeout=1e3),e.maxTimeout??(e.maxTimeout=Number.POSITIVE_INFINITY),e.maxRetryTime??(e.maxRetryTime=Number.POSITIVE_INFINITY),e.randomize??(e.randomize=!1),e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.shouldConsumeRetry??(e.shouldConsumeRetry=()=>!0),jg("factor",e.factor,{min:0,allowInfinity:!1}),jg("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),jg("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),jg("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0,s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();let o=await r(t);return e.signal?.throwIfAborted(),o}catch(o){await tX({error:o,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var Qg=class{constructor(e,t={}){l(this,"log");l(this,"queue");l(this,"started");l(this,"peerStore");l(this,"retries");l(this,"retryInterval");l(this,"backoffFactor");l(this,"connectionManager");l(this,"events");this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new am({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;let t=await this.peerStore.get(e);_B(t)&&(this.queue.has(e)||this.queue.add(async n=>{await vw(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(o){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,o),o}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);let s={};[...t.tags.keys()].forEach(o=>{o.startsWith(Z5)&&(s[o]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>_B(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}};function _B(r){for(let e of r.tags.keys())if(e.startsWith(Z5))return!0;return!1}var ww=50,Sw={maxConnections:iB,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},AB;AB=Symbol.toStringTag;var Jg=class{constructor(e,t={}){l(this,"started");l(this,"connections");l(this,"allow");l(this,"deny");l(this,"maxIncomingPendingConnections");l(this,"incomingPendingConnections");l(this,"outboundPendingConnections");l(this,"maxConnections");l(this,"dialQueue");l(this,"reconnectQueue");l(this,"connectionPruner");l(this,"inboundConnectionRateLimiter");l(this,"peerStore");l(this,"metrics");l(this,"events");l(this,"log");l(this,"peerId");l(this,AB,"@libp2p/connection-manager");if(this.maxConnections=t.maxConnections??Sw.maxConnections,this.maxConnections<1)throw new be("Connection Manager maxConnections must be greater than 0");this.connections=new Co,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>G0(yt(n))),this.deny=(t.deny??[]).map(n=>G0(yt(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Sw.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new lm({points:t.inboundConnectionThreshold??Sw.inboundConnectionThreshold,duration:1}),this.connectionPruner=new Vg({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>yt(n))}),this.dialQueue=new Xg(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??Hg,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:t1},connections:this.connections}),this.reconnectQueue=new Qg({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let t of this.connections.values())for(let n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let s of n.streams){let o=`${s.direction} ${s.protocol??"unnegotiated"}`;e[o]=(e[o]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let s of n){let o={};for(let i of s.streams){let a=`${i.direction} ${i.protocol??"unnegotiated"}`;o[a]=(o[a]??0)+1}for(let[i,a]of Object.entries(o))e[i]=e[i]??[],e[i].push(a)}let t={};for(let[n,s]of Object.entries(e)){s=s.sort((i,a)=>i-a);let o=Math.floor(s.length*.9);t[n]=s[o]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await NA(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await OA(this.reconnectQueue,this.dialQueue,this.connectionPruner);let e=[];for(let t of this.connections.values())for(let n of t)e.push(Promise.all([$0(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(s=>{n.abort(s)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new be("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;let n=t.remotePeer,s=!this.connections.has(n),o=this.connections.get(n)??[];o.push(t),this.connections.set(n,o),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e,n=t.remotePeer,o=(this.connections.get(n)??[]).filter(i=>i.id!==t.id);this.connections.set(n,o),o.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Ps("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();let{peerId:n,multiaddrs:s}=Kg(e);if(this.peerId.equals(n))throw new uc("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);let c=Fg(n,this.getConnections(n),s);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new ve("dial-queue:already-connected")),c}let o=await this.dialQueue.dial(e,{...t,priority:t.priority??ww});if(o.status!=="open")throw new Hi("Remote closed connection during opening");let i=this.connections.get(o.remotePeer);i==null&&(i=[],this.connections.set(o.remotePeer,i));let a=!1;for(let c of i)if(c.id===o.id&&(a=!0),t.force!==!0&&c.id!==o.id&&c.remoteAddr.equals(o.remoteAddr))return o.abort(new yo("Duplicate multiaddr connection")),c;return a||i.push(o),o}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await Promise.all([$0(s,"close",t),s.close(t)])}catch(o){s.abort(o)}}))}acceptIncomingConnection(e){if(this.deny.some(s=>{if(ar(e.remoteAddr)){let o=De(e.remoteAddr);return s.contains(o.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>{if(ar(e.remoteAddr)){let o=De(e.remoteAddr);return s.contains(o.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(ar(e.remoteAddr)){let s=De(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(s.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>yt(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}};var sX=1e4,oX="1.0.0",iX="ping",aX="ipfs",IB=32,cX=!0,TB,RB;RB=Symbol.toStringTag,TB=md;var e3=class{constructor(e,t={}){l(this,"protocol");l(this,"components");l(this,"log");l(this,"heartbeatInterval");l(this,"pingIntervalMs");l(this,"abortController");l(this,"timeout");l(this,"abortConnectionOnPingFailure");l(this,RB,"@libp2p/connection-monitor");l(this,TB,["@libp2p/connection-monitor"]);this.components=e,this.protocol=`/${t.protocolPrefix??aX}/${iX}/${oX}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??sX,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??cX,this.timeout=new om({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),o=$b(s);t=Date.now(),await Promise.all([o.write(gu(IB),{signal:n}),o.read({bytes:IB,signal:n})]),e.rtt=Date.now()-t,await s.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};var CB;CB=Symbol.toStringTag;var t3=class{constructor(e,t){l(this,"routers");l(this,"started");l(this,"components");l(this,CB,"@libp2p/content-routing");this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:z(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:z(n,"base36")})})??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new cf("No content routers available");let n=this,s=new Ic;for await(let o of Bo(...n.routers.filter(i=>i.findProviders instanceof Function).map(i=>i.findProviders(e,t))))o!=null&&(o.multiaddrs.length>0&&await this.components.peerStore.merge(o.id,{multiaddrs:o.multiaddrs},t),!s.has(o.id)&&(s.add(o.id),yield o))}async provide(e,t={}){if(this.routers.length===0)throw new cf("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new cf("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Ps;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Ps;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}};var r3=globalThis.CustomEvent??Event;async function*il(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered??!1,s=new EventTarget,o=[],i=ue(),a=ue(),c=!1,u,f=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let y of r){if(o.length===t&&(i=ue(),await i.promise),f)break;let x={done:!1};o.push(x),y().then(b=>{x.done=!0,x.ok=!0,x.value=b,s.dispatchEvent(new r3("task-complete"))},b=>{x.done=!0,x.err=b,s.dispatchEvent(new r3("task-complete"))})}c=!0,s.dispatchEvent(new r3("task-complete"))}catch(y){u=y,s.dispatchEvent(new r3("task-complete"))}});function h(){return n?o[0]?.done:!!o.find(y=>y.done)}function*d(){for(;o.length>0&&o[0].done;){let y=o[0];if(o.shift(),y.ok)yield y.value;else throw f=!0,i.resolve(),y.err;i.resolve()}}function*p(){for(;h();)for(let y=0;y<o.length;y++)if(o[y].done){let x=o[y];if(o.splice(y,1),y--,x.ok)yield x.value;else throw f=!0,i.resolve(),x.err;i.resolve()}}for(;;){if(h()||(a=ue(),await a.promise),u!=null||(n?yield*d():yield*p(),u!=null))throw u;if(c&&o.length===0)break}}var DB;DB=Symbol.toStringTag;var n3=class{constructor(e,t={}){l(this,"log");l(this,"peerId");l(this,"peerStore");l(this,"routers");l(this,DB,"@libp2p/peer-routing");this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:z(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}async findPeer(e,t){if(this.routers.length===0)throw new q0("No peer routers available");if(e.toString()===this.peerId.toString())throw new Cg("Should not try to find self");let n=this,s=Bo(...this.routers.filter(o=>o.findPeer instanceof Function).map(o=>(async function*(){try{yield await o.findPeer(e,t)}catch(i){n.log.error("router failed to find peer - %e",i)}})()));for await(let o of s)if(o!=null)return o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs},t),o;throw new cd}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new q0("No peer routers available");let n=this,s=Yd(1024);for await(let o of il((async function*(){let i=Bo(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of i)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return a}})()))o!=null&&(o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs},t),!s.has(o.id.toMultihash().bytes)&&(s.add(o.id.toMultihash().bytes),yield o))}};function lX(r){return r.reason}async function n1(r,e,t){if(e==null)return r;let n=t?.translateError??lX;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((o,i)=>{s=()=>{i(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}var BB,PB,s3=class extends(PB=Je,BB=Symbol.toStringTag,PB){constructor(t){super();l(this,"peerRouting");l(this,"log");l(this,"walking");l(this,"walkers");l(this,"shutdownController");l(this,"walkController");l(this,"needNext");l(this,BB,"@libp2p/random-walk");this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){this.walking||this.startWalk(),this.walkers++;let n=At([this.shutdownController.signal,t?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=ue(),yield(await $0(this,"walk:peer",{signal:n,rejectionEvents:["walk:error"]})).detail}catch(s){throw s.detail!=null?s.detail:s}finally{n.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let t=At([this.walkController.signal,this.shutdownController.signal]);let n=Date.now(),s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let o=gu(32),i=Date.now();for await(let a of this.peerRouting.getClosestPeers(o,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-i,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await n1(this.needNext.promise,t)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",o,this.walkers,s)}catch(o){this.log.error("random walk errored - %e",o),this.safeDispatchEvent("walk:error",{detail:o})}this.log("no walkers left, ended walk")}).catch(o=>{this.log.error("random walk errored - %e",o)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-n),this.walking=!1})}};var _w=32,Aw=64,LB;LB=Symbol.toStringTag;var o3=class{constructor(e){l(this,"log");l(this,"topologies");l(this,"handlers");l(this,"components");l(this,"middleware");l(this,LB,"@libp2p/registrar");this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{let t={};for(let[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=xr({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new Dg(`No handler registered for protocol ${e}`);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new Bg(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:_w,maxOutboundStreams:Aw,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new be("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){let t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{let s=await this.components.peerStore.get(t,n);for(let o of s.protocols){let i=this.topologies.get(o);i!=null&&await Promise.all([...i.values()].map(async a=>{a.filter?.has(t)!==!1&&(a.filter?.remove(t),await a.onDisconnect?.(t))}))}}catch(s){if(s.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,s)}}async _onPeerUpdate(e){let{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(o=>!t.protocols.includes(o));try{for(let o of s){let i=this.topologies.get(o);i!=null&&await Promise.all([...i.values()].map(async a=>{a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),await a.onDisconnect?.(t.id))}))}}catch(o){this.log.error("could not inform topologies of updated peer %p - %e",t.id,o)}}async _onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;try{for(let o of t){let i=this.topologies.get(o);i!=null&&await Promise.all([...i.values()].map(async a=>{n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),await a.onConnect?.(s,n))}))}}catch(o){this.log.error("could not inform topologies of updated peer after identify %p - %e",s,o)}}};var kB;kB=Symbol.toStringTag;var i3=class{constructor(e,t={}){l(this,"log");l(this,"components");l(this,"transports");l(this,"listeners");l(this,"faultTolerance");l(this,"started");l(this,kB,"@libp2p/transport-manager");this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=xr({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=xr({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??pd.FATAL_ALL}add(e){let t=e[Symbol.toStringTag];if(t==null)throw new be("Transport must have a valid tag");if(this.transports.has(t))throw new be(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.dialTransportForMultiaddr(e);if(n==null)throw new Mg(`No transport available for address ${String(e)}`);return t?.onProgress?.(new ve("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Ps("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(o=>{t.errors.set(o.toString(),new Pg)});let n=[];for(let[o,i]of this.transports.entries()){let a=i.listenFilter(e);for(let c of a){this.log("creating listener for %s on %a",o,c);let u=i.createListener({upgrader:this.components.upgrader}),f=this.listeners.get(o)??[];f==null&&(f=[],this.listeners.set(o,f)),f.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{let h=f.findIndex(d=>d===u);f.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),$9.matches(c)?t.ipv4.attempts++:G9.matches(c)&&t.ipv6.attempts++,n.push(u.listen(c).then(()=>{t.errors.delete(c.toString()),$9.matches(c)&&t.ipv4.success++,G9.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",o,c,h),t.errors.set(c.toString(),h),h}))}}let s=await Promise.allSettled(n);if(!(s.length>0&&s.every(o=>o.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===pd.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new Lg(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([o,i])=>`
  ${o}: ${`${uX(i)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;let t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};function uX(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}var Gs="/multistream/1.0.0";var o1=class extends Error{constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}};l(o1,"name","UnsupportedProtocolError");var i1=class extends Error{constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}};l(i1,"name","InvalidMessageError");var fX=H(`
`);async function a1(r,e){let n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==fX[0])throw new i1("Missing newline");return z(n).trimEnd()}async function pf(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");let n=r.log.newScope("mss:select"),s=im(r,{...t,maxDataLength:1024});for(let o=0;o<e.length;o++){let i=e[o],a;if(o===0){n.trace('write ["%s", "%s"]',Gs,i);let c=H(`${Gs}
`),u=H(`${i}
`);if(await s.writeV([c,u],t),n.trace("reading multistream-select header"),a=await a1(s,t),n.trace('read "%s"',a),a!==Gs){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',i),await s.write(H(`${i}
`),t);if(n.trace("reading protocol response"),a=await a1(s,t),n.trace('read "%s"',a),a===i)return n.trace('selected "%s" after negotiation',a),s.unwrap(),i}throw new o1(`Protocol selection failed - could not negotiate ${e}`)}var a3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MSG_LENGTH")}},mf=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthError");l(this,"code","ERR_MSG_DATA_TOO_LONG")}},c3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthLengthError");l(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},c1=class extends Error{constructor(){super(...arguments);l(this,"name","UnexpectedEOFError");l(this,"code","ERR_UNEXPECTED_EOF")}};function l3(r){return r[Symbol.asyncIterator]!=null}function OB(r,e){if(r.byteLength>e)throw new mf("Message length too long")}var f3=r=>{let e=ce(r),t=pe(e);return je(r,t),f3.bytes=e,t};f3.bytes=0;function h3(r,e){e=e??{};let t=e.lengthEncoder??f3,n=e?.maxDataLength??4194304;function*s(o){OB(o,n);let i=t(o.byteLength);i instanceof Uint8Array?yield i:yield*i,o instanceof Uint8Array?yield o:yield*o}return l3(r)?(async function*(){for await(let o of r)yield*s(o)})():(function*(){for(let o of r)yield*s(o)})()}h3.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??f3,n=e?.maxDataLength??4194304;return OB(r,n),new Z(t(r.byteLength),r)};var al;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(al||(al={}));var Tw=r=>{let e=Nt(r);return Tw.bytes=ce(e),e};Tw.bytes=0;function Iw(r,e){let t=new Z,n=al.LENGTH,s=-1,o=e?.lengthDecoder??Tw,i=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;function*c(){for(;t.byteLength>0;){if(n===al.LENGTH)try{if(s=o(t),s<0)throw new a3("Invalid message length");if(s>a)throw new mf("Message length too long");let u=o.bytes;t.consume(u),e?.onLength!=null&&e.onLength(s),n=al.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>i)throw new c3("Message length length too long");break}throw u}if(n===al.DATA){if(t.byteLength<s)break;let u=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(u),yield u,n=al.LENGTH}}}return l3(r)?(async function*(){for await(let u of r)t.append(u),yield*c();if(t.byteLength>0)throw new c1("Unexpected end of input")})():(function*(){for(let u of r)t.append(u),yield*c();if(t.byteLength>0)throw new c1("Unexpected end of input")})()}Iw.fromReader=(r,e)=>{let t=1,n=(async function*(){for(;;)try{let{done:o,value:i}=await r.next(t);if(o===!0)return;i!=null&&(yield i)}catch(o){if(o.code==="ERR_UNDER_READ")return{done:!0,value:null};throw o}finally{t=1}})();return Iw(n,{...e??{},onLength:o=>{t=o}})};async function gf(r,e,t={}){e=Array.isArray(e)?e:[e];let n=r.log.newScope("mss:handle"),s=im(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){n.trace("reading incoming string");let o=await a1(s,t);if(n.trace('read "%s"',o),o===Gs){n.trace('respond with "%s" for "%s"',Gs,o),await s.write(H(`${Gs}
`),t),n.trace('responded with "%s" for "%s"',Gs,o);continue}if(e.includes(o))return n.trace('respond with "%s" for "%s"',o,o),await s.write(H(`${o}
`),t),n.trace('responded with "%s" for "%s"',o,o),s.unwrap(),o;if(o==="ls"){let i=new Z(...e.map(a=>h3.single(H(`${a}
`))),H(`
`));n.trace('respond with "%s" for %s',e,o),await s.write(i,t),n.trace('responded with "%s" for %s',e,o);continue}n.trace('respond with "na" for "%s"',o),await s.write(H(`na
`),t),n('responded with "na" for "%s"',o)}}var KB,FB,VB,Cw=class extends(VB=Je,FB=Symbol.toStringTag,KB=LA,VB){constructor(t,n){super();l(this,"id");l(this,"remoteAddr");l(this,"remotePeer");l(this,"direction");l(this,"timeline");l(this,"direct");l(this,"multiplexer");l(this,"encryption");l(this,"limits");l(this,"log");l(this,"maConn");l(this,"muxer");l(this,"components");l(this,"outboundStreamProtocolNegotiationTimeout");l(this,"inboundStreamProtocolNegotiationTimeout");l(this,"closeTimeout");l(this,FB,"Connection");l(this,KB,!0);l(this,"newStream",async(t,n={})=>{if(this.muxer==null)throw new fa("Connection is not multiplexed");if(this.muxer.status!=="open")throw new Hi(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new Hi(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&n?.runOnLimitedConnection!==!0)throw new tu("Cannot open protocol stream on limited connection");Array.isArray(t)||(t=[t]),this.log.trace("starting new stream for protocols %s",t);let s=await this.muxer.createStream({...n,protocol:t.length===1?t[0]:void 0});this.log.trace("started new stream %s for protocols %s",s.id,t);try{if(n.signal==null){s.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",t);let c=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);n={...n,signal:c}}s.protocol===""?(s.log.trace("selecting protocol from protocols %s",t),s.protocol=await pf(s,t,n),s.log("negotiated protocol %s",s.protocol)):s.log("pre-negotiated protocol %s",s.protocol);let o=mX(s.protocol,this.components.registrar,n),i=UB(s.protocol,"outbound",this);if(i>o){let c=new dd(`Too many outbound protocol streams for protocol "${s.protocol}" - ${i}/${o}`);throw s.abort(c),c}await this.components.peerStore.merge(this.remotePeer,{protocols:[s.protocol]}),this.components.metrics?.trackProtocolStream(s);let a=this.components.registrar.getMiddleware(s.protocol);return await this.runMiddlewareChain(s,this,a)}catch(o){throw s.status==="open"?s.abort(o):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,t,o),o}});this.components=t,this.id=n.id,this.remoteAddr=n.maConn.remoteAddr,this.remotePeer=n.remotePeer,this.direction=n.direction??"outbound",this.timeline=n.maConn.timeline,this.encryption=n.cryptoProtocol,this.limits=n.limits,this.maConn=n.maConn,this.log=n.maConn.log,this.outboundStreamProtocolNegotiationTimeout=n.outboundStreamProtocolNegotiationTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=n.inboundStreamProtocolNegotiationTimeout??1e4,this.closeTimeout=n.closeTimeout??1e3,this.direct=ew(n.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(s=>s.code===421)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),n.muxer!=null&&(this.multiplexer=n.muxer.protocol,this.muxer=n.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",s=>{this.dispatchEvent(new g2(s.local,s.error))})}get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}async onIncomingStream(t){let n=t.detail,s=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);n.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(n.protocol===""){let f=this.components.registrar.getProtocols();n.log.trace("selecting protocol from protocols %s",f),n.protocol=await gf(n,f,{signal:s}),n.log("negotiated protocol %s",n.protocol)}else n.log("pre-negotiated protocol %s",n.protocol);let o=pX(n.protocol,this.components.registrar);if(UB(n.protocol,"inbound",this)>o)throw new hd(`Too many inbound protocol streams for protocol "${n.protocol}" - limit ${o}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]},{signal:s}),this.components.metrics?.trackProtocolStream(n);let{handler:a,options:c}=this.components.registrar.getHandler(n.protocol);if(this.limits!=null&&c.runOnLimitedConnection!==!0)throw new tu("Cannot open protocol stream on limited connection");let u=this.components.registrar.getMiddleware(n.protocol);u.push(async(f,h,d)=>{await a(f,h),d(f,h)}),await this.runMiddlewareChain(n,this,u)}catch(o){n.abort(o)}}async runMiddlewareChain(t,n,s){for(let o=0;o<s.length;o++){let i=s[o];t.log.trace("running middleware",o,i),await new Promise((a,c)=>{try{let u=i(t,n,(f,h)=>{t=f,n=h,a()});u instanceof Promise&&u.catch(c)}catch(u){c(u)}}),t.log.trace("ran middleware",o,i)}return t}async close(t={}){if(this.log("closing connection to %a",this.remoteAddr),t.signal==null){let n=AbortSignal.timeout(this.closeTimeout);t={...t,signal:n}}await this.muxer?.close(t),await this.maConn.close(t)}abort(t){this.muxer?.abort(t),this.maConn.abort(t)}};function HB(r,e){return new Cw(r,e)}function pX(r,e){try{let{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return _w}function mX(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??Aw}function UB(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}var qB;qB=Symbol.toStringTag;var d3=class{constructor(e,t){l(this,"components");l(this,"connectionEncrypters");l(this,"streamMuxers");l(this,"inboundUpgradeTimeout");l(this,"inboundStreamProtocolNegotiationTimeout");l(this,"outboundStreamProtocolNegotiationTimeout");l(this,"events");l(this,"metrics");l(this,"connectionCloseTimeout");l(this,qB,"@libp2p/upgrader");this.components=e,this.connectionEncrypters=xr({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=xr({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.connectionCloseTimeout=t.connectionCloseTimeout??1e3,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}async shouldBlockConnection(e,...t){let n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new Ng(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){let t=At([AbortSignal.timeout(this.inboundUpgradeTimeout),e]);return t}async upgradeInbound(e,t){let n=!1,s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new Og("Connection denied");await n1(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(o){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[o.name??"Error"]:!0}),o}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});let n=e.remoteAddr.getComponents().findLast(i=>i.code===421)?.value,s;n!=null&&(s=Ms(n),await n1(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let o="outbound";return t.initiator===!1&&(o="inbound"),await this._performUpgrade(e,o,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s=e,o,i,a,c,u=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${u}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){let h=this.components.connectionProtector;h!=null&&(e.log("protecting the %s connection",t),s=await h.protect(s,n))}try{if(gX(n)){if(n.remotePeer==null)throw new yo(`${t} connection that skipped encryption must have a peer id`);c="native",o=n.remotePeer}else{let h=e.remoteAddr.getComponents().findLast(p=>p.code===421)?.value,d;h!=null&&(d=Ms(h)),n?.onProgress?.(new ve(`upgrader:encrypt-${t}-connection`)),{connection:s,remotePeer:o,protocol:c,streamMuxer:i}=await(t==="inbound"?this._encryptInbound(s,{...n,remotePeer:d}):this._encryptOutbound(s,{...n,remotePeer:d}))}if(o.equals(this.components.peerId)){let h=new uc("Can not dial self");throw e.abort(h),h}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",o,e),n?.muxerFactory!=null?i=n.muxerFactory:i==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new ve(`upgrader:multiplex-${t}-connection`)),i=await(t==="inbound"?this._multiplexInbound(s,this.streamMuxers,n):this._multiplexOutbound(s,this.streamMuxers,n)))}catch(h){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,h),h}i!=null&&(e.log("create muxer %s",i.protocol),a=i.createStreamMuxer(s)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",o,e);let f=this._createConnection({id:u,cryptoProtocol:c,direction:t,maConn:e,stream:s,muxer:a,remotePeer:o,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return f.log("successfully upgraded connection"),f}_createConnection(e){let t=HB(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{let s=await gf(e,n,t),o=this.connectionEncrypters.get(s);if(o==null)throw new rl(`no crypto module found for ${s}`);return e.log("encrypting inbound connection using %s",s),{...await o.secureInbound(e,t),protocol:s}}catch(s){throw new rl(s.message)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);let s=await pf(e,n,t),o=this.connectionEncrypters.get(s);if(o==null)throw new rl(`no crypto module found for ${s}`);return e.log("encrypting outbound connection using %s",s),{...await o.secureOutbound(e,t),protocol:s}}catch(s){throw new rl(s.message)}}async _multiplexOutbound(e,t,n){let s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);let o=await pf(e,s,n),i=t.get(o);if(i==null)throw new fa(`No muxer configured for protocol "${o}"`);return e.log("selected %s as muxer protocol",o),i}catch(o){throw e.log.error("error multiplexing outbound connection - %e",o),new fa(String(o))}}async _multiplexInbound(e,t,n){let s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{e.log.trace("selecting stream muxer from %s",s);let o=await gf(e,s,n),i=t.get(o);if(i==null)throw new fa(`No muxer configured for protocol "${o}"`);return e.log("selected %s as muxer protocol",o),i}catch(o){throw e.log.error("error multiplexing inbound connection - %e",o),o}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};function gX(r){return r.skipEncryption===!0}var p3="3.1.2",m3="js-libp2p";function $B(r,e){return`${r??m3}/${e??p3} browser/${globalThis.navigator.userAgent}`}var l1,Dw,g3=class extends Je{constructor(t){super();ne(this,l1);l(this,"peerId");l(this,"peerStore");l(this,"contentRouting");l(this,"peerRouting");l(this,"metrics");l(this,"services");l(this,"logger");l(this,"status");l(this,"components");l(this,"log");this.status="stopped";let n=new Je,s=n.dispatchEvent.bind(n);n.dispatchEvent=f=>{let h=s(f),d=this.dispatchEvent(new CustomEvent(f.type,{detail:f.detail}));return h||d},this.peerId=t.peerId,this.logger=t.logger??Y2(),this.log=this.logger.forComponent("libp2p"),this.services={};let o=t.nodeInfo?.name??m3,i=t.nodeInfo?.version??p3,a=this.components=eB({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:o,version:i,userAgent:t.nodeInfo?.userAgent??$B(o,i)},logger:this.logger,events:n,datastore:t.datastore??new gg,connectionGater:rB(t.connectionGater),dns:t.dns});t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",AD(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),a.events.addEventListener("peer:update",f=>{if(f.detail.previous==null){let h={id:f.detail.peer.id,multiaddrs:f.detail.peer.addresses.map(d=>d.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:h})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(a)),this.components.upgrader=new d3(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((f,h)=>this.configureComponent(`connection-encryption-${h}`,f(this.components))),streamMuxers:(t.streamMuxers??[]).map((f,h)=>this.configureComponent(`stream-muxers-${h}`,f(this.components))),inboundUpgradeTimeout:t.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:t.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:t.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:t.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new i3(this.components,t.transportManager)),this.configureComponent("connectionManager",new Jg(this.components,t.connectionManager)),t.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new e3(this.components,t.connectionMonitor)),this.configureComponent("registrar",new o3(this.components)),this.configureComponent("addressManager",new Ig(this.components,t.addresses));let c=(t.peerRouters??[]).map((f,h)=>this.configureComponent(`peer-router-${h}`,f(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new n3(this.components,{routers:c}));let u=(t.contentRouters??[]).map((f,h)=>this.configureComponent(`content-router-${h}`,f(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new t3(this.components,{routers:u})),this.configureComponent("randomWalk",new s3(this.components)),(t.peerDiscovery??[]).forEach((f,h)=>{this.configureComponent(`peer-discovery-${h}`,f(this.components)).addEventListener("peer",p=>{ee(this,l1,Dw).call(this,p)})}),t.transports?.forEach((f,h)=>{this.components.transportManager.add(this.configureComponent(`transport-${h}`,f(this.components)))}),t.services!=null)for(let f of Object.keys(t.services)){let h=t.services[f],d=h(this.components);if(d==null){this.log.error("service factory %s returned null or undefined instance",f);continue}this.services[f]=d,this.configureComponent(f,d),d[G5]!=null&&(this.log("registering service %s for content routing",f),u.push(d[G5])),d[Y5]!=null&&(this.log("registering service %s for peer routing",f),c.push(d[Y5])),d[W5]!=null&&(this.log("registering service %s for peer discovery",f),d[W5].addEventListener?.("peer",p=>{ee(this,l1,Dw).call(this,p)}))}tB(a)}configureComponent(t,n){return n==null&&this.log.error("component %s was null or undefined",t),this.components[t]=n,n}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(t){throw this.log.error("an error occurred starting libp2p - %e",t),this.status="started",await this.stop(),t}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let t=new Ic;for(let n of this.components.connectionManager.getConnections())t.add(n.remotePeer);return Array.from(t)}async dial(t,n={}){return this.components.connectionManager.openConnection(t,{priority:75,...n})}async dialProtocol(t,n,s={}){if(n==null)throw new be("no protocols were provided to open a stream");if(n=Array.isArray(n)?n:[n],n.length===0)throw new be("no protocols were provided to open a stream");return this.components.connectionManager.openStream(t,n,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,n={}){nf(t)&&(t=Ms(t.getComponents().findLast(s=>s.code===421)?.value??"")),await this.components.connectionManager.closeConnections(t,n)}async getPublicKey(t,n={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{let a=await this.peerStore.get(t,n);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}let s=we([H("/pk/"),t.toMultihash().bytes]),o=await this.contentRouting.get(s,n),i=KT(o);return await this.peerStore.patch(t,{publicKey:i},n),i}async handle(t,n,s){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async o=>{await this.components.registrar.handle(o,n,s)}))}async unhandle(t,n){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async s=>{await this.components.registrar.unhandle(s,n)}))}async register(t,n,s){return this.components.registrar.register(t,n,s)}unregister(t){this.components.registrar.unregister(t)}use(t,n){this.components.registrar.use(t,Array.isArray(n)?n:[n])}unuse(t){this.components.registrar.unuse(t)}async isDialable(t,n={}){return this.components.connectionManager.isDialable(t,n)}};l1=new WeakSet,Dw=function(t){let{detail:n}=t;if(n.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(n.id,{multiaddrs:n.multiaddrs}).catch(s=>{this.log.error("could not update multiaddrs of discovered peer - %e",s)})};async function Bw(r={}){r.privateKey??(r.privateKey=await UT("Ed25519"));let e=new g3({...await WT(r),peerId:GT(r.privateKey)});return r.start!==!1&&await e.start(),e}var GB=Symbol.for("@libp2p/content-routing");var y3=Symbol.for("@libp2p/peer-discovery");var b3=Symbol.for("@libp2p/peer-id");function WB(r){return r!=null&&!!r[b3]}var YB=Symbol.for("@libp2p/peer-routing");var cl="StrictSign",yf="StrictNoSign",Kr;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Kr||(Kr={}));var bf=Symbol.for("@libp2p/transport");var ZB;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(ZB||(ZB={}));var wf=class wf extends Error{constructor(t="The operation was aborted"){super(t);l(this,"code");l(this,"type");this.name="AbortError",this.code=wf.code,this.type=wf.type}};l(wf,"code","ABORT_ERR"),l(wf,"type","aborted");var da=wf,K=class extends Error{constructor(t,n,s){super(t);l(this,"code");l(this,"props");this.code=n,this.name=s?.name??"CodeError",this.props=s??{}}};var u1="ERR_TIMEOUT",XB="ERR_INVALID_PARAMETERS";var w3="ERR_INVALID_MESSAGE";var Ze=(r,...e)=>{try{[...e]}catch{}};var Ws,Pt=class extends EventTarget{constructor(){super();ne(this,Ws,new Map);Ze(1/0,this)}listenerCount(t){let n=V(this,Ws).get(t);return n==null?0:n.length}addEventListener(t,n,s){super.addEventListener(t,n,s);let o=V(this,Ws).get(t);o==null&&(o=[],V(this,Ws).set(t,o)),o.push({callback:n,once:(s!==!0&&s!==!1&&s?.once)??!1})}removeEventListener(t,n,s){super.removeEventListener(t.toString(),n??null,s);let o=V(this,Ws).get(t);o!=null&&(o=o.filter(({callback:i})=>i!==n),V(this,Ws).set(t,o))}dispatchEvent(t){let n=super.dispatchEvent(t),s=V(this,Ws).get(t.type);return s==null||(s=s.filter(({once:o})=>!o),V(this,Ws).set(t.type,s)),n}safeDispatchEvent(t,n={}){return this.dispatchEvent(new En(t,n))}};Ws=new WeakMap;var En=globalThis.CustomEvent;function jB(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function QB(...r){let e=[];for(let t of r)jB(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function JB(...r){let e=[];for(let t of r)jB(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var Gt=Symbol.for("@libp2p/service-capabilities"),xf=Symbol.for("@libp2p/service-dependencies");var sP=Symbol.for("nodejs.util.inspect.custom"),eP=Object.values(Qr).map(r=>r.decoder).reduce((r,e)=>r.or(e),Qr.identity.decoder),oP=114,kw=36,Nw=37,tP,f1=class{constructor(e){l(this,"type");l(this,"multihash");l(this,"privateKey");l(this,"publicKey");l(this,"string");l(this,tP,!0);this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ie.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return se.createV1(oP,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return j(this.multihash.bytes,e);if(typeof e=="string")return Qe(e).equals(this);if(e?.multihash?.bytes!=null)return j(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[(tP=b3,sP)](){return`PeerId(${this.toString()})`}},Ef=class extends f1{constructor(t){super({...t,type:"RSA"});l(this,"type","RSA");l(this,"publicKey");this.publicKey=t.publicKey}},vf=class extends f1{constructor(t){super({...t,type:"Ed25519"});l(this,"type","Ed25519");l(this,"publicKey");this.publicKey=t.multihash.digest}},Sf=class extends f1{constructor(t){super({...t,type:"secp256k1"});l(this,"type","secp256k1");l(this,"publicKey");this.publicKey=t.multihash.digest}},Pw=2336,rP,nP,Lw=class{constructor(e){l(this,"type","url");l(this,"multihash");l(this,"privateKey");l(this,"publicKey");l(this,"url");l(this,rP,!0);this.url=e.toString(),this.multihash=ge.digest(H(this.url))}[(nP=sP,rP=b3,nP)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toCID(){return se.createV1(Pw,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=z(e)),e.toString()===this.toString())}};function Qe(r,e){if(e=e??eP,r.charAt(0)==="1"||r.charAt(0)==="Q"){let t=mt(ie.decode(`z${r}`));return r.startsWith("12D")?new vf({multihash:t}):r.startsWith("16U")?new Sf({multihash:t}):new Ef({multihash:t})}return Wt(eP.decode(r))}function Wt(r){try{let e=mt(r);if(e.code===ge.code){if(e.digest.length===kw)return new vf({multihash:e});if(e.digest.length===Nw)return new Sf({multihash:e})}if(e.code===Ee.code)return new Ef({multihash:e})}catch{return yX(se.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function yX(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==oP&&r.code!==Pw)throw new Error("Supplied PeerID CID is invalid");if(r.code===Pw){let t=z(r.multihash.digest);return new Lw(new URL(t))}let e=r.multihash;if(e.code===Ee.code)return new Ef({multihash:r.multihash});if(e.code===ge.code){if(e.digest.length===kw)return new vf({multihash:r.multihash});if(e.digest.length===Nw)return new Sf({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function ds(r,e){return r.length===kw?new vf({multihash:ot(ge.code,r),privateKey:e}):r.length===Nw?new Sf({multihash:ot(ge.code,r),privateKey:e}):new Ef({multihash:await Ee.digest(r),publicKey:r,privateKey:e})}var Yt=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMultiaddrError")}};l(Yt,"name","InvalidMultiaddrError");var Ys=class extends Error{constructor(){super(...arguments);l(this,"name","ValidationError")}};l(Ys,"name","ValidationError");var _f=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidParametersError")}};l(_f,"name","InvalidParametersError");var h1=class extends Error{constructor(){super(...arguments);l(this,"name","UnknownProtocolError")}};l(h1,"name","UnknownProtocolError");function Mw(r){return e=>z(e,r)}function Uw(r){return e=>H(e,r)}function Af(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function ll(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function iP(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=H(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=ll(n);return we([t,s],t.length+s.length)}function aP(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=yr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=ll(n);return we([t,s],t.length+s.length)}function Kw(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=z(e,"base32"),s=Af(t);return`${n}:${s}`}var Fw=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new Yt("Invalid byte value in IP address");e[n]=s}),e},cP=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=gt(t[n]),i;o&&(i=Fw(t[n]),t[n]=z(i.subarray(0,2),"base16")),i!=null&&++n<8&&t.splice(n,0,z(i.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let o=parseInt(t[n],16);if(isNaN(o)||o<0||o>65535)throw new Yt("Invalid byte value in IP address");s[e++]=o>>8&255,s[e++]=o&255}return s},lP=function(r){if(r.byteLength!==4)throw new Yt("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},uP=function(r){if(r.byteLength!==16)throw new Yt("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let s=r[n],o=r[n+1],i=`${s.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`;e.push(i)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new Yt(`Invalid IPv6 address "${t}"`)}};function fP(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Yt(`Invalid IPv6 address "${r}"`)}}var Ow=Object.values(Qr).map(r=>r.decoder),wX=(function(){let r=Ow[0].or(Ow[1]);return Ow.slice(2).forEach(e=>r=r.or(e)),r})();function hP(r){return wX.decode(r)}function dP(r){return e=>r.encoder.encode(e)}function xX(r){if(parseInt(r).toString()!==r)throw new Ys("Value must be an integer")}function EX(r){if(r<0)throw new Ys("Value must be a positive integer, or zero")}function vX(r){return e=>{if(e>r)throw new Ys(`Value must be smaller than or equal to ${r}`)}}function SX(...r){return e=>{for(let t of r)t(e)}}var d1=SX(xX,EX,vX(65535));var Zt=-1,Vw=class{constructor(){l(this,"protocolsByCode",new Map);l(this,"protocolsByName",new Map)}getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new h1(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},Fr=new Vw,JX=[{code:4,name:"ip4",size:32,valueToBytes:Fw,bytesToValue:lP,validate:r=>{if(!gt(r))throw new Ys(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:ll,bytesToValue:Af,validate:d1},{code:273,name:"udp",size:16,valueToBytes:ll,bytesToValue:Af,validate:d1},{code:33,name:"dccp",size:16,valueToBytes:ll,bytesToValue:Af,validate:d1},{code:41,name:"ip6",size:128,valueToBytes:cP,bytesToValue:uP,stringToValue:fP,validate:r=>{if(!Nn(r))throw new Ys(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:Zt},{code:43,name:"ipcidr",size:8,bytesToValue:Mw("base10"),valueToBytes:Uw("base10")},{code:53,name:"dns",size:Zt,resolvable:!0},{code:54,name:"dns4",size:Zt,resolvable:!0},{code:55,name:"dns6",size:Zt,resolvable:!0},{code:56,name:"dnsaddr",size:Zt,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:ll,bytesToValue:Af,validate:d1},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Zt,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:Zt,bytesToValue:Mw("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?Uw("base58btc")(r):se.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:Kw,valueToBytes:iP},{code:445,name:"onion3",size:296,bytesToValue:Kw,valueToBytes:aP},{code:446,name:"garlic64",size:Zt},{code:447,name:"garlic32",size:Zt},{code:448,name:"tls"},{code:449,name:"sni",size:Zt},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Zt,bytesToValue:dP(xo),valueToBytes:hP},{code:480,name:"http"},{code:481,name:"http-path",size:Zt,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Zt}];JX.forEach(r=>{Fr.addProtocol(r)});function pP(r){let e=[],t=0;for(;t<r.length;){let n=Nt(r,t),s=Fr.getProtocol(n),o=ce(n),i=ej(s,r,t+o),a=0;i>0&&s.size===Zt&&(a=ce(i));let c=o+a+i,u={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(i>0){let f=t+o+a,h=r.subarray(f,f+i);u.value=s.bytesToValue?.(h)??z(h)}e.push(u),t+=c}return e}function mP(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let s=Fr.getProtocol(n.code),o=ce(n.code),i,a=0,c=0;n.value!=null&&(i=s.valueToBytes?.(n.value)??H(n.value),a=i.byteLength,s.size===Zt&&(c=ce(a)));let u=new Uint8Array(o+c+a),f=0;Et(n.code,u,f),f+=o,i!=null&&(s.size===Zt&&(Et(a,u,f),f+=c),u.set(i,f)),n.bytes=u}t.push(n.bytes),e+=n.bytes.byteLength}return we(t,e)}function gP(r){if(r.charAt(0)!=="/")throw new Yt('String multiaddr must start with "/"');let e=[],t="protocol",n="",s="";for(let o=1;o<r.length;o++){let i=r.charAt(o);i!=="/"&&(t==="protocol"?s+=r.charAt(o):n+=r.charAt(o));let a=o===r.length-1;if(i==="/"||a){let c=Fr.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new Yt(`Component ${s} was missing value`);t="value"}else if(t==="value"){let u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new Yt(`Component ${s} was missing value`);u.value=c.stringToValue?.(n)??n}e.push(u),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new Yt("Incomplete multiaddr");return e}function yP(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=Fr.getProtocol(e.code);if(t==null)throw new Yt(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function ej(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Nt(e,t)}var tj=Symbol.for("nodejs.util.inspect.custom"),Zw=Symbol.for("@multiformats/multiaddr"),rj=[53,54,55,56],Yw=class extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}};function nj(r){if(r==null&&(r="/"),xP(r))return r.getComponents();if(r instanceof Uint8Array)return pP(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),gP(r);if(Array.isArray(r))return r;throw new Yt("Must be a string, Uint8Array, Component[], or another Multiaddr")}var bP,lt,Tf,Rf,If=class If{constructor(e="/",t={}){l(this,bP,!0);ne(this,lt);ne(this,Tf);ne(this,Rf);le(this,lt,nj(e)),t.validate!==!1&&sj(this)}get bytes(){return V(this,Rf)==null&&le(this,Rf,mP(V(this,lt))),V(this,Rf)}toString(){return V(this,Tf)==null&&le(this,Tf,yP(V(this,lt))),V(this,Tf)}toJSON(){return this.toString()}toOptions(){let e,t,n,s,o="";for(let{code:a,name:c,value:u}of V(this,lt))a===42&&(o=`%${u??""}`),rj.includes(a)&&(t="tcp",s=443,n=`${u??""}${o}`,e=a===55?6:4),(a===6||a===273)&&(t=c==="tcp"?"tcp":"udp",s=parseInt(u??"")),(a===4||a===41)&&(t="tcp",n=`${u??""}${o}`,e=a===41?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}getComponents(){return[...V(this,lt)]}protos(){return V(this,lt).map(({code:e,value:t})=>{let n=Fr.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return V(this,lt).map(({code:e})=>e)}protoNames(){return V(this,lt).map(({name:e})=>e)}tuples(){return V(this,lt).map(({code:e,value:t})=>{if(t==null)return[e];let n=Fr.getProtocol(e),s=[e];return t!=null&&s.push(n.valueToBytes?.(t)??H(t)),s})}stringTuples(){return V(this,lt).map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){let t=new If(e);return new If([...V(this,lt),...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new _f(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new If(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=V(this,lt).length-1;n>-1;n--)if(V(this,lt)[n].code===e){t=n;break}return new If(V(this,lt).slice(0,t),{validate:!1})}getPeerId(){try{let e=[];V(this,lt).forEach(({code:n,value:s})=>{n===421&&e.push([n,s]),n===290&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?z(ie.decode(`z${n}`),"base58btc"):z(se.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(let e of V(this,lt))if(Fr.getProtocol(e.code).path)return e.value??null;return null}equals(e){return j(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(o=>o.resolvable);if(t==null)return[this];let n=wP.get(t.name);if(n==null)throw new Yw(`no available resolver for ${t.name}`);return(await n(this,e)).map(o=>xe(o))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(V(this,lt).length!==2||V(this,lt)[0].code!==4&&V(this,lt)[0].code!==41||V(this,lt)[1].code!==6&&V(this,lt)[1].code!==273)}[(bP=Zw,tj)](){return`Multiaddr(${this.toString()})`}};lt=new WeakMap,Tf=new WeakMap,Rf=new WeakMap;var _3=If;function sj(r){r.getComponents().forEach(e=>{let t=Fr.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function EP(r,e){return Fr.getProtocol(r).bytesToValue?.(e)??z(e,"base16")}var wP=new Map;function xP(r){return!!r?.[Zw]}function xe(r){return new _3(r)}function Ot(r){let e=Fr.getProtocol(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}var oj=r=>r.toString().split("/").slice(1),Cf=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Ae=r=>({match:e=>Cf(t=>t===r).match(e),pattern:r}),pa=()=>({match:r=>Cf(e=>typeof e=="string").match(r),pattern:"{string}"}),Df=()=>({match:r=>Cf(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),Fe=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{ie.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),m1=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{xo.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),Ue=r=>({match:e=>{let t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),lr=(...r)=>({match:e=>{let t;for(let n of r){let s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Re=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function Xe(...r){function e(s){let o=oj(s);for(let i of r){let a=i.match(o);if(a===!1)return!1;o=a}return o}function t(s){return e(s)!==!1}function n(s){let o=e(s);return o===!1?!1:o.length===0}return{matchers:r,matches:t,exactMatch:n}}var ij=Fe(),Wwe=Xe(ij),I3=Re(Ae("dns4"),pa()),T3=Re(Ae("dns6"),pa()),R3=Re(Ae("dnsaddr"),pa()),jw=Re(Ae("dns"),pa()),Ywe=Xe(I3,Ue(Fe())),Zwe=Xe(T3,Ue(Fe())),Xwe=Xe(R3,Ue(Fe())),jwe=Xe(lr(jw,R3,I3,T3),Ue(Fe())),vP=Re(Ae("ip4"),Cf(gt)),SP=Re(Ae("ip6"),Cf(Nn)),Qw=lr(vP,SP),Yo=lr(Qw,jw,I3,T3,R3),_P=Xe(lr(Qw,Re(lr(jw,R3,I3,T3),Ue(Fe())))),Qwe=Xe(vP),Jwe=Xe(SP),exe=Xe(Qw),Jw=Re(Yo,Ae("tcp"),Df()),g1=Re(Yo,Ae("udp"),Df()),txe=Xe(Re(Jw,Ue(Fe()))),rxe=Xe(g1),ex=Re(g1,Ae("quic"),Ue(Fe())),C3=Re(g1,Ae("quic-v1"),Ue(Fe())),aj=lr(ex,C3),nxe=Xe(ex),sxe=Xe(C3),Xw=lr(Yo,Jw,g1,ex,C3),AP=lr(Re(Xw,Ae("ws"),Ue(Fe()))),oxe=Xe(AP),IP=lr(Re(Xw,Ae("wss"),Ue(Fe())),Re(Xw,Ae("tls"),Ue(Re(Ae("sni"),pa())),Ae("ws"),Ue(Fe()))),ixe=Xe(IP),TP=Re(g1,Ae("webrtc-direct"),Ue(m1()),Ue(m1()),Ue(Fe())),RP=Xe(TP),CP=Re(C3,Ae("webtransport"),Ue(m1()),Ue(m1()),Ue(Fe())),axe=Xe(CP),A3=lr(AP,IP,Re(Jw,Ue(Fe())),Re(aj,Ue(Fe())),Re(Yo,Ue(Fe())),TP,CP,Fe()),DP=Xe(A3),cj=Re(A3,Ae("p2p-circuit"),Fe()),BP=Xe(cj),lj=lr(Re(A3,Ae("p2p-circuit"),Ae("webrtc"),Ue(Fe())),Re(A3,Ae("webrtc"),Ue(Fe())),Re(Ae("webrtc"),Ue(Fe()))),PP=Xe(lj),uj=lr(Re(Yo,Ae("tcp"),Df(),Ae("http"),Ue(Fe())),Re(Yo,Ae("http"),Ue(Fe()))),cxe=Xe(uj),fj=lr(Re(Yo,Ae("tcp"),lr(Re(Ae("443"),Ae("http")),Re(Df(),Ae("https")),Re(Df(),Ae("tls"),Ae("http"))),Ue(Fe())),Re(Yo,Ae("tls"),Ae("http"),Ue(Fe())),Re(Yo,Ae("https"),Ue(Fe()))),lxe=Xe(fj),hj=lr(Re(Ae("memory"),pa(),Ue(Fe()))),uxe=Xe(hj),dj=lr(Re(Ae("unix"),pa(),Ue(Fe()))),fxe=Xe(dj);var vn;(function(r){r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",r.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",r.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(vn||(vn={}));var ma=class extends K{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}};var tx=class extends ma{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,vn.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}};function ax(r,e){return new tx(r,e)}var rx=class extends ma{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,vn.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}};function D3(r){return new rx(r)}var nx=class extends ma{constructor(e){super(`There was a problem with a provided argument: ${e}`,vn.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}};function y1(r){return new nx(r)}var sx=class extends ma{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,vn.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}};function cx(r,e){return new sx(r,e)}var ox=class extends ma{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,vn.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}};function LP(r){return new ox(r)}var ix=class extends ma{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `,vn.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}};function kP(r){return new ix(r)}var NP=function(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,o;n<s;n++)(o||!(n in e))&&(o||(o=Array.prototype.slice.call(e,0,n)),o[n]=e[n]);return r.concat(o||Array.prototype.slice.call(e))},pj=(function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r})();var mj=(function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r})();var gj=(function(){function r(e,t,n,s){this.name=e,this.version=t,this.os=n,this.bot=s,this.type="bot-device"}return r})();var yj=(function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r})();var bj=(function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r})();var wj=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,xj=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,OP=3,Ej=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",wj]],MP=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function KP(r){return r?UP(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new bj:typeof navigator<"u"?UP(navigator.userAgent):_j()}function vj(r){return r!==""&&Ej.reduce(function(e,t){var n=t[0],s=t[1];if(e)return e;var o=s.exec(r);return!!o&&[n,o]},!1)}function UP(r){var e=vj(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new yj;var s=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);s?s.length<OP&&(s=NP(NP([],s,!0),Aj(OP-s.length),!0)):s=[];var o=s.join("."),i=Sj(r),a=xj.exec(r);return a&&a[1]?new gj(t,o,i,a[1]):new pj(t,o,i)}function Sj(r){for(var e=0,t=MP.length;e<t;e++){var n=MP[e],s=n[0],o=n[1],i=o.exec(r);if(i)return s}return null}function _j(){var r=typeof process<"u"&&process.version;return r?new mj(process.version.slice(1)):null}function Aj(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var FP=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"];var VP=KP(),b1=VP!=null&&VP.name==="firefox",B3=async function*(){},P3=async r=>{},Ij=30*1e3;function HP(r,e,t=Ij,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);let s=ue(),o=!1;r.bufferedAmountLowThreshold=0;let i=()=>{o||(n.log("%s drain channel closed before drain",e),s.resolve())};r.addEventListener("close",i,{once:!0}),r.addEventListener("bufferedamountlow",()=>{o=!0,r.removeEventListener("close",i),s.resolve()}),await bn(s.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(s=>{n.log.error("error closing outbound stream",s)})}async function w1(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??FP.map(e=>({urls:[e]})),r}var ul=class{constructor(e,t){l(this,"log");l(this,"peerConnection");l(this,"remoteAddr");l(this,"timeline");l(this,"metrics");l(this,"source",B3());l(this,"sink",P3);this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;let n=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",n),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var L3=class extends Error{constructor(t,n,s){super(t??"The operation was aborted");l(this,"type");l(this,"code");this.type="aborted",this.name=s??"AbortError",this.code=n??"ABORT_ERR"}};async function $e(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new L3(t?.errorMessage,t?.errorCode,t?.errorName));let n,s=new L3(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((o,i)=>{n=()=>{i(s)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}function ga(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function qP(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function zP(r,e){let t=ga(r).return?.();qP(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var Tj="ERR_STREAM_RESET",Rj="ERR_SINK_INVALID_STATE",Cj=5e3;function lx(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var k3=class{constructor(e){l(this,"id");l(this,"direction");l(this,"timeline");l(this,"protocol");l(this,"metadata");l(this,"source");l(this,"status");l(this,"readStatus");l(this,"writeStatus");l(this,"log");l(this,"sinkController");l(this,"sinkEnd");l(this,"closed");l(this,"endErr");l(this,"streamSource");l(this,"onEnd");l(this,"onCloseRead");l(this,"onCloseWrite");l(this,"onReset");l(this,"onAbort");l(this,"sendCloseWriteTimeout");l(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=ue(),this.closed=ue(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??Cj,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=We({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new K(`writable end state is "${this.writeStatus}" not "ready"`,Rj);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let s=this.sendNewStream(t);lx(s)&&await s}let n=()=>{zP(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Z(s):s;let o=this.sendData(s,t);lx(o)&&(this.sendingData=ue(),await o,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await $e(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await $e(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await $e(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await $e(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();lx(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new K("stream reset",Tj);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};function N3(r){return r[Symbol.asyncIterator]!=null}var O3=r=>{let e=ce(r),t=pe(e);return je(r,t),O3.bytes=e,t};O3.bytes=0;function ps(r,e){e=e??{};let t=e.lengthEncoder??O3;function*n(s){let o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return N3(r)?(async function*(){for await(let s of r)yield*n(s)})():(function*(){for(let s of r)yield*n(s)})()}ps.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??O3;return new Z(t(r.byteLength),r)};var M3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MSG_LENGTH")}},U3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthError");l(this,"code","ERR_MSG_DATA_TOO_LONG")}},K3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthLengthError");l(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},x1=class extends Error{constructor(){super(...arguments);l(this,"name","UnexpectedEOFError");l(this,"code","ERR_UNEXPECTED_EOF")}};var Dj=8,Bj=1024*1024*4,fl;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(fl||(fl={}));var ux=r=>{let e=Nt(r);return ux.bytes=ce(e),e};ux.bytes=0;function ms(r,e){let t=new Z,n=fl.LENGTH,s=-1,o=e?.lengthDecoder??ux,i=e?.maxLengthLength??Dj,a=e?.maxDataLength??Bj;function*c(){for(;t.byteLength>0;){if(n===fl.LENGTH)try{if(s=o(t),s<0)throw new M3("Invalid message length");if(s>a)throw new U3("Message length too long");let u=o.bytes;t.consume(u),e?.onLength!=null&&e.onLength(s),n=fl.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>i)throw new K3("Message length length too long");break}throw u}if(n===fl.DATA){if(t.byteLength<s)break;let u=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(u),yield u,n=fl.LENGTH}}}return N3(r)?(async function*(){for await(let u of r)t.append(u),yield*c();if(t.byteLength>0)throw new x1("Unexpected end of input")})():(function*(){for(let u of r)t.append(u),yield*c();if(t.byteLength>0)throw new x1("Unexpected end of input")})()}ms.fromReader=(r,e)=>{let t=1,n=(async function*(){for(;;)try{let{done:o,value:i}=await r.next(t);if(o===!0)return;i!=null&&(yield i)}catch(o){if(o.code==="ERR_UNDER_READ")return{done:!0,value:null};throw o}finally{t=1}})();return ms(n,{...e??{},onLength:o=>{t=o}})};var Pj=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Lj(r,e,t){let n,s=new Promise((o,i)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:u,removeListener:f}=Pj(r),h=(...p)=>{let y=t.multiArgs?p:p[0];t.filter&&!t.filter(y)||(c.push(y),t.count===c.length&&(n(),o(c)))},d=p=>{n(),i(p)};n=()=>{for(let p of a)f(p,h);for(let p of t.rejectionEvents)f(p,d)};for(let p of a)u(p,h);for(let p of t.rejectionEvents)u(p,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(c)});if(s.cancel=n,typeof t.timeout=="number"){let o=bn(s,{milliseconds:t.timeout});return o.cancel=n,o}return s}function E1(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=Lj(r,e,t),s=n.then(o=>o[0]);return s.cancel=n.cancel,s}var fx=new Float32Array([-0]),ya=new Uint8Array(fx.buffer);function GP(r,e,t){fx[0]=r,e[t]=ya[0],e[t+1]=ya[1],e[t+2]=ya[2],e[t+3]=ya[3]}function WP(r,e){return ya[0]=r[e],ya[1]=r[e+1],ya[2]=r[e+2],ya[3]=r[e+3],fx[0]}var hx=new Float64Array([-0]),Ar=new Uint8Array(hx.buffer);function YP(r,e,t){hx[0]=r,e[t]=Ar[0],e[t+1]=Ar[1],e[t+2]=Ar[2],e[t+3]=Ar[3],e[t+4]=Ar[4],e[t+5]=Ar[5],e[t+6]=Ar[6],e[t+7]=Ar[7]}function ZP(r,e){return Ar[0]=r[e],Ar[1]=r[e+1],Ar[2]=r[e+2],Ar[3]=r[e+3],Ar[4]=r[e+4],Ar[5]=r[e+5],Ar[6]=r[e+6],Ar[7]=r[e+7],hx[0]}var kj=BigInt(Number.MAX_SAFE_INTEGER),Nj=BigInt(Number.MIN_SAFE_INTEGER),Sn=class r{constructor(e,t){l(this,"lo");l(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return hl;if(e<kj&&e>Nj)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>XP&&(s=0n,++n>XP&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return hl;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):hl}},hl=new Sn(0,0);hl.toBigInt=function(){return 0n};hl.zzEncode=hl.zzDecode=function(){return this};hl.length=function(){return 1};var XP=4294967296n;function jP(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function QP(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function dx(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function gs(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function F3(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var px=class{constructor(e){l(this,"buf");l(this,"pos");l(this,"len");l(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,gs(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw gs(this,4);return F3(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw gs(this,4);return F3(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw gs(this,4);let e=WP(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw gs(this,4);let e=ZP(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw gs(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return QP(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw gs(this,e);this.pos+=e}else do if(this.pos>=this.len)throw gs(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Sn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw gs(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw gs(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw gs(this,8);let e=F3(this.buf,this.pos+=4),t=F3(this.buf,this.pos+=4);return new Sn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=gn(this.buf,this.pos);return this.pos+=ce(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function mx(r){return new px(r instanceof Uint8Array?r:r.subarray())}function Le(r,e,t){let n=mx(r);return e.decode(n,void 0,t)}function gx(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return pe(i);s+i>e&&(n=pe(e),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var dl=class{constructor(e,t,n){l(this,"fn");l(this,"len");l(this,"next");l(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}};function yx(){}var wx=class{constructor(e){l(this,"head");l(this,"tail");l(this,"len");l(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},Oj=gx();function Mj(r){return globalThis.Buffer!=null?pe(r):Oj(r)}var S1=class{constructor(){l(this,"len");l(this,"head");l(this,"tail");l(this,"states");this.len=0,this.head=new dl(yx,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new dl(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new xx((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(V3,10,Sn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Sn.fromBigInt(e);return this._push(V3,t.length(),t)}uint64Number(e){return this._push(Et,ce(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Sn.fromBigInt(e).zzEncode();return this._push(V3,t.length(),t)}sint64Number(e){let t=Sn.fromNumber(e).zzEncode();return this._push(V3,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(bx,1,e?1:0)}fixed32(e){return this._push(v1,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Sn.fromBigInt(e);return this._push(v1,4,t.lo)._push(v1,4,t.hi)}fixed64Number(e){let t=Sn.fromNumber(e);return this._push(v1,4,t.lo)._push(v1,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(GP,4,e)}double(e){return this._push(YP,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(bx,1,0):this.uint32(t)._push(Kj,t,e)}string(e){let t=jP(e);return t!==0?this.uint32(t)._push(dx,t,e):this._push(bx,1,0)}fork(){return this.states=new wx(this),this.head=this.tail=new dl(yx,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new dl(yx,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=Mj(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function bx(r,e,t){e[t]=r&255}function Uj(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var xx=class extends dl{constructor(t,n){super(Uj,t,n);l(this,"next");this.next=void 0}};function V3(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function v1(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Kj(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(S1.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(Fj,e,r),this},S1.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(Vj,e,r),this});function Fj(r,e,t){e.set(r,t)}function Vj(r,e,t){r.length<40?dx(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(H(r),t)}function Ex(){return new S1}function ke(r,e){let t=Ex();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Bf;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Bf||(Bf={}));function H3(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Fn(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(o,i){let a=e(o);i.int32(a)},n=function(o){let i=o.int32();return e(i)};return H3("enum",Bf.VARINT,t,n)}function Ne(r,e){return H3("message",Bf.LENGTH_DELIMITED,r,e)}var Vr=class extends Error{constructor(t,n,s){super(t,s);l(this,"code");this.code=n}};var Hr;(function(r){let e;(function(s){s.FIN="FIN",s.STOP_SENDING="STOP_SENDING",s.RESET="RESET",s.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(s){s[s.FIN=0]="FIN",s[s.STOP_SENDING=1]="STOP_SENDING",s[s.RESET=2]="RESET",s[s.FIN_ACK=3]="FIN_ACK"})(t||(t={})),(function(s){s.codec=()=>Fn(t)})(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=Ne((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.flag!=null&&(o.uint32(8),r.Flag.codec().encode(s.flag,o)),s.message!=null&&(o.uint32(18),o.bytes(s.message)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.flag=r.Flag.codec().decode(s);break;case 2:i.message=s.bytes();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>ke(s,r.codec()),r.decode=s=>Le(s,r.codec())})(Hr||(Hr={}));var Hj=2*1024*1024,qj=30*1e3,q3=16*1024;function zj(r=q3){let e=ce(r-ce(r)),t=1+ce(Object.keys(Hr.Flag).length-1),n=1,s=r-e-t-n,o=ce(s);return e+t+n+o}var $j=zj(),Gj=5e3,Wj=5e3,vx=class extends k3{constructor(t){let n=t.onEnd;t.onEnd=o=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await bn(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),n?.(o)}).catch(i=>{this.log.error("error ending stream",i)})};super(t);l(this,"channel");l(this,"incomingData");l(this,"maxBufferedAmount");l(this,"bufferedAmountLowEventTimeout");l(this,"maxMessageSize");l(this,"receiveFinAck");l(this,"finAckTimeout");l(this,"openTimeout");switch(this.channel=t.channel,this.channel.binaryType="arraybuffer",this.incomingData=We(),this.bufferedAmountLowEventTimeout=t.bufferedAmountLowEventTimeout??qj,this.maxBufferedAmount=t.maxBufferedAmount??Hj,this.maxMessageSize=(t.maxMessageSize??q3)-$j,this.receiveFinAck=ue(),this.finAckTimeout=t.closeTimeout??Gj,this.openTimeout=t.openTimeout??Wj,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new K("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=o=>{this.timeline.open=new Date().getTime()},this.channel.onclose=o=>{this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=o=>{let i=o.error;this.abort(i)},this.channel.onmessage=async o=>{let{data:i}=o;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};let s=this;Promise.resolve().then(async()=>{for await(let o of ms(this.incomingData)){let i=s.processIncomingProtobuf(o);i!=null&&s.sourcePush(new Z(i))}}).catch(o=>{this.log.error("error processing incoming data channel messages",o)})}sendNewStream(){}async _sendMessage(t,n=!0){if(n&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await E1(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(s){throw s instanceof Qi?new K(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):s}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new K(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");this.channel.readyState!=="open"&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await E1(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(t.subarray())}async sendData(t){for(t=t.sublist();t.byteLength>0;){let n=Math.min(t.byteLength,this.maxMessageSize),s=t.subarray(0,n),o=Hr.encode({message:s}),i=ps.single(o);await this._sendMessage(i),t.consume(n)}}async sendReset(){await this._sendFlag(Hr.Flag.RESET)}async sendCloseWrite(t){if(await this._sendFlag(Hr.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await $e(this.receiveFinAck.promise,t?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(s){this.log.error("failed to await FIN_ACK",s)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(Hr.Flag.STOP_SENDING)}processIncomingProtobuf(t){let n=Hr.decode(t);if(n.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',n.flag,this.writeStatus,this.readStatus),n.flag===Hr.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Hr.Flag.FIN_ACK).catch(s=>{this.log.error("error sending FIN_ACK immediately",s)})),n.flag===Hr.Flag.RESET&&this.reset(),n.flag===Hr.Flag.STOP_SENDING&&this.remoteCloseRead(),n.flag===Hr.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return n.message}async _sendFlag(t){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,t.toString()),!1;this.log.trace("sending flag %s",t.toString());let n=Hr.encode({flag:t}),s=ps.single(n);try{return await this._sendMessage(s,!1),!0}catch(o){this.log.error("could not send flag %s",t.toString(),o)}return!1}};function Pf(r){let{channel:e,direction:t}=r;return new vx({id:t==="inbound"?`i${e.id}`:`r${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${t}:${e.id}`),...r})}var eL="/webrtc",ba=class{constructor(e,t){l(this,"protocol");l(this,"peerConnection");l(this,"bufferedStreams",[]);l(this,"metrics");l(this,"dataChannelOptions");l(this,"components");l(this,"log");this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??eL,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}let s={},o=Pf({channel:n,direction:"inbound",onEnd:i=>{s.onEnd(i)},logger:e.logger,...this.dataChannelOptions});s.stream=o,s.channel=n,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(i=>i.stream.id!==o.id)},this.bufferedStreams.push(s)}}createStreamMuxer(e){return new Sx(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}},Lf,z3,Sx=class{constructor(e,t){ne(this,Lf);l(this,"init");l(this,"streams");l(this,"protocol");l(this,"log");l(this,"peerConnection");l(this,"dataChannelOptions");l(this,"metrics");l(this,"logger");l(this,"source",B3());l(this,"sink",P3);this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??eL,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}let s=Pf({channel:n,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",n.id,n.readyState),ee(this,Lf,z3).call(this,s,n)},logger:this.logger,...this.dataChannelOptions});this.streams.push(s),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),ee(this,Lf,z3).call(this,n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(let t of this.streams)t.abort(e)}newStream(){let e=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",e.id);let t=Pf({channel:e,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",e.id,e.readyState),ee(this,Lf,z3).call(this,t,e)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}};Lf=new WeakSet,z3=function(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),HP(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)};var pl=globalThis.RTCPeerConnection,$3=globalThis.RTCSessionDescription,tL=globalThis.RTCIceCandidate;var _x=class{constructor(){l(this,"readNext");l(this,"haveNext");l(this,"ended");l(this,"nextResult");this.ended=!1,this.readNext=ue(),this.haveNext=ue()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ue(),e}async throw(e){return this.ended=!0,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ue(),await $e(this.readNext.promise,t?.signal,t)}};function rL(){return new _x}var G3=class extends Error{constructor(){super(...arguments);l(this,"name","UnexpectedEOFError");l(this,"code","ERR_UNEXPECTED_EOF")}};var Ax=class extends Error{constructor(t,n){super(t);l(this,"code");this.code=n}},Ix=class extends Ax{constructor(t){super(t,"ABORT_ERR");l(this,"type");this.type="aborted",this.name="AbortError"}};function nL(r,e){let t=rL();r.sink(t).catch(async i=>{await t.end(i)}),r.sink=async i=>{for await(let a of i)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let s=new Z;return{read:async(i,a)=>{a?.signal?.throwIfAborted();let c,u=new Promise((f,h)=>{c=()=>{h(new Ix("Read aborted"))},a?.signal?.addEventListener("abort",c)});try{if(i==null){let{done:h,value:d}=await Promise.race([n.next(),u]);return h===!0?new Z:d}for(;s.byteLength<i;){let{value:h,done:d}=await Promise.race([n.next(),u]);if(d===!0)throw new G3("unexpected end of input");s.append(h)}let f=s.sublist(0,i);return s.consume(i),f}finally{c!=null&&a?.signal?.removeEventListener("abort",c)}},write:async(i,a)=>{a?.signal?.throwIfAborted(),i instanceof Uint8Array?await t.push(i,a):await t.push(i.subarray(),a)},unwrap:()=>{if(s.byteLength>0){let i=r.source;r.source=(async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*i})()}return r}}}var W3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidMessageLengthError");l(this,"code","ERR_INVALID_MSG_LENGTH")}},Y3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthError");l(this,"code","ERR_MSG_DATA_TOO_LONG")}},Z3=class extends Error{constructor(){super(...arguments);l(this,"name","InvalidDataLengthLengthError");l(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function _1(r,e={}){let t=nL(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=ce(e.maxDataLength));let n=e?.lengthDecoder??Nt,s=e?.lengthEncoder??je;return{read:async i=>{let a=-1,c=new Z;for(;;){c.append(await t.read(1,i));try{a=n(c)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new W3("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new Z3("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new Y3("message length too long");return t.read(a,i)},write:async(i,a)=>{await t.write(new Z(s(i.byteLength),i),a)},writeV:async(i,a)=>{let c=new Z(...i.flatMap(u=>[s(u.byteLength),u]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function bt(r,e){let t=_1(r,e),n={read:async(s,o)=>{let i=await t.read(o);return s.decode(i)},write:async(s,o,i)=>{await t.write(o.encode(s),i)},writeV:async(s,o,i)=>{await t.writeV(s.map(a=>o.encode(a)),i)},pb:s=>({read:async o=>n.read(s,o),write:async(o,i)=>n.write(o,s,i),writeV:async(o,i)=>n.writeV(o,s,i),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var cn;(function(r){let e;(function(s){s.SDP_OFFER="SDP_OFFER",s.SDP_ANSWER="SDP_ANSWER",s.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.SDP_OFFER=0]="SDP_OFFER",s[s.SDP_ANSWER=1]="SDP_ANSWER",s[s.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),(function(s){s.codec=()=>Fn(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ne((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.data!=null&&(o.uint32(18),o.string(s.data)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.type=r.Type.codec().decode(s);break;case 2:i.data=s.string();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>ke(s,r.codec()),r.decode=s=>Le(s,r.codec())})(cn||(cn={}));var X3=async(r,e,t)=>{try{let n=ue();for(Zj(r,n);;){let s=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(s==null){t.signal?.throwIfAborted();break}if(s.type!==cn.Type.ICE_CANDIDATE)throw new K("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");let o=JSON.parse(s.data??"null");if(o===""||o===null){t.onProgress?.(new ve("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}let i=new tL(o);t.log.trace("%s received new ICE candidate %o",t.direction,o);try{t.onProgress?.(new ve("webrtc:add-ice-candidate",i.candidate)),await r.addIceCandidate(i)}catch(a){t.log.error("%s bad candidate received",t.direction,o,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0)throw n}};function Yj(r){return b1?r.iceConnectionState:r.connectionState}function Zj(r,e){r[b1?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(Yj(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new K("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break;default:break}}}async function sL({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:s,connectionManager:o,transportManager:i,log:a,logger:c,onProgress:u}){let{baseAddr:f}=oL(s);n?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",f);let h=f.getPeerId();if(h==null)throw new K("Relay peer was missing","ERR_INVALID_ADDRESS");let d=o.getConnections(Qe(h)),p,y=!1;d.length===0?(u?.(new ve("webrtc:dial-relay")),p=await i.dial(f,{signal:t,onProgress:u}),y=!0):(u?.(new ve("webrtc:reuse-relay-connection")),p=d[0]);try{u?.(new ve("webrtc:open-signaling-stream"));let x=await p.newStream(j3,{signal:t,runOnTransientConnection:!0}),b=bt(x).pb(cn),_=new pl(r),v=new ba({logger:c},{peerConnection:_,dataChannelOptions:e});try{let w=_.createDataChannel("init");_.onicecandidate=({candidate:F})=>{let A=JSON.stringify(F?.toJSON()??null);a.trace("initiator sending ICE candidate %o",F),b.write({type:cn.Type.ICE_CANDIDATE,data:A},{signal:t}).catch(E=>{a.error("error sending ICE candidate",E)})},_.onicecandidateerror=F=>{a.error("initiator ICE candidate error",F)};let R=await _.createOffer().catch(F=>{throw a.error("could not execute createOffer",F),new K("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")});a.trace("initiator send SDP offer %s",R.sdp),u?.(new ve("webrtc:send-sdp-offer")),await b.write({type:cn.Type.SDP_OFFER,data:R.sdp},{signal:t}),await _.setLocalDescription(R).catch(F=>{throw a.error("could not execute setLocalDescription",F),new K("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),u?.(new ve("webrtc:read-sdp-answer"));let N=await b.read({signal:t});if(N.type!==cn.Type.SDP_ANSWER)throw new K("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",N.data);let O=new $3({type:"answer",sdp:N.data});return await _.setRemoteDescription(O).catch(F=>{throw a.error("could not execute setRemoteDescription",F),new K("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.trace("initiator read candidates until connected"),u?.(new ve("webrtc:read-ice-candidates")),await X3(_,b,{direction:"initiator",signal:t,log:a,onProgress:u}),a.trace("initiator connected, closing init channel"),w.close(),u?.(new ve("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await x.close({signal:t}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:_,muxerFactory:v}}catch(w){throw a.error("outgoing signaling error",w),_.close(),x.abort(w),w}finally{_.onicecandidate=null,_.onicecandidateerror=null}}finally{if(y)try{await p.close({signal:t})}catch(x){p.abort(x)}}}var Xj=te("dns4"),jj=te("dns6"),Qj=te("dnsaddr"),xa=Rt(te("dns"),Qj,Xj,jj),Q3=Rt(te("ip4"),te("ip6")),kf=Rt(he(Q3,te("tcp")),he(xa,te("tcp"))),J3=he(Q3,te("udp")),Jj=he(J3,te("utp")),eQ=he(J3,te("quic")),tQ=he(J3,te("quic-v1")),Tx=Rt(he(kf,te("ws")),he(xa,te("ws"))),Nf=Rt(he(Tx,te("p2p")),Tx),Rx=Rt(he(kf,te("wss")),he(xa,te("wss")),he(kf,te("tls"),te("ws")),he(xa,te("tls"),te("ws"))),ml=Rt(he(Rx,te("p2p")),Rx),Cx=Rt(he(kf,te("http")),he(Q3,te("http")),he(xa,te("http"))),Dx=Rt(he(kf,te("https")),he(Q3,te("https")),he(xa,te("https"))),iL=he(J3,te("webrtc-direct"),te("certhash")),lL=Rt(he(iL,te("p2p")),iL),aL=he(tQ,te("webtransport"),te("certhash"),te("certhash")),uL=Rt(he(aL,te("p2p")),aL),fL=Rt(he(Nf,te("p2p-webrtc-star"),te("p2p")),he(ml,te("p2p-webrtc-star"),te("p2p")),he(Nf,te("p2p-webrtc-star")),he(ml,te("p2p-webrtc-star"))),Hve=Rt(he(Nf,te("p2p-websocket-star"),te("p2p")),he(ml,te("p2p-websocket-star"),te("p2p")),he(Nf,te("p2p-websocket-star")),he(ml,te("p2p-websocket-star"))),hL=Rt(he(Cx,te("p2p-webrtc-direct"),te("p2p")),he(Dx,te("p2p-webrtc-direct"),te("p2p")),he(Cx,te("p2p-webrtc-direct")),he(Dx,te("p2p-webrtc-direct"))),gl=Rt(Tx,Rx,Cx,Dx,fL,hL,kf,Jj,eQ,xa,lL,uL),qve=Rt(he(gl,te("p2p-stardust"),te("p2p")),he(gl,te("p2p-stardust"))),wa=Rt(he(gl,te("p2p")),fL,hL,lL,uL,te("p2p")),cL=Rt(he(wa,te("p2p-circuit"),wa),he(wa,te("p2p-circuit")),he(te("p2p-circuit"),wa),he(gl,te("p2p-circuit")),he(te("p2p-circuit"),gl),te("p2p-circuit")),dL=()=>Rt(he(cL,dL),cL),Zo=dL(),pL=Rt(he(Zo,wa,Zo),he(wa,Zo),he(Zo,wa),Zo,wa);var zve=Rt(he(Zo,te("webrtc"),te("p2p")),he(Zo,te("webrtc")),he(gl,te("webrtc"),te("p2p")),he(gl,te("webrtc")),te("webrtc"));function mL(r){function e(t){let n;try{n=xe(t)}catch{return!1}let s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function he(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:mL(e),partialMatch:e}}function Rt(...r){function e(n){let s=null;return r.some(o=>{let i=typeof o=="function"?o().partialMatch(n):o.partialMatch(n);return i!=null?(s=i,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:mL(e),partialMatch:e}}function te(r){let e=r;function t(s){let o;try{o=xe(s)}catch{return!1}let i=o.protoNames();return i.length===1&&i[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var e4=class extends Pt{constructor(t,n){super();l(this,"peerId");l(this,"transportManager");l(this,"shutdownController");this.peerId=t.peerId,this.transportManager=t.transportManager,this.shutdownController=n.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(t=>t!==this).map(t=>t.getAddrs().filter(n=>Zo.matches(n)).map(n=>n.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}};async function gL({peerConnection:r,stream:e,signal:t,connection:n,log:s}){s.trace("new inbound signaling stream");let o=bt(e).pb(cn);try{r.onicecandidate=({candidate:f})=>{let h=JSON.stringify(f?.toJSON()??null);s.trace("recipient sending ICE candidate %s",h),o.write({type:cn.Type.ICE_CANDIDATE,data:h},{signal:t}).catch(d=>{s.error("error sending ICE candidate",d)})};let a=await o.read({signal:t});if(a.type!==cn.Type.SDP_OFFER)throw new K(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");s.trace("recipient receive SDP offer %s",a.data);let c=new $3({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(f=>{throw s.error("could not execute setRemoteDescription",f),new K("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});let u=await r.createAnswer().catch(f=>{throw s.error("could not execute createAnswer",f),new K("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});s.trace("recipient send SDP answer %s",u.sdp),await o.write({type:cn.Type.SDP_ANSWER,data:u.sdp},{signal:t}),await r.setLocalDescription(u).catch(f=>{throw s.error("could not execute setLocalDescription",f),new K("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),s.trace("recipient read candidates until connected"),await X3(r,o,{direction:"recipient",signal:t,log:s})}catch(a){if(r.connectionState!=="connected")throw s.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}let i=xe(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",i),{remoteAddress:i}}var nQ="/webrtc",sQ="/p2p-circuit",j3="/webrtc-signaling/0.0.1",oQ=30*1e3,yL,bL,wL,xL;xL=bf,wL=Symbol.toStringTag,bL=Gt,yL=xf;var t4=class{constructor(e,t={}){l(this,"components");l(this,"init");l(this,"log");l(this,"_started",!1);l(this,"metrics");l(this,"shutdownController");l(this,xL,!0);l(this,wL,"@libp2p/webrtc");l(this,bL,["@libp2p/transport"]);l(this,yL,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,Ze(1/0,this.shutdownController.signal),e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(j3,e=>{this._onProtocol(e).catch(t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(j3),this._started=!1}createListener(e){return new e4(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(PP.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:n,peerConnection:s,muxerFactory:o}=await sL({rtcConfiguration:await w1(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),i=new ul(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(i,{skipProtection:!0,skipEncryption:!0,muxerFactory:o,onProgress:t.onProgress});return this._closeOnShutdown(s,i),a}async _onProtocol({connection:e,stream:t}){let n=AbortSignal.timeout(this.init.inboundConnectionTimeout??oQ),s=new pl(await w1(this.init.rtcConfiguration)),o=new ba(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:i}=await gL({peerConnection:s,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});let a=new ul(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:i,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:o}),this._closeOnShutdown(s,a)}catch(i){throw this.log.error("incoming signaling error",i),s.close(),t.abort(i),i}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function oL(r){let e=r.toString().split(nQ+"/");if(e.length!==2)throw new K("webrtc protocol was not present in multiaddr",vn.ERR_INVALID_MULTIADDR);if(!e[0].includes(sQ))throw new K("p2p-circuit protocol was not present in multiaddr",vn.ERR_INVALID_MULTIADDR);let t=xe(e[0]),s=xe("/"+e[1]).getPeerId();if(s==null)throw new K("destination peer id was missing",vn.ERR_INVALID_MULTIADDR);let o=t.protos().pop();if(o===void 0)throw new K("invalid multiaddr",vn.ERR_INVALID_MULTIADDR);return o.name!=="p2p"&&(t=t.encapsulate(`/p2p/${s}`)),{baseAddr:t,peerId:Qe(s)}}var c6={};pt(c6,{Ed25519PrivateKey:()=>ai,Ed25519PublicKey:()=>Sl,MAX_RSA_KEY_SIZE:()=>Il,RsaPrivateKey:()=>La,RsaPublicKey:()=>Al,Secp256k1PrivateKey:()=>Rl,Secp256k1PublicKey:()=>Tl,generateEphemeralKeyPair:()=>xk,generateKeyPair:()=>a6,generateKeyPairFromSeed:()=>KJ,importKey:()=>VJ,keyStretcher:()=>Ak,keysPBM:()=>Yf,marshalPrivateKey:()=>FJ,marshalPublicKey:()=>IE,supportedKeys:()=>gi,unmarshalPrivateKey:()=>yi,unmarshalPublicKey:()=>ka});var rE={};pt(rE,{Ed25519PrivateKey:()=>ai,Ed25519PublicKey:()=>Sl,generateKeyPair:()=>$Q,generateKeyPairFromSeed:()=>tE,unmarshalEd25519PrivateKey:()=>qQ,unmarshalEd25519PublicKey:()=>zQ});function Bx(r,e){let t=H(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=we([new Uint8Array(e-t.length),t])}return t}function Vn(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var yl=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function jo(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function ys(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function ur(r,...e){if(!jo(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Qo(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");ys(r.outputLen),ys(r.blockLen)}function Mf(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function vL(r,e){ur(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function _n(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Uf(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function bs(r,e){return r<<32-e|r>>>e}var SL=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",iQ=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Hn(r){if(ur(r),SL)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=iQ[r[t]];return e}var Xo={_0:48,_9:57,A:65,F:70,a:97,f:102};function EL(r){if(r>=Xo._0&&r<=Xo._9)return r-Xo._0;if(r>=Xo.A&&r<=Xo.F)return r-(Xo.A-10);if(r>=Xo.a&&r<=Xo.f)return r-(Xo.a-10)}function bl(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(SL)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let s=0,o=0;s<t;s++,o+=2){let i=EL(r.charCodeAt(o)),a=EL(r.charCodeAt(o+1));if(i===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}var aQ=async()=>{};async function _L(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);let o=Date.now()-n;o>=0&&o<e||(await aQ(),n+=o)}}function r4(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Ea(r){return typeof r=="string"&&(r=r4(r)),ur(r),r}function Px(r){return typeof r=="string"&&(r=r4(r)),ur(r),r}function qr(...r){let e=0;for(let n=0;n<r.length;n++){let s=r[n];ur(s),e+=s.length}let t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let o=r[n];t.set(o,s),s+=o.length}return t}function AL(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}var Of=class{};function Lx(r){let e=n=>r().update(Ea(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Zs(r=32){if(yl&&typeof yl.getRandomValues=="function")return yl.getRandomValues(new Uint8Array(r));if(yl&&typeof yl.randomBytes=="function")return Uint8Array.from(yl.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function cQ(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,u=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+u,a,n)}function IL(r,e,t){return r&e^~r&t}function TL(r,e,t){return r&e^r&t^e&t}var A1=class extends Of{constructor(e,t,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Uf(this.buffer)}update(e){Mf(this),e=Ea(e),ur(e);let{view:t,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=Uf(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Mf(this),vL(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;t[i++]=128,_n(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let h=i;h<s;h++)t[h]=0;cQ(n,s-8,BigInt(this.length*8),o),this.process(n,0);let a=Uf(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)a.setUint32(4*h,f[h],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Jo=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var fr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var n4=BigInt(4294967295),RL=BigInt(32);function lQ(r,e=!1){return e?{h:Number(r&n4),l:Number(r>>RL&n4)}:{h:Number(r>>RL&n4)|0,l:Number(r&n4)|0}}function CL(r,e=!1){let t=r.length,n=new Uint32Array(t),s=new Uint32Array(t);for(let o=0;o<t;o++){let{h:i,l:a}=lQ(r[o],e);[n[o],s[o]]=[i,a]}return[n,s]}var kx=(r,e,t)=>r>>>t,Nx=(r,e,t)=>r<<32-t|e>>>t,wl=(r,e,t)=>r>>>t|e<<32-t,xl=(r,e,t)=>r<<32-t|e>>>t,I1=(r,e,t)=>r<<64-t|e>>>t-32,T1=(r,e,t)=>r>>>t-32|e<<64-t;function Xs(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var DL=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),BL=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,PL=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),LL=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,kL=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),NL=(r,e,t,n,s,o)=>e+t+n+s+o+(r/2**32|0)|0;var fQ=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),va=new Uint32Array(64),s4=class extends A1{constructor(e=32){super(64,e,8,!1),this.A=Jo[0]|0,this.B=Jo[1]|0,this.C=Jo[2]|0,this.D=Jo[3]|0,this.E=Jo[4]|0,this.F=Jo[5]|0,this.G=Jo[6]|0,this.H=Jo[7]|0}get(){let{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)va[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){let d=va[h-15],p=va[h-2],y=bs(d,7)^bs(d,18)^d>>>3,x=bs(p,17)^bs(p,19)^p>>>10;va[h]=x+va[h-7]+y+va[h-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:u,H:f}=this;for(let h=0;h<64;h++){let d=bs(a,6)^bs(a,11)^bs(a,25),p=f+d+IL(a,c,u)+fQ[h]+va[h]|0,x=(bs(n,2)^bs(n,13)^bs(n,22))+TL(n,s,o)|0;f=u,u=c,c=a,a=i+p|0,i=o,o=s,s=n,n=p+x|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(n,s,o,i,a,c,u,f)}roundClean(){_n(va)}destroy(){this.set(0,0,0,0,0,0,0,0),_n(this.buffer)}};var OL=CL(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),hQ=OL[0],dQ=OL[1],Sa=new Uint32Array(80),_a=new Uint32Array(80),o4=class extends A1{constructor(e=64){super(128,e,16,!1),this.Ah=fr[0]|0,this.Al=fr[1]|0,this.Bh=fr[2]|0,this.Bl=fr[3]|0,this.Ch=fr[4]|0,this.Cl=fr[5]|0,this.Dh=fr[6]|0,this.Dl=fr[7]|0,this.Eh=fr[8]|0,this.El=fr[9]|0,this.Fh=fr[10]|0,this.Fl=fr[11]|0,this.Gh=fr[12]|0,this.Gl=fr[13]|0,this.Hh=fr[14]|0,this.Hl=fr[15]|0}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:u,El:f,Fh:h,Fl:d,Gh:p,Gl:y,Hh:x,Hl:b}=this;return[e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b]}set(e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=f|0,this.Fh=h|0,this.Fl=d|0,this.Gh=p|0,this.Gl=y|0,this.Hh=x|0,this.Hl=b|0}process(e,t){for(let w=0;w<16;w++,t+=4)Sa[w]=e.getUint32(t),_a[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){let R=Sa[w-15]|0,N=_a[w-15]|0,O=wl(R,N,1)^wl(R,N,8)^kx(R,N,7),F=xl(R,N,1)^xl(R,N,8)^Nx(R,N,7),A=Sa[w-2]|0,E=_a[w-2]|0,L=wl(A,E,19)^I1(A,E,61)^kx(A,E,6),U=xl(A,E,19)^T1(A,E,61)^Nx(A,E,6),B=PL(F,U,_a[w-7],_a[w-16]),I=LL(B,O,L,Sa[w-7],Sa[w-16]);Sa[w]=I|0,_a[w]=B|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:u,Dl:f,Eh:h,El:d,Fh:p,Fl:y,Gh:x,Gl:b,Hh:_,Hl:v}=this;for(let w=0;w<80;w++){let R=wl(h,d,14)^wl(h,d,18)^I1(h,d,41),N=xl(h,d,14)^xl(h,d,18)^T1(h,d,41),O=h&p^~h&x,F=d&y^~d&b,A=kL(v,N,F,dQ[w],_a[w]),E=NL(A,_,R,O,hQ[w],Sa[w]),L=A|0,U=wl(n,s,28)^I1(n,s,34)^I1(n,s,39),B=xl(n,s,28)^T1(n,s,34)^T1(n,s,39),I=n&o^n&a^o&a,g=s&i^s&c^i&c;_=x|0,v=b|0,x=p|0,b=y|0,p=h|0,y=d|0,{h,l:d}=Xs(u|0,f|0,E|0,L|0),u=a|0,f=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let m=DL(L,B,g);n=BL(m,E,U,I),s=m|0}({h:n,l:s}=Xs(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=Xs(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=Xs(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l:f}=Xs(this.Dh|0,this.Dl|0,u|0,f|0),{h,l:d}=Xs(this.Eh|0,this.El|0,h|0,d|0),{h:p,l:y}=Xs(this.Fh|0,this.Fl|0,p|0,y|0),{h:x,l:b}=Xs(this.Gh|0,this.Gl|0,x|0,b|0),{h:_,l:v}=Xs(this.Hh|0,this.Hl|0,_|0,v|0),this.set(n,s,o,i,a,c,u,f,h,d,p,y,x,b,_,v)}roundClean(){_n(Sa,_a)}destroy(){_n(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var i4=Lx(()=>new s4);var a4=Lx(()=>new o4);var Ux=BigInt(0),Mx=BigInt(1);function ei(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function An(r,e,t=""){let n=jo(r),s=r?.length,o=e!==void 0;if(!n||o&&s!==e){let i=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return r}function R1(r){let e=r.toString(16);return e.length&1?"0"+e:e}function ML(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Ux:BigInt("0x"+r)}function Kf(r){return ML(Hn(r))}function qn(r){return ur(r),ML(Hn(Uint8Array.from(r).reverse()))}function c4(r,e){return bl(r.toString(16).padStart(e*2,"0"))}function C1(r,e){return c4(r,e).reverse()}function He(r,e,t){let n;if(typeof e=="string")try{n=bl(e)}catch(o){throw new Error(r+" must be hex string or Uint8Array, cause: "+o)}else if(jo(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");let s=n.length;if(typeof t=="number"&&s!==t)throw new Error(r+" of length "+t+" expected, got "+s);return n}function UL(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}function Kx(r){return Uint8Array.from(r)}var Ox=r=>typeof r=="bigint"&&Ux<=r;function KL(r,e,t){return Ox(r)&&Ox(e)&&Ox(t)&&e<=r&&r<t}function Aa(r,e,t,n){if(!KL(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function l4(r){let e;for(e=0;r>Ux;r>>=Mx,e+=1);return e}var Ia=r=>(Mx<<BigInt(r))-Mx;function FL(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=p=>new Uint8Array(p),s=p=>Uint8Array.of(p),o=n(r),i=n(r),a=0,c=()=>{o.fill(1),i.fill(0),a=0},u=(...p)=>t(i,o,...p),f=(p=n(0))=>{i=u(s(0),p),o=u(),p.length!==0&&(i=u(s(1),p),o=u())},h=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let p=0,y=[];for(;p<e;){o=u();let x=o.slice();y.push(x),p+=o.length}return qr(...y)};return(p,y)=>{c(),f(p);let x;for(;!(x=y(h()));)f();return c(),x}}function js(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,o,i){let a=r[s];if(i&&a===void 0)return;let c=typeof a;if(c!==o||a===null)throw new Error(`param "${s}" is invalid: expected ${o}, got ${c}`)}Object.entries(e).forEach(([s,o])=>n(s,o,!1)),Object.entries(t).forEach(([s,o])=>n(s,o,!0))}var Fx=()=>{throw new Error("not implemented")};function Ff(r){let e=new WeakMap;return(t,...n)=>{let s=e.get(t);if(s!==void 0)return s;let o=r(t,...n);return e.set(t,o),o}}var zr=BigInt(0),Xt=BigInt(1),El=BigInt(2),qL=BigInt(3),zL=BigInt(4),$L=BigInt(5),pQ=BigInt(7),GL=BigInt(8),mQ=BigInt(9),WL=BigInt(16);function rt(r,e){let t=r%e;return t>=zr?t:e+t}function nt(r,e,t){let n=r;for(;e-- >zr;)n*=n,n%=t;return n}function VL(r,e){if(r===zr)throw new Error("invert: expected non-zero number");if(e<=zr)throw new Error("invert: expected positive modulus, got "+e);let t=rt(r,e),n=e,s=zr,o=Xt,i=Xt,a=zr;for(;t!==zr;){let u=n/t,f=n%t,h=s-i*u,d=o-a*u;n=t,t=f,s=i,o=a,i=h,a=d}if(n!==Xt)throw new Error("invert: does not exist");return rt(s,e)}function Vx(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function YL(r,e){let t=(r.ORDER+Xt)/zL,n=r.pow(e,t);return Vx(r,n,e),n}function gQ(r,e){let t=(r.ORDER-$L)/GL,n=r.mul(e,El),s=r.pow(n,t),o=r.mul(e,s),i=r.mul(r.mul(o,El),s),a=r.mul(o,r.sub(i,r.ONE));return Vx(r,a,e),a}function yQ(r){let e=In(r),t=ZL(r),n=t(e,e.neg(e.ONE)),s=t(e,n),o=t(e,e.neg(n)),i=(r+pQ)/WL;return(a,c)=>{let u=a.pow(c,i),f=a.mul(u,n),h=a.mul(u,s),d=a.mul(u,o),p=a.eql(a.sqr(f),c),y=a.eql(a.sqr(h),c);u=a.cmov(u,f,p),f=a.cmov(d,h,y);let x=a.eql(a.sqr(f),c),b=a.cmov(u,f,x);return Vx(a,b,c),b}}function ZL(r){if(r<qL)throw new Error("sqrt is not defined for small field");let e=r-Xt,t=0;for(;e%El===zr;)e/=El,t++;let n=El,s=In(r);for(;HL(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return YL;let o=s.pow(n,e),i=(e+Xt)/El;return function(c,u){if(c.is0(u))return u;if(HL(c,u)!==1)throw new Error("Cannot find square root");let f=t,h=c.mul(c.ONE,o),d=c.pow(u,e),p=c.pow(u,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let y=1,x=c.sqr(d);for(;!c.eql(x,c.ONE);)if(y++,x=c.sqr(x),y===f)throw new Error("Cannot find square root");let b=Xt<<BigInt(f-y-1),_=c.pow(h,b);f=y,h=c.sqr(_),d=c.mul(d,h),p=c.mul(p,_)}return p}}function bQ(r){return r%zL===qL?YL:r%GL===$L?gQ:r%WL===mQ?yQ(r):ZL(r)}var ti=(r,e)=>(rt(r,e)&Xt)===Xt,wQ=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Hx(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=wQ.reduce((n,s)=>(n[s]="function",n),e);return js(r,t),r}function xQ(r,e,t){if(t<zr)throw new Error("invalid exponent, negatives unsupported");if(t===zr)return r.ONE;if(t===Xt)return e;let n=r.ONE,s=e;for(;t>zr;)t&Xt&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Xt;return n}function D1(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),o=r.inv(s);return e.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),o),n}function HL(r,e){let t=(r.ORDER-Xt)/El,n=r.pow(e,t),s=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function u4(r,e){e!==void 0&&ys(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function In(r,e,t=!1,n={}){if(r<=zr)throw new Error("invalid field: expected ORDER > 0, got "+r);let s,o,i=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");let d=e;d.BITS&&(s=d.BITS),d.sqrt&&(o=d.sqrt),typeof d.isLE=="boolean"&&(t=d.isLE),typeof d.modFromBytes=="boolean"&&(i=d.modFromBytes),a=d.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(o=n.sqrt);let{nBitLength:c,nByteLength:u}=u4(r,s);if(u>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let f,h=Object.freeze({ORDER:r,isLE:t,BITS:c,BYTES:u,MASK:Ia(c),ZERO:zr,ONE:Xt,allowedLengths:a,create:d=>rt(d,r),isValid:d=>{if(typeof d!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof d);return zr<=d&&d<r},is0:d=>d===zr,isValidNot0:d=>!h.is0(d)&&h.isValid(d),isOdd:d=>(d&Xt)===Xt,neg:d=>rt(-d,r),eql:(d,p)=>d===p,sqr:d=>rt(d*d,r),add:(d,p)=>rt(d+p,r),sub:(d,p)=>rt(d-p,r),mul:(d,p)=>rt(d*p,r),pow:(d,p)=>xQ(h,d,p),div:(d,p)=>rt(d*VL(p,r),r),sqrN:d=>d*d,addN:(d,p)=>d+p,subN:(d,p)=>d-p,mulN:(d,p)=>d*p,inv:d=>VL(d,r),sqrt:o||(d=>(f||(f=bQ(r)),f(h,d))),toBytes:d=>t?C1(d,u):c4(d,u),fromBytes:(d,p=!0)=>{if(a){if(!a.includes(d.length)||d.length>u)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+d.length);let x=new Uint8Array(u);x.set(d,t?0:x.length-d.length),d=x}if(d.length!==u)throw new Error("Field.fromBytes: expected "+u+" bytes, got "+d.length);let y=t?qn(d):Kf(d);if(i&&(y=rt(y,r)),!p&&!h.isValid(y))throw new Error("invalid field element: outside of range 0..ORDER");return y},invertBatch:d=>D1(h,d),cmov:(d,p,y)=>y?p:d});return Object.freeze(h)}function XL(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function qx(r){let e=XL(r);return e+Math.ceil(e/2)}function zx(r,e,t=!1){let n=r.length,s=XL(e),o=qx(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let i=t?qn(r):Kf(r),a=rt(i,e-Xt)+Xt;return t?C1(a,s):c4(a,s)}var Vf=BigInt(0),vl=BigInt(1);function B1(r,e){let t=e.negate();return r?t:e}function ri(r,e){let t=D1(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function ek(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function $x(r,e){ek(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,o=Ia(r),i=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function jL(r,e,t){let{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=t,a=Number(r&s),c=r>>i;a>n&&(a-=o,c+=vl);let u=e*n,f=u+Math.abs(a)-1,h=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:f,isZero:h,isNeg:d,isNegF:p,offsetF:u}}function EQ(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function vQ(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}var Gx=new WeakMap,tk=new WeakMap;function Wx(r){return tk.get(r)||1}function QL(r){if(r!==Vf)throw new Error("invalid wNAF")}var Hf=class{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>Vf;)t&vl&&(n=n.add(s)),s=s.double(),t>>=vl;return n}precomputeWindow(e,t){let{windows:n,windowSize:s}=$x(t,this.bits),o=[],i=e,a=i;for(let c=0;c<n;c++){a=i,o.push(a);for(let u=1;u<s;u++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=$x(e,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:p}=jL(n,a,i);n=c,f?o=o.add(B1(d,t[p])):s=s.add(B1(h,t[u]))}return QL(n),{p:s,f:o}}wNAFUnsafe(e,t,n,s=this.ZERO){let o=$x(e,this.bits);for(let i=0;i<o.windows&&n!==Vf;i++){let{nextN:a,offset:c,isZero:u,isNeg:f}=jL(n,i,o);if(n=a,!u){let h=t[c];s=s.add(f?h.negate():h)}}return QL(n),s}getPrecomputes(e,t,n){let s=Gx.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),Gx.set(t,s))),s}cached(e,t,n){let s=Wx(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){let o=Wx(e);return o===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),t,s)}createCache(e,t){ek(t,this.bits),tk.set(e,t),Gx.delete(e)}hasCache(e){return Wx(e)!==1}};function rk(r,e,t,n){let s=e,o=r.ZERO,i=r.ZERO;for(;t>Vf||n>Vf;)t&vl&&(o=o.add(s)),n&vl&&(i=i.add(s)),s=s.double(),t>>=vl,n>>=vl;return{p1:o,p2:i}}function qf(r,e,t,n){EQ(t,r),vQ(n,e);let s=t.length,o=n.length;if(s!==o)throw new Error("arrays of points and scalars must have equal length");let i=r.ZERO,a=l4(BigInt(s)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let u=Ia(c),f=new Array(Number(u)+1).fill(i),h=Math.floor((e.BITS-1)/c)*c,d=i;for(let p=h;p>=0;p-=c){f.fill(i);for(let x=0;x<o;x++){let b=n[x],_=Number(b>>BigInt(p)&u);f[_]=f[_].add(t[x])}let y=i;for(let x=f.length-1,b=i;x>0;x--)b=b.add(f[x]),y=y.add(b);if(d=d.add(y),p!==0)for(let x=0;x<c;x++)d=d.double()}return d}function JL(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Hx(e),e}else return In(r,{isLE:t})}function f4(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let u=e[c];if(!(typeof u=="bigint"&&u>Vf))throw new Error(`CURVE.${c} must be positive bigint`)}let s=JL(e.p,t.Fp,n),o=JL(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}var Ta=BigInt(0),jt=BigInt(1),Yx=BigInt(2),SQ=BigInt(8);function _Q(r,e,t,n){let s=r.sqr(t),o=r.sqr(n),i=r.add(r.mul(e.a,s),o),a=r.add(r.ONE,r.mul(e.d,r.mul(s,o)));return r.eql(i,a)}function AQ(r,e={}){let t=f4("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i}=o;js(e,{},{uvRatio:"function"});let a=Yx<<BigInt(s.BYTES*8)-jt,c=b=>n.create(b),u=e.uvRatio||((b,_)=>{try{return{isValid:!0,value:n.sqrt(n.div(b,_))}}catch{return{isValid:!1,value:Ta}}});if(!_Q(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function f(b,_,v=!1){let w=v?jt:Ta;return Aa("coordinate "+b,_,w,a),_}function h(b){if(!(b instanceof y))throw new Error("ExtendedPoint expected")}let d=Ff((b,_)=>{let{X:v,Y:w,Z:R}=b,N=b.is0();_==null&&(_=N?SQ:n.inv(R));let O=c(v*_),F=c(w*_),A=n.mul(R,_);if(N)return{x:Ta,y:jt};if(A!==jt)throw new Error("invZ was invalid");return{x:O,y:F}}),p=Ff(b=>{let{a:_,d:v}=o;if(b.is0())throw new Error("bad point: ZERO");let{X:w,Y:R,Z:N,T:O}=b,F=c(w*w),A=c(R*R),E=c(N*N),L=c(E*E),U=c(F*_),B=c(E*c(U+A)),I=c(L+c(v*c(F*A)));if(B!==I)throw new Error("bad point: equation left != right (1)");let g=c(w*R),m=c(N*O);if(g!==m)throw new Error("bad point: equation left != right (2)");return!0});class y{constructor(_,v,w,R){this.X=f("x",_),this.Y=f("y",v),this.Z=f("z",w,!0),this.T=f("t",R),Object.freeze(this)}static CURVE(){return o}static fromAffine(_){if(_ instanceof y)throw new Error("extended point not allowed");let{x:v,y:w}=_||{};return f("x",v),f("y",w),new y(v,w,jt,c(v*w))}static fromBytes(_,v=!1){let w=n.BYTES,{a:R,d:N}=o;_=Kx(An(_,w,"point")),ei(v,"zip215");let O=Kx(_),F=_[w-1];O[w-1]=F&-129;let A=qn(O),E=v?a:n.ORDER;Aa("point.y",A,Ta,E);let L=c(A*A),U=c(L-jt),B=c(N*L-R),{isValid:I,value:g}=u(U,B);if(!I)throw new Error("bad point: invalid y coordinate");let m=(g&jt)===jt,S=(F&128)!==0;if(!v&&g===Ta&&S)throw new Error("bad point: x=0 and x_0=1");return S!==m&&(g=c(-g)),y.fromAffine({x:g,y:A})}static fromHex(_,v=!1){return y.fromBytes(He("point",_),v)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(_=8,v=!0){return x.createCache(this,_),v||this.multiply(Yx),this}assertValidity(){p(this)}equals(_){h(_);let{X:v,Y:w,Z:R}=this,{X:N,Y:O,Z:F}=_,A=c(v*F),E=c(N*R),L=c(w*F),U=c(O*R);return A===E&&L===U}is0(){return this.equals(y.ZERO)}negate(){return new y(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:_}=o,{X:v,Y:w,Z:R}=this,N=c(v*v),O=c(w*w),F=c(Yx*c(R*R)),A=c(_*N),E=v+w,L=c(c(E*E)-N-O),U=A+O,B=U-F,I=A-O,g=c(L*B),m=c(U*I),S=c(L*I),T=c(B*U);return new y(g,m,T,S)}add(_){h(_);let{a:v,d:w}=o,{X:R,Y:N,Z:O,T:F}=this,{X:A,Y:E,Z:L,T:U}=_,B=c(R*A),I=c(N*E),g=c(F*w*U),m=c(O*L),S=c((R+N)*(A+E)-B-I),T=m-g,P=m+g,C=c(I-v*B),k=c(S*T),D=c(P*C),M=c(S*C),q=c(T*P);return new y(k,D,q,M)}subtract(_){return this.add(_.negate())}multiply(_){if(!s.isValidNot0(_))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:v,f:w}=x.cached(this,_,R=>ri(y,R));return ri(y,[v,w])[0]}multiplyUnsafe(_,v=y.ZERO){if(!s.isValid(_))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return _===Ta?y.ZERO:this.is0()||_===jt?this:x.unsafe(this,_,w=>ri(y,w),v)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return x.unsafe(this,o.n).is0()}toAffine(_){return d(this,_)}clearCofactor(){return i===jt?this:this.multiplyUnsafe(i)}toBytes(){let{x:_,y:v}=this.toAffine(),w=n.toBytes(v);return w[w.length-1]|=_&jt?128:0,w}toHex(){return Hn(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(_){return ri(y,_)}static msm(_,v){return qf(y,s,_,v)}_setWindowSize(_){this.precompute(_)}toRawBytes(){return this.toBytes()}}y.BASE=new y(o.Gx,o.Gy,jt,c(o.Gx*o.Gy)),y.ZERO=new y(Ta,jt,jt,Ta),y.Fp=n,y.Fn=s;let x=new Hf(y,s.BITS);return y.BASE.precompute(8),y}var h4=class{constructor(e){this.ep=e}static fromBytes(e){Fx()}static fromHex(e){Fx()}get x(){return this.toAffine().x}get y(){return this.toAffine().y}clearCofactor(){return this}assertValidity(){this.ep.assertValidity()}toAffine(e){return this.ep.toAffine(e)}toHex(){return Hn(this.toBytes())}toString(){return this.toHex()}isTorsionFree(){return!0}isSmallOrder(){return!1}add(e){return this.assertSame(e),this.init(this.ep.add(e.ep))}subtract(e){return this.assertSame(e),this.init(this.ep.subtract(e.ep))}multiply(e){return this.init(this.ep.multiply(e))}multiplyUnsafe(e){return this.init(this.ep.multiplyUnsafe(e))}double(){return this.init(this.ep.double())}negate(){return this.init(this.ep.negate())}precompute(e,t){return this.init(this.ep.precompute(e,t))}toRawBytes(){return this.toBytes()}};function IQ(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');js(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:s,Fp:o,Fn:i}=r,a=t.randomBytes||Zs,c=t.adjustScalarBytes||(E=>E),u=t.domain||((E,L,U)=>{if(ei(U,"phflag"),L.length||U)throw new Error("Contexts/pre-hash are not supported");return E});function f(E){return i.create(qn(E))}function h(E){let L=w.secretKey;E=He("private key",E,L);let U=He("hashed private key",e(E),2*L),B=c(U.slice(0,L)),I=U.slice(L,2*L),g=f(B);return{head:B,prefix:I,scalar:g}}function d(E){let{head:L,prefix:U,scalar:B}=h(E),I=s.multiply(B),g=I.toBytes();return{head:L,prefix:U,scalar:B,point:I,pointBytes:g}}function p(E){return d(E).pointBytes}function y(E=Uint8Array.of(),...L){let U=qr(...L);return f(e(u(U,He("context",E),!!n)))}function x(E,L,U={}){E=He("message",E),n&&(E=n(E));let{prefix:B,scalar:I,pointBytes:g}=d(L),m=y(U.context,B,E),S=s.multiply(m).toBytes(),T=y(U.context,S,g,E),P=i.create(m+T*I);if(!i.isValid(P))throw new Error("sign failed: invalid s");let C=qr(S,i.toBytes(P));return An(C,w.signature,"result")}let b={zip215:!0};function _(E,L,U,B=b){let{context:I,zip215:g}=B,m=w.signature;E=He("signature",E,m),L=He("message",L),U=He("publicKey",U,w.publicKey),g!==void 0&&ei(g,"zip215"),n&&(L=n(L));let S=m/2,T=E.subarray(0,S),P=qn(E.subarray(S,m)),C,k,D;try{C=r.fromBytes(U,g),k=r.fromBytes(T,g),D=s.multiplyUnsafe(P)}catch{return!1}if(!g&&C.isSmallOrder())return!1;let M=y(I,k.toBytes(),C.toBytes(),L);return k.add(C.multiplyUnsafe(M)).subtract(D).clearCofactor().is0()}let v=o.BYTES,w={secretKey:v,publicKey:v,signature:2*v,seed:v};function R(E=a(w.seed)){return An(E,w.seed,"seed")}function N(E){let L=A.randomSecretKey(E);return{secretKey:L,publicKey:p(L)}}function O(E){return jo(E)&&E.length===i.BYTES}function F(E,L){try{return!!r.fromBytes(E,L)}catch{return!1}}let A={getExtendedPublicKey:d,randomSecretKey:R,isValidSecretKey:O,isValidPublicKey:F,toMontgomery(E){let{y:L}=r.fromBytes(E),U=w.publicKey,B=U===32;if(!B&&U!==57)throw new Error("only defined for 25519 and 448");let I=B?o.div(jt+L,jt-L):o.div(L-jt,L+jt);return o.toBytes(I)},toMontgomerySecret(E){let L=w.secretKey;An(E,L);let U=e(E.subarray(0,L));return c(U).subarray(0,L)},randomPrivateKey:R,precompute(E=8,L=r.BASE){return L.precompute(E,!1)}};return Object.freeze({keygen:N,getPublicKey:p,sign:x,verify:_,utils:A,Point:r,lengths:w})}function TQ(r){let e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=In(e.n,r.nBitLength,!0),s={Fp:t,Fn:n,uvRatio:r.uvRatio},o={randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:s,hash:r.hash,eddsaOpts:o}}function RQ(r,e){let t=e.Point;return Object.assign({},e,{ExtendedPoint:t,CURVE:r,nBitLength:t.Fn.BITS,nByteLength:t.Fn.BYTES})}function nk(r){let{CURVE:e,curveOpts:t,hash:n,eddsaOpts:s}=TQ(r),o=AQ(e,t),i=IQ(o,n,s);return RQ(r,i)}var P1=BigInt(0),zf=BigInt(1),d4=BigInt(2);function CQ(r){return js(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function sk(r){let e=CQ(r),{P:t,type:n,adjustScalarBytes:s,powPminus2:o,randomBytes:i}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");let c=i||Zs,u=a?255:448,f=a?32:56,h=BigInt(a?9:5),d=BigInt(a?121665:39081),p=a?d4**BigInt(254):d4**BigInt(447),y=a?BigInt(8)*d4**BigInt(251)-zf:BigInt(4)*d4**BigInt(445)-zf,x=p+y+zf,b=I=>rt(I,t),_=v(h);function v(I){return C1(b(I),f)}function w(I){let g=He("u coordinate",I,f);return a&&(g[31]&=127),b(qn(g))}function R(I){return qn(s(He("scalar",I,f)))}function N(I,g){let m=A(w(g),R(I));if(m===P1)throw new Error("invalid private or public key received");return v(m)}function O(I){return N(I,_)}function F(I,g,m){let S=b(I*(g-m));return g=b(g-S),m=b(m+S),{x_2:g,x_3:m}}function A(I,g){Aa("u",I,P1,t),Aa("scalar",g,p,x);let m=g,S=I,T=zf,P=P1,C=I,k=zf,D=P1;for(let q=BigInt(u-1);q>=P1;q--){let W=m>>q&zf;D^=W,{x_2:T,x_3:C}=F(D,T,C),{x_2:P,x_3:k}=F(D,P,k),D=W;let G=T+P,$=b(G*G),X=T-P,Q=b(X*X),J=$-Q,Y=C+k,re=C-k,sr=b(re*G),or=b(Y*X),CA=sr+or,DA=sr-or;C=b(CA*CA),k=b(S*b(DA*DA)),T=b($*Q),P=b(J*($+b(d*J)))}({x_2:T,x_3:C}=F(D,T,C)),{x_2:P,x_3:k}=F(D,P,k);let M=o(P);return b(T*M)}let E={secretKey:f,publicKey:f,seed:f},L=(I=c(f))=>(ur(I,E.seed),I);function U(I){let g=L(I);return{secretKey:g,publicKey:O(g)}}return{keygen:U,getSharedSecret:(I,g)=>N(I,g),getPublicKey:I=>O(I),scalarMult:N,scalarMultBase:O,utils:{randomSecretKey:L,randomPrivateKey:L},GuBytes:_.slice(),lengths:E}}var DQ=BigInt(0),si=BigInt(1),ok=BigInt(2),BQ=BigInt(3),PQ=BigInt(5),LQ=BigInt(8),$f=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),L1={p:$f,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:LQ,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function ck(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),o=$f,a=r*r%o*r%o,c=nt(a,ok,o)*a%o,u=nt(c,si,o)*r%o,f=nt(u,PQ,o)*u%o,h=nt(f,e,o)*f%o,d=nt(h,t,o)*h%o,p=nt(d,n,o)*d%o,y=nt(p,s,o)*p%o,x=nt(y,s,o)*p%o,b=nt(x,e,o)*f%o;return{pow_p_5_8:nt(b,ok,o)*r%o,b2:a}}function lk(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var Zx=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function Qx(r,e){let t=$f,n=rt(e*e*e,t),s=rt(n*n*e,t),o=ck(r*s).pow_p_5_8,i=rt(r*n*o,t),a=rt(e*i*i,t),c=i,u=rt(i*Zx,t),f=a===r,h=a===rt(-r,t),d=a===rt(-r*Zx,t);return f&&(i=c),(h||d)&&(i=u),ti(i,t)&&(i=rt(-i,t)),{isValid:f||h,value:i}}var ni=In(L1.p,{isLE:!0}),kQ=In(L1.n,{isLE:!0}),NQ={...L1,Fp:ni,hash:a4,adjustScalarBytes:lk,uvRatio:Qx},Tn=nk(NQ);var k1=(()=>{let r=ni.ORDER;return sk({P:r,type:"x25519",powPminus2:e=>{let{pow_p_5_8:t,b2:n}=ck(e);return rt(nt(t,BQ,r)*n,r)},adjustScalarBytes:lk})})();var Xx=Zx,OQ=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),MQ=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),UQ=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),KQ=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952"),ik=r=>Qx(si,r),FQ=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),jx=r=>Tn.Point.Fp.create(qn(r)&FQ);function ak(r){let{d:e}=L1,t=$f,n=_=>ni.create(_),s=n(Xx*r*r),o=n((s+si)*UQ),i=BigInt(-1),a=n((i-e*s)*n(s+e)),{isValid:c,value:u}=Qx(o,a),f=n(u*r);ti(f,t)||(f=n(-f)),c||(u=f),c||(i=s);let h=n(i*(s-si)*KQ-a),d=u*u,p=n((u+u)*a),y=n(h*OQ),x=n(si-d),b=n(si+d);return new Tn.Point(n(p*b),n(x*y),n(y*b),n(p*x))}function VQ(r){ur(r,64);let e=jx(r.subarray(0,32)),t=ak(e),n=jx(r.subarray(32,64)),s=ak(n);return new oi(t.add(s))}var oi=class r extends h4{constructor(e){super(e)}static fromAffine(e){return new r(Tn.Point.fromAffine(e))}assertSame(e){if(!(e instanceof r))throw new Error("RistrettoPoint expected")}init(e){return new r(e)}static hashToCurve(e){return VQ(He("ristrettoHash",e,64))}static fromBytes(e){ur(e,32);let{a:t,d:n}=L1,s=$f,o=R=>ni.create(R),i=jx(e);if(!UL(ni.toBytes(i),e)||ti(i,s))throw new Error("invalid ristretto255 encoding 1");let a=o(i*i),c=o(si+t*a),u=o(si-t*a),f=o(c*c),h=o(u*u),d=o(t*n*f-h),{isValid:p,value:y}=ik(o(d*h)),x=o(y*u),b=o(y*x*d),_=o((i+i)*x);ti(_,s)&&(_=o(-_));let v=o(c*b),w=o(_*v);if(!p||ti(w,s)||v===DQ)throw new Error("invalid ristretto255 encoding 2");return new r(new Tn.Point(_,v,si,w))}static fromHex(e){return r.fromBytes(He("ristrettoHex",e,32))}static msm(e,t){return qf(r,Tn.Point.Fn,e,t)}toBytes(){let{X:e,Y:t,Z:n,T:s}=this.ep,o=$f,i=b=>ni.create(b),a=i(i(n+t)*i(n-t)),c=i(e*t),u=i(c*c),{value:f}=ik(i(a*u)),h=i(f*a),d=i(f*c),p=i(h*d*s),y;if(ti(s*p,o)){let b=i(t*Xx),_=i(e*Xx);e=b,t=_,y=i(h*MQ)}else y=d;ti(e*p,o)&&(t=i(-t));let x=i((n-t)*y);return ti(x,o)&&(x=i(-x)),ni.toBytes(x)}equals(e){this.assertSame(e);let{X:t,Y:n}=this.ep,{X:s,Y:o}=e.ep,i=u=>ni.create(u),a=i(t*o)===i(n*s),c=i(n*o)===i(t*s);return a||c}is0(){return this.equals(r.ZERO)}};oi.BASE=new oi(Tn.Point.BASE);oi.ZERO=new oi(Tn.Point.ZERO);oi.Fp=ni;oi.Fn=kQ;var Gf=32,ii=64,p4=32;function uk(){let r=Tn.utils.randomPrivateKey(),e=Tn.getPublicKey(r);return{privateKey:pk(r,e),publicKey:e}}function fk(r){if(r.length!==p4)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=Tn.getPublicKey(e);return{privateKey:pk(e,t),publicKey:t}}function hk(r,e){let t=r.subarray(0,p4);return Tn.sign(e instanceof Uint8Array?e:e.subarray(),t)}function dk(r,e,t){return Tn.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function pk(r,e){let t=new Uint8Array(ii);for(let n=0;n<p4;n++)t[n]=r[n],t[p4+n]=e[n];return t}var ut={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var Jx={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function m4(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=ut.get();t*=8;async function c(h,d){let p=a.getRandomValues(new Uint8Array(o)),y=a.getRandomValues(new Uint8Array(n)),x={name:e,iv:y};typeof d=="string"&&(d=H(d));let b;if(d.length===0){b=await a.subtle.importKey("jwk",Jx,{name:"AES-GCM"},!0,["encrypt"]);try{let v={name:"PBKDF2",salt:p,iterations:i,hash:{name:s}},w=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(v,w,{name:e,length:t},!0,["encrypt"])}catch{b=await a.subtle.importKey("jwk",Jx,{name:"AES-GCM"},!0,["encrypt"])}}else{let v={name:"PBKDF2",salt:p,iterations:i,hash:{name:s}},w=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(v,w,{name:e,length:t},!0,["encrypt"])}let _=await a.subtle.encrypt(x,b,h);return we([p,x.iv,new Uint8Array(_)])}async function u(h,d){let p=h.subarray(0,o),y=h.subarray(o,o+n),x=h.subarray(o+n),b={name:e,iv:y};typeof d=="string"&&(d=H(d));let _;if(d.length===0)try{let w={name:"PBKDF2",salt:p,iterations:i,hash:{name:s}},R=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);_=await a.subtle.deriveKey(w,R,{name:e,length:t},!0,["decrypt"])}catch{_=await a.subtle.importKey("jwk",Jx,{name:"AES-GCM"},!0,["decrypt"])}else{let w={name:"PBKDF2",salt:p,iterations:i,hash:{name:s}},R=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);_=await a.subtle.deriveKey(w,R,{name:e,length:t},!0,["decrypt"])}let v=await a.subtle.decrypt(b,_,x);return new Uint8Array(v)}return{encrypt:c,decrypt:u}}async function Wf(r,e){let n=await m4().encrypt(r,e);return dc.encode(n)}var Yf={};pt(Yf,{KeyType:()=>st,PrivateKey:()=>xs,PublicKey:()=>ws});var st;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(st||(st={}));var eE;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(eE||(eE={}));(function(r){r.codec=()=>Fn(eE)})(st||(st={}));var ws;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),st.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=st.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(ws||(ws={}));var xs;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),st.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=st.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(xs||(xs={}));var Sl=class{constructor(e){l(this,"_key");this._key=Zf(e,Gf)}verify(e,t){return dk(this._key,t,e)}marshal(){return this._key}get bytes(){return ws.encode({Type:st.Ed25519,Data:this.marshal()}).subarray()}equals(e){return j(this.bytes,e.bytes)}hash(){let e=Ee.digest(this.bytes);return Vn(e)?e.then(({bytes:t})=>t):e.bytes}},ai=class{constructor(e,t){l(this,"_key");l(this,"_publicKey");this._key=Zf(e,ii),this._publicKey=Zf(t,Gf)}sign(e){return hk(this._key,e)}get public(){return new Sl(this._publicKey)}marshal(){return this._key}get bytes(){return xs.encode({Type:st.Ed25519,Data:this.marshal()}).subarray()}equals(e){return j(this.bytes,e.bytes)}async hash(){let e=Ee.digest(this.bytes),t;return Vn(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=ge.digest(this.public.bytes);return ie.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Wf(this.bytes,e);throw new K(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function qQ(r){if(r.length>ii){r=Zf(r,ii+Gf);let n=r.subarray(0,ii),s=r.subarray(ii,r.length);return new ai(n,s)}r=Zf(r,ii);let e=r.subarray(0,ii),t=r.subarray(Gf);return new ai(e,t)}function zQ(r){return r=Zf(r,Gf),new Sl(r)}async function $Q(){let{privateKey:r,publicKey:e}=uk();return new ai(r,e)}async function tE(r){let{privateKey:e,publicKey:t}=fk(r);return new ai(e,t)}function Zf(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new K(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var gk={"P-256":256,"P-384":384,"P-521":521},GQ=Object.keys(gk),nE=GQ.join(" / ");async function yk(r){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new K(`Unknown curve: ${r}. Must be ${nE}`,"ERR_INVALID_CURVE");let e=await ut.get().subtle.generateKey({name:"ECDH",namedCurve:r},!0,["deriveBits"]),t=async(o,i)=>{let a;i!=null?a=await ut.get().subtle.importKey("jwk",YQ(r,i),{name:"ECDH",namedCurve:r},!1,["deriveBits"]):a=e.privateKey;let c=await ut.get().subtle.importKey("jwk",wk(r,o),{name:"ECDH",namedCurve:r},!1,[]),u=await ut.get().subtle.deriveBits({name:"ECDH",namedCurve:r,public:c},a,gk[r]);return new Uint8Array(u,0,u.byteLength)},n=await ut.get().subtle.exportKey("jwk",e.publicKey);return{key:WQ(n),genSharedKey:t}}var bk={"P-256":32,"P-384":48,"P-521":66};function WQ(r){if(r.crv==null||r.x==null||r.y==null)throw new K("JWK was missing components","ERR_INVALID_PARAMETERS");if(r.crv!=="P-256"&&r.crv!=="P-384"&&r.crv!=="P-521")throw new K(`Unknown curve: ${r.crv}. Must be ${nE}`,"ERR_INVALID_CURVE");let e=bk[r.crv];return we([Uint8Array.from([4]),Bx(r.x,e),Bx(r.y,e)],1+e*2)}function wk(r,e){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new K(`Unknown curve: ${r}. Must be ${nE}`,"ERR_INVALID_CURVE");let t=bk[r];if(!j(e.subarray(0,1),Uint8Array.from([4])))throw new K("Cannot unmarshal public key - invalid key format","ERR_INVALID_KEY_FORMAT");return{kty:"EC",crv:r,x:z(e.subarray(1,t+1),"base64url"),y:z(e.subarray(1+t),"base64url"),ext:!0}}var YQ=(r,e)=>({...wk(r,e.public),d:z(e.private,"base64url")});var xk=yk;async function Ek(r,e){let t=dc.decode(r);return m4().decrypt(t,e)}var vk={SHA1:20,SHA256:32,SHA512:64};var ZQ={SHA1:"SHA-1",SHA256:"SHA-256",SHA512:"SHA-512"},XQ=async(r,e)=>{let t=await ut.get().subtle.sign({name:"HMAC"},r,e);return new Uint8Array(t,0,t.byteLength)};async function Sk(r,e){let t=ZQ[r],n=await ut.get().subtle.importKey("raw",e,{name:"HMAC",hash:{name:t}},!1,["sign"]);return{async digest(s){return XQ(n,s)},length:vk[r]}}var _k={"AES-128":{ivSize:16,keySize:16},"AES-256":{ivSize:16,keySize:32},Blowfish:{ivSize:8,keySize:32}};async function Ak(r,e,t){let n=_k[r];if(n==null){let v=Object.keys(_k).join(" / ");throw new K(`unknown cipher type '${r}'. Must be ${v}`,"ERR_INVALID_CIPHER_TYPE")}if(e==null)throw new K("missing hash type","ERR_MISSING_HASH_TYPE");let s=n.keySize,o=n.ivSize,i=20,a=H("key expansion"),c=2*(o+s+i),u=await Sk(e,t),f=await u.digest(a),h=[],d=0;for(;d<c;){let v=await u.digest(we([f,a])),w=v.length;d+w>c&&(w=c-d),h.push(v),d+=w,f=await u.digest(f)}let p=c/2,y=we(h),x=y.subarray(0,p),b=y.subarray(p,c),_=v=>({iv:v.subarray(0,o),cipherKey:v.subarray(o,o+s),macKey:v.subarray(o+s)});return{k1:_(x),k2:_(b)}}var gE={};pt(gE,{MAX_RSA_KEY_SIZE:()=>Il,RsaPrivateKey:()=>La,RsaPublicKey:()=>Al,fromJwk:()=>SJ,generateKeyPair:()=>_J,unmarshalRsaPrivateKey:()=>pE,unmarshalRsaPublicKey:()=>vJ});function ln(r){if(isNaN(r)||r<=0)throw new K("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Zs(r)}var Pa={};pt(Pa,{exportToPem:()=>bJ,importFromPem:()=>dE,jwkToPkcs1:()=>pJ,jwkToPkix:()=>gJ,pkcs1ToJwk:()=>dJ,pkixToJwk:()=>mJ});var g4=class extends Of{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Qo(e);let n=Ea(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),_n(o)}update(e){return Mf(this),this.iHash.update(e),this}digestInto(e){Mf(this),ur(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ra=(r,e,t)=>new g4(r,e).update(t).digest();Ra.create=(r,e)=>new g4(r,e);function QQ(r,e,t,n){Qo(r);let s=AL({dkLen:32,asyncTick:10},n),{c:o,dkLen:i,asyncTick:a}=s;if(ys(o),ys(i),ys(a),o<1)throw new Error("iterations (c) should be >= 1");let c=Px(e),u=Px(t),f=new Uint8Array(i),h=Ra.create(r,c),d=h._cloneInto().update(u);return{c:o,dkLen:i,asyncTick:a,DK:f,PRF:h,PRFSalt:d}}function JQ(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),_n(s),t}async function sE(r,e,t,n){let{c:s,dkLen:o,asyncTick:i,DK:a,PRF:c,PRFSalt:u}=QQ(r,e,t,n),f,h=new Uint8Array(4),d=Uf(h),p=new Uint8Array(c.outputLen);for(let y=1,x=0;x<o;y++,x+=c.outputLen){let b=a.subarray(x,x+c.outputLen);d.setInt32(0,y,!1),(f=u._cloneInto(f)).update(h).digestInto(p),b.set(p.subarray(0,b.length)),await _L(s-1,i,()=>{c._cloneInto(f).update(p).digestInto(p);for(let _=0;_<b.length;_++)b[_]^=p[_]})}return JQ(c,u,a,f,p)}var oE=a4;var Oe=go(Ik());function _l(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Ca(r,e,t=-1){let n=t,s=r,o=0,i=Math.pow(2,e);for(let a=1;a<8;a++){if(r<i){let c;if(n<0)c=new ArrayBuffer(a),o=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),o=n}let u=new Uint8Array(c);for(let f=a-1;f>=0;f--){let h=Math.pow(2,f*e);u[o-f-1]=Math.floor(s/h),s-=u[o-f-1]*h}return c}i*=Math.pow(2,e)}return new ArrayBuffer(0)}function w4(...r){let e=0,t=0;for(let o of r)e+=o.length;let n=new ArrayBuffer(e),s=new Uint8Array(n);for(let o of r)s.set(o,t),t+=o.length;return s}function aE(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=_l(t,8),s=new ArrayBuffer(this.valueHex.byteLength),o=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)o[a]=r[a];return o[0]&=127,_l(o,8)-n}function Tk(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let i=t-e,a=Ca(i,8,n),c=new Uint8Array(a);return c[0]|=128,a}let s=Ca(e,8,n),o=new Uint8Array(s);if(o[0]&128){let i=s.slice(0),a=new Uint8Array(i);s=new ArrayBuffer(s.byteLength+1),o=new Uint8Array(s);for(let c=0;c<i.byteLength;c++)o[c+1]=a[c];o[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function Rk(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function un(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,s=new Array(n);for(let i=0;i<n;i++)s[i]="0";return s.join("").concat(t)}var J_e=Math.log(2);function x4(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function cE(r){let e=0,t=0;for(let s=0;s<r.length;s++){let o=r[s];e+=o.byteLength}let n=new Uint8Array(e);for(let s=0;s<r.length;s++){let o=r[s];n.set(new Uint8Array(o),t),t+=o.byteLength}return n.buffer}function hi(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var M1=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return cE(this.items)}},N1=[new Uint8Array([1])],Ck="0123456789";var Qf="",Js=new ArrayBuffer(0),lE=new Uint8Array(0),U1="EndOfContent",Bk="OCTET STRING",Pk="BIT STRING";function di(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);let o=n[0]||{};this.isHexOnly=(s=o.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=o.valueHex?Oe.BufferSourceConverter.toUint8Array(o.valueHex):lE}fromBER(n,s,o){let i=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!hi(this,i,s,o))return-1;let a=s+o;return this.valueHexView=i.subarray(s,a),this.valueHexView.length?(this.blockLength=o,a):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Js)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Oe.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var li=class{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Qf,warnings:n=[],valueBeforeDecode:s=lE}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Oe.BufferSourceConverter.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Oe.Convert.ToHex(this.valueBeforeDecodeView)}}};li.NAME="baseBlock";var Ir=class extends li{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};Ir.NAME="valueBlock";var E4=class extends di(li){constructor({idBlock:e={}}={}){var t,n,s,o;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Oe.BufferSourceConverter.toUint8Array(e.valueHex):lE,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(o=e.isConstructed)!==null&&o!==void 0?o:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Js}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let s=new Uint8Array(1);if(!e){let o=this.tagNumber;o&=31,t|=o,s[0]=t}return s.buffer}if(!this.isHexOnly){let s=Ca(this.tagNumber,7),o=new Uint8Array(s),i=s.byteLength,a=new Uint8Array(i+1);if(a[0]=t|31,!e){for(let c=0;c<i-1;c++)a[c+1]=o[c]|128;a[i]=o[i-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let s=this.valueHexView;for(let o=0;o<s.length-1;o++)n[o+1]=s[o]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){let s=Oe.BufferSourceConverter.toUint8Array(e);if(!hi(this,s,t,n))return-1;let o=s.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;switch(o[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(o[0]&32)===32,this.isHexOnly=!1;let a=o[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,u=this.valueHexView=new Uint8Array(255),f=255;for(;o[c]&128;){if(u[c-1]=o[c]&127,c++,c>=o.length)return this.error="End of input reached before message was fully decoded",-1;if(c===f){f+=255;let d=new Uint8Array(f);for(let p=0;p<u.length;p++)d[p]=u[p];u=this.valueHexView=new Uint8Array(f)}}this.blockLength=c+1,u[c-1]=o[c]&127;let h=new Uint8Array(c);for(let d=0;d<c;d++)h[d]=u[d];u=this.valueHexView=new Uint8Array(c),u.set(h),this.blockLength<=9?this.tagNumber=_l(u,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};E4.NAME="identificationBlock";var v4=class extends li{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){let s=Oe.BufferSourceConverter.toUint8Array(e);if(!hi(this,s,t,n))return-1;let o=s.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;if(o[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=o[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(o[0]&128),this.longFormUsed===!1)return this.length=o[0],this.blockLength=1,t+this.blockLength;let i=o[0]&127;if(i>8)return this.error="Too big integer",-1;if(i+1>o.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=s.subarray(a,a+i);return c[i-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=_l(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=i+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let s=Ca(this.length,8);if(s.byteLength>127)return this.error="Too big length",Js;if(t=new ArrayBuffer(s.byteLength+1),e)return t;let o=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let i=0;i<s.byteLength;i++)n[i+1]=o[i];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};v4.NAME="lengthBlock";var oe={},hr=class extends li{constructor({name:e=Qf,optional:t=!1,primitiveSchema:n,...s}={},o){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new E4(s),this.lenBlock=new v4(s),this.valueBlock=o?new o(s):new Ir(s)}fromBER(e,t,n){let s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){let n=t||new M1;t||Lk(this);let s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let o=this.valueBlock.toBER(e);this.lenBlock.length=o.byteLength;let i=this.lenBlock.toBER(e);n.write(i),n.write(o)}return t?Js:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Oe.Convert.ToHex(this.toBER())}onAsciiEncoding(){let e=this.constructor.NAME,t=Oe.Convert.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return Rk(t,n)}};hr.NAME="BaseBlock";function Lk(r){var e;if(r instanceof oe.Constructed)for(let t of r.valueBlock.value)Lk(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}var S4=class extends hr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Qf,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){let s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};S4.NAME="BaseStringBlock";var _4=class extends di(Ir){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};_4.NAME="PrimitiveValueBlock";var kk,A4=class extends hr{constructor(e={}){super(e,_4),this.idBlock.isConstructed=!1}};kk=A4;oe.Primitive=kk;A4.NAME="PRIMITIVE";function cJ(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function s6(r,e=0,t=r.length){let n=e,s=new hr({},Ir),o=new li;if(!hi(o,r,e,t))return s.error=o.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=a,t-=s.idBlock.blockLength,a=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=a,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=hr;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=oe.EndOfContent;break;case 1:c=oe.Boolean;break;case 2:c=oe.Integer;break;case 3:c=oe.BitString;break;case 4:c=oe.OctetString;break;case 5:c=oe.Null;break;case 6:c=oe.ObjectIdentifier;break;case 10:c=oe.Enumerated;break;case 12:c=oe.Utf8String;break;case 13:c=oe.RelativeObjectIdentifier;break;case 14:c=oe.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=oe.Sequence;break;case 17:c=oe.Set;break;case 18:c=oe.NumericString;break;case 19:c=oe.PrintableString;break;case 20:c=oe.TeletexString;break;case 21:c=oe.VideotexString;break;case 22:c=oe.IA5String;break;case 23:c=oe.UTCTime;break;case 24:c=oe.GeneralizedTime;break;case 25:c=oe.GraphicString;break;case 26:c=oe.VisibleString;break;case 27:c=oe.GeneralString;break;case 28:c=oe.UniversalString;break;case 29:c=oe.CharacterString;break;case 30:c=oe.BmpString;break;case 31:c=oe.DATE;break;case 32:c=oe.TimeOfDay;break;case 33:c=oe.DateTime;break;case 34:c=oe.Duration;break;default:{let u=s.idBlock.isConstructed?new oe.Constructed:new oe.Primitive;u.idBlock=s.idBlock,u.lenBlock=s.lenBlock,u.warnings=s.warnings,s=u}}break;default:c=s.idBlock.isConstructed?oe.Constructed:oe.Primitive}return s=cJ(s,c),a=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:a,result:s}}function Jf(r){if(!r.byteLength){let e=new hr({},Ir);return e.error="Input buffer has zero length",{offset:-1,result:e}}return s6(Oe.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function lJ(r,e){return r?1:e}var Qs=class extends Ir{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let s=Oe.BufferSourceConverter.toUint8Array(e);if(!hi(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let o=t;for(;lJ(this.isIndefiniteForm,n)>0;){let i=s6(s,o,n);if(i.offset===-1)return this.error=i.result.error,this.warnings.concat(i.result.warnings),-1;if(o=i.offset,this.blockLength+=i.result.blockLength,n-=i.result.blockLength,this.value.push(i.result),this.isIndefiniteForm&&i.result.constructor.NAME===U1)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===U1?this.value.pop():this.warnings.push("No EndOfContent block encoded")),o}toBER(e,t){let n=t||new M1;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?Js:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};Qs.NAME="ConstructedValueBlock";var Nk,Da=class extends hr{constructor(e={}){super(e,Qs),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};Nk=Da;oe.Constructed=Nk;Da.NAME="CONSTRUCTED";var I4=class extends Ir{fromBER(e,t,n){return t}toBER(e){return Js}};I4.override="EndOfContentValueBlock";var Ok,T4=class extends hr{constructor(e={}){super(e,I4),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};Ok=T4;oe.EndOfContent=Ok;T4.NAME=U1;var Mk,Ba=class extends hr{constructor(e={}){super(e,Ir),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};Mk=Ba;oe.Null=Mk;Ba.NAME="NULL";var R4=class extends di(Ir){get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Oe.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){let s=Oe.BufferSourceConverter.toUint8Array(e);return hi(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,aE.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};R4.NAME="BooleanValueBlock";var Uk,C4=class extends hr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,R4),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};Uk=C4;oe.Boolean=Uk;C4.NAME="BOOLEAN";var D4=class extends di(Qs){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Qs.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let o=0;o<this.value.length;o++){let i=this.value[o].constructor.NAME;if(i===U1){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(i!==Bk)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?Qs.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};D4.NAME="OctetStringValueBlock";var uE,ui=class extends hr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,o;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},D4),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let o=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(o.byteLength){let i=s6(o,0,o.byteLength);i.offset!==-1&&i.offset===n&&(this.valueBlock.value=[i.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Da.prototype.onAsciiEncoding.call(this);let e=this.constructor.NAME,t=Oe.Convert.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof uE&&e.push(t.valueBlock.valueHexView);return Oe.BufferSourceConverter.concat(e)}};uE=ui;oe.OctetString=uE;ui.NAME=Bk;var B4=class extends di(Qs){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=Qs.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let a of this.value){let c=a.constructor.NAME;if(c===U1){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==Pk)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let u=a.valueBlock;if(this.unusedBits>0&&u.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=u.unusedBits}return s}let o=Oe.BufferSourceConverter.toUint8Array(e);if(!hi(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(this.unusedBits=i[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=i.subarray(1);try{if(a.byteLength){let c=s6(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=i.subarray(1),this.blockLength=i.length,t+n}toBER(e,t){if(this.isConstructed)return Qs.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength){let s=new Uint8Array(1);return s[0]=0,s.buffer}let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};B4.NAME="BitStringValueBlock";var Kk,jf=class extends hr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,o;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},B4),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Da.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let i of t)e.push(i.toString(2).padStart(8,"0"));let n=e.join(""),s=this.constructor.NAME,o=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${o}`}}};Kk=jf;oe.BitString=Kk;jf.NAME=Pk;var Fk;function uJ(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e),o=n.slice(0),i=o.length-1,a=s.slice(0),c=a.length-1,u=0,f=c<i?i:c,h=0;for(let d=f;d>=0;d--,h++)!0===h<a.length?u=o[i-h]+a[c-h]+t[0]:u=o[i-h]+t[0],t[0]=u/10,!0===h>=o.length?o=w4(new Uint8Array([u%10]),o):o[i-h]=u%10;return t[0]>0&&(o=w4(t,o)),o}function Dk(r){if(r>=N1.length)for(let e=N1.length;e<=r;e++){let t=new Uint8Array([0]),n=N1[e-1].slice(0);for(let s=n.length-1;s>=0;s--){let o=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=o[0]/10,n[s]=o[0]%10}t[0]>0&&(n=w4(t,n)),N1.push(n)}return N1[r]}function fJ(r,e){let t=0,n=new Uint8Array(r),s=new Uint8Array(e),o=n.slice(0),i=o.length-1,a=s.slice(0),c=a.length-1,u,f=0;for(let h=c;h>=0;h--,f++)u=o[i-f]-a[c-f]-t,!0===u<0?(t=1,o[i-f]=u+10):(t=0,o[i-f]=u);if(t>0)for(let h=i-c+1;h>=0;h--,f++)if(u=o[i-f]-t,u<0)t=1,o[i-f]=u+10;else{t=0,o[i-f]=u;break}return o.slice()}var K1=class extends di(Ir){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=aE.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(Tk(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){let o=this.fromBER(e,t,n);if(o===-1)return o;let i=this.valueHexView;return i[0]===0&&(i[1]&128)!==0?this.valueHexView=i.subarray(1):s!==0&&i.length<s&&(s-i.length>1&&(s=i.length+1),this.valueHexView=i.subarray(s-i.length)),o}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,s,o=this.valueHexView,i="",a=!1;for(let c=o.byteLength-1;c>=0;c--){s=o[c];for(let u=0;u<8;u++)(s&1)===1&&(n===e?(t=fJ(Dk(n),t),i="-"):t=uJ(t,Dk(n))),n++,s>>=1}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(i+=Ck.charAt(t[c]));return a===!1&&(i+=Ck.charAt(0)),i}};Fk=K1;K1.NAME="IntegerValueBlock";Object.defineProperty(Fk.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var O1,Lt=class extends hr{constructor(e={}){super(e,K1),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return x4(),BigInt(this.valueBlock.toString())}static fromBigInt(e){x4();let t=BigInt(e),n=new M1,s=t.toString(16).replace(/^-/,""),o=new Uint8Array(Oe.Convert.FromHex(s));if(t<0){let a=new Uint8Array(o.length+(o[0]&128?1:0));a[0]|=128;let u=BigInt(`0x${Oe.Convert.ToHex(a)}`)+t,f=Oe.BufferSourceConverter.toUint8Array(Oe.Convert.FromHex(u.toString(16)));f[0]|=128,n.write(f)}else o[0]&128&&n.write(new Uint8Array([0])),n.write(o);return new O1({valueHex:n.final()})}convertToDER(){let e=new O1({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new O1({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};O1=Lt;oe.Integer=O1;Lt.NAME="INTEGER";var Vk,P4=class extends Lt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};Vk=P4;oe.Enumerated=Vk;P4.NAME="ENUMERATED";var F1=class extends di(Ir){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let s=Oe.BufferSourceConverter.toUint8Array(e);if(!hi(this,s,t,n))return-1;let o=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,(o[a]&128)!==0);a++);let i=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)i[a]=this.valueHexView[a];return this.valueHexView=i,(o[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=_l(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){x4();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let s=this.valueHexView,o=new Uint8Array(this.blockLength);for(let i=0;i<this.blockLength-1;i++)o[i]=s[i]|128;return o[this.blockLength-1]=s[this.blockLength-1],o.buffer}let t=Ca(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Js;let n=new Uint8Array(t.byteLength);if(!e){let s=new Uint8Array(t),o=t.byteLength-1;for(let i=0;i<o;i++)n[i]=s[i]|128;n[o]=s[o]}return n}toString(){let e="";if(this.isHexOnly)e=Oe.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};F1.NAME="sidBlock";var L4=class extends Ir{constructor({value:e=Qf,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){let o=new F1;if(s=o.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=o.error,s;this.value.length===0&&(o.isFirstSid=!0),this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return s}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,Js;t.push(s)}return cE(t)}fromString(e){this.value=[];let t=0,n=0,s="",o=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,o){let i=this.value[0],a=0;switch(i.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(s,10);if(isNaN(c))return;i.valueDec=c+a,o=!1}else{let i=new F1;if(s>Number.MAX_SAFE_INTEGER){x4();let a=BigInt(s);i.valueBigInt=a}else if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return;this.value.length||(i.isFirstSid=!0,o=!0),this.value.push(i)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};L4.NAME="ObjectIdentifierValueBlock";var Hk,Es=class extends hr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,L4),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};Hk=Es;oe.ObjectIdentifier=Hk;Es.NAME="OBJECT IDENTIFIER";var V1=class extends di(li){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let s=Oe.BufferSourceConverter.toUint8Array(e);if(!hi(this,s,t,n))return-1;let o=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,(o[a]&128)!==0);a++);let i=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)i[a]=this.valueHexView[a];return this.valueHexView=i,(o[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=_l(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let s=this.valueHexView,o=new Uint8Array(this.blockLength);for(let i=0;i<this.blockLength-1;i++)o[i]=s[i]|128;return o[this.blockLength-1]=s[this.blockLength-1],o.buffer}let t=Ca(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Js;let n=new Uint8Array(t.byteLength);if(!e){let s=new Uint8Array(t),o=t.byteLength-1;for(let i=0;i<o;i++)n[i]=s[i]|128;n[o]=s[o]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Oe.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};V1.NAME="relativeSidBlock";var k4=class extends Ir{constructor({value:e=Qf,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){let o=new V1;if(s=o.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=o.error,s;this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return s}toBER(e,t){let n=[];for(let s=0;s<this.value.length;s++){let o=this.value[s].toBER(e);if(o.byteLength===0)return this.error=this.value[s].error,Js;n.push(o)}return cE(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;let o=new V1;if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return!0;this.value.push(o)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};k4.NAME="RelativeObjectIdentifierValueBlock";var qk,N4=class extends hr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,k4),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};qk=N4;oe.RelativeObjectIdentifier=qk;N4.NAME="RelativeObjectIdentifier";var zk,Qt=class extends Da{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};zk=Qt;oe.Sequence=zk;Qt.NAME="SEQUENCE";var $k,O4=class extends Da{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};$k=O4;oe.Set=$k;O4.NAME="SET";var M4=class extends di(Ir){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Qf}toJSON(){return{...super.toJSON(),value:this.value}}};M4.NAME="StringValueBlock";var U4=class extends M4{};U4.NAME="SimpleStringValueBlock";var $r=class extends S4{constructor({...e}={}){super(e,U4)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Oe.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}};$r.NAME="SIMPLE STRING";var K4=class extends $r{fromBuffer(e){this.valueBlock.valueHexView=Oe.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=Oe.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Oe.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Oe.Convert.FromUtf8String(e)),this.valueBlock.value=e}};K4.NAME="Utf8StringValueBlock";var Gk,fi=class extends K4{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};Gk=fi;oe.Utf8String=Gk;fi.NAME="UTF8String";var F4=class extends $r{fromBuffer(e){this.valueBlock.value=Oe.Convert.ToUtf16String(e),this.valueBlock.valueHexView=Oe.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Oe.Convert.FromUtf16String(e))}};F4.NAME="BmpStringValueBlock";var Wk,V4=class extends F4{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};Wk=V4;oe.BmpString=Wk;V4.NAME="BMPString";var H4=class extends $r{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){let o=Ca(e.charCodeAt(s),8),i=new Uint8Array(o);if(i.length>4)continue;let a=4-i.length;for(let c=i.length-1;c>=0;c--)n[s*4+c+a]=i[c]}this.valueBlock.value=e}};H4.NAME="UniversalStringValueBlock";var Yk,q4=class extends H4{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};Yk=q4;oe.UniversalString=Yk;q4.NAME="UniversalString";var Zk,z4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};Zk=z4;oe.NumericString=Zk;z4.NAME="NumericString";var Xk,$4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};Xk=$4;oe.PrintableString=Xk;$4.NAME="PrintableString";var jk,G4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};jk=G4;oe.TeletexString=jk;G4.NAME="TeletexString";var Qk,W4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};Qk=W4;oe.VideotexString=Qk;W4.NAME="VideotexString";var Jk,Y4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};Jk=Y4;oe.IA5String=Jk;Y4.NAME="IA5String";var eN,Z4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};eN=Z4;oe.GraphicString=eN;Z4.NAME="GraphicString";var tN,H1=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};tN=H1;oe.VisibleString=tN;H1.NAME="VisibleString";var rN,X4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};rN=X4;oe.GeneralString=rN;X4.NAME="GeneralString";var nN,j4=class extends $r{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};nN=j4;oe.CharacterString=nN;j4.NAME="CharacterString";var sN,q1=class extends H1{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Oe.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=un(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=un(this.month,2),t[2]=un(this.day,2),t[3]=un(this.hour,2),t[4]=un(this.minute,2),t[5]=un(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};sN=q1;oe.UTCTime=sN;q1.NAME="UTCTime";var oN,Q4=class extends q1{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){let e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",o=0,i,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,d=n.indexOf("+"),p="";if(d===-1&&(d=n.indexOf("-"),h=-1),d!==-1){if(p=n.substring(d+1),n=n.substring(0,d),p.length!==2&&p.length!==4)throw new Error("Wrong input string for conversion");let y=parseInt(p.substring(0,2),10);if(isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*y,p.length===4){if(y=parseInt(p.substring(2,4),10),isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");c=h*y}}}let u=n.indexOf(".");if(u===-1&&(u=n.indexOf(",")),u!==-1){let h=new Number(`0${n.substring(u)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");o=h.valueOf(),s=n.substring(0,u)}else s=n;switch(!0){case s.length===8:if(i=/(\d{4})(\d{2})(\d{2})/ig,u!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(i=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let h=60*o;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===12:if(i=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let h=60*o;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===14:if(i=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let h=1e3*o;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}let f=i.exec(s);if(f===null)throw new Error("Wrong input string for conversion");for(let h=1;h<f.length;h++)switch(h){case 1:this.year=parseInt(f[h],10);break;case 2:this.month=parseInt(f[h],10);break;case 3:this.day=parseInt(f[h],10);break;case 4:this.hour=parseInt(f[h],10)+a;break;case 5:this.minute=parseInt(f[h],10)+c;break;case 6:this.second=parseInt(f[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(un(this.year,4)),t.push(un(this.month,2)),t.push(un(this.day,2)),t.push(un(this.hour,2)),t.push(un(this.minute,2)),t.push(un(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(un(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};oN=Q4;oe.GeneralizedTime=oN;Q4.NAME="GeneralizedTime";var iN,J4=class extends fi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};iN=J4;oe.DATE=iN;J4.NAME="DATE";var aN,e6=class extends fi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};aN=e6;oe.TimeOfDay=aN;e6.NAME="TimeOfDay";var cN,t6=class extends fi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};cN=t6;oe.DateTime=cN;t6.NAME="DateTime";var lN,r6=class extends fi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};lN=r6;oe.Duration=lN;r6.NAME="Duration";var uN,n6=class extends fi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};uN=n6;oe.TIME=uN;n6.NAME="TIME";function dJ(r){let{result:e}=Jf(r),t=e.valueBlock.value;return{n:z(eo(t[1].toBigInt()),"base64url"),e:z(eo(t[2].toBigInt()),"base64url"),d:z(eo(t[3].toBigInt()),"base64url"),p:z(eo(t[4].toBigInt()),"base64url"),q:z(eo(t[5].toBigInt()),"base64url"),dp:z(eo(t[6].toBigInt()),"base64url"),dq:z(eo(t[7].toBigInt()),"base64url"),qi:z(eo(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function pJ(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new K("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new Qt({value:[new Lt({value:0}),Lt.fromBigInt(to(H(r.n,"base64url"))),Lt.fromBigInt(to(H(r.e,"base64url"))),Lt.fromBigInt(to(H(r.d,"base64url"))),Lt.fromBigInt(to(H(r.p,"base64url"))),Lt.fromBigInt(to(H(r.q,"base64url"))),Lt.fromBigInt(to(H(r.dp,"base64url"))),Lt.fromBigInt(to(H(r.dq,"base64url"))),Lt.fromBigInt(to(H(r.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function mJ(r){let{result:e}=Jf(r),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:z(eo(t[0].toBigInt()),"base64url"),e:z(eo(t[1].toBigInt()),"base64url")}}function gJ(r){if(r.n==null||r.e==null)throw new K("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new Qt({value:[new Qt({value:[new Es({value:"1.2.840.113549.1.1.1"}),new Ba]}),new jf({valueHex:new Qt({value:[Lt.fromBigInt(to(H(r.n,"base64url"))),Lt.fromBigInt(to(H(r.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function eo(r){let e=r.toString(16);e.length%2>0&&(e=`0${e}`);let t=e.length/2,n=new Uint8Array(t),s=0,o=0;for(;s<t;)n[s]=parseInt(e.slice(o,o+2),16),s+=1,o+=2;return n}function to(r){let e=[];return r.forEach(function(t){let n=t.toString(16);n.length%2>0&&(n=`0${n}`),e.push(n)}),BigInt("0x"+e.join(""))}var yJ=16,fE=32,hE=1e4;async function bJ(r,e){let t=ut.get(),s=new Qt({value:[new Lt({value:0}),new Qt({value:[new Es({value:"1.2.840.113549.1.1.1"}),new Ba]}),new ui({valueHex:r.marshal()})]}).toBER(),o=new Uint8Array(s,0,s.byteLength),i=ln(yJ),a=await sE(oE,e,i,{c:hE,dkLen:fE}),c=ln(16),u=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),f=await t.subtle.encrypt({name:"AES-CBC",iv:c},u,o),h=new Qt({value:[new ui({valueHex:i}),new Lt({value:hE}),new Lt({value:fE}),new Qt({value:[new Es({value:"1.2.840.113549.2.11"}),new Ba]})]}),d=new Qt({value:[new Es({value:"1.2.840.113549.1.5.13"}),new Qt({value:[new Qt({value:[new Es({value:"1.2.840.113549.1.5.12"}),h]}),new Qt({value:[new Es({value:"2.16.840.1.101.3.4.1.42"}),new ui({valueHex:c})]})]})]}),y=new Qt({value:[d,new ui({valueHex:f})]}).toBER(),x=new Uint8Array(y,0,y.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...z(x,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function dE(r,e){let t=ut.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let s=H(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Jf(s),{iv:i,salt:a,iterations:c,keySize:u,cipherText:f}=wJ(o),h=await sE(oE,e,a,{c,dkLen:u}),d=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),p=z1(await t.subtle.decrypt({name:"AES-CBC",iv:i},d,f)),{result:y}=Jf(p);n=fN(y)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let s=H(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Jf(s);n=fN(o)}else throw new K("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return pE(n)}function wJ(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new K("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new K("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let o=n.valueBlock.value[1],i=z1(o.valueBlock.value[0].getValue()),a=hE,c=fE;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new K("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let u=e.valueBlock.value[1].valueBlock.value[1],f=u.valueBlock.value[0].toString();if(f!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(f!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new K("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}let h=z1(u.valueBlock.value[1].getValue());return{cipherText:z1(r.valueBlock.value[1].getValue()),salt:i,iterations:a,keySize:c,iv:h}}function fN(r){return z1(r.valueBlock.value[2].getValue())}function z1(r){return new Uint8Array(r,0,r.byteLength)}async function hN(r){let e=await ut.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await mN(e);return{privateKey:t[0],publicKey:t[1]}}async function mE(r){let t=[await ut.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await xJ(r)],n=await mN({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function dN(r,e){let t=await ut.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await ut.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function pN(r,e,t){let n=await ut.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return ut.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function mN(r){if(r.privateKey==null||r.publicKey==null)throw new K("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([ut.get().subtle.exportKey("jwk",r.privateKey),ut.get().subtle.exportKey("jwk",r.publicKey)])}async function xJ(r){return ut.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function o6(r){if(r.kty!=="RSA")throw new K("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new K("invalid key modulus","ERR_INVALID_KEY_MODULUS");return H(r.n,"base64url").length*8}var Il=8192,Al=class{constructor(e){l(this,"_key");this._key=e}verify(e,t){return pN(this._key,t,e)}marshal(){return Pa.jwkToPkix(this._key)}get bytes(){return ws.encode({Type:st.RSA,Data:this.marshal()}).subarray()}equals(e){return j(this.bytes,e.bytes)}hash(){let e=Ee.digest(this.bytes);return Vn(e)?e.then(({bytes:t})=>t):e.bytes}},La=class{constructor(e,t){l(this,"_key");l(this,"_publicKey");this._key=e,this._publicKey=t}genSecret(){return ln(16)}sign(e){return dN(this._key,e)}get public(){if(this._publicKey==null)throw new K("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Al(this._publicKey)}marshal(){return Pa.jwkToPkcs1(this._key)}get bytes(){return xs.encode({Type:st.RSA,Data:this.marshal()}).subarray()}equals(e){return j(this.bytes,e.bytes)}hash(){let e=Ee.digest(this.bytes);return Vn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return z(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Pa.exportToPem(this,e);if(t==="libp2p-key")return Wf(this.bytes,e);throw new K(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function pE(r){let e=Pa.pkcs1ToJwk(r);if(o6(e)>Il)throw new K("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await mE(e);return new La(t.privateKey,t.publicKey)}function vJ(r){let e=Pa.pkixToJwk(r);if(o6(e)>Il)throw new K("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Al(e)}async function SJ(r){if(o6(r)>Il)throw new K("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await mE(r);return new La(e.privateKey,e.publicKey)}async function _J(r){if(r>Il)throw new K("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await hN(r);return new La(e.privateKey,e.publicKey)}var SE={};pt(SE,{Secp256k1PrivateKey:()=>Rl,Secp256k1PublicKey:()=>Tl,generateKeyPair:()=>UJ,unmarshalSecp256k1PrivateKey:()=>OJ,unmarshalSecp256k1PublicKey:()=>MJ});var gN=(r,e)=>(r+(r>=0?e:-e)/yN)/e;function AJ(r,e,t){let[[n,s],[o,i]]=e,a=gN(i*r,t),c=gN(-s*r,t),u=r-a*n-c*o,f=-a*s-c*i,h=u<mi,d=f<mi;h&&(u=-u),d&&(f=-f);let p=Ia(Math.ceil(l4(t)/2))+th;if(u<mi||u>=p||f<mi||f>=p)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:u,k2neg:d,k2:f}}function bE(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function yE(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return ei(t.lowS,"lowS"),ei(t.prehash,"prehash"),t.format!==void 0&&bE(t.format),t}var wE=class extends Error{constructor(e=""){super(e)}},pi={Err:wE,_tlv:{encode:(r,e)=>{let{Err:t}=pi;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,s=R1(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?R1(s.length/2|128):"";return R1(r)+o+s+e},decode(r,e){let{Err:t}=pi,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let s=e[n++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let f of u)i=i<<8|f;if(n+=c,i<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+i);if(a.length!==i)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(r){let{Err:e}=pi;if(r<mi)throw new e("integer: negative integers are not allowed");let t=R1(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=pi;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Kf(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=pi,s=He("signature",r),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:u,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){let{_tlv:e,_int:t}=pi,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),o=n+s;return e.encode(48,o)}},mi=BigInt(0),th=BigInt(1),yN=BigInt(2),i6=BigInt(3),IJ=BigInt(4);function eh(r,e){let{BYTES:t}=r,n;if(typeof e=="bigint")n=e;else{let s=He("private key",e);try{n=r.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!r.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function TJ(r,e={}){let t=f4("weierstrass",r,e),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i,n:a}=o;js(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:c}=e;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let u=wN(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(B,I,g){let{x:m,y:S}=I.toAffine(),T=n.toBytes(m);if(ei(g,"isCompressed"),g){f();let P=!n.isOdd(S);return qr(bN(P),T)}else return qr(Uint8Array.of(4),T,n.toBytes(S))}function d(B){An(B,void 0,"Point");let{publicKey:I,publicKeyUncompressed:g}=u,m=B.length,S=B[0],T=B.subarray(1);if(m===I&&(S===2||S===3)){let P=n.fromBytes(T);if(!n.isValid(P))throw new Error("bad point: is not on curve, wrong x");let C=x(P),k;try{k=n.sqrt(C)}catch(q){let W=q instanceof Error?": "+q.message:"";throw new Error("bad point: is not on curve, sqrt error"+W)}f();let D=n.isOdd(k);return(S&1)===1!==D&&(k=n.neg(k)),{x:P,y:k}}else if(m===g&&S===4){let P=n.BYTES,C=n.fromBytes(T.subarray(0,P)),k=n.fromBytes(T.subarray(P,P*2));if(!b(C,k))throw new Error("bad point: is not on curve");return{x:C,y:k}}else throw new Error(`bad point: got length ${m}, expected compressed=${I} or uncompressed=${g}`)}let p=e.toBytes||h,y=e.fromBytes||d;function x(B){let I=n.sqr(B),g=n.mul(I,B);return n.add(n.add(g,n.mul(B,o.a)),o.b)}function b(B,I){let g=n.sqr(I),m=x(B);return n.eql(g,m)}if(!b(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let _=n.mul(n.pow(o.a,i6),IJ),v=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(_,v)))throw new Error("bad curve params: a or b");function w(B,I,g=!1){if(!n.isValid(I)||g&&n.is0(I))throw new Error(`bad point coordinate ${B}`);return I}function R(B){if(!(B instanceof E))throw new Error("ProjectivePoint expected")}function N(B){if(!c||!c.basises)throw new Error("no endo");return AJ(B,c.basises,s.ORDER)}let O=Ff((B,I)=>{let{X:g,Y:m,Z:S}=B;if(n.eql(S,n.ONE))return{x:g,y:m};let T=B.is0();I==null&&(I=T?n.ONE:n.inv(S));let P=n.mul(g,I),C=n.mul(m,I),k=n.mul(S,I);if(T)return{x:n.ZERO,y:n.ZERO};if(!n.eql(k,n.ONE))throw new Error("invZ was invalid");return{x:P,y:C}}),F=Ff(B=>{if(B.is0()){if(e.allowInfinityPoint&&!n.is0(B.Y))return;throw new Error("bad point: ZERO")}let{x:I,y:g}=B.toAffine();if(!n.isValid(I)||!n.isValid(g))throw new Error("bad point: x or y not field elements");if(!b(I,g))throw new Error("bad point: equation left != right");if(!B.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function A(B,I,g,m,S){return g=new E(n.mul(g.X,B),g.Y,g.Z),I=B1(m,I),g=B1(S,g),I.add(g)}class E{constructor(I,g,m){this.X=w("x",I),this.Y=w("y",g,!0),this.Z=w("z",m),Object.freeze(this)}static CURVE(){return o}static fromAffine(I){let{x:g,y:m}=I||{};if(!I||!n.isValid(g)||!n.isValid(m))throw new Error("invalid affine point");if(I instanceof E)throw new Error("projective point not allowed");return n.is0(g)&&n.is0(m)?E.ZERO:new E(g,m,n.ONE)}static fromBytes(I){let g=E.fromAffine(y(An(I,void 0,"point")));return g.assertValidity(),g}static fromHex(I){return E.fromBytes(He("pointHex",I))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(I=8,g=!0){return U.createCache(this,I),g||this.multiply(i6),this}assertValidity(){F(this)}hasEvenY(){let{y:I}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(I)}equals(I){R(I);let{X:g,Y:m,Z:S}=this,{X:T,Y:P,Z:C}=I,k=n.eql(n.mul(g,C),n.mul(T,S)),D=n.eql(n.mul(m,C),n.mul(P,S));return k&&D}negate(){return new E(this.X,n.neg(this.Y),this.Z)}double(){let{a:I,b:g}=o,m=n.mul(g,i6),{X:S,Y:T,Z:P}=this,C=n.ZERO,k=n.ZERO,D=n.ZERO,M=n.mul(S,S),q=n.mul(T,T),W=n.mul(P,P),G=n.mul(S,T);return G=n.add(G,G),D=n.mul(S,P),D=n.add(D,D),C=n.mul(I,D),k=n.mul(m,W),k=n.add(C,k),C=n.sub(q,k),k=n.add(q,k),k=n.mul(C,k),C=n.mul(G,C),D=n.mul(m,D),W=n.mul(I,W),G=n.sub(M,W),G=n.mul(I,G),G=n.add(G,D),D=n.add(M,M),M=n.add(D,M),M=n.add(M,W),M=n.mul(M,G),k=n.add(k,M),W=n.mul(T,P),W=n.add(W,W),M=n.mul(W,G),C=n.sub(C,M),D=n.mul(W,q),D=n.add(D,D),D=n.add(D,D),new E(C,k,D)}add(I){R(I);let{X:g,Y:m,Z:S}=this,{X:T,Y:P,Z:C}=I,k=n.ZERO,D=n.ZERO,M=n.ZERO,q=o.a,W=n.mul(o.b,i6),G=n.mul(g,T),$=n.mul(m,P),X=n.mul(S,C),Q=n.add(g,m),J=n.add(T,P);Q=n.mul(Q,J),J=n.add(G,$),Q=n.sub(Q,J),J=n.add(g,S);let Y=n.add(T,C);return J=n.mul(J,Y),Y=n.add(G,X),J=n.sub(J,Y),Y=n.add(m,S),k=n.add(P,C),Y=n.mul(Y,k),k=n.add($,X),Y=n.sub(Y,k),M=n.mul(q,J),k=n.mul(W,X),M=n.add(k,M),k=n.sub($,M),M=n.add($,M),D=n.mul(k,M),$=n.add(G,G),$=n.add($,G),X=n.mul(q,X),J=n.mul(W,J),$=n.add($,X),X=n.sub(G,X),X=n.mul(q,X),J=n.add(J,X),G=n.mul($,J),D=n.add(D,G),G=n.mul(Y,J),k=n.mul(Q,k),k=n.sub(k,G),G=n.mul(Q,$),M=n.mul(Y,M),M=n.add(M,G),new E(k,D,M)}subtract(I){return this.add(I.negate())}is0(){return this.equals(E.ZERO)}multiply(I){let{endo:g}=e;if(!s.isValidNot0(I))throw new Error("invalid scalar: out of range");let m,S,T=P=>U.cached(this,P,C=>ri(E,C));if(g){let{k1neg:P,k1:C,k2neg:k,k2:D}=N(I),{p:M,f:q}=T(C),{p:W,f:G}=T(D);S=q.add(G),m=A(g.beta,M,W,P,k)}else{let{p:P,f:C}=T(I);m=P,S=C}return ri(E,[m,S])[0]}multiplyUnsafe(I){let{endo:g}=e,m=this;if(!s.isValid(I))throw new Error("invalid scalar: out of range");if(I===mi||m.is0())return E.ZERO;if(I===th)return m;if(U.hasCache(this))return this.multiply(I);if(g){let{k1neg:S,k1:T,k2neg:P,k2:C}=N(I),{p1:k,p2:D}=rk(E,m,T,C);return A(g.beta,k,D,S,P)}else return U.unsafe(m,I)}multiplyAndAddUnsafe(I,g,m){let S=this.multiplyUnsafe(g).add(I.multiplyUnsafe(m));return S.is0()?void 0:S}toAffine(I){return O(this,I)}isTorsionFree(){let{isTorsionFree:I}=e;return i===th?!0:I?I(E,this):U.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:I}=e;return i===th?this:I?I(E,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(I=!0){return ei(I,"isCompressed"),this.assertValidity(),p(E,this,I)}toHex(I=!0){return Hn(this.toBytes(I))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(I=!0){return this.toBytes(I)}_setWindowSize(I){this.precompute(I)}static normalizeZ(I){return ri(E,I)}static msm(I,g){return qf(E,s,I,g)}static fromPrivateKey(I){return E.BASE.multiply(eh(s,I))}}E.BASE=new E(o.Gx,o.Gy,n.ONE),E.ZERO=new E(n.ZERO,n.ONE,n.ZERO),E.Fp=n,E.Fn=s;let L=s.BITS,U=new Hf(E,e.endo?Math.ceil(L/2):L);return E.BASE.precompute(8),E}function bN(r){return Uint8Array.of(r?2:3)}function wN(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function RJ(r,e={}){let{Fn:t}=r,n=e.randomBytes||Zs,s=Object.assign(wN(r.Fp,t),{seed:qx(t.ORDER)});function o(p){try{return!!eh(t,p)}catch{return!1}}function i(p,y){let{publicKey:x,publicKeyUncompressed:b}=s;try{let _=p.length;return y===!0&&_!==x||y===!1&&_!==b?!1:!!r.fromBytes(p)}catch{return!1}}function a(p=n(s.seed)){return zx(An(p,s.seed,"seed"),t.ORDER)}function c(p,y=!0){return r.BASE.multiply(eh(t,p)).toBytes(y)}function u(p){let y=a(p);return{secretKey:y,publicKey:c(y)}}function f(p){if(typeof p=="bigint")return!1;if(p instanceof r)return!0;let{secretKey:y,publicKey:x,publicKeyUncompressed:b}=s;if(t.allowedLengths||y===x)return;let _=He("key",p).length;return _===x||_===b}function h(p,y,x=!0){if(f(p)===!0)throw new Error("first arg must be private key");if(f(y)===!1)throw new Error("second arg must be public key");let b=eh(t,p);return r.fromHex(y).multiply(b).toBytes(x)}return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:u,Point:r,utils:{isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a,isValidPrivateKey:o,randomPrivateKey:a,normPrivateKeyToScalar:p=>eh(t,p),precompute(p=8,y=r.BASE){return y.precompute(p,!1)}},lengths:s})}function CJ(r,e,t={}){Qo(e),js(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let n=t.randomBytes||Zs,s=t.hmac||((g,...m)=>Ra(e,g,qr(...m))),{Fp:o,Fn:i}=r,{ORDER:a,BITS:c}=i,{keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p}=RJ(r,t),y={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},x="compact";function b(g){let m=a>>th;return g>m}function _(g,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${g}: out of range 1..Point.Fn.ORDER`);return m}function v(g,m){bE(m);let S=p.signature,T=m==="compact"?S:m==="recovered"?S+1:void 0;return An(g,T,`${m} signature`)}class w{constructor(m,S,T){this.r=_("r",m),this.s=_("s",S),T!=null&&(this.recovery=T),Object.freeze(this)}static fromBytes(m,S=x){v(m,S);let T;if(S==="der"){let{r:D,s:M}=pi.toSig(An(m));return new w(D,M)}S==="recovered"&&(T=m[0],S="compact",m=m.subarray(1));let P=i.BYTES,C=m.subarray(0,P),k=m.subarray(P,P*2);return new w(i.fromBytes(C),i.fromBytes(k),T)}static fromHex(m,S){return this.fromBytes(bl(m),S)}addRecoveryBit(m){return new w(this.r,this.s,m)}recoverPublicKey(m){let S=o.ORDER,{r:T,s:P,recovery:C}=this;if(C==null||![0,1,2,3].includes(C))throw new Error("recovery id invalid");if(a*yN<S&&C>1)throw new Error("recovery id is ambiguous for h>1 curve");let D=C===2||C===3?T+a:T;if(!o.isValid(D))throw new Error("recovery id 2 or 3 invalid");let M=o.toBytes(D),q=r.fromBytes(qr(bN((C&1)===0),M)),W=i.inv(D),G=N(He("msgHash",m)),$=i.create(-G*W),X=i.create(P*W),Q=r.BASE.multiplyUnsafe($).add(q.multiplyUnsafe(X));if(Q.is0())throw new Error("point at infinify");return Q.assertValidity(),Q}hasHighS(){return b(this.s)}toBytes(m=x){if(bE(m),m==="der")return bl(pi.hexFromSig(this));let S=i.toBytes(this.r),T=i.toBytes(this.s);if(m==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return qr(Uint8Array.of(this.recovery),S,T)}return qr(S,T)}toHex(m){return Hn(this.toBytes(m))}assertValidity(){}static fromCompact(m){return w.fromBytes(He("sig",m),"compact")}static fromDER(m){return w.fromBytes(He("sig",m),"der")}normalizeS(){return this.hasHighS()?new w(this.r,i.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return Hn(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return Hn(this.toBytes("compact"))}}let R=t.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");let S=Kf(m),T=m.length*8-c;return T>0?S>>BigInt(T):S},N=t.bits2int_modN||function(m){return i.create(R(m))},O=Ia(c);function F(g){return Aa("num < 2^"+c,g,mi,O),i.toBytes(g)}function A(g,m){return An(g,void 0,"message"),m?An(e(g),void 0,"prehashed message"):g}function E(g,m,S){if(["recovered","canonical"].some($=>$ in S))throw new Error("sign() legacy options not supported");let{lowS:T,prehash:P,extraEntropy:C}=yE(S,y);g=A(g,P);let k=N(g),D=eh(i,m),M=[F(D),F(k)];if(C!=null&&C!==!1){let $=C===!0?n(p.secretKey):C;M.push(He("extraEntropy",$))}let q=qr(...M),W=k;function G($){let X=R($);if(!i.isValidNot0(X))return;let Q=i.inv(X),J=r.BASE.multiply(X).toAffine(),Y=i.create(J.x);if(Y===mi)return;let re=i.create(Q*i.create(W+Y*D));if(re===mi)return;let sr=(J.x===Y?0:2)|Number(J.y&th),or=re;return T&&b(re)&&(or=i.neg(re),sr^=1),new w(Y,or,sr)}return{seed:q,k2sig:G}}function L(g,m,S={}){g=He("message",g);let{seed:T,k2sig:P}=E(g,m,S);return FL(e.outputLen,i.BYTES,s)(T,P)}function U(g){let m,S=typeof g=="string"||jo(g),T=!S&&g!==null&&typeof g=="object"&&typeof g.r=="bigint"&&typeof g.s=="bigint";if(!S&&!T)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(T)m=new w(g.r,g.s);else if(S){try{m=w.fromBytes(He("sig",g),"der")}catch(P){if(!(P instanceof pi.Err))throw P}if(!m)try{m=w.fromBytes(He("sig",g),"compact")}catch{return!1}}return m||!1}function B(g,m,S,T={}){let{lowS:P,prehash:C,format:k}=yE(T,y);if(S=He("publicKey",S),m=A(He("message",m),C),"strict"in T)throw new Error("options.strict was renamed to lowS");let D=k===void 0?U(g):w.fromBytes(He("sig",g),k);if(D===!1)return!1;try{let M=r.fromBytes(S);if(P&&D.hasHighS())return!1;let{r:q,s:W}=D,G=N(m),$=i.inv(W),X=i.create(G*$),Q=i.create(q*$),J=r.BASE.multiplyUnsafe(X).add(M.multiplyUnsafe(Q));return J.is0()?!1:i.create(J.x)===q}catch{return!1}}function I(g,m,S={}){let{prehash:T}=yE(S,y);return m=A(m,T),w.fromBytes(g,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p,Point:r,sign:L,verify:B,recoverPublicKey:I,Signature:w,hash:e})}function DJ(r){let e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=r.allowedPrivateKeyLengths?Array.from(new Set(r.allowedPrivateKeyLengths.map(i=>Math.ceil(i/2)))):void 0,s=In(e.n,{BITS:r.nBitLength,allowedLengths:n,modFromBytes:r.wrapPrivateKey}),o={Fp:t,Fn:s,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:o}}function BJ(r){let{CURVE:e,curveOpts:t}=DJ(r),n={hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,hash:r.hash,ecdsaOpts:n}}function PJ(r,e){let t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},r,u4(t.Fn.ORDER,t.Fn.BITS))})}function xN(r){let{CURVE:e,curveOpts:t,hash:n,ecdsaOpts:s}=BJ(r),o=TJ(e,t),i=CJ(o,n,s);return PJ(r,i)}function EN(r,e){let t=n=>xN({...r,hash:n});return{...t(e),create:t}}var EE={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},LJ={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var vN=BigInt(2);function kJ(r){let e=EE.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,f=u*u*r%e,h=nt(f,t,e)*f%e,d=nt(h,t,e)*f%e,p=nt(d,vN,e)*u%e,y=nt(p,s,e)*p%e,x=nt(y,o,e)*y%e,b=nt(x,a,e)*x%e,_=nt(b,c,e)*b%e,v=nt(_,a,e)*x%e,w=nt(v,t,e)*f%e,R=nt(w,i,e)*y%e,N=nt(R,n,e)*u%e,O=nt(N,vN,e);if(!xE.eql(xE.sqr(O),r))throw new Error("Cannot find square root");return O}var xE=In(EE.p,{sqrt:kJ}),ro=EN({...EE,Fp:xE,lowS:!0,endo:LJ},i4);function SN(){return ro.utils.randomPrivateKey()}function _N(r,e){let t=Ee.digest(e instanceof Uint8Array?e:e.subarray());if(Vn(t))return t.then(({digest:n})=>ro.sign(n,r).toDERRawBytes()).catch(n=>{throw new K(String(n),"ERR_INVALID_INPUT")});try{return ro.sign(t.digest,r).toDERRawBytes()}catch(n){throw new K(String(n),"ERR_INVALID_INPUT")}}function AN(r,e,t){let n=Ee.digest(t instanceof Uint8Array?t:t.subarray());if(Vn(n))return n.then(({digest:s})=>ro.verify(e,s,r)).catch(s=>{throw new K(String(s),"ERR_INVALID_INPUT")});try{return ro.verify(e,n.digest,r)}catch(s){throw new K(String(s),"ERR_INVALID_INPUT")}}function IN(r){return ro.ProjectivePoint.fromHex(r).toRawBytes(!0)}function TN(r){try{ro.getPublicKey(r,!0)}catch(e){throw new K(String(e),"ERR_INVALID_PRIVATE_KEY")}}function vE(r){try{ro.ProjectivePoint.fromHex(r)}catch(e){throw new K(String(e),"ERR_INVALID_PUBLIC_KEY")}}function RN(r){try{return ro.getPublicKey(r,!0)}catch(e){throw new K(String(e),"ERR_INVALID_PRIVATE_KEY")}}var Tl=class{constructor(e){l(this,"_key");vE(e),this._key=e}verify(e,t){return AN(this._key,t,e)}marshal(){return IN(this._key)}get bytes(){return ws.encode({Type:st.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return j(this.bytes,e.bytes)}async hash(){let e=Ee.digest(this.bytes),t;return Vn(e)?{bytes:t}=await e:t=e.bytes,t}},Rl=class{constructor(e,t){l(this,"_key");l(this,"_publicKey");this._key=e,this._publicKey=t??RN(e),TN(this._key),vE(this._publicKey)}sign(e){return _N(this._key,e)}get public(){return new Tl(this._publicKey)}marshal(){return this._key}get bytes(){return xs.encode({Type:st.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return j(this.bytes,e.bytes)}hash(){let e=Ee.digest(this.bytes);return Vn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return z(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Wf(this.bytes,e);throw new K(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function OJ(r){return new Rl(r)}function MJ(r){return new Tl(r)}async function UJ(){let r=SN();return new Rl(r)}var gi={rsa:gE,ed25519:rE,secp256k1:SE};function _E(r){let e=Object.keys(gi).join(" / ");return new K(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function AE(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return gi[r];throw _E(r)}async function a6(r,e){return AE(r).generateKeyPair(e??2048)}async function KJ(r,e,t){if(r.toLowerCase()!=="ed25519")throw new K("Seed key derivation is unimplemented for RSA or secp256k1","ERR_UNSUPPORTED_KEY_DERIVATION_TYPE");return tE(e)}function ka(r){let e=ws.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case st.RSA:return gi.rsa.unmarshalRsaPublicKey(t);case st.Ed25519:return gi.ed25519.unmarshalEd25519PublicKey(t);case st.Secp256k1:return gi.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw _E(e.Type??"unknown")}}function IE(r,e){return e=(e??"rsa").toLowerCase(),AE(e),r.bytes}async function yi(r){let e=xs.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case st.RSA:return gi.rsa.unmarshalRsaPrivateKey(t);case st.Ed25519:return gi.ed25519.unmarshalEd25519PrivateKey(t);case st.Secp256k1:return gi.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw _E(e.Type??"RSA")}}function FJ(r,e){return e=(e??"rsa").toLowerCase(),AE(e),r.bytes}async function VJ(r,e){try{let t=await Ek(r,e);return await yi(t)}catch{}if(!r.includes("BEGIN"))throw new K("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return dE(r,e)}function TE(){let r=ue(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:(async function*(){yield*await r.promise})()}}function CN(){let r=TE(),e=TE();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var rh=!!globalThis.process?.env?.DUMP_SESSION_KEYS;function l6(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`positive integer expected, not ${r}`)}function RE(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function CE(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function fn(r,...e){if(!CE(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function DE(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function DN(r,e){fn(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var bi=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),BN=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),HJ=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!HJ)throw new Error("Non little-endian hardware is not supported");function qJ(r){if(typeof r!="string")throw new Error(`string expected, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function u6(r){if(typeof r=="string")r=qJ(r);else if(CE(r))r=f6(r);else throw new Error(`Uint8Array expected, got ${typeof r}`);return r}function PN(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function LN(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var BE=(r,e)=>(Object.assign(e,r),e);function PE(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,u=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+u,a,n)}function f6(r){return Uint8Array.from(r)}function wi(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}var NN=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),zJ=NN("expand 16-byte k"),$J=NN("expand 32-byte k"),GJ=bi(zJ),ON=bi($J),aIe=ON.slice();function ae(r,e){return r<<e|r>>>32-e}function LE(r){return r.byteOffset%4===0}var h6=64,WJ=16,MN=2**32-1,kN=new Uint32Array;function YJ(r,e,t,n,s,o,i,a){let c=s.length,u=new Uint8Array(h6),f=bi(u),h=LE(s)&&LE(o),d=h?bi(s):kN,p=h?bi(o):kN;for(let y=0;y<c;i++){if(r(e,t,n,f,i,a),i>=MN)throw new Error("arx: counter overflow");let x=Math.min(h6,c-y);if(h&&x===h6){let b=y/4;if(y%4!==0)throw new Error("arx: invalid block position");for(let _=0,v;_<WJ;_++)v=b+_,p[v]=d[v]^f[_];y+=h6;continue}for(let b=0,_;b<x;b++)_=y+b,o[_]=s[_]^u[b];y+=x}}function kE(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:o,rounds:i}=PN({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return l6(s),l6(i),RE(o),RE(t),(a,c,u,f,h=0)=>{fn(a),fn(c),fn(u);let d=u.length;if(f===void 0&&(f=new Uint8Array(d)),fn(f),l6(h),h<0||h>=MN)throw new Error("arx: counter overflow");if(f.length<d)throw new Error(`arx: output (${f.length}) is shorter than data (${d})`);let p=[],y=a.length,x,b;if(y===32)p.push(x=f6(a)),b=ON;else if(y===16&&t)x=new Uint8Array(32),x.set(a),x.set(a,16),b=GJ,p.push(x);else throw new Error(`arx: invalid 32-byte key, got length=${y}`);LE(c)||p.push(c=f6(c));let _=bi(x);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(b,_,bi(c.subarray(0,16)),_),c=c.subarray(16)}let v=16-s;if(v!==c.length)throw new Error(`arx: nonce must be ${v} or 16 bytes`);if(v!==12){let R=new Uint8Array(12);R.set(c,o?0:12-c.length),c=R,p.push(c)}let w=bi(c);return YJ(r,b,_,w,u,f,h,i),wi(...p),f}}var dr=(r,e)=>r[e++]&255|(r[e++]&255)<<8,NE=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=u6(e),fn(e,32);let t=dr(e,0),n=dr(e,2),s=dr(e,4),o=dr(e,6),i=dr(e,8),a=dr(e,10),c=dr(e,12),u=dr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let f=0;f<8;f++)this.pad[f]=dr(e,16+2*f)}process(e,t,n=!1){let s=n?0:2048,{h:o,r:i}=this,a=i[0],c=i[1],u=i[2],f=i[3],h=i[4],d=i[5],p=i[6],y=i[7],x=i[8],b=i[9],_=dr(e,t+0),v=dr(e,t+2),w=dr(e,t+4),R=dr(e,t+6),N=dr(e,t+8),O=dr(e,t+10),F=dr(e,t+12),A=dr(e,t+14),E=o[0]+(_&8191),L=o[1]+((_>>>13|v<<3)&8191),U=o[2]+((v>>>10|w<<6)&8191),B=o[3]+((w>>>7|R<<9)&8191),I=o[4]+((R>>>4|N<<12)&8191),g=o[5]+(N>>>1&8191),m=o[6]+((N>>>14|O<<2)&8191),S=o[7]+((O>>>11|F<<5)&8191),T=o[8]+((F>>>8|A<<8)&8191),P=o[9]+(A>>>5|s),C=0,k=C+E*a+L*(5*b)+U*(5*x)+B*(5*y)+I*(5*p);C=k>>>13,k&=8191,k+=g*(5*d)+m*(5*h)+S*(5*f)+T*(5*u)+P*(5*c),C+=k>>>13,k&=8191;let D=C+E*c+L*a+U*(5*b)+B*(5*x)+I*(5*y);C=D>>>13,D&=8191,D+=g*(5*p)+m*(5*d)+S*(5*h)+T*(5*f)+P*(5*u),C+=D>>>13,D&=8191;let M=C+E*u+L*c+U*a+B*(5*b)+I*(5*x);C=M>>>13,M&=8191,M+=g*(5*y)+m*(5*p)+S*(5*d)+T*(5*h)+P*(5*f),C+=M>>>13,M&=8191;let q=C+E*f+L*u+U*c+B*a+I*(5*b);C=q>>>13,q&=8191,q+=g*(5*x)+m*(5*y)+S*(5*p)+T*(5*d)+P*(5*h),C+=q>>>13,q&=8191;let W=C+E*h+L*f+U*u+B*c+I*a;C=W>>>13,W&=8191,W+=g*(5*b)+m*(5*x)+S*(5*y)+T*(5*p)+P*(5*d),C+=W>>>13,W&=8191;let G=C+E*d+L*h+U*f+B*u+I*c;C=G>>>13,G&=8191,G+=g*a+m*(5*b)+S*(5*x)+T*(5*y)+P*(5*p),C+=G>>>13,G&=8191;let $=C+E*p+L*d+U*h+B*f+I*u;C=$>>>13,$&=8191,$+=g*c+m*a+S*(5*b)+T*(5*x)+P*(5*y),C+=$>>>13,$&=8191;let X=C+E*y+L*p+U*d+B*h+I*f;C=X>>>13,X&=8191,X+=g*u+m*c+S*a+T*(5*b)+P*(5*x),C+=X>>>13,X&=8191;let Q=C+E*x+L*y+U*p+B*d+I*h;C=Q>>>13,Q&=8191,Q+=g*f+m*u+S*c+T*a+P*(5*b),C+=Q>>>13,Q&=8191;let J=C+E*b+L*x+U*y+B*p+I*d;C=J>>>13,J&=8191,J+=g*h+m*f+S*u+T*c+P*a,C+=J>>>13,J&=8191,C=(C<<2)+C|0,C=C+k|0,k=C&8191,C=C>>>13,D+=C,o[0]=k,o[1]=D,o[2]=M,o[3]=q,o[4]=W,o[5]=G,o[6]=$,o[7]=X,o[8]=Q,o[9]=J}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let o=(s^1)-1;for(let a=0;a<10;a++)n[a]&=o;o=~o;for(let a=0;a<10;a++)e[a]=e[a]&o|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let i=e[0]+t[0];e[0]=i&65535;for(let a=1;a<8;a++)i=(e[a]+t[a]|0)+(i>>>16)|0,e[a]=i&65535;wi(n)}update(e){DE(this);let{buffer:t,blockLen:n}=this;e=u6(e);let s=e.length;for(let o=0;o<s;){let i=Math.min(n-this.pos,s-o);if(i===n){for(;n<=s-o;o+=n)this.process(e,o);continue}t.set(e.subarray(o,o+i),this.pos),this.pos+=i,o+=i,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){wi(this.h,this.r,this.buffer,this.pad)}digestInto(e){DE(this),DN(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let o=0;for(let i=0;i<8;i++)e[o++]=n[i]>>>0,e[o++]=n[i]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function ZJ(r){let e=(n,s)=>r(s).update(u6(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var UN=ZJ(r=>new NE(r));function VN(r,e,t,n,s,o=20){let i=r[0],a=r[1],c=r[2],u=r[3],f=e[0],h=e[1],d=e[2],p=e[3],y=e[4],x=e[5],b=e[6],_=e[7],v=s,w=t[0],R=t[1],N=t[2],O=i,F=a,A=c,E=u,L=f,U=h,B=d,I=p,g=y,m=x,S=b,T=_,P=v,C=w,k=R,D=N;for(let q=0;q<o;q+=2)O=O+L|0,P=ae(P^O,16),g=g+P|0,L=ae(L^g,12),O=O+L|0,P=ae(P^O,8),g=g+P|0,L=ae(L^g,7),F=F+U|0,C=ae(C^F,16),m=m+C|0,U=ae(U^m,12),F=F+U|0,C=ae(C^F,8),m=m+C|0,U=ae(U^m,7),A=A+B|0,k=ae(k^A,16),S=S+k|0,B=ae(B^S,12),A=A+B|0,k=ae(k^A,8),S=S+k|0,B=ae(B^S,7),E=E+I|0,D=ae(D^E,16),T=T+D|0,I=ae(I^T,12),E=E+I|0,D=ae(D^E,8),T=T+D|0,I=ae(I^T,7),O=O+U|0,D=ae(D^O,16),S=S+D|0,U=ae(U^S,12),O=O+U|0,D=ae(D^O,8),S=S+D|0,U=ae(U^S,7),F=F+B|0,P=ae(P^F,16),T=T+P|0,B=ae(B^T,12),F=F+B|0,P=ae(P^F,8),T=T+P|0,B=ae(B^T,7),A=A+I|0,C=ae(C^A,16),g=g+C|0,I=ae(I^g,12),A=A+I|0,C=ae(C^A,8),g=g+C|0,I=ae(I^g,7),E=E+L|0,k=ae(k^E,16),m=m+k|0,L=ae(L^m,12),E=E+L|0,k=ae(k^E,8),m=m+k|0,L=ae(L^m,7);let M=0;n[M++]=i+O|0,n[M++]=a+F|0,n[M++]=c+A|0,n[M++]=u+E|0,n[M++]=f+L|0,n[M++]=h+U|0,n[M++]=d+B|0,n[M++]=p+I|0,n[M++]=y+g|0,n[M++]=x+m|0,n[M++]=b+S|0,n[M++]=_+T|0,n[M++]=v+P|0,n[M++]=w+C|0,n[M++]=R+k|0,n[M++]=N+D|0}function XJ(r,e,t,n){let s=r[0],o=r[1],i=r[2],a=r[3],c=e[0],u=e[1],f=e[2],h=e[3],d=e[4],p=e[5],y=e[6],x=e[7],b=t[0],_=t[1],v=t[2],w=t[3];for(let N=0;N<20;N+=2)s=s+c|0,b=ae(b^s,16),d=d+b|0,c=ae(c^d,12),s=s+c|0,b=ae(b^s,8),d=d+b|0,c=ae(c^d,7),o=o+u|0,_=ae(_^o,16),p=p+_|0,u=ae(u^p,12),o=o+u|0,_=ae(_^o,8),p=p+_|0,u=ae(u^p,7),i=i+f|0,v=ae(v^i,16),y=y+v|0,f=ae(f^y,12),i=i+f|0,v=ae(v^i,8),y=y+v|0,f=ae(f^y,7),a=a+h|0,w=ae(w^a,16),x=x+w|0,h=ae(h^x,12),a=a+h|0,w=ae(w^a,8),x=x+w|0,h=ae(h^x,7),s=s+u|0,w=ae(w^s,16),y=y+w|0,u=ae(u^y,12),s=s+u|0,w=ae(w^s,8),y=y+w|0,u=ae(u^y,7),o=o+f|0,b=ae(b^o,16),x=x+b|0,f=ae(f^x,12),o=o+f|0,b=ae(b^o,8),x=x+b|0,f=ae(f^x,7),i=i+h|0,_=ae(_^i,16),d=d+_|0,h=ae(h^d,12),i=i+h|0,_=ae(_^i,8),d=d+_|0,h=ae(h^d,7),a=a+c|0,v=ae(v^a,16),p=p+v|0,c=ae(c^p,12),a=a+c|0,v=ae(v^a,8),p=p+v|0,c=ae(c^p,7);let R=0;n[R++]=s,n[R++]=o,n[R++]=i,n[R++]=a,n[R++]=b,n[R++]=_,n[R++]=v,n[R++]=w}var jJ=kE(VN,{counterRight:!1,counterLength:4,allowShortKeys:!1}),QJ=kE(VN,{counterRight:!1,counterLength:8,extendNonceFn:XJ,allowShortKeys:!1});var JJ=new Uint8Array(16),KN=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(JJ.subarray(t))},eee=new Uint8Array(32);function FN(r,e,t,n,s){let o=r(e,t,eee),i=UN.create(o);s&&KN(i,s),KN(i,n);let a=new Uint8Array(16),c=BN(a);PE(c,0,BigInt(s?s.length:0),!0),PE(c,8,BigInt(n.length),!0),i.update(a);let u=i.digest();return wi(o,a),u}var HN=r=>(e,t,n)=>(fn(e,32),fn(t),{encrypt(o,i){let a=o.length,c=a+16;i?fn(i,c):i=new Uint8Array(c),r(e,t,o,i,1);let u=FN(r,e,t,i.subarray(0,-16),n);return i.set(u,a),wi(u),i},decrypt(o,i){let a=o.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");i?fn(i,c):i=new Uint8Array(c);let u=o.subarray(0,-16),f=o.subarray(-16),h=FN(r,e,t,u,n);if(!LN(f,h))throw new Error("invalid tag");return r(e,t,u,i,1),wi(h),i}}),OE=BE({blockSize:64,nonceLength:12,tagLength:16},HN(jJ)),gIe=BE({blockSize:64,nonceLength:24,tagLength:16},HN(QJ));function zN(r,e,t){return Qo(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Ra(r,Ea(t),Ea(e))}var ME=Uint8Array.from([0]),qN=Uint8Array.of();function $N(r,e,t,n=32){Qo(r),ys(n);let s=r.outputLen;if(n>255*s)throw new Error("Length should be <= 255*HashLen");let o=Math.ceil(n/s);t===void 0&&(t=qN);let i=new Uint8Array(o*s),a=Ra.create(r,e),c=a._cloneInto(),u=new Uint8Array(a.outputLen);for(let f=0;f<o;f++)ME[0]=f+1,c.update(f===0?qN:u).update(t).update(ME).digestInto(u),i.set(u,s*f),a._cloneInto(c);return a.destroy(),c.destroy(),_n(u,ME),i.slice(0,n)}var d6=i4;var UE={hashSHA256(r){return d6(r.subarray())},getHKDF(r,e){let t=zN(d6,e,r),s=$N(d6,t,void 0,96),o=s.subarray(0,32),i=s.subarray(32,64),a=s.subarray(64,96);return[o,i,a]},generateX25519KeyPair(){let r=k1.utils.randomPrivateKey();return{publicKey:k1.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:k1.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return k1.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return OE(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,s){return OE(n,e,t).decrypt(r.subarray(),s)}};var GN=UE;function WN(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}var nh=r=>{let e=pe(2);return e[0]=r>>8,e[1]=r,e};nh.bytes=2;var $1=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};$1.bytes=2;function YN(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function KE(r,e){!e.enabled||!rh||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${z(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${z(r.privateKey,"hex")}`)):e("Missing local static keys."))}function FE(r,e){!e.enabled||!rh||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${z(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${z(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function ZN(r,e){!e.enabled||!rh||e(r?`REMOTE_STATIC_PUBLIC_KEY ${z(r.subarray(),"hex")}`:"Missing remote static public key.")}function VE(r,e){!e.enabled||!rh||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${z(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function HE(r,e,t){!t.enabled||!rh||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&z(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&z(e.k,"hex")}`))}function vs(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=pe(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}var m6=class m6 extends Error{constructor(t="Unexpected Peer"){super(t);l(this,"code");this.code=m6.code}};l(m6,"code","ERR_UNEXPECTED_PEER");var p6=m6,g6=class g6 extends Error{constructor(t="Invalid crypto exchange"){super(t);l(this,"code");this.code=g6.code}};l(g6,"code","ERR_INVALID_CRYPTO_EXCHANGE");var sh=g6;var tee=0,ree=4294967295,nee="Cipherstate has reached maximum n, a new handshake must be performed",y6=class{constructor(e=tee){l(this,"n");l(this,"bytes");l(this,"view");this.n=e,this.bytes=fe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>ree)throw new Error(nee)}};var Cl=fe(0),oh=class{constructor(e,t=void 0,n=0){l(this,"k");l(this,"n");l(this,"crypto");this.crypto=e,this.k=t,this.n=new y6(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();let s=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),s}},qE=class{constructor(e,t){l(this,"cs");l(this,"ck");l(this,"h");l(this,"crypto");this.crypto=e;let n=H(t,"utf-8");this.h=see(e,n),this.ck=this.h,this.cs=new oh(e)}mixKey(e){let[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new oh(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Z(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,Cl);return[new oh(this.crypto,e),new oh(this.crypto,t)]}},zE=class{constructor(e){l(this,"ss");l(this,"s");l(this,"e");l(this,"rs");l(this,"re");l(this,"initiator");l(this,"crypto");let{crypto:t,protocolName:n,prologue:s,initiator:o,s:i,e:a,rs:c,re:u}=e;this.crypto=t,this.ss=new qE(t,n),this.ss.mixHash(s),this.initiator=o,this.s=i,this.e=a,this.rs=c,this.re=u}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");let s=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(s),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},G1=class extends zE{writeMessageA(e){return new Z(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new Z(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new Z(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new sh(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new sh(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new sh(`handshake stage 2 validation fail: ${t.message}`)}}};function see(r,e){if(e.length<=32){let t=fe(32);return t.set(e),t}else return r.hash(e)}var b6;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let o of t.webtransportCerthashes)n.uint32(10),n.bytes(o);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={webtransportCerthashes:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();i>>>3===1?s.webtransportCerthashes.push(t.bytes()):t.skipType(i&7)}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(b6||(b6={}));var W1;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),b6.codec().encode(t.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={identityKey:fe(0),identitySig:fe(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=b6.codec().decode(t,t.uint32());break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(W1||(W1={}));async function $E(r,e,t){let n=await r.sign(XN(e));return W1.encode({identityKey:r.public.bytes,identitySig:n,extensions:t})}async function GE(r,e,t){try{let n=W1.decode(r);if(t){let i=t.subarray();if(!j(i,n.identityKey))throw new Error(`Payload identity key ${z(n.identityKey,"hex")} does not match expected remote identity key ${z(i,"hex")}`)}if(!e)throw new Error("Remote static does not exist");let s=XN(e);if(!await ka(n.identityKey).verify(s,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new p6(n.message)}}function XN(r){let e=H("noise-libp2p-static-key:");return r instanceof Uint8Array?we([e,r],e.length+r.length):(r.prepend(e),r)}async function jN(r,e){let{log:t,connection:n,crypto:s,privateKey:o,prologue:i,s:a,remoteIdentityKey:c,extensions:u}=r,f=await $E(o,a.publicKey,u),h=new G1({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:i,s:a});KE(h.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(Cl),e),t.trace("Stage 0 - Initiator finished sending first message."),FE(h.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");let d=h.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),VE(h.re,t),ZN(h.rs,t),t.trace("Initiator going to check remote's signature...");let p=await GE(d,h.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(f),e),t.trace("Stage 2 - Initiator sent message with signed payload.");let[y,x]=h.ss.split();return HE(y,x,t),{payload:p,encrypt:b=>y.encryptWithAd(Cl,b),decrypt:(b,_)=>x.decryptWithAd(Cl,b,_)}}async function QN(r,e){let{log:t,connection:n,crypto:s,privateKey:o,prologue:i,s:a,remoteIdentityKey:c,extensions:u}=r,f=await $E(o,a.publicKey,u),h=new G1({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:i,s:a});KE(h.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),VE(h.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(f),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),FE(h.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");let d=h.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");let p=await GE(d,h.rs,c),[y,x]=h.ss.split();return HE(y,x,t),{payload:p,encrypt:b=>x.encryptWithAd(Cl,b),decrypt:(b,_)=>y.decryptWithAd(Cl,b,_)}}var eO=16;function tO(r,e){return async function*(t){for await(let n of t)for(let s=0;s<n.length;s+=65519){let o=s+65519;o>n.length&&(o=n.length);let i;n instanceof Uint8Array?i=r.encrypt(n.subarray(s,o)):i=r.encrypt(n.sublist(s,o)),e?.encryptedPackets.increment(),yield new Z(nh(i.byteLength),i)}}}function rO(r,e){return async function*(t){for await(let n of t)for(let s=0;s<n.length;s+=65535){let o=s+65535;if(o>n.length&&(o=n.length),o-eO<s)throw new Error("Invalid chunk");let i=n.sublist(s,o),a=n.subarray(s,o-eO);try{let c=r.decrypt(i,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}var nO,sO;sO=Symbol.toStringTag,nO=Gt;var w6=class{constructor(e,t={}){l(this,"protocol","/noise");l(this,"crypto");l(this,"prologue");l(this,"staticKey");l(this,"extensions");l(this,"metrics");l(this,"components");l(this,sO,"@chainsafe/libp2p-noise");l(this,nO,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);let{staticNoiseKey:n,extensions:s,crypto:o,prologueBytes:i}=t,{metrics:a}=e;this.components=e;let c=o??GN;this.crypto=WN(c),this.extensions=s,this.metrics=a?YN(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=i??fe(0)}async secureOutbound(...e){let{localPeer:t,connection:n,remotePeer:s,signal:o}=this.parseArgs(e),i=_1(n,{lengthEncoder:nh,lengthDecoder:$1,maxDataLength:65535});if(!t.privateKey)throw new K("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");let a=await yi(t.privateKey),c=s?.publicKey,u=await this.performHandshakeInitiator(i,a,c,{signal:o}),f=await this.createSecureConnection(i,u);return n.source=f.source,n.sink=f.sink,{conn:n,remoteExtensions:u.payload.extensions,remotePeer:await ds(u.payload.identityKey)}}async secureInbound(...e){let{localPeer:t,connection:n,remotePeer:s,signal:o}=this.parseArgs(e),i=_1(n,{lengthEncoder:nh,lengthDecoder:$1,maxDataLength:65535});if(!t.privateKey)throw new K("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");let a=await yi(t.privateKey),c=s?.publicKey,u=await this.performHandshakeResponder(i,a,c,{signal:o}),f=await this.createSecureConnection(i,u);return n.source=f.source,n.sink=f.sink,{conn:n,remoteExtensions:u.payload.extensions,remotePeer:await ds(u.payload.identityKey)}}async performHandshakeInitiator(e,t,n,s){let o;try{o=await jN({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(i){throw this.metrics?.xxHandshakeErrors.increment(),i}return o}async performHandshakeResponder(e,t,n,s){let o;try{o=await QN({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(i){throw this.metrics?.xxHandshakeErrors.increment(),i}return o}async createSecureConnection(e,t){let[n,s]=CN(),o=e.unwrap();return await at(n,tO(t,this.metrics),o,i=>ms(i,{lengthDecoder:$1}),rO(t,this.metrics),n),s}parseArgs(e){return WB(e[0])?{localPeer:e[0],connection:e[1],remotePeer:e[2]}:{localPeer:this.components.peerId,connection:e[0],remotePeer:e[1]?.remotePeer,signal:e[1]?.signal}}};function Z1(r={}){return e=>new w6(e,r)}var WE=Object.values(Qr).map(r=>r.decoder).reduce((r,e)=>r.or(e));function oO(r,e){let t=r.getConfiguration().certificates?.at(0);if(t?.getFingerprints==null){e.log.trace("fetching fingerprint from local SDP");let s=r.localDescription;return s==null?void 0:iee(s.sdp)}if(e.log.trace("fetching fingerprint from local certificate"),t.getFingerprints().length===0)return;let n=t.getFingerprints()[0].value;if(n==null)throw cx("","no fingerprint on local certificate");return n}var oee=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function iee(r){return r.match(oee)?.groups?.fingerprint}function aee(r){for(let e of r.protoNames())if(e.startsWith("ip"))return e.toUpperCase();return"IP6"}function x6(r){let t=r.stringTuples().filter(n=>n[0]===cO).map(n=>n[1])[0];if(t===void 0||t==="")throw D3(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function YE(r){return kt.decode(WE.decode(r))}function cee(r){let e=YE(x6(r)),t=ZE(e.code),n=e.digest.reduce((o,i)=>o+i.toString(16).padStart(2,"0"),""),s=n.match(/.{1,2}/g);if(s==null)throw cx(n,r.toString());return[`${t} ${s.join(":").toUpperCase()}`,n]}function ZE(r){switch(r){case 17:return"SHA-1";case 18:return"SHA-256";case 19:return"SHA-512";default:throw kP(r)}}function lee(r,e){let{host:t,port:n}=r.toOptions(),s=aee(r),[o]=cee(r);return`v=0
o=- 0 0 IN ${s} ${t}
s=-
c=IN ${s} ${t}
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:passive
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${o}
a=sctp-port:5000
a=max-message-size:${q3}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host\r
`}function iO(r,e){return{type:"answer",sdp:lee(r,e)}}function aO(r,e){if(r.sdp===void 0)throw y1("Can't munge a missing SDP");return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+`
`).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+`
`),r}var lO=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),uO=r=>[...Array(r)].map(()=>lO.at(Math.floor(Math.random()*lO.length))).join("");var fee=1e4,pRe=Ot("webrtc-direct").code,cO=Ot("certhash").code,fO,hO,dO;dO=bf,hO=Symbol.toStringTag,fO=Gt;var E6=class{constructor(e,t={}){l(this,"log");l(this,"metrics");l(this,"components");l(this,"init");l(this,dO,!0);l(this,hO,"@libp2p/webrtc-direct");l(this,fO,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(e,t){let n=await this._connect(e,t);return this.log("dialing address: %a",e),n}createListener(e){throw LP("WebRTCTransport.createListener")}listenFilter(e){return e.filter(RP.exactMatch)}dialFilter(e){return this.listenFilter(e)}async _connect(e,t){let n=new AbortController,s=n.signal,o=e.getPeerId();if(o===null)throw D3("we need to have the remote's PeerId");let i=Qe(o),a=YE(x6(e)),c=await pl.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:ZE(a.code)}),u=new pl({...await w1(this.init.rtcConfiguration),certificates:[c]});try{let f=new Promise((A,E)=>{let L=u.createDataChannel("",{negotiated:!0,id:0}),U=setTimeout(()=>{let B=`Data channel was never opened: state: ${L.readyState}`;this.log.error(B),this.metrics?.dialerEvents.increment({open_error:!0}),E(ax("data",B))},fee);L.onopen=B=>{clearTimeout(U),A(L)},L.onerror=B=>{clearTimeout(U);let g=`Error opening a data channel for handshaking: ${B.target?.toString()??"not specified"}`;this.log.error(g),this.metrics?.dialerEvents.increment({unknown_error:!0}),E(ax("data",g))}}),h="libp2p+webrtc+v1/"+uO(32),d=await u.createOffer(),p=aO(d,h);await u.setLocalDescription(p);let y=iO(e,h);await u.setRemoteDescription(y);let x=await f,b=this.components.peerId,_=this.generateNoisePrologue(u,a.code,e),v=Z1({prologueBytes:_})(this.components),w=Pf({channel:x,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),R={...w,sink:w.sink.bind(w),source:(async function*(){for await(let A of w.source)for(let E of A)yield E})()},N=new ul(this.components,{peerConnection:u,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),O=b1?"iceconnectionstatechange":"connectionstatechange";u.addEventListener(O,()=>{switch(u.connectionState){case"failed":case"disconnected":case"closed":N.close().catch(A=>{this.log.error("error closing connection",A)}).finally(()=>{n.abort()});break;default:break}},{signal:s}),this.metrics?.dialerEvents.increment({peer_connection:!0});let F=new ba(this.components,{peerConnection:u,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await v.secureInbound(b,R,i),await t.upgrader.upgradeOutbound(N,{skipProtection:!0,skipEncryption:!0,muxerFactory:F})}catch(f){throw u.close(),f}}generateNoisePrologue(e,t,n){if(e.getConfiguration().certificates?.length===0)throw y1("no local certificate");let s=oO(e,{log:this.log});if(s==null)throw y1("no local fingerprint found");let o=s.trim().toLowerCase().replaceAll(":",""),i=H(o,"hex"),a=ot(t,i),c=WE.decode(x6(n)),u=H("libp2p-webrtc-noise:");return we([u,a.bytes,c])}};function XE(r){return e=>new E6(e,r)}function jE(r){return e=>new t4(e,r)}var hee=[Ot("tcp").code,Ot("dns").code,Ot("dnsaddr").code,Ot("dns4").code,Ot("dns6").code];function pO(r){return yO("sni",r)?.[1]}function mO(r){let e=yO("tcp",r)?.[1];return e==null?"":`:${e}`}function yO(r,e){let t;try{t=Ot(r).code}catch{return}for(let[n,s]of e)if(n===t&&s!=null)return[n,s]}function gO(r){return r.some(([e,t])=>e===Ot("tls").code)}function hn(r,e,t){let n=bO[Ot(r).name];if(n==null)throw new Error(`Can't interpret protocol ${Ot(r).name}`);let s=n(e,t);return r===Ot("ip6").code?`[${s}]`:s}var bO={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${hn(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${hn(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${hn(t[0],t[1]??"",e)}/ipfs/${r}`},p2p:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${hn(t[0],t[1]??"",e)}/p2p/${r}`},http:(r,e)=>{let t=gO(e),n=pO(e),s=mO(e);if(t&&n!=null)return`https://${n}${s}`;let o=t?"https://":"http://",i=e.pop();if(i==null)throw new Error("Unexpected end of multiaddr");let a=hn(i[0],i[1]??"",e);return a=a.replace("tcp://",""),`${o}${a}`},"http-path":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=hn(t[0],t[1]??"",e),s=decodeURIComponent(r);return`${n}/${s}`},tls:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return hn(t[0],t[1]??"",e)},sni:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return hn(t[0],t[1]??"",e)},https:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=hn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=gO(e),n=pO(e),s=mO(e);if(t&&n!=null)return`wss://${n}${s}`;let o=t?"wss://":"ws://",i=e.pop();if(i==null)throw new Error("Unexpected end of multiaddr");let a=hn(i[0],i[1]??"",e);return a=a.replace("tcp://",""),`${o}${a}`},wss:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=hn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${hn(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${hn(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${hn(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function wO(r,e){let n=xe(r).stringTuples(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let o=Ot(s[0]),i=bO[o.name];if(i==null)throw new Error(`No interpreter found for ${o.name}`);let a=i(s[1]??"",n);return e?.assumeHttp!==!1&&hee.includes(s[0])&&(a=a.replace(/^.*:\/\//,""),s[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}var xO=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",o)}function s(){n(),e()}function o(i){n(),t(i.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",o)})};var EO=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let s of n){try{await xO(r)}catch(o){if(o.message==="socket closed")break;throw o}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,o)=>{r.addEventListener("close",i=>{if(i.wasClean||i.code===1006)s();else{let a=Object.assign(new Error("ws error"),{event:i});o(a)}}),setTimeout(()=>{r.close()})})});var AO=go(SO(),1);function _O(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var IO=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((o,i)=>{if(n){o();return}if(s!=null){i(s);return}let a=f=>{r.removeEventListener("open",c),r.removeEventListener("error",u),f()},c=()=>{a(o)},u=f=>{a(()=>{i(f.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",u)})},t=(async function*(){let o=new AO.EventIterator(({push:i,stop:a,fail:c})=>{let u=h=>{let d=null;typeof h.data=="string"&&(d=H(h.data)),_O(h.data)&&(d=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(d=h.data),d!=null&&i(d)},f=h=>{c(h.error??new Error("Socket error"))};return r.addEventListener("message",u),r.addEventListener("error",f),r.addEventListener("close",a),()=>{r.removeEventListener("message",u),r.removeEventListener("error",f),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let i of o)yield _O(i)?new Uint8Array(i):i})(),n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",o=>{n||(s=o.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var TO=(r,e)=>{e=e??{};let t=IO(r),n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{let i=new URL(r.url);n=i.hostname,s=parseInt(i.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:EO(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(i=>{r.addEventListener("close",()=>{i()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}};var RO=WebSocket;var pee={"http:":"ws:","https:":"wss:"},CO="ws:",DO=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??CO}${r}`),r.startsWith("/")&&e!=null){let n=e.protocol??CO,s=e.host,o=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${s}${o}${r}`}let t=new URL(r);for(let[n,s]of Object.entries(pee))t.protocol===n&&(t.protocol=s);return t};function BO(r,e){let t=typeof window>"u"?void 0:window.location;e=e??{};let n=DO(r,t),s=new RO(n.toString(),e.websocket);return TO(s,e)}var kO=go(LO(),1),ev=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,_6=(0,kO.default)(),A6=ev&&!_6,NO=_6&&!ev,OO=_6&&ev,MO=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!_6,I6=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,KRe=typeof globalThis.process<"u"&&typeof globalThis.process.env<"u"&&globalThis.process.env.NODE_ENV==="test",UO=typeof navigator<"u"&&navigator.product==="ReactNative";function j1(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return Nf.matches(t)||ml.matches(t)})}function KO(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return ml.matches(t)})}function FO(){throw new Error("WebSocket Servers can not be created in the browser!")}function VO(r,e,t){let n=t.logger.forComponent("libp2p:websockets:maconn"),s=t.metrics,o=t.metricPrefix??"",i={log:n,async sink(a){try{await r.sink((async function*(){for await(let c of a)c instanceof Uint8Array?yield c:yield c.subarray()})())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){let c=Date.now();if(a.signal==null){let f=AbortSignal.timeout(500);a={...a,signal:f}}let u=()=>{let{host:f,port:h}=i.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",f,h,Date.now()-c),this.abort(new K("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};a.signal?.addEventListener("abort",u);try{await r.close()}catch(f){n.error("error closing WebSocket gracefully",f),this.abort(f)}finally{a.signal?.removeEventListener("abort",u),i.timeline.close=Date.now()}},abort(a){let{host:c,port:u}=i.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,u,a),r.destroy(),i.timeline.close=Date.now(),s?.increment({[`${o}error`]:!0})}};return r.socket.addEventListener("close",()=>{s?.increment({[`${o}close`]:!0}),i.timeline.close==null&&(i.timeline.close=Date.now())},{once:!0}),i}var HO,qO,zO;zO=bf,qO=Symbol.toStringTag,HO=Gt;var tv=class{constructor(e,t){l(this,"log");l(this,"init");l(this,"logger");l(this,"metrics");l(this,"components");l(this,zO,!0);l(this,qO,"@libp2p/websockets");l(this,HO,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(e,t){this.log("dialing %s",e),t=t??{};let n=await this._connect(e,t),s=VO(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);let o=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),o}async _connect(e,t){t?.signal?.throwIfAborted();let n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);let s=ue(),o=BO(wO(e),this.init);o.socket.addEventListener("error",()=>{let i=new K(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",i),this.metrics?.dialerEvents.increment({error:!0}),s.reject(i)});try{t.onProgress?.(new ve("websockets:open-connection")),await $e(Promise.race([o.connected(),s.promise]),t.signal)}catch(i){throw t.signal?.aborted===!0&&this.metrics?.dialerEvents.increment({abort:!0}),o.close().catch(a=>{this.log.error("error closing raw socket",a)}),i}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),o}createListener(e){return FO({logger:this.logger,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):A6||I6?KO(e):j1(e)}dialFilter(e){return this.listenFilter(e)}};function rv(r={}){return e=>new tv(e,r)}var Ss=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};l(Ss,"name","InvalidParametersError");var Q1=class extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}};l(Q1,"name","InvalidPublicKeyError");var J1=class extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};l(J1,"name","UnsupportedKeyTypeError");var wee=parseInt("11111",2),nv=parseInt("10000000",2),xee=parseInt("01111111",2),$O={0:ep,1:ep,2:Eee,3:_ee,4:Aee,5:See,6:vee,16:ep,22:ep,48:ep};function sv(r,e={offset:0}){let t=r[e.offset]&wee;if(e.offset++,$O[t]!=null)return $O[t](r,e);throw new Error("No decoder for tag "+t)}function tp(r,e){let t=0;if((r[e.offset]&nv)===nv){let n=r[e.offset]&xee,s="0x";e.offset++;for(let o=0;o<n;o++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function ep(r,e){tp(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=sv(r,e);if(n===null)break;t.push(n)}return t}function Eee(r,e){let t=tp(r,e),n=e.offset,s=e.offset+t,o=[];for(let i=n;i<s;i++)i===n&&r[i]===0||o.push(r[i]);return e.offset+=t,Uint8Array.from(o)}function vee(r,e){let t=tp(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let o=0,i=0;s<40?(o=0,i=s):s<80?(o=1,i=s-40):(o=2,i=s-80);let a=`${o}.${i}`,c=[];for(;e.offset<n;){let u=r[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let f=0;for(let h=0;h<c.length;h++)f+=c[h]<<h*7;a+=`.${f}`,c=[]}}return a}function See(r,e){return e.offset++,null}function _ee(r,e){let t=tp(r,e),n=r[e.offset];e.offset++;let s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function Aee(r,e){let t=tp(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Iee(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new Z;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function ov(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=Iee(r.byteLength);return new Z(Uint8Array.from([e.byteLength|nv]),e)}function GO(r){let e=new Z,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Z(Uint8Array.from([2]),ov(e),e)}function WO(r){let e=Uint8Array.from([0]),t=new Z(e,r);return new Z(Uint8Array.from([3]),ov(t),t)}function T6(r,e=48){let t=new Z;for(let n of r)t.append(n);return new Z(Uint8Array.from([e]),ov(t),t)}async function YO(r,e,t,n){let s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let o=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),o}var Tee=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Ree=Uint8Array.from([6,5,43,129,4,0,34]),Cee=Uint8Array.from([6,5,43,129,4,0,35]),Dee={ext:!0,kty:"EC",crv:"P-256"},Bee={ext:!0,kty:"EC",crv:"P-384"},Pee={ext:!0,kty:"EC",crv:"P-521"},iv=32,av=48,cv=66;function ZO(r){let e=sv(r);return XO(e)}function XO(r){let e=r[1][1][0],t=1,n,s;if(e.byteLength===iv*2+1)return n=z(e.subarray(t,t+iv),"base64url"),s=z(e.subarray(t+iv),"base64url"),new ih({...Dee,key_ops:["verify"],x:n,y:s});if(e.byteLength===av*2+1)return n=z(e.subarray(t,t+av),"base64url"),s=z(e.subarray(t+av),"base64url"),new ih({...Bee,key_ops:["verify"],x:n,y:s});if(e.byteLength===cv*2+1)return n=z(e.subarray(t,t+cv),"base64url"),s=z(e.subarray(t+cv),"base64url"),new ih({...Pee,key_ops:["verify"],x:n,y:s});throw new Ss(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function jO(r){return T6([GO(Uint8Array.from([1])),T6([Lee(r.crv)],160),T6([WO(new Z(Uint8Array.from([4]),H(r.x??"","base64url"),H(r.y??"","base64url")))],161)]).subarray()}function Lee(r){if(r==="P-256")return Tee;if(r==="P-384")return Ree;if(r==="P-521")return Cee;throw new Ss(`Invalid curve ${r}`)}var ih=class{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=jO(this.jwk)),this._raw}toMultihash(){return ge.digest(Na(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}async verify(e,t,n){return YO(this.jwk,t,e,n)}};function Dl(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function no(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function Ie(r,e,t=""){let n=Dl(r),s=r?.length,o=e!==void 0;if(!n||o&&s!==e){let i=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return r}function R6(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");no(r.outputLen),no(r.blockLen)}function ah(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function JO(r,e){Ie(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Ei(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function C6(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function _s(r,e){return r<<32-e|r>>>e}var eM=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",kee=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function vi(r){if(Ie(r),eM)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=kee[r[t]];return e}var xi={_0:48,_9:57,A:65,F:70,a:97,f:102};function QO(r){if(r>=xi._0&&r<=xi._9)return r-xi._0;if(r>=xi.A&&r<=xi.F)return r-(xi.A-10);if(r>=xi.a&&r<=xi.f)return r-(xi.a-10)}function Si(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(eM)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let s=0,o=0;s<t;s++,o+=2){let i=QO(r.charCodeAt(o)),a=QO(r.charCodeAt(o+1));if(i===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}function dn(...r){let e=0;for(let n=0;n<r.length;n++){let s=r[n];Ie(s),e+=s.length}let t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let o=r[n];t.set(o,s),s+=o.length}return t}function lv(r,e={}){let t=(s,o)=>r(o).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Oa(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var uv=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function tM(r,e,t){return r&e^~r&t}function rM(r,e,t){return r&e^r&t^e&t}var rp=class{constructor(e,t,n,s){l(this,"blockLen");l(this,"outputLen");l(this,"padOffset");l(this,"isLE");l(this,"buffer");l(this,"view");l(this,"finished",!1);l(this,"length",0);l(this,"pos",0);l(this,"destroyed",!1);this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=C6(this.buffer)}update(e){ah(this),Ie(e);let{view:t,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=C6(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ah(this),JO(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;t[i++]=128,Ei(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let h=i;h<s;h++)t[h]=0;n.setBigUint64(s-8,BigInt(this.length*8),o),this.process(n,0);let a=C6(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let u=c/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)a.setUint32(4*h,f[h],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},_i=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var pr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var D6=BigInt(4294967295),nM=BigInt(32);function Nee(r,e=!1){return e?{h:Number(r&D6),l:Number(r>>nM&D6)}:{h:Number(r>>nM&D6)|0,l:Number(r&D6)|0}}function sM(r,e=!1){let t=r.length,n=new Uint32Array(t),s=new Uint32Array(t);for(let o=0;o<t;o++){let{h:i,l:a}=Nee(r[o],e);[n[o],s[o]]=[i,a]}return[n,s]}var fv=(r,e,t)=>r>>>t,hv=(r,e,t)=>r<<32-t|e>>>t,Bl=(r,e,t)=>r>>>t|e<<32-t,Pl=(r,e,t)=>r<<32-t|e>>>t,np=(r,e,t)=>r<<64-t|e>>>t-32,sp=(r,e,t)=>r>>>t-32|e<<64-t;function so(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var oM=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),iM=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,aM=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),cM=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,lM=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),uM=(r,e,t,n,s,o)=>e+t+n+s+o+(r/2**32|0)|0;var Mee=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ma=new Uint32Array(64),dv=class extends rp{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)Ma[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){let d=Ma[h-15],p=Ma[h-2],y=_s(d,7)^_s(d,18)^d>>>3,x=_s(p,17)^_s(p,19)^p>>>10;Ma[h]=x+Ma[h-7]+y+Ma[h-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:u,H:f}=this;for(let h=0;h<64;h++){let d=_s(a,6)^_s(a,11)^_s(a,25),p=f+d+tM(a,c,u)+Mee[h]+Ma[h]|0,x=(_s(n,2)^_s(n,13)^_s(n,22))+rM(n,s,o)|0;f=u,u=c,c=a,a=i+p|0,i=o,o=s,s=n,n=p+x|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(n,s,o,i,a,c,u,f)}roundClean(){Ei(Ma)}destroy(){this.set(0,0,0,0,0,0,0,0),Ei(this.buffer)}},pv=class extends dv{constructor(){super(32);l(this,"A",_i[0]|0);l(this,"B",_i[1]|0);l(this,"C",_i[2]|0);l(this,"D",_i[3]|0);l(this,"E",_i[4]|0);l(this,"F",_i[5]|0);l(this,"G",_i[6]|0);l(this,"H",_i[7]|0)}};var fM=sM(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Uee=fM[0],Kee=fM[1],Ua=new Uint32Array(80),Ka=new Uint32Array(80),mv=class extends rp{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:u,El:f,Fh:h,Fl:d,Gh:p,Gl:y,Hh:x,Hl:b}=this;return[e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b]}set(e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=f|0,this.Fh=h|0,this.Fl=d|0,this.Gh=p|0,this.Gl=y|0,this.Hh=x|0,this.Hl=b|0}process(e,t){for(let w=0;w<16;w++,t+=4)Ua[w]=e.getUint32(t),Ka[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){let R=Ua[w-15]|0,N=Ka[w-15]|0,O=Bl(R,N,1)^Bl(R,N,8)^fv(R,N,7),F=Pl(R,N,1)^Pl(R,N,8)^hv(R,N,7),A=Ua[w-2]|0,E=Ka[w-2]|0,L=Bl(A,E,19)^np(A,E,61)^fv(A,E,6),U=Pl(A,E,19)^sp(A,E,61)^hv(A,E,6),B=aM(F,U,Ka[w-7],Ka[w-16]),I=cM(B,O,L,Ua[w-7],Ua[w-16]);Ua[w]=I|0,Ka[w]=B|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:u,Dl:f,Eh:h,El:d,Fh:p,Fl:y,Gh:x,Gl:b,Hh:_,Hl:v}=this;for(let w=0;w<80;w++){let R=Bl(h,d,14)^Bl(h,d,18)^np(h,d,41),N=Pl(h,d,14)^Pl(h,d,18)^sp(h,d,41),O=h&p^~h&x,F=d&y^~d&b,A=lM(v,N,F,Kee[w],Ka[w]),E=uM(A,_,R,O,Uee[w],Ua[w]),L=A|0,U=Bl(n,s,28)^np(n,s,34)^np(n,s,39),B=Pl(n,s,28)^sp(n,s,34)^sp(n,s,39),I=n&o^n&a^o&a,g=s&i^s&c^i&c;_=x|0,v=b|0,x=p|0,b=y|0,p=h|0,y=d|0,{h,l:d}=so(u|0,f|0,E|0,L|0),u=a|0,f=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let m=oM(L,B,g);n=iM(m,E,U,I),s=m|0}({h:n,l:s}=so(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=so(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=so(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l:f}=so(this.Dh|0,this.Dl|0,u|0,f|0),{h,l:d}=so(this.Eh|0,this.El|0,h|0,d|0),{h:p,l:y}=so(this.Fh|0,this.Fl|0,p|0,y|0),{h:x,l:b}=so(this.Gh|0,this.Gl|0,x|0,b|0),{h:_,l:v}=so(this.Hh|0,this.Hl|0,_|0,v|0),this.set(n,s,o,i,a,c,u,f,h,d,p,y,x,b,_,v)}roundClean(){Ei(Ua,Ka)}destroy(){Ei(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},gv=class extends mv{constructor(){super(64);l(this,"Ah",pr[0]|0);l(this,"Al",pr[1]|0);l(this,"Bh",pr[2]|0);l(this,"Bl",pr[3]|0);l(this,"Ch",pr[4]|0);l(this,"Cl",pr[5]|0);l(this,"Dh",pr[6]|0);l(this,"Dl",pr[7]|0);l(this,"Eh",pr[8]|0);l(this,"El",pr[9]|0);l(this,"Fh",pr[10]|0);l(this,"Fl",pr[11]|0);l(this,"Gh",pr[12]|0);l(this,"Gl",pr[13]|0);l(this,"Hh",pr[14]|0);l(this,"Hl",pr[15]|0)}};var hM=lv(()=>new pv,uv(1));var dM=lv(()=>new gv,uv(3));var bv=BigInt(0),yv=BigInt(1);function Ai(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function pM(r){if(typeof r=="bigint"){if(!B6(r))throw new Error("positive bigint expected, got "+r)}else no(r);return r}function op(r){let e=pM(r).toString(16);return e.length&1?"0"+e:e}function mM(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?bv:BigInt("0x"+r)}function ch(r){return mM(vi(r))}function Ll(r){return mM(vi(L6(Ie(r)).reverse()))}function P6(r,e){no(e),r=pM(r);let t=Si(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function wv(r,e){return P6(r,e).reverse()}function L6(r){return Uint8Array.from(r)}var B6=r=>typeof r=="bigint"&&bv<=r;function Fee(r,e,t){return B6(r)&&B6(e)&&B6(t)&&e<=r&&r<t}function ip(r,e,t,n){if(!Fee(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function xv(r){let e;for(e=0;r>bv;r>>=yv,e+=1);return e}var ap=r=>(yv<<BigInt(r))-yv;function gM(r,e,t){if(no(r,"hashLen"),no(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=b=>new Uint8Array(b),s=Uint8Array.of(),o=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=n(r),u=n(r),f=0,h=()=>{c.fill(1),u.fill(0),f=0},d=(...b)=>t(u,dn(c,...b)),p=(b=s)=>{u=d(o,b),c=d(),b.length!==0&&(u=d(i,b),c=d())},y=()=>{if(f++>=a)throw new Error("drbg: tried max amount of iterations");let b=0,_=[];for(;b<e;){c=d();let v=c.slice();_.push(v),b+=c.length}return dn(..._)};return(b,_)=>{h(),p(b);let v;for(;!(v=_(y()));)p();return h(),v}}function Fa(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,i,a){let c=r[o];if(a&&c===void 0)return;let u=typeof c;if(u!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${u}`)}let s=(o,i)=>Object.entries(o).forEach(([a,c])=>n(a,c,i));s(e,!1),s(t,!0)}function lh(r){let e=new WeakMap;return(t,...n)=>{let s=e.get(t);if(s!==void 0)return s;let o=r(t,...n);return e.set(t,o),o}}var Gr=BigInt(0),Jt=BigInt(1),kl=BigInt(2),wM=BigInt(3),xM=BigInt(4),EM=BigInt(5),Vee=BigInt(7),vM=BigInt(8),Hee=BigInt(9),SM=BigInt(16);function Ct(r,e){let t=r%e;return t>=Gr?t:e+t}function ft(r,e,t){let n=r;for(;e-- >Gr;)n*=n,n%=t;return n}function yM(r,e){if(r===Gr)throw new Error("invert: expected non-zero number");if(e<=Gr)throw new Error("invert: expected positive modulus, got "+e);let t=Ct(r,e),n=e,s=Gr,o=Jt,i=Jt,a=Gr;for(;t!==Gr;){let u=n/t,f=n%t,h=s-i*u,d=o-a*u;n=t,t=f,s=i,o=a,i=h,a=d}if(n!==Jt)throw new Error("invert: does not exist");return Ct(s,e)}function vv(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function _M(r,e){let t=(r.ORDER+Jt)/xM,n=r.pow(e,t);return vv(r,n,e),n}function qee(r,e){let t=(r.ORDER-EM)/vM,n=r.mul(e,kl),s=r.pow(n,t),o=r.mul(e,s),i=r.mul(r.mul(o,kl),s),a=r.mul(o,r.sub(i,r.ONE));return vv(r,a,e),a}function zee(r){let e=uh(r),t=AM(r),n=t(e,e.neg(e.ONE)),s=t(e,n),o=t(e,e.neg(n)),i=(r+Vee)/SM;return(a,c)=>{let u=a.pow(c,i),f=a.mul(u,n),h=a.mul(u,s),d=a.mul(u,o),p=a.eql(a.sqr(f),c),y=a.eql(a.sqr(h),c);u=a.cmov(u,f,p),f=a.cmov(d,h,y);let x=a.eql(a.sqr(f),c),b=a.cmov(u,f,x);return vv(a,b,c),b}}function AM(r){if(r<wM)throw new Error("sqrt is not defined for small field");let e=r-Jt,t=0;for(;e%kl===Gr;)e/=kl,t++;let n=kl,s=uh(r);for(;bM(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return _M;let o=s.pow(n,e),i=(e+Jt)/kl;return function(c,u){if(c.is0(u))return u;if(bM(c,u)!==1)throw new Error("Cannot find square root");let f=t,h=c.mul(c.ONE,o),d=c.pow(u,e),p=c.pow(u,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let y=1,x=c.sqr(d);for(;!c.eql(x,c.ONE);)if(y++,x=c.sqr(x),y===f)throw new Error("Cannot find square root");let b=Jt<<BigInt(f-y-1),_=c.pow(h,b);f=y,h=c.sqr(_),d=c.mul(d,h),p=c.mul(p,_)}return p}}function $ee(r){return r%xM===wM?_M:r%vM===EM?qee:r%SM===Hee?zee(r):AM(r)}var IM=(r,e)=>(Ct(r,e)&Jt)===Jt,Gee=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Sv(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=Gee.reduce((n,s)=>(n[s]="function",n),e);return Fa(r,t),r}function Wee(r,e,t){if(t<Gr)throw new Error("invalid exponent, negatives unsupported");if(t===Gr)return r.ONE;if(t===Jt)return e;let n=r.ONE,s=e;for(;t>Gr;)t&Jt&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Jt;return n}function cp(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),o=r.inv(s);return e.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),o),n}function bM(r,e){let t=(r.ORDER-Jt)/kl,n=r.pow(e,t),s=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function Yee(r,e){e!==void 0&&no(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var Ev=class{constructor(e,t={}){l(this,"ORDER");l(this,"BITS");l(this,"BYTES");l(this,"isLE");l(this,"ZERO",Gr);l(this,"ONE",Jt);l(this,"_lengths");l(this,"_sqrt");l(this,"_mod");if(e<=Gr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:s,nByteLength:o}=Yee(e,n);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Ct(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return Gr<=e&&e<this.ORDER}is0(e){return e===Gr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Jt)===Jt}neg(e){return Ct(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Ct(e*e,this.ORDER)}add(e,t){return Ct(e+t,this.ORDER)}sub(e,t){return Ct(e-t,this.ORDER)}mul(e,t){return Ct(e*t,this.ORDER)}pow(e,t){return Wee(this,e,t)}div(e,t){return Ct(e*yM(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return yM(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=$ee(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?wv(e,this.BYTES):P6(e,this.BYTES)}fromBytes(e,t=!1){Ie(e);let{_lengths:n,BYTES:s,isLE:o,ORDER:i,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let u=new Uint8Array(s);u.set(e,o?0:u.length-e.length),e=u}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=o?Ll(e):ch(e);if(a&&(c=Ct(c,i)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return cp(this,e)}cmov(e,t,n){return n?t:e}};function uh(r,e={}){return new Ev(r,e)}function TM(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function _v(r){let e=TM(r);return e+Math.ceil(e/2)}function Av(r,e,t=!1){Ie(r);let n=r.length,s=TM(e),o=_v(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let i=t?Ll(r):ch(r),a=Ct(i,e-Jt)+Jt;return t?wv(a,s):P6(a,s)}var fh=BigInt(0),Nl=BigInt(1);function lp(r,e){let t=e.negate();return r?t:e}function Ol(r,e){let t=cp(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function BM(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function Iv(r,e){BM(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,o=ap(r),i=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function RM(r,e,t){let{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=t,a=Number(r&s),c=r>>i;a>n&&(a-=o,c+=Nl);let u=e*n,f=u+Math.abs(a)-1,h=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:f,isZero:h,isNeg:d,isNegF:p,offsetF:u}}var Tv=new WeakMap,PM=new WeakMap;function Rv(r){return PM.get(r)||1}function CM(r){if(r!==fh)throw new Error("invalid wNAF")}var hh=class{constructor(e,t){l(this,"BASE");l(this,"ZERO");l(this,"Fn");l(this,"bits");this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>fh;)t&Nl&&(n=n.add(s)),s=s.double(),t>>=Nl;return n}precomputeWindow(e,t){let{windows:n,windowSize:s}=Iv(t,this.bits),o=[],i=e,a=i;for(let c=0;c<n;c++){a=i,o.push(a);for(let u=1;u<s;u++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=Iv(e,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:p}=RM(n,a,i);n=c,f?o=o.add(lp(d,t[p])):s=s.add(lp(h,t[u]))}return CM(n),{p:s,f:o}}wNAFUnsafe(e,t,n,s=this.ZERO){let o=Iv(e,this.bits);for(let i=0;i<o.windows&&n!==fh;i++){let{nextN:a,offset:c,isZero:u,isNeg:f}=RM(n,i,o);if(n=a,!u){let h=t[c];s=s.add(f?h.negate():h)}}return CM(n),s}getPrecomputes(e,t,n){let s=Tv.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),Tv.set(t,s))),s}cached(e,t,n){let s=Rv(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){let o=Rv(e);return o===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),t,s)}createCache(e,t){BM(t,this.bits),PM.set(e,t),Tv.delete(e)}hasCache(e){return Rv(e)!==1}};function LM(r,e,t,n){let s=e,o=r.ZERO,i=r.ZERO;for(;t>fh||n>fh;)t&Nl&&(o=o.add(s)),n&Nl&&(i=i.add(s)),s=s.double(),t>>=Nl,n>>=Nl;return{p1:o,p2:i}}function DM(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Sv(e),e}else return uh(r,{isLE:t})}function k6(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let u=e[c];if(!(typeof u=="bigint"&&u>fh))throw new Error(`CURVE.${c} must be positive bigint`)}let s=DM(e.p,t.Fp,n),o=DM(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}function N6(r,e){return function(n){let s=r(n);return{secretKey:s,publicKey:e(s)}}}var Va=BigInt(0),er=BigInt(1),Cv=BigInt(2),Zee=BigInt(8);function Xee(r,e,t,n){let s=r.sqr(t),o=r.sqr(n),i=r.add(r.mul(e.a,s),o),a=r.add(r.ONE,r.mul(e.d,r.mul(s,o)));return r.eql(i,a)}function kM(r,e={}){let t=k6("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i}=o;Fa(e,{},{uvRatio:"function"});let a=Cv<<BigInt(s.BYTES*8)-er,c=_=>n.create(_),u=e.uvRatio||((_,v)=>{try{return{isValid:!0,value:n.sqrt(n.div(_,v))}}catch{return{isValid:!1,value:Va}}});if(!Xee(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function f(_,v,w=!1){let R=w?er:Va;return ip("coordinate "+_,v,R,a),v}function h(_){if(!(_ instanceof y))throw new Error("EdwardsPoint expected")}let d=lh((_,v)=>{let{X:w,Y:R,Z:N}=_,O=_.is0();v==null&&(v=O?Zee:n.inv(N));let F=c(w*v),A=c(R*v),E=n.mul(N,v);if(O)return{x:Va,y:er};if(E!==er)throw new Error("invZ was invalid");return{x:F,y:A}}),p=lh(_=>{let{a:v,d:w}=o;if(_.is0())throw new Error("bad point: ZERO");let{X:R,Y:N,Z:O,T:F}=_,A=c(R*R),E=c(N*N),L=c(O*O),U=c(L*L),B=c(A*v),I=c(L*c(B+E)),g=c(U+c(w*c(A*E)));if(I!==g)throw new Error("bad point: equation left != right (1)");let m=c(R*N),S=c(O*F);if(m!==S)throw new Error("bad point: equation left != right (2)");return!0}),b=class b{constructor(v,w,R,N){l(this,"X");l(this,"Y");l(this,"Z");l(this,"T");this.X=f("x",v),this.Y=f("y",w),this.Z=f("z",R,!0),this.T=f("t",N),Object.freeze(this)}static CURVE(){return o}static fromAffine(v){if(v instanceof b)throw new Error("extended point not allowed");let{x:w,y:R}=v||{};return f("x",w),f("y",R),new b(w,R,er,c(w*R))}static fromBytes(v,w=!1){let R=n.BYTES,{a:N,d:O}=o;v=L6(Ie(v,R,"point")),Ai(w,"zip215");let F=L6(v),A=v[R-1];F[R-1]=A&-129;let E=Ll(F),L=w?a:n.ORDER;ip("point.y",E,Va,L);let U=c(E*E),B=c(U-er),I=c(O*U-N),{isValid:g,value:m}=u(B,I);if(!g)throw new Error("bad point: invalid y coordinate");let S=(m&er)===er,T=(A&128)!==0;if(!w&&m===Va&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(m=c(-m)),b.fromAffine({x:m,y:E})}static fromHex(v,w=!1){return b.fromBytes(Si(v),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(v=8,w=!0){return x.createCache(this,v),w||this.multiply(Cv),this}assertValidity(){p(this)}equals(v){h(v);let{X:w,Y:R,Z:N}=this,{X:O,Y:F,Z:A}=v,E=c(w*A),L=c(O*N),U=c(R*A),B=c(F*N);return E===L&&U===B}is0(){return this.equals(b.ZERO)}negate(){return new b(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:v}=o,{X:w,Y:R,Z:N}=this,O=c(w*w),F=c(R*R),A=c(Cv*c(N*N)),E=c(v*O),L=w+R,U=c(c(L*L)-O-F),B=E+F,I=B-A,g=E-F,m=c(U*I),S=c(B*g),T=c(U*g),P=c(I*B);return new b(m,S,P,T)}add(v){h(v);let{a:w,d:R}=o,{X:N,Y:O,Z:F,T:A}=this,{X:E,Y:L,Z:U,T:B}=v,I=c(N*E),g=c(O*L),m=c(A*R*B),S=c(F*U),T=c((N+O)*(E+L)-I-g),P=S-m,C=S+m,k=c(g-w*I),D=c(T*P),M=c(C*k),q=c(T*k),W=c(P*C);return new b(D,M,W,q)}subtract(v){return this.add(v.negate())}multiply(v){if(!s.isValidNot0(v))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:w,f:R}=x.cached(this,v,N=>Ol(b,N));return Ol(b,[w,R])[0]}multiplyUnsafe(v,w=b.ZERO){if(!s.isValid(v))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return v===Va?b.ZERO:this.is0()||v===er?this:x.unsafe(this,v,R=>Ol(b,R),w)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return x.unsafe(this,o.n).is0()}toAffine(v){return d(this,v)}clearCofactor(){return i===er?this:this.multiplyUnsafe(i)}toBytes(){let{x:v,y:w}=this.toAffine(),R=n.toBytes(w);return R[R.length-1]|=v&er?128:0,R}toHex(){return vi(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(b,"BASE",new b(o.Gx,o.Gy,er,c(o.Gx*o.Gy))),l(b,"ZERO",new b(Va,er,er,Va)),l(b,"Fp",n),l(b,"Fn",s);let y=b,x=new hh(y,s.BITS);return y.BASE.precompute(8),y}function NM(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Fa(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:s,Fp:o,Fn:i}=r,a=t.randomBytes||Oa,c=t.adjustScalarBytes||(A=>A),u=t.domain||((A,E,L)=>{if(Ai(L,"phflag"),E.length||L)throw new Error("Contexts/pre-hash are not supported");return A});function f(A){return i.create(Ll(A))}function h(A){let E=w.secretKey;Ie(A,w.secretKey,"secretKey");let L=Ie(e(A),2*E,"hashedSecretKey"),U=c(L.slice(0,E)),B=L.slice(E,2*E),I=f(U);return{head:U,prefix:B,scalar:I}}function d(A){let{head:E,prefix:L,scalar:U}=h(A),B=s.multiply(U),I=B.toBytes();return{head:E,prefix:L,scalar:U,point:B,pointBytes:I}}function p(A){return d(A).pointBytes}function y(A=Uint8Array.of(),...E){let L=dn(...E);return f(e(u(L,Ie(A,void 0,"context"),!!n)))}function x(A,E,L={}){A=Ie(A,void 0,"message"),n&&(A=n(A));let{prefix:U,scalar:B,pointBytes:I}=d(E),g=y(L.context,U,A),m=s.multiply(g).toBytes(),S=y(L.context,m,I,A),T=i.create(g+S*B);if(!i.isValid(T))throw new Error("sign failed: invalid s");let P=dn(m,i.toBytes(T));return Ie(P,w.signature,"result")}let b={zip215:!0};function _(A,E,L,U=b){let{context:B,zip215:I}=U,g=w.signature;A=Ie(A,g,"signature"),E=Ie(E,void 0,"message"),L=Ie(L,w.publicKey,"publicKey"),I!==void 0&&Ai(I,"zip215"),n&&(E=n(E));let m=g/2,S=A.subarray(0,m),T=Ll(A.subarray(m,g)),P,C,k;try{P=r.fromBytes(L,I),C=r.fromBytes(S,I),k=s.multiplyUnsafe(T)}catch{return!1}if(!I&&P.isSmallOrder())return!1;let D=y(B,C.toBytes(),P.toBytes(),E);return C.add(P.multiplyUnsafe(D)).subtract(k).clearCofactor().is0()}let v=o.BYTES,w={secretKey:v,publicKey:v,signature:2*v,seed:v};function R(A=a(w.seed)){return Ie(A,w.seed,"seed")}function N(A){return Dl(A)&&A.length===i.BYTES}function O(A,E){try{return!!r.fromBytes(A,E)}catch{return!1}}let F={getExtendedPublicKey:d,randomSecretKey:R,isValidSecretKey:N,isValidPublicKey:O,toMontgomery(A){let{y:E}=r.fromBytes(A),L=w.publicKey,U=L===32;if(!U&&L!==57)throw new Error("only defined for 25519 and 448");let B=U?o.div(er+E,er-E):o.div(E-er,E+er);return o.toBytes(B)},toMontgomerySecret(A){let E=w.secretKey;Ie(A,E);let L=e(A.subarray(0,E));return c(L).subarray(0,E)}};return Object.freeze({keygen:N6(R,p),getPublicKey:p,sign:x,verify:_,utils:F,Point:r,lengths:w})}var jee=BigInt(1),OM=BigInt(2);var Qee=BigInt(5),Jee=BigInt(8),Dv=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),ete={p:Dv,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Jee,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function tte(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),o=Dv,a=r*r%o*r%o,c=ft(a,OM,o)*a%o,u=ft(c,jee,o)*r%o,f=ft(u,Qee,o)*u%o,h=ft(f,e,o)*f%o,d=ft(h,t,o)*h%o,p=ft(d,n,o)*d%o,y=ft(p,s,o)*p%o,x=ft(y,s,o)*p%o,b=ft(x,e,o)*f%o;return{pow_p_5_8:ft(b,OM,o)*r%o,b2:a}}function rte(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var MM=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function nte(r,e){let t=Dv,n=Ct(e*e*e,t),s=Ct(n*n*e,t),o=tte(r*s).pow_p_5_8,i=Ct(r*n*o,t),a=Ct(e*i*i,t),c=i,u=Ct(i*MM,t),f=a===r,h=a===Ct(-r,t),d=a===Ct(-r*MM,t);return f&&(i=c),(h||d)&&(i=u),IM(i,t)&&(i=Ct(-i,t)),{isValid:f||h,value:i}}var ste=kM(ete,{uvRatio:nte});function ote(r){return NM(ste,dM,Object.assign({adjustScalarBytes:rte},r))}var UM=ote({});var up=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},O6=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var KM={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new O6("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var M6=KM;var U6=32;var Bv,ite=(async()=>{try{return await M6.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function ate(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await M6.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await M6.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function cte(r,e,t){return UM.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function FM(r,e,t){return Bv==null&&(Bv=await ite),Bv?ate(r,e,t):cte(r,e,t)}function K6(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var F6=class{constructor(e){l(this,"type","Ed25519");l(this,"raw");this.raw=Pv(e,U6)}toMultihash(){return ge.digest(Na(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let s=FM(this.raw,t,e);return K6(s)?s.then(o=>(n?.signal?.throwIfAborted(),o)):s}};function HM(r){return r=Pv(r,U6),new F6(r)}function Pv(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Ss(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var Lv=new Float32Array([-0]),Ha=new Uint8Array(Lv.buffer);function qM(r,e,t){Lv[0]=r,e[t]=Ha[0],e[t+1]=Ha[1],e[t+2]=Ha[2],e[t+3]=Ha[3]}function zM(r,e){return Ha[0]=r[e],Ha[1]=r[e+1],Ha[2]=r[e+2],Ha[3]=r[e+3],Lv[0]}var kv=new Float64Array([-0]),Tr=new Uint8Array(kv.buffer);function $M(r,e,t){kv[0]=r,e[t]=Tr[0],e[t+1]=Tr[1],e[t+2]=Tr[2],e[t+3]=Tr[3],e[t+4]=Tr[4],e[t+5]=Tr[5],e[t+6]=Tr[6],e[t+7]=Tr[7]}function GM(r,e){return Tr[0]=r[e],Tr[1]=r[e+1],Tr[2]=r[e+2],Tr[3]=r[e+3],Tr[4]=r[e+4],Tr[5]=r[e+5],Tr[6]=r[e+6],Tr[7]=r[e+7],kv[0]}var ute=BigInt(Number.MAX_SAFE_INTEGER),fte=BigInt(Number.MIN_SAFE_INTEGER),Rn=class r{constructor(e,t){l(this,"lo");l(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Ml;if(e<ute&&e>fte)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>WM&&(s=0n,++n>WM&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return Ml;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Ml}},Ml=new Rn(0,0);Ml.toBigInt=function(){return 0n};Ml.zzEncode=Ml.zzDecode=function(){return this};Ml.length=function(){return 1};var WM=4294967296n;function YM(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function ZM(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function Nv(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function As(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function V6(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var Ov=class{constructor(e){l(this,"buf");l(this,"pos");l(this,"len");l(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,As(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw As(this,4);return V6(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw As(this,4);return V6(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw As(this,4);let e=zM(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw As(this,4);let e=GM(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw As(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return ZM(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw As(this,e);this.pos+=e}else do if(this.pos>=this.len)throw As(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Rn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw As(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw As(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw As(this,8);let e=V6(this.buf,this.pos+=4),t=V6(this.buf,this.pos+=4);return new Rn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=gn(this.buf,this.pos);return this.pos+=ce(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function Mv(r){return new Ov(r instanceof Uint8Array?r:r.subarray())}function $n(r,e,t){let n=Mv(r);return e.decode(n,void 0,t)}function Uv(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return pe(i);s+i>e&&(n=pe(e),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var Ul=class{constructor(e,t,n){l(this,"fn");l(this,"len");l(this,"next");l(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}};function Kv(){}var Vv=class{constructor(e){l(this,"head");l(this,"tail");l(this,"len");l(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},hte=Uv();function dte(r){return globalThis.Buffer!=null?pe(r):hte(r)}var hp=class{constructor(){l(this,"len");l(this,"head");l(this,"tail");l(this,"states");this.len=0,this.head=new Ul(Kv,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Ul(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Hv((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(H6,10,Rn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Rn.fromBigInt(e);return this._push(H6,t.length(),t)}uint64Number(e){return this._push(Et,ce(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Rn.fromBigInt(e).zzEncode();return this._push(H6,t.length(),t)}sint64Number(e){let t=Rn.fromNumber(e).zzEncode();return this._push(H6,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Fv,1,e?1:0)}fixed32(e){return this._push(fp,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Rn.fromBigInt(e);return this._push(fp,4,t.lo)._push(fp,4,t.hi)}fixed64Number(e){let t=Rn.fromNumber(e);return this._push(fp,4,t.lo)._push(fp,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(qM,4,e)}double(e){return this._push($M,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(Fv,1,0):this.uint32(t)._push(mte,t,e)}string(e){let t=YM(e);return t!==0?this.uint32(t)._push(Nv,t,e):this._push(Fv,1,0)}fork(){return this.states=new Vv(this),this.head=this.tail=new Ul(Kv,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Ul(Kv,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=dte(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function Fv(r,e,t){e[t]=r&255}function pte(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var Hv=class extends Ul{constructor(t,n){super(pte,t,n);l(this,"next");this.next=void 0}};function H6(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function fp(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function mte(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(hp.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(gte,e,r),this},hp.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(yte,e,r),this});function gte(r,e,t){e.set(r,t)}function yte(r,e,t){r.length<40?Nv(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(H(r),t)}function qv(){return new hp}function Gn(r,e){let t=qv();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var dh;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(dh||(dh={}));function q6(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Kl(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(o,i){let a=e(o);i.int32(a)},n=function(o){let i=o.int32();return e(i)};return q6("enum",dh.VARINT,t,n)}function Wn(r,e){return q6("message",dh.LENGTH_DELIMITED,r,e)}var dp=class extends Error{constructor(){super(...arguments);l(this,"code","ERR_MAX_LENGTH");l(this,"name","MaxLengthError")}};var Cn;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Cn||(Cn={}));var zv;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(zv||(zv={}));(function(r){r.codec=()=>Kl(zv)})(Cn||(Cn={}));var pp;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Cn.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=Cn.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})(pp||(pp={}));var $v;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Cn.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=Cn.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})($v||($v={}));function z6(r){if(isNaN(r)||r<=0)throw new Ss("random bytes length must be a Number bigger than 0");return Oa(r)}var $6=class{constructor(e,t){l(this,"oHash");l(this,"iHash");l(this,"blockLen");l(this,"outputLen");l(this,"finished",!1);l(this,"destroyed",!1);if(R6(e),Ie(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),Ei(s)}update(e){return ah(this),this.iHash.update(e),this}digestInto(e){ah(this),Ie(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Gv=(r,e,t)=>new $6(r,e).update(t).digest();Gv.create=(r,e)=>new $6(r,e);var jM=(r,e)=>(r+(r>=0?e:-e)/QM)/e;function wte(r,e,t){let[[n,s],[o,i]]=e,a=jM(i*r,t),c=jM(-s*r,t),u=r-a*n-c*o,f=-a*s-c*i,h=u<Ii,d=f<Ii;h&&(u=-u),d&&(f=-f);let p=ap(Math.ceil(xv(t)/2))+ph;if(u<Ii||u>=p||f<Ii||f>=p)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:u,k2neg:d,k2:f}}function Yv(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function Wv(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Ai(t.lowS,"lowS"),Ai(t.prehash,"prehash"),t.format!==void 0&&Yv(t.format),t}var Zv=class extends Error{constructor(e=""){super(e)}},qa={Err:Zv,_tlv:{encode:(r,e)=>{let{Err:t}=qa;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,s=op(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?op(s.length/2|128):"";return op(r)+o+s+e},decode(r,e){let{Err:t}=qa,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let s=e[n++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let f of u)i=i<<8|f;if(n+=c,i<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+i);if(a.length!==i)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(r){let{Err:e}=qa;if(r<Ii)throw new e("integer: negative integers are not allowed");let t=op(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=qa;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return ch(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=qa,s=Ie(r,void 0,"signature"),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:u,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){let{_tlv:e,_int:t}=qa,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),o=n+s;return e.encode(48,o)}},Ii=BigInt(0),ph=BigInt(1),QM=BigInt(2),G6=BigInt(3),xte=BigInt(4);function JM(r,e={}){let t=k6("weierstrass",r,e),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i,n:a}=o;Fa(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let u=tU(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(I,g,m){let{x:S,y:T}=g.toAffine(),P=n.toBytes(S);if(Ai(m,"isCompressed"),m){f();let C=!n.isOdd(T);return dn(eU(C),P)}else return dn(Uint8Array.of(4),P,n.toBytes(T))}function d(I){Ie(I,void 0,"Point");let{publicKey:g,publicKeyUncompressed:m}=u,S=I.length,T=I[0],P=I.subarray(1);if(S===g&&(T===2||T===3)){let C=n.fromBytes(P);if(!n.isValid(C))throw new Error("bad point: is not on curve, wrong x");let k=x(C),D;try{D=n.sqrt(k)}catch(W){let G=W instanceof Error?": "+W.message:"";throw new Error("bad point: is not on curve, sqrt error"+G)}f();let M=n.isOdd(D);return(T&1)===1!==M&&(D=n.neg(D)),{x:C,y:D}}else if(S===m&&T===4){let C=n.BYTES,k=n.fromBytes(P.subarray(0,C)),D=n.fromBytes(P.subarray(C,C*2));if(!b(k,D))throw new Error("bad point: is not on curve");return{x:k,y:D}}else throw new Error(`bad point: got length ${S}, expected compressed=${g} or uncompressed=${m}`)}let p=e.toBytes||h,y=e.fromBytes||d;function x(I){let g=n.sqr(I),m=n.mul(g,I);return n.add(n.add(m,n.mul(I,o.a)),o.b)}function b(I,g){let m=n.sqr(g),S=x(I);return n.eql(m,S)}if(!b(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let _=n.mul(n.pow(o.a,G6),xte),v=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(_,v)))throw new Error("bad curve params: a or b");function w(I,g,m=!1){if(!n.isValid(g)||m&&n.is0(g))throw new Error(`bad point coordinate ${I}`);return g}function R(I){if(!(I instanceof E))throw new Error("Weierstrass Point expected")}function N(I){if(!c||!c.basises)throw new Error("no endo");return wte(I,c.basises,s.ORDER)}let O=lh((I,g)=>{let{X:m,Y:S,Z:T}=I;if(n.eql(T,n.ONE))return{x:m,y:S};let P=I.is0();g==null&&(g=P?n.ONE:n.inv(T));let C=n.mul(m,g),k=n.mul(S,g),D=n.mul(T,g);if(P)return{x:n.ZERO,y:n.ZERO};if(!n.eql(D,n.ONE))throw new Error("invZ was invalid");return{x:C,y:k}}),F=lh(I=>{if(I.is0()){if(e.allowInfinityPoint&&!n.is0(I.Y))return;throw new Error("bad point: ZERO")}let{x:g,y:m}=I.toAffine();if(!n.isValid(g)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!b(g,m))throw new Error("bad point: equation left != right");if(!I.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function A(I,g,m,S,T){return m=new E(n.mul(m.X,I),m.Y,m.Z),g=lp(S,g),m=lp(T,m),g.add(m)}let B=class B{constructor(g,m,S){l(this,"X");l(this,"Y");l(this,"Z");this.X=w("x",g),this.Y=w("y",m,!0),this.Z=w("z",S),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){let{x:m,y:S}=g||{};if(!g||!n.isValid(m)||!n.isValid(S))throw new Error("invalid affine point");if(g instanceof B)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(S)?B.ZERO:new B(m,S,n.ONE)}static fromBytes(g){let m=B.fromAffine(y(Ie(g,void 0,"point")));return m.assertValidity(),m}static fromHex(g){return B.fromBytes(Si(g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,m=!0){return U.createCache(this,g),m||this.multiply(G6),this}assertValidity(){F(this)}hasEvenY(){let{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.eql(n.mul(m,k),n.mul(P,T)),M=n.eql(n.mul(S,k),n.mul(C,T));return D&&M}negate(){return new B(this.X,n.neg(this.Y),this.Z)}double(){let{a:g,b:m}=o,S=n.mul(m,G6),{X:T,Y:P,Z:C}=this,k=n.ZERO,D=n.ZERO,M=n.ZERO,q=n.mul(T,T),W=n.mul(P,P),G=n.mul(C,C),$=n.mul(T,P);return $=n.add($,$),M=n.mul(T,C),M=n.add(M,M),k=n.mul(g,M),D=n.mul(S,G),D=n.add(k,D),k=n.sub(W,D),D=n.add(W,D),D=n.mul(k,D),k=n.mul($,k),M=n.mul(S,M),G=n.mul(g,G),$=n.sub(q,G),$=n.mul(g,$),$=n.add($,M),M=n.add(q,q),q=n.add(M,q),q=n.add(q,G),q=n.mul(q,$),D=n.add(D,q),G=n.mul(P,C),G=n.add(G,G),q=n.mul(G,$),k=n.sub(k,q),M=n.mul(G,W),M=n.add(M,M),M=n.add(M,M),new B(k,D,M)}add(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.ZERO,M=n.ZERO,q=n.ZERO,W=o.a,G=n.mul(o.b,G6),$=n.mul(m,P),X=n.mul(S,C),Q=n.mul(T,k),J=n.add(m,S),Y=n.add(P,C);J=n.mul(J,Y),Y=n.add($,X),J=n.sub(J,Y),Y=n.add(m,T);let re=n.add(P,k);return Y=n.mul(Y,re),re=n.add($,Q),Y=n.sub(Y,re),re=n.add(S,T),D=n.add(C,k),re=n.mul(re,D),D=n.add(X,Q),re=n.sub(re,D),q=n.mul(W,Y),D=n.mul(G,Q),q=n.add(D,q),D=n.sub(X,q),q=n.add(X,q),M=n.mul(D,q),X=n.add($,$),X=n.add(X,$),Q=n.mul(W,Q),Y=n.mul(G,Y),X=n.add(X,Q),Q=n.sub($,Q),Q=n.mul(W,Q),Y=n.add(Y,Q),$=n.mul(X,Y),M=n.add(M,$),$=n.mul(re,Y),D=n.mul(J,D),D=n.sub(D,$),$=n.mul(J,X),q=n.mul(re,q),q=n.add(q,$),new B(D,M,q)}subtract(g){return this.add(g.negate())}is0(){return this.equals(B.ZERO)}multiply(g){let{endo:m}=e;if(!s.isValidNot0(g))throw new Error("invalid scalar: out of range");let S,T,P=C=>U.cached(this,C,k=>Ol(B,k));if(m){let{k1neg:C,k1:k,k2neg:D,k2:M}=N(g),{p:q,f:W}=P(k),{p:G,f:$}=P(M);T=W.add($),S=A(m.beta,q,G,C,D)}else{let{p:C,f:k}=P(g);S=C,T=k}return Ol(B,[S,T])[0]}multiplyUnsafe(g){let{endo:m}=e,S=this;if(!s.isValid(g))throw new Error("invalid scalar: out of range");if(g===Ii||S.is0())return B.ZERO;if(g===ph)return S;if(U.hasCache(this))return this.multiply(g);if(m){let{k1neg:T,k1:P,k2neg:C,k2:k}=N(g),{p1:D,p2:M}=LM(B,S,P,k);return A(m.beta,D,M,T,C)}else return U.unsafe(S,g)}toAffine(g){return O(this,g)}isTorsionFree(){let{isTorsionFree:g}=e;return i===ph?!0:g?g(B,this):U.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:g}=e;return i===ph?this:g?g(B,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return Ai(g,"isCompressed"),this.assertValidity(),p(B,this,g)}toHex(g=!0){return vi(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(B,"BASE",new B(o.Gx,o.Gy,n.ONE)),l(B,"ZERO",new B(n.ZERO,n.ONE,n.ZERO)),l(B,"Fp",n),l(B,"Fn",s);let E=B,L=s.BITS,U=new hh(E,e.endo?Math.ceil(L/2):L);return E.BASE.precompute(8),E}function eU(r){return Uint8Array.of(r?2:3)}function tU(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Ete(r,e={}){let{Fn:t}=r,n=e.randomBytes||Oa,s=Object.assign(tU(r.Fp,t),{seed:_v(t.ORDER)});function o(p){try{let y=t.fromBytes(p);return t.isValidNot0(y)}catch{return!1}}function i(p,y){let{publicKey:x,publicKeyUncompressed:b}=s;try{let _=p.length;return y===!0&&_!==x||y===!1&&_!==b?!1:!!r.fromBytes(p)}catch{return!1}}function a(p=n(s.seed)){return Av(Ie(p,s.seed,"seed"),t.ORDER)}function c(p,y=!0){return r.BASE.multiply(t.fromBytes(p)).toBytes(y)}function u(p){let{secretKey:y,publicKey:x,publicKeyUncompressed:b}=s;if(!Dl(p)||"_lengths"in t&&t._lengths||y===x)return;let _=Ie(p,void 0,"key").length;return _===x||_===b}function f(p,y,x=!0){if(u(p)===!0)throw new Error("first arg must be private key");if(u(y)===!1)throw new Error("second arg must be public key");let b=t.fromBytes(p);return r.fromBytes(y).multiply(b).toBytes(x)}let h={isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a},d=N6(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:d,Point:r,utils:h,lengths:s})}function rU(r,e,t={}){R6(e),Fa(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||Oa,s=t.hmac||((g,m)=>Gv(e,g,m)),{Fp:o,Fn:i}=r,{ORDER:a,BITS:c}=i,{keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p}=Ete(r,t),y={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},x=a*QM<o.ORDER;function b(g){let m=a>>ph;return g>m}function _(g,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${g}: out of range 1..Point.Fn.ORDER`);return m}function v(){if(x)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(g,m){Yv(m);let S=p.signature,T=m==="compact"?S:m==="recovered"?S+1:void 0;return Ie(g,T)}class R{constructor(m,S,T){l(this,"r");l(this,"s");l(this,"recovery");if(this.r=_("r",m),this.s=_("s",S),T!=null){if(v(),![0,1,2,3].includes(T))throw new Error("invalid recovery id");this.recovery=T}Object.freeze(this)}static fromBytes(m,S=y.format){w(m,S);let T;if(S==="der"){let{r:D,s:M}=qa.toSig(Ie(m));return new R(D,M)}S==="recovered"&&(T=m[0],S="compact",m=m.subarray(1));let P=p.signature/2,C=m.subarray(0,P),k=m.subarray(P,P*2);return new R(i.fromBytes(C),i.fromBytes(k),T)}static fromHex(m,S){return this.fromBytes(Si(m),S)}assertRecovery(){let{recovery:m}=this;if(m==null)throw new Error("invalid recovery id: must be present");return m}addRecoveryBit(m){return new R(this.r,this.s,m)}recoverPublicKey(m){let{r:S,s:T}=this,P=this.assertRecovery(),C=P===2||P===3?S+a:S;if(!o.isValid(C))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let k=o.toBytes(C),D=r.fromBytes(dn(eU((P&1)===0),k)),M=i.inv(C),q=O(Ie(m,void 0,"msgHash")),W=i.create(-q*M),G=i.create(T*M),$=r.BASE.multiplyUnsafe(W).add(D.multiplyUnsafe(G));if($.is0())throw new Error("invalid recovery: point at infinify");return $.assertValidity(),$}hasHighS(){return b(this.s)}toBytes(m=y.format){if(Yv(m),m==="der")return Si(qa.hexFromSig(this));let{r:S,s:T}=this,P=i.toBytes(S),C=i.toBytes(T);return m==="recovered"?(v(),dn(Uint8Array.of(this.assertRecovery()),P,C)):dn(P,C)}toHex(m){return vi(this.toBytes(m))}}let N=t.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");let S=ch(m),T=m.length*8-c;return T>0?S>>BigInt(T):S},O=t.bits2int_modN||function(m){return i.create(N(m))},F=ap(c);function A(g){return ip("num < 2^"+c,g,Ii,F),i.toBytes(g)}function E(g,m){return Ie(g,void 0,"message"),m?Ie(e(g),void 0,"prehashed message"):g}function L(g,m,S){let{lowS:T,prehash:P,extraEntropy:C}=Wv(S,y);g=E(g,P);let k=O(g),D=i.fromBytes(m);if(!i.isValidNot0(D))throw new Error("invalid private key");let M=[A(D),A(k)];if(C!=null&&C!==!1){let $=C===!0?n(p.secretKey):C;M.push(Ie($,void 0,"extraEntropy"))}let q=dn(...M),W=k;function G($){let X=N($);if(!i.isValidNot0(X))return;let Q=i.inv(X),J=r.BASE.multiply(X).toAffine(),Y=i.create(J.x);if(Y===Ii)return;let re=i.create(Q*i.create(W+Y*D));if(re===Ii)return;let sr=(J.x===Y?0:2)|Number(J.y&ph),or=re;return T&&b(re)&&(or=i.neg(re),sr^=1),new R(Y,or,x?void 0:sr)}return{seed:q,k2sig:G}}function U(g,m,S={}){let{seed:T,k2sig:P}=L(g,m,S);return gM(e.outputLen,i.BYTES,s)(T,P).toBytes(S.format)}function B(g,m,S,T={}){let{lowS:P,prehash:C,format:k}=Wv(T,y);if(S=Ie(S,void 0,"publicKey"),m=E(m,C),!Dl(g)){let D=g instanceof R?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+D)}w(g,k);try{let D=R.fromBytes(g,k),M=r.fromBytes(S);if(P&&D.hasHighS())return!1;let{r:q,s:W}=D,G=O(m),$=i.inv(W),X=i.create(G*$),Q=i.create(q*$),J=r.BASE.multiplyUnsafe(X).add(M.multiplyUnsafe(Q));return J.is0()?!1:i.create(J.x)===q}catch{return!1}}function I(g,m,S={}){let{prehash:T}=Wv(S,y);return m=E(m,T),R.fromBytes(g,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p,Point:r,sign:U,verify:B,recoverPublicKey:I,Signature:R,hash:e})}var jv={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},vte={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var nU=BigInt(2);function Ste(r){let e=jv.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,f=u*u*r%e,h=ft(f,t,e)*f%e,d=ft(h,t,e)*f%e,p=ft(d,nU,e)*u%e,y=ft(p,s,e)*p%e,x=ft(y,o,e)*y%e,b=ft(x,a,e)*x%e,_=ft(b,c,e)*b%e,v=ft(_,a,e)*x%e,w=ft(v,t,e)*f%e,R=ft(w,i,e)*y%e,N=ft(R,n,e)*u%e,O=ft(N,nU,e);if(!Xv.eql(Xv.sqr(O),r))throw new Error("Cannot find square root");return O}var Xv=uh(jv.p,{sqrt:Ste}),_te=JM(jv,{Fp:Xv,endo:vte}),mh=rU(_te,hM);function sU(r,e,t,n){let s=Ee.digest(t instanceof Uint8Array?t:t.subarray());if(K6(s))return s.then(({digest:o})=>(n?.signal?.throwIfAborted(),mh.verify(e,o,r,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new up(String(o))});try{return n?.signal?.throwIfAborted(),mh.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(o){throw new up(String(o))}}var W6=class{constructor(e){l(this,"type","secp256k1");l(this,"raw");l(this,"_key");this._key=iU(e),this.raw=oU(this._key)}toMultihash(){return ge.digest(Na(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return sU(this._key,t,e,n)}};function aU(r){return new W6(r)}function oU(r){return mh.Point.fromBytes(r).toBytes()}function iU(r){try{return mh.Point.fromBytes(r),r}catch(e){throw new Q1(String(e))}}function cU(r){let{Type:e,Data:t}=pp.decode(r.digest),n=t??new Uint8Array;switch(e){case Cn.Ed25519:return HM(n);case Cn.secp256k1:return aU(n);case Cn.ECDSA:return ZO(n);default:throw new J1}}function Na(r){return pp.encode({Type:Cn[r.type],Data:r.raw})}var Qv=Symbol.for("@libp2p/peer-id");var Jv="keep-alive";var uU=Symbol.for("@libp2p/transport");var lU;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(lU||(lU={}));var oo=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};l(oo,"name","AbortError");var mp=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};l(mp,"name","InvalidParametersError");var gp=class extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}};l(gp,"name","InvalidCIDError");var yp=class extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};l(yp,"name","InvalidMultihashError");var bp=class extends Error{constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}};l(bp,"name","InvalidMessageError");var gh=class extends Error{constructor(e="Dial error"){super(e),this.name="DialError"}};l(gh,"name","DialError");var wp=class extends Error{constructor(e="Listen error"){super(e),this.name="ListenError"}};l(wp,"name","ListenError");function fU(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function hU(...r){let e=[];for(let t of r)fU(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function dU(...r){let e=[];for(let t of r)fU(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var pU=Symbol.for("@libp2p/service-capabilities"),mU=Symbol.for("@libp2p/service-dependencies");var wU=Symbol.for("nodejs.util.inspect.custom"),Ate=114,gU,xp=class{constructor(e){l(this,"type");l(this,"multihash");l(this,"publicKey");l(this,"string");l(this,gU,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ie.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return se.createV1(Ate,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return j(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return j(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(gU=Qv,wU)](){return`PeerId(${this.toString()})`}},Y6=class extends xp{constructor(t){super({...t,type:"RSA"});l(this,"type","RSA");l(this,"publicKey");this.publicKey=t.publicKey}},Z6=class extends xp{constructor(t){super({...t,type:"Ed25519"});l(this,"type","Ed25519");l(this,"publicKey");this.publicKey=t.publicKey}},X6=class extends xp{constructor(t){super({...t,type:"secp256k1"});l(this,"type","secp256k1");l(this,"publicKey");this.publicKey=t.publicKey}},Ite=2336,yU,bU,Ep=class{constructor(e){l(this,"type","url");l(this,"multihash");l(this,"publicKey");l(this,"url");l(this,yU,!0);this.url=e.toString(),this.multihash=ge.digest(H(this.url))}[(bU=wU,yU=Qv,bU)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return se.createV1(Ite,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=z(e)),e.toString()===this.toString())}};var Tte=114,xU=2336;function eS(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=mt(ie.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Rte(se.parse(r));if(e==null)throw new mp('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=mt(e.decode(r))}return yh(t)}function yh(r){if(Dte(r))return new Y6({multihash:r});if(Cte(r))try{let e=cU(r);if(e.type==="Ed25519")return new Z6({multihash:r,publicKey:e});if(e.type==="secp256k1")return new X6({multihash:r,publicKey:e})}catch{let t=z(r.digest);return new Ep(new URL(t))}throw new yp("Supplied PeerID Multihash is invalid")}function Rte(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==Tte&&r.code!==xU)throw new gp("Supplied PeerID CID is invalid");if(r.code===xU){let e=z(r.multihash.digest);return new Ep(new URL(e))}return yh(r.multihash)}function Cte(r){return r.code===ge.code}function Dte(r){return r.code===Ee.code}var Mt=class extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};l(Mt,"name","InvalidParametersError");var Fl=class extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}};l(Fl,"name","InvalidPublicKeyError");var vp=class extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};l(vp,"name","UnsupportedKeyTypeError");var Bte=parseInt("11111",2),tS=parseInt("10000000",2),Pte=parseInt("01111111",2),EU={0:Sp,1:Sp,2:Lte,3:Ote,4:Mte,5:Nte,6:kte,16:Sp,22:Sp,48:Sp};function Ti(r,e={offset:0}){let t=r[e.offset]&Bte;if(e.offset++,EU[t]!=null)return EU[t](r,e);throw new Error("No decoder for tag "+t)}function _p(r,e){let t=0;if((r[e.offset]&tS)===tS){let n=r[e.offset]&Pte,s="0x";e.offset++;for(let o=0;o<n;o++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Sp(r,e){_p(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=Ti(r,e);if(n===null)break;t.push(n)}return t}function Lte(r,e){let t=_p(r,e),n=e.offset,s=e.offset+t,o=[];for(let i=n;i<s;i++)i===n&&r[i]===0||o.push(r[i]);return e.offset+=t,Uint8Array.from(o)}function kte(r,e){let t=_p(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let o=0,i=0;s<40?(o=0,i=s):s<80?(o=1,i=s-40):(o=2,i=s-80);let a=`${o}.${i}`,c=[];for(;e.offset<n;){let u=r[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let f=0;for(let h=0;h<c.length;h++)f+=c[h]<<h*7;a+=`.${f}`,c=[]}}return a}function Nte(r,e){return e.offset++,null}function Ote(r,e){let t=_p(r,e),n=r[e.offset];e.offset++;let s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function Mte(r,e){let t=_p(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Ute(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new Z;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function rS(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=Ute(r.byteLength);return new Z(Uint8Array.from([e.byteLength|tS]),e)}function pn(r){let e=new Z,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Z(Uint8Array.from([2]),rS(e),e)}function j6(r){let e=Uint8Array.from([0]),t=new Z(e,r);return new Z(Uint8Array.from([3]),rS(t),t)}function za(r,e=48){let t=new Z;for(let n of r)t.append(n);return new Z(Uint8Array.from([e]),rS(t),t)}async function vU(r,e,t,n){let s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let o=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),o}var Kte=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Fte=Uint8Array.from([6,5,43,129,4,0,34]),Vte=Uint8Array.from([6,5,43,129,4,0,35]),Hte={ext:!0,kty:"EC",crv:"P-256"},qte={ext:!0,kty:"EC",crv:"P-384"},zte={ext:!0,kty:"EC",crv:"P-521"},nS=32,sS=48,oS=66;function SU(r){let e=Ti(r);return _U(e)}function _U(r){let e=r[1][1][0],t=1,n,s;if(e.byteLength===nS*2+1)return n=z(e.subarray(t,t+nS),"base64url"),s=z(e.subarray(t+nS),"base64url"),new bh({...Hte,key_ops:["verify"],x:n,y:s});if(e.byteLength===sS*2+1)return n=z(e.subarray(t,t+sS),"base64url"),s=z(e.subarray(t+sS),"base64url"),new bh({...qte,key_ops:["verify"],x:n,y:s});if(e.byteLength===oS*2+1)return n=z(e.subarray(t,t+oS),"base64url"),s=z(e.subarray(t+oS),"base64url"),new bh({...zte,key_ops:["verify"],x:n,y:s});throw new Mt(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function AU(r){return za([pn(Uint8Array.from([1])),za([$te(r.crv)],160),za([j6(new Z(Uint8Array.from([4]),H(r.x??"","base64url"),H(r.y??"","base64url")))],161)]).subarray()}function $te(r){if(r==="P-256")return Kte;if(r==="P-384")return Fte;if(r==="P-521")return Vte;throw new Mt(`Invalid curve ${r}`)}var bh=class{constructor(e){l(this,"type","ECDSA");l(this,"jwk");l(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=AU(this.jwk)),this._raw}toMultihash(){return ge.digest($a(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}async verify(e,t,n){return vU(this.jwk,t,e,n)}};function Vl(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function io(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function Te(r,e,t=""){let n=Vl(r),s=r?.length,o=e!==void 0;if(!n||o&&s!==e){let i=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return r}function Q6(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");io(r.outputLen),io(r.blockLen)}function wh(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function TU(r,e){Te(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Ci(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function J6(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Is(r,e){return r<<32-e|r>>>e}var RU=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Gte=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Di(r){if(Te(r),RU)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=Gte[r[t]];return e}var Ri={_0:48,_9:57,A:65,F:70,a:97,f:102};function IU(r){if(r>=Ri._0&&r<=Ri._9)return r-Ri._0;if(r>=Ri.A&&r<=Ri.F)return r-(Ri.A-10);if(r>=Ri.a&&r<=Ri.f)return r-(Ri.a-10)}function Bi(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(RU)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let s=0,o=0;s<t;s++,o+=2){let i=IU(r.charCodeAt(o)),a=IU(r.charCodeAt(o+1));if(i===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}function mn(...r){let e=0;for(let n=0;n<r.length;n++){let s=r[n];Te(s),e+=s.length}let t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let o=r[n];t.set(o,s),s+=o.length}return t}function iS(r,e={}){let t=(s,o)=>r(o).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function xh(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var aS=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function CU(r,e,t){return r&e^~r&t}function DU(r,e,t){return r&e^r&t^e&t}var Ap=class{constructor(e,t,n,s){l(this,"blockLen");l(this,"outputLen");l(this,"padOffset");l(this,"isLE");l(this,"buffer");l(this,"view");l(this,"finished",!1);l(this,"length",0);l(this,"pos",0);l(this,"destroyed",!1);this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=J6(this.buffer)}update(e){wh(this),Te(e);let{view:t,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=J6(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){wh(this),TU(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;t[i++]=128,Ci(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let h=i;h<s;h++)t[h]=0;n.setBigUint64(s-8,BigInt(this.length*8),o),this.process(n,0);let a=J6(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let u=c/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)a.setUint32(4*h,f[h],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Pi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var mr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var ey=BigInt(4294967295),BU=BigInt(32);function Wte(r,e=!1){return e?{h:Number(r&ey),l:Number(r>>BU&ey)}:{h:Number(r>>BU&ey)|0,l:Number(r&ey)|0}}function PU(r,e=!1){let t=r.length,n=new Uint32Array(t),s=new Uint32Array(t);for(let o=0;o<t;o++){let{h:i,l:a}=Wte(r[o],e);[n[o],s[o]]=[i,a]}return[n,s]}var cS=(r,e,t)=>r>>>t,lS=(r,e,t)=>r<<32-t|e>>>t,Hl=(r,e,t)=>r>>>t|e<<32-t,ql=(r,e,t)=>r<<32-t|e>>>t,Ip=(r,e,t)=>r<<64-t|e>>>t-32,Tp=(r,e,t)=>r>>>t-32|e<<64-t;function ao(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var LU=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),kU=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,NU=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),OU=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,MU=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),UU=(r,e,t,n,s,o)=>e+t+n+s+o+(r/2**32|0)|0;var Zte=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ga=new Uint32Array(64),uS=class extends Ap{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)Ga[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){let d=Ga[h-15],p=Ga[h-2],y=Is(d,7)^Is(d,18)^d>>>3,x=Is(p,17)^Is(p,19)^p>>>10;Ga[h]=x+Ga[h-7]+y+Ga[h-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:u,H:f}=this;for(let h=0;h<64;h++){let d=Is(a,6)^Is(a,11)^Is(a,25),p=f+d+CU(a,c,u)+Zte[h]+Ga[h]|0,x=(Is(n,2)^Is(n,13)^Is(n,22))+DU(n,s,o)|0;f=u,u=c,c=a,a=i+p|0,i=o,o=s,s=n,n=p+x|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(n,s,o,i,a,c,u,f)}roundClean(){Ci(Ga)}destroy(){this.set(0,0,0,0,0,0,0,0),Ci(this.buffer)}},fS=class extends uS{constructor(){super(32);l(this,"A",Pi[0]|0);l(this,"B",Pi[1]|0);l(this,"C",Pi[2]|0);l(this,"D",Pi[3]|0);l(this,"E",Pi[4]|0);l(this,"F",Pi[5]|0);l(this,"G",Pi[6]|0);l(this,"H",Pi[7]|0)}};var KU=PU(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Xte=KU[0],jte=KU[1],Wa=new Uint32Array(80),Ya=new Uint32Array(80),hS=class extends Ap{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:u,El:f,Fh:h,Fl:d,Gh:p,Gl:y,Hh:x,Hl:b}=this;return[e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b]}set(e,t,n,s,o,i,a,c,u,f,h,d,p,y,x,b){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=f|0,this.Fh=h|0,this.Fl=d|0,this.Gh=p|0,this.Gl=y|0,this.Hh=x|0,this.Hl=b|0}process(e,t){for(let w=0;w<16;w++,t+=4)Wa[w]=e.getUint32(t),Ya[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){let R=Wa[w-15]|0,N=Ya[w-15]|0,O=Hl(R,N,1)^Hl(R,N,8)^cS(R,N,7),F=ql(R,N,1)^ql(R,N,8)^lS(R,N,7),A=Wa[w-2]|0,E=Ya[w-2]|0,L=Hl(A,E,19)^Ip(A,E,61)^cS(A,E,6),U=ql(A,E,19)^Tp(A,E,61)^lS(A,E,6),B=NU(F,U,Ya[w-7],Ya[w-16]),I=OU(B,O,L,Wa[w-7],Wa[w-16]);Wa[w]=I|0,Ya[w]=B|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:u,Dl:f,Eh:h,El:d,Fh:p,Fl:y,Gh:x,Gl:b,Hh:_,Hl:v}=this;for(let w=0;w<80;w++){let R=Hl(h,d,14)^Hl(h,d,18)^Ip(h,d,41),N=ql(h,d,14)^ql(h,d,18)^Tp(h,d,41),O=h&p^~h&x,F=d&y^~d&b,A=MU(v,N,F,jte[w],Ya[w]),E=UU(A,_,R,O,Xte[w],Wa[w]),L=A|0,U=Hl(n,s,28)^Ip(n,s,34)^Ip(n,s,39),B=ql(n,s,28)^Tp(n,s,34)^Tp(n,s,39),I=n&o^n&a^o&a,g=s&i^s&c^i&c;_=x|0,v=b|0,x=p|0,b=y|0,p=h|0,y=d|0,{h,l:d}=ao(u|0,f|0,E|0,L|0),u=a|0,f=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let m=LU(L,B,g);n=kU(m,E,U,I),s=m|0}({h:n,l:s}=ao(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=ao(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=ao(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l:f}=ao(this.Dh|0,this.Dl|0,u|0,f|0),{h,l:d}=ao(this.Eh|0,this.El|0,h|0,d|0),{h:p,l:y}=ao(this.Fh|0,this.Fl|0,p|0,y|0),{h:x,l:b}=ao(this.Gh|0,this.Gl|0,x|0,b|0),{h:_,l:v}=ao(this.Hh|0,this.Hl|0,_|0,v|0),this.set(n,s,o,i,a,c,u,f,h,d,p,y,x,b,_,v)}roundClean(){Ci(Wa,Ya)}destroy(){Ci(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},dS=class extends hS{constructor(){super(64);l(this,"Ah",mr[0]|0);l(this,"Al",mr[1]|0);l(this,"Bh",mr[2]|0);l(this,"Bl",mr[3]|0);l(this,"Ch",mr[4]|0);l(this,"Cl",mr[5]|0);l(this,"Dh",mr[6]|0);l(this,"Dl",mr[7]|0);l(this,"Eh",mr[8]|0);l(this,"El",mr[9]|0);l(this,"Fh",mr[10]|0);l(this,"Fl",mr[11]|0);l(this,"Gh",mr[12]|0);l(this,"Gl",mr[13]|0);l(this,"Hh",mr[14]|0);l(this,"Hl",mr[15]|0)}};var Eh=iS(()=>new fS,aS(1));var FU=iS(()=>new dS,aS(3));var mS=BigInt(0),pS=BigInt(1);function Li(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function VU(r){if(typeof r=="bigint"){if(!ty(r))throw new Error("positive bigint expected, got "+r)}else io(r);return r}function Rp(r){let e=VU(r).toString(16);return e.length&1?"0"+e:e}function HU(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?mS:BigInt("0x"+r)}function vh(r){return HU(Di(r))}function zl(r){return HU(Di(ny(Te(r)).reverse()))}function ry(r,e){io(e),r=VU(r);let t=Bi(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function gS(r,e){return ry(r,e).reverse()}function ny(r){return Uint8Array.from(r)}var ty=r=>typeof r=="bigint"&&mS<=r;function Qte(r,e,t){return ty(r)&&ty(e)&&ty(t)&&e<=r&&r<t}function Cp(r,e,t,n){if(!Qte(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function yS(r){let e;for(e=0;r>mS;r>>=pS,e+=1);return e}var Dp=r=>(pS<<BigInt(r))-pS;function qU(r,e,t){if(io(r,"hashLen"),io(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=b=>new Uint8Array(b),s=Uint8Array.of(),o=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=n(r),u=n(r),f=0,h=()=>{c.fill(1),u.fill(0),f=0},d=(...b)=>t(u,mn(c,...b)),p=(b=s)=>{u=d(o,b),c=d(),b.length!==0&&(u=d(i,b),c=d())},y=()=>{if(f++>=a)throw new Error("drbg: tried max amount of iterations");let b=0,_=[];for(;b<e;){c=d();let v=c.slice();_.push(v),b+=c.length}return mn(..._)};return(b,_)=>{h(),p(b);let v;for(;!(v=_(y()));)p();return h(),v}}function Za(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,i,a){let c=r[o];if(a&&c===void 0)return;let u=typeof c;if(u!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${u}`)}let s=(o,i)=>Object.entries(o).forEach(([a,c])=>n(a,c,i));s(e,!1),s(t,!0)}function Sh(r){let e=new WeakMap;return(t,...n)=>{let s=e.get(t);if(s!==void 0)return s;let o=r(t,...n);return e.set(t,o),o}}var Wr=BigInt(0),tr=BigInt(1),$l=BigInt(2),GU=BigInt(3),WU=BigInt(4),YU=BigInt(5),Jte=BigInt(7),ZU=BigInt(8),ere=BigInt(9),XU=BigInt(16);function Dt(r,e){let t=r%e;return t>=Wr?t:e+t}function ht(r,e,t){let n=r;for(;e-- >Wr;)n*=n,n%=t;return n}function zU(r,e){if(r===Wr)throw new Error("invert: expected non-zero number");if(e<=Wr)throw new Error("invert: expected positive modulus, got "+e);let t=Dt(r,e),n=e,s=Wr,o=tr,i=tr,a=Wr;for(;t!==Wr;){let u=n/t,f=n%t,h=s-i*u,d=o-a*u;n=t,t=f,s=i,o=a,i=h,a=d}if(n!==tr)throw new Error("invert: does not exist");return Dt(s,e)}function wS(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function jU(r,e){let t=(r.ORDER+tr)/WU,n=r.pow(e,t);return wS(r,n,e),n}function tre(r,e){let t=(r.ORDER-YU)/ZU,n=r.mul(e,$l),s=r.pow(n,t),o=r.mul(e,s),i=r.mul(r.mul(o,$l),s),a=r.mul(o,r.sub(i,r.ONE));return wS(r,a,e),a}function rre(r){let e=_h(r),t=QU(r),n=t(e,e.neg(e.ONE)),s=t(e,n),o=t(e,e.neg(n)),i=(r+Jte)/XU;return(a,c)=>{let u=a.pow(c,i),f=a.mul(u,n),h=a.mul(u,s),d=a.mul(u,o),p=a.eql(a.sqr(f),c),y=a.eql(a.sqr(h),c);u=a.cmov(u,f,p),f=a.cmov(d,h,y);let x=a.eql(a.sqr(f),c),b=a.cmov(u,f,x);return wS(a,b,c),b}}function QU(r){if(r<GU)throw new Error("sqrt is not defined for small field");let e=r-tr,t=0;for(;e%$l===Wr;)e/=$l,t++;let n=$l,s=_h(r);for(;$U(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return jU;let o=s.pow(n,e),i=(e+tr)/$l;return function(c,u){if(c.is0(u))return u;if($U(c,u)!==1)throw new Error("Cannot find square root");let f=t,h=c.mul(c.ONE,o),d=c.pow(u,e),p=c.pow(u,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let y=1,x=c.sqr(d);for(;!c.eql(x,c.ONE);)if(y++,x=c.sqr(x),y===f)throw new Error("Cannot find square root");let b=tr<<BigInt(f-y-1),_=c.pow(h,b);f=y,h=c.sqr(_),d=c.mul(d,h),p=c.mul(p,_)}return p}}function nre(r){return r%WU===GU?jU:r%ZU===YU?tre:r%XU===ere?rre(r):QU(r)}var JU=(r,e)=>(Dt(r,e)&tr)===tr,sre=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function xS(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=sre.reduce((n,s)=>(n[s]="function",n),e);return Za(r,t),r}function ore(r,e,t){if(t<Wr)throw new Error("invalid exponent, negatives unsupported");if(t===Wr)return r.ONE;if(t===tr)return e;let n=r.ONE,s=e;for(;t>Wr;)t&tr&&(n=r.mul(n,s)),s=r.sqr(s),t>>=tr;return n}function Bp(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),o=r.inv(s);return e.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),o),n}function $U(r,e){let t=(r.ORDER-tr)/$l,n=r.pow(e,t),s=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function ire(r,e){e!==void 0&&io(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var bS=class{constructor(e,t={}){l(this,"ORDER");l(this,"BITS");l(this,"BYTES");l(this,"isLE");l(this,"ZERO",Wr);l(this,"ONE",tr);l(this,"_lengths");l(this,"_sqrt");l(this,"_mod");if(e<=Wr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:s,nByteLength:o}=ire(e,n);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Dt(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return Wr<=e&&e<this.ORDER}is0(e){return e===Wr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&tr)===tr}neg(e){return Dt(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Dt(e*e,this.ORDER)}add(e,t){return Dt(e+t,this.ORDER)}sub(e,t){return Dt(e-t,this.ORDER)}mul(e,t){return Dt(e*t,this.ORDER)}pow(e,t){return ore(this,e,t)}div(e,t){return Dt(e*zU(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return zU(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=nre(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?gS(e,this.BYTES):ry(e,this.BYTES)}fromBytes(e,t=!1){Te(e);let{_lengths:n,BYTES:s,isLE:o,ORDER:i,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let u=new Uint8Array(s);u.set(e,o?0:u.length-e.length),e=u}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=o?zl(e):vh(e);if(a&&(c=Dt(c,i)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return Bp(this,e)}cmov(e,t,n){return n?t:e}};function _h(r,e={}){return new bS(r,e)}function eK(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function ES(r){let e=eK(r);return e+Math.ceil(e/2)}function vS(r,e,t=!1){Te(r);let n=r.length,s=eK(e),o=ES(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let i=t?zl(r):vh(r),a=Dt(i,e-tr)+tr;return t?gS(a,s):ry(a,s)}var Ah=BigInt(0),Gl=BigInt(1);function Pp(r,e){let t=e.negate();return r?t:e}function Wl(r,e){let t=Bp(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function sK(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function SS(r,e){sK(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,o=Dp(r),i=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function tK(r,e,t){let{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=t,a=Number(r&s),c=r>>i;a>n&&(a-=o,c+=Gl);let u=e*n,f=u+Math.abs(a)-1,h=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:f,isZero:h,isNeg:d,isNegF:p,offsetF:u}}var _S=new WeakMap,oK=new WeakMap;function AS(r){return oK.get(r)||1}function rK(r){if(r!==Ah)throw new Error("invalid wNAF")}var Ih=class{constructor(e,t){l(this,"BASE");l(this,"ZERO");l(this,"Fn");l(this,"bits");this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>Ah;)t&Gl&&(n=n.add(s)),s=s.double(),t>>=Gl;return n}precomputeWindow(e,t){let{windows:n,windowSize:s}=SS(t,this.bits),o=[],i=e,a=i;for(let c=0;c<n;c++){a=i,o.push(a);for(let u=1;u<s;u++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=SS(e,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:p}=tK(n,a,i);n=c,f?o=o.add(Pp(d,t[p])):s=s.add(Pp(h,t[u]))}return rK(n),{p:s,f:o}}wNAFUnsafe(e,t,n,s=this.ZERO){let o=SS(e,this.bits);for(let i=0;i<o.windows&&n!==Ah;i++){let{nextN:a,offset:c,isZero:u,isNeg:f}=tK(n,i,o);if(n=a,!u){let h=t[c];s=s.add(f?h.negate():h)}}return rK(n),s}getPrecomputes(e,t,n){let s=_S.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),_S.set(t,s))),s}cached(e,t,n){let s=AS(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){let o=AS(e);return o===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),t,s)}createCache(e,t){sK(t,this.bits),oK.set(e,t),_S.delete(e)}hasCache(e){return AS(e)!==1}};function iK(r,e,t,n){let s=e,o=r.ZERO,i=r.ZERO;for(;t>Ah||n>Ah;)t&Gl&&(o=o.add(s)),n&Gl&&(i=i.add(s)),s=s.double(),t>>=Gl,n>>=Gl;return{p1:o,p2:i}}function nK(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return xS(e),e}else return _h(r,{isLE:t})}function sy(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let u=e[c];if(!(typeof u=="bigint"&&u>Ah))throw new Error(`CURVE.${c} must be positive bigint`)}let s=nK(e.p,t.Fp,n),o=nK(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}function oy(r,e){return function(n){let s=r(n);return{secretKey:s,publicKey:e(s)}}}var Xa=BigInt(0),rr=BigInt(1),IS=BigInt(2),are=BigInt(8);function cre(r,e,t,n){let s=r.sqr(t),o=r.sqr(n),i=r.add(r.mul(e.a,s),o),a=r.add(r.ONE,r.mul(e.d,r.mul(s,o)));return r.eql(i,a)}function aK(r,e={}){let t=sy("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i}=o;Za(e,{},{uvRatio:"function"});let a=IS<<BigInt(s.BYTES*8)-rr,c=_=>n.create(_),u=e.uvRatio||((_,v)=>{try{return{isValid:!0,value:n.sqrt(n.div(_,v))}}catch{return{isValid:!1,value:Xa}}});if(!cre(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function f(_,v,w=!1){let R=w?rr:Xa;return Cp("coordinate "+_,v,R,a),v}function h(_){if(!(_ instanceof y))throw new Error("EdwardsPoint expected")}let d=Sh((_,v)=>{let{X:w,Y:R,Z:N}=_,O=_.is0();v==null&&(v=O?are:n.inv(N));let F=c(w*v),A=c(R*v),E=n.mul(N,v);if(O)return{x:Xa,y:rr};if(E!==rr)throw new Error("invZ was invalid");return{x:F,y:A}}),p=Sh(_=>{let{a:v,d:w}=o;if(_.is0())throw new Error("bad point: ZERO");let{X:R,Y:N,Z:O,T:F}=_,A=c(R*R),E=c(N*N),L=c(O*O),U=c(L*L),B=c(A*v),I=c(L*c(B+E)),g=c(U+c(w*c(A*E)));if(I!==g)throw new Error("bad point: equation left != right (1)");let m=c(R*N),S=c(O*F);if(m!==S)throw new Error("bad point: equation left != right (2)");return!0}),b=class b{constructor(v,w,R,N){l(this,"X");l(this,"Y");l(this,"Z");l(this,"T");this.X=f("x",v),this.Y=f("y",w),this.Z=f("z",R,!0),this.T=f("t",N),Object.freeze(this)}static CURVE(){return o}static fromAffine(v){if(v instanceof b)throw new Error("extended point not allowed");let{x:w,y:R}=v||{};return f("x",w),f("y",R),new b(w,R,rr,c(w*R))}static fromBytes(v,w=!1){let R=n.BYTES,{a:N,d:O}=o;v=ny(Te(v,R,"point")),Li(w,"zip215");let F=ny(v),A=v[R-1];F[R-1]=A&-129;let E=zl(F),L=w?a:n.ORDER;Cp("point.y",E,Xa,L);let U=c(E*E),B=c(U-rr),I=c(O*U-N),{isValid:g,value:m}=u(B,I);if(!g)throw new Error("bad point: invalid y coordinate");let S=(m&rr)===rr,T=(A&128)!==0;if(!w&&m===Xa&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(m=c(-m)),b.fromAffine({x:m,y:E})}static fromHex(v,w=!1){return b.fromBytes(Bi(v),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(v=8,w=!0){return x.createCache(this,v),w||this.multiply(IS),this}assertValidity(){p(this)}equals(v){h(v);let{X:w,Y:R,Z:N}=this,{X:O,Y:F,Z:A}=v,E=c(w*A),L=c(O*N),U=c(R*A),B=c(F*N);return E===L&&U===B}is0(){return this.equals(b.ZERO)}negate(){return new b(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:v}=o,{X:w,Y:R,Z:N}=this,O=c(w*w),F=c(R*R),A=c(IS*c(N*N)),E=c(v*O),L=w+R,U=c(c(L*L)-O-F),B=E+F,I=B-A,g=E-F,m=c(U*I),S=c(B*g),T=c(U*g),P=c(I*B);return new b(m,S,P,T)}add(v){h(v);let{a:w,d:R}=o,{X:N,Y:O,Z:F,T:A}=this,{X:E,Y:L,Z:U,T:B}=v,I=c(N*E),g=c(O*L),m=c(A*R*B),S=c(F*U),T=c((N+O)*(E+L)-I-g),P=S-m,C=S+m,k=c(g-w*I),D=c(T*P),M=c(C*k),q=c(T*k),W=c(P*C);return new b(D,M,W,q)}subtract(v){return this.add(v.negate())}multiply(v){if(!s.isValidNot0(v))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:w,f:R}=x.cached(this,v,N=>Wl(b,N));return Wl(b,[w,R])[0]}multiplyUnsafe(v,w=b.ZERO){if(!s.isValid(v))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return v===Xa?b.ZERO:this.is0()||v===rr?this:x.unsafe(this,v,R=>Wl(b,R),w)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return x.unsafe(this,o.n).is0()}toAffine(v){return d(this,v)}clearCofactor(){return i===rr?this:this.multiplyUnsafe(i)}toBytes(){let{x:v,y:w}=this.toAffine(),R=n.toBytes(w);return R[R.length-1]|=v&rr?128:0,R}toHex(){return Di(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(b,"BASE",new b(o.Gx,o.Gy,rr,c(o.Gx*o.Gy))),l(b,"ZERO",new b(Xa,rr,rr,Xa)),l(b,"Fp",n),l(b,"Fn",s);let y=b,x=new Ih(y,s.BITS);return y.BASE.precompute(8),y}function cK(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Za(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:s,Fp:o,Fn:i}=r,a=t.randomBytes||xh,c=t.adjustScalarBytes||(A=>A),u=t.domain||((A,E,L)=>{if(Li(L,"phflag"),E.length||L)throw new Error("Contexts/pre-hash are not supported");return A});function f(A){return i.create(zl(A))}function h(A){let E=w.secretKey;Te(A,w.secretKey,"secretKey");let L=Te(e(A),2*E,"hashedSecretKey"),U=c(L.slice(0,E)),B=L.slice(E,2*E),I=f(U);return{head:U,prefix:B,scalar:I}}function d(A){let{head:E,prefix:L,scalar:U}=h(A),B=s.multiply(U),I=B.toBytes();return{head:E,prefix:L,scalar:U,point:B,pointBytes:I}}function p(A){return d(A).pointBytes}function y(A=Uint8Array.of(),...E){let L=mn(...E);return f(e(u(L,Te(A,void 0,"context"),!!n)))}function x(A,E,L={}){A=Te(A,void 0,"message"),n&&(A=n(A));let{prefix:U,scalar:B,pointBytes:I}=d(E),g=y(L.context,U,A),m=s.multiply(g).toBytes(),S=y(L.context,m,I,A),T=i.create(g+S*B);if(!i.isValid(T))throw new Error("sign failed: invalid s");let P=mn(m,i.toBytes(T));return Te(P,w.signature,"result")}let b={zip215:!0};function _(A,E,L,U=b){let{context:B,zip215:I}=U,g=w.signature;A=Te(A,g,"signature"),E=Te(E,void 0,"message"),L=Te(L,w.publicKey,"publicKey"),I!==void 0&&Li(I,"zip215"),n&&(E=n(E));let m=g/2,S=A.subarray(0,m),T=zl(A.subarray(m,g)),P,C,k;try{P=r.fromBytes(L,I),C=r.fromBytes(S,I),k=s.multiplyUnsafe(T)}catch{return!1}if(!I&&P.isSmallOrder())return!1;let D=y(B,C.toBytes(),P.toBytes(),E);return C.add(P.multiplyUnsafe(D)).subtract(k).clearCofactor().is0()}let v=o.BYTES,w={secretKey:v,publicKey:v,signature:2*v,seed:v};function R(A=a(w.seed)){return Te(A,w.seed,"seed")}function N(A){return Vl(A)&&A.length===i.BYTES}function O(A,E){try{return!!r.fromBytes(A,E)}catch{return!1}}let F={getExtendedPublicKey:d,randomSecretKey:R,isValidSecretKey:N,isValidPublicKey:O,toMontgomery(A){let{y:E}=r.fromBytes(A),L=w.publicKey,U=L===32;if(!U&&L!==57)throw new Error("only defined for 25519 and 448");let B=U?o.div(rr+E,rr-E):o.div(E-rr,E+rr);return o.toBytes(B)},toMontgomerySecret(A){let E=w.secretKey;Te(A,E);let L=e(A.subarray(0,E));return c(L).subarray(0,E)}};return Object.freeze({keygen:oy(R,p),getPublicKey:p,sign:x,verify:_,utils:F,Point:r,lengths:w})}var lre=BigInt(1),lK=BigInt(2);var ure=BigInt(5),fre=BigInt(8),TS=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),hre={p:TS,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:fre,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function dre(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),o=TS,a=r*r%o*r%o,c=ht(a,lK,o)*a%o,u=ht(c,lre,o)*r%o,f=ht(u,ure,o)*u%o,h=ht(f,e,o)*f%o,d=ht(h,t,o)*h%o,p=ht(d,n,o)*d%o,y=ht(p,s,o)*p%o,x=ht(y,s,o)*p%o,b=ht(x,e,o)*f%o;return{pow_p_5_8:ht(b,lK,o)*r%o,b2:a}}function pre(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var uK=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function mre(r,e){let t=TS,n=Dt(e*e*e,t),s=Dt(n*n*e,t),o=dre(r*s).pow_p_5_8,i=Dt(r*n*o,t),a=Dt(e*i*i,t),c=i,u=Dt(i*uK,t),f=a===r,h=a===Dt(-r,t),d=a===Dt(-r*uK,t);return f&&(i=c),(h||d)&&(i=u),JU(i,t)&&(i=Dt(-i,t)),{isValid:f||h,value:i}}var gre=aK(hre,{uvRatio:mre});function yre(r){return cK(gre,FU,Object.assign({adjustScalarBytes:pre},r))}var fK=yre({});var Lp=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},iy=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var hK={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new iy("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var Yn=hK;var ay=32;var RS,bre=(async()=>{try{return await Yn.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function wre(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await Yn.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Yn.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function xre(r,e,t){return fK.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function dK(r,e,t){return RS==null&&(RS=await bre),RS?wre(r,e,t):xre(r,e,t)}function cy(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var ly=class{constructor(e){l(this,"type","Ed25519");l(this,"raw");this.raw=CS(e,ay)}toMultihash(){return ge.digest($a(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let s=dK(this.raw,t,e);return cy(s)?s.then(o=>(n?.signal?.throwIfAborted(),o)):s}};function mK(r){return r=CS(r,ay),new ly(r)}function CS(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Mt(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var DS=new Float32Array([-0]),ja=new Uint8Array(DS.buffer);function gK(r,e,t){DS[0]=r,e[t]=ja[0],e[t+1]=ja[1],e[t+2]=ja[2],e[t+3]=ja[3]}function yK(r,e){return ja[0]=r[e],ja[1]=r[e+1],ja[2]=r[e+2],ja[3]=r[e+3],DS[0]}var BS=new Float64Array([-0]),Rr=new Uint8Array(BS.buffer);function bK(r,e,t){BS[0]=r,e[t]=Rr[0],e[t+1]=Rr[1],e[t+2]=Rr[2],e[t+3]=Rr[3],e[t+4]=Rr[4],e[t+5]=Rr[5],e[t+6]=Rr[6],e[t+7]=Rr[7]}function wK(r,e){return Rr[0]=r[e],Rr[1]=r[e+1],Rr[2]=r[e+2],Rr[3]=r[e+3],Rr[4]=r[e+4],Rr[5]=r[e+5],Rr[6]=r[e+6],Rr[7]=r[e+7],BS[0]}var vre=BigInt(Number.MAX_SAFE_INTEGER),Sre=BigInt(Number.MIN_SAFE_INTEGER),Dn=class r{constructor(e,t){l(this,"lo");l(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Yl;if(e<vre&&e>Sre)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>xK&&(s=0n,++n>xK&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return Yl;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Yl}},Yl=new Dn(0,0);Yl.toBigInt=function(){return 0n};Yl.zzEncode=Yl.zzDecode=function(){return this};Yl.length=function(){return 1};var xK=4294967296n;function EK(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function vK(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function PS(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function Ts(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function uy(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var LS=class{constructor(e){l(this,"buf");l(this,"pos");l(this,"len");l(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Ts(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Ts(this,4);return uy(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Ts(this,4);return uy(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Ts(this,4);let e=yK(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Ts(this,4);let e=wK(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Ts(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return vK(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Ts(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Ts(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Dn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Ts(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Ts(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Ts(this,8);let e=uy(this.buf,this.pos+=4),t=uy(this.buf,this.pos+=4);return new Dn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=gn(this.buf,this.pos);return this.pos+=ce(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function kS(r){return new LS(r instanceof Uint8Array?r:r.subarray())}function Th(r,e,t){let n=kS(r);return e.decode(n,void 0,t)}function NS(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return pe(i);s+i>e&&(n=pe(e),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var Zl=class{constructor(e,t,n){l(this,"fn");l(this,"len");l(this,"next");l(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}};function OS(){}var US=class{constructor(e){l(this,"head");l(this,"tail");l(this,"len");l(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},_re=NS();function Are(r){return globalThis.Buffer!=null?pe(r):_re(r)}var Np=class{constructor(){l(this,"len");l(this,"head");l(this,"tail");l(this,"states");this.len=0,this.head=new Zl(OS,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Zl(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new KS((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(fy,10,Dn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Dn.fromBigInt(e);return this._push(fy,t.length(),t)}uint64Number(e){return this._push(Et,ce(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Dn.fromBigInt(e).zzEncode();return this._push(fy,t.length(),t)}sint64Number(e){let t=Dn.fromNumber(e).zzEncode();return this._push(fy,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(MS,1,e?1:0)}fixed32(e){return this._push(kp,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Dn.fromBigInt(e);return this._push(kp,4,t.lo)._push(kp,4,t.hi)}fixed64Number(e){let t=Dn.fromNumber(e);return this._push(kp,4,t.lo)._push(kp,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(gK,4,e)}double(e){return this._push(bK,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(MS,1,0):this.uint32(t)._push(Tre,t,e)}string(e){let t=EK(e);return t!==0?this.uint32(t)._push(PS,t,e):this._push(MS,1,0)}fork(){return this.states=new US(this),this.head=this.tail=new Zl(OS,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Zl(OS,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=Are(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function MS(r,e,t){e[t]=r&255}function Ire(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var KS=class extends Zl{constructor(t,n){super(Ire,t,n);l(this,"next");this.next=void 0}};function fy(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function kp(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Tre(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Np.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(Rre,e,r),this},Np.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(Cre,e,r),this});function Rre(r,e,t){e.set(r,t)}function Cre(r,e,t){r.length<40?PS(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(H(r),t)}function FS(){return new Np}function Rh(r,e){let t=FS();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Ch;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Ch||(Ch={}));function hy(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function VS(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(o,i){let a=e(o);i.int32(a)},n=function(o){let i=o.int32();return e(i)};return hy("enum",Ch.VARINT,t,n)}function Dh(r,e){return hy("message",Ch.LENGTH_DELIMITED,r,e)}var nr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(nr||(nr={}));var HS;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(HS||(HS={}));(function(r){r.codec=()=>VS(HS)})(nr||(nr={}));var ki;(function(r){let e;r.codec=()=>(e==null&&(e=Dh((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),nr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=nr.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Rh(t,r.codec()),r.decode=(t,n)=>Th(t,r.codec(),n)})(ki||(ki={}));var qS;(function(r){let e;r.codec=()=>(e==null&&(e=Dh((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),nr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=nr.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Rh(t,r.codec()),r.decode=(t,n)=>Th(t,r.codec(),n)})(qS||(qS={}));var Mp={};pt(Mp,{MAX_RSA_KEY_SIZE:()=>zS,generateRSAKeyPair:()=>RK,jwkToJWKKeyPair:()=>CK,jwkToPkcs1:()=>Lre,jwkToPkix:()=>YS,jwkToRSAPrivateKey:()=>QS,pkcs1MessageToJwk:()=>GS,pkcs1MessageToRSAPrivateKey:()=>ZS,pkcs1ToJwk:()=>Pre,pkcs1ToRSAPrivateKey:()=>TK,pkixMessageToJwk:()=>WS,pkixMessageToRSAPublicKey:()=>jS,pkixToJwk:()=>kre,pkixToRSAPublicKey:()=>XS});var Bh=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Mp.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return se.createV1(114,this._multihash)}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return IK(this.jwk,t,e,n)}},Op=class{constructor(e,t){l(this,"type","RSA");l(this,"jwk");l(this,"_raw");l(this,"publicKey");this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Mp.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}sign(e,t){return AK(this.jwk,e,t)}};var zS=8192,$S=18,Dre=1062,Bre=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function Pre(r){let e=Ti(r);return GS(e)}function GS(r){return{n:z(r[1],"base64url"),e:z(r[2],"base64url"),d:z(r[3],"base64url"),p:z(r[4],"base64url"),q:z(r[5],"base64url"),dp:z(r[6],"base64url"),dq:z(r[7],"base64url"),qi:z(r[8],"base64url"),kty:"RSA"}}function Lre(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new Mt("JWK was missing components");return za([pn(Uint8Array.from([0])),pn(H(r.n,"base64url")),pn(H(r.e,"base64url")),pn(H(r.d,"base64url")),pn(H(r.p,"base64url")),pn(H(r.q,"base64url")),pn(H(r.dp,"base64url")),pn(H(r.dq,"base64url")),pn(H(r.qi,"base64url"))]).subarray()}function kre(r){let e=Ti(r,{offset:0});return WS(e)}function WS(r){let e=Ti(r[1],{offset:0});return{kty:"RSA",n:z(e[0],"base64url"),e:z(e[1],"base64url")}}function YS(r){if(r.n==null||r.e==null)throw new Mt("JWK was missing components");return za([Bre,j6(za([pn(H(r.n,"base64url")),pn(H(r.e,"base64url"))]))]).subarray()}function TK(r){let e=Ti(r);return ZS(e)}function ZS(r){let e=GS(r);return QS(e)}function XS(r,e){if(r.byteLength>=Dre)throw new Fl("Key size is too large");let t=Ti(r,{offset:0});return jS(t,r,e)}function jS(r,e,t){let n=WS(r);if(t==null){let s=Eh(ki.encode({Type:nr.RSA,Data:e}));t=ot($S,s)}return new Bh(n,t)}function QS(r){if(BK(r)>zS)throw new Mt("Key size is too large");let e=CK(r),t=Eh(ki.encode({Type:nr.RSA,Data:YS(e.publicKey)})),n=ot($S,t);return new Op(e.privateKey,new Bh(e.publicKey,n))}async function RK(r){if(r>zS)throw new Mt("Key size is too large");let e=await DK(r),t=Eh(ki.encode({Type:nr.RSA,Data:YS(e.publicKey)})),n=ot($S,t);return new Op(e.privateKey,new Bh(e.publicKey,n))}function CK(r){if(r==null)throw new Mt("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function DK(r,e){let t=await Yn.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await Nre(t,e);return{privateKey:n[0],publicKey:n[1]}}async function AK(r,e,t){let n=await Yn.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let s=await Yn.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function IK(r,e,t,n){let s=await Yn.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let o=await Yn.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),o}async function Nre(r,e){if(r.privateKey==null||r.publicKey==null)throw new Mt("Private and public key are required");let t=await Promise.all([Yn.get().subtle.exportKey("jwk",r.privateKey),Yn.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function BK(r){if(r.kty!=="RSA")throw new Mt("invalid key type");if(r.n==null)throw new Mt("invalid key modulus");return H(r.n,"base64url").length*8}var dy=class{constructor(e,t){l(this,"oHash");l(this,"iHash");l(this,"blockLen");l(this,"outputLen");l(this,"finished",!1);l(this,"destroyed",!1);if(Q6(e),Te(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),Ci(s)}update(e){return wh(this),this.iHash.update(e),this}digestInto(e){wh(this),Te(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},JS=(r,e,t)=>new dy(r,e).update(t).digest();JS.create=(r,e)=>new dy(r,e);var PK=(r,e)=>(r+(r>=0?e:-e)/LK)/e;function Ore(r,e,t){let[[n,s],[o,i]]=e,a=PK(i*r,t),c=PK(-s*r,t),u=r-a*n-c*o,f=-a*s-c*i,h=u<Ni,d=f<Ni;h&&(u=-u),d&&(f=-f);let p=Dp(Math.ceil(yS(t)/2))+Ph;if(u<Ni||u>=p||f<Ni||f>=p)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:h,k1:u,k2neg:d,k2:f}}function t_(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function e_(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Li(t.lowS,"lowS"),Li(t.prehash,"prehash"),t.format!==void 0&&t_(t.format),t}var r_=class extends Error{constructor(e=""){super(e)}},Qa={Err:r_,_tlv:{encode:(r,e)=>{let{Err:t}=Qa;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,s=Rp(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?Rp(s.length/2|128):"";return Rp(r)+o+s+e},decode(r,e){let{Err:t}=Qa,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let s=e[n++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let f of u)i=i<<8|f;if(n+=c,i<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+i);if(a.length!==i)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(r){let{Err:e}=Qa;if(r<Ni)throw new e("integer: negative integers are not allowed");let t=Rp(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=Qa;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return vh(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=Qa,s=Te(r,void 0,"signature"),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:u,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){let{_tlv:e,_int:t}=Qa,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),o=n+s;return e.encode(48,o)}},Ni=BigInt(0),Ph=BigInt(1),LK=BigInt(2),py=BigInt(3),Mre=BigInt(4);function kK(r,e={}){let t=sy("weierstrass",r,e),{Fp:n,Fn:s}=t,o=t.CURVE,{h:i,n:a}=o;Za(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let u=OK(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(I,g,m){let{x:S,y:T}=g.toAffine(),P=n.toBytes(S);if(Li(m,"isCompressed"),m){f();let C=!n.isOdd(T);return mn(NK(C),P)}else return mn(Uint8Array.of(4),P,n.toBytes(T))}function d(I){Te(I,void 0,"Point");let{publicKey:g,publicKeyUncompressed:m}=u,S=I.length,T=I[0],P=I.subarray(1);if(S===g&&(T===2||T===3)){let C=n.fromBytes(P);if(!n.isValid(C))throw new Error("bad point: is not on curve, wrong x");let k=x(C),D;try{D=n.sqrt(k)}catch(W){let G=W instanceof Error?": "+W.message:"";throw new Error("bad point: is not on curve, sqrt error"+G)}f();let M=n.isOdd(D);return(T&1)===1!==M&&(D=n.neg(D)),{x:C,y:D}}else if(S===m&&T===4){let C=n.BYTES,k=n.fromBytes(P.subarray(0,C)),D=n.fromBytes(P.subarray(C,C*2));if(!b(k,D))throw new Error("bad point: is not on curve");return{x:k,y:D}}else throw new Error(`bad point: got length ${S}, expected compressed=${g} or uncompressed=${m}`)}let p=e.toBytes||h,y=e.fromBytes||d;function x(I){let g=n.sqr(I),m=n.mul(g,I);return n.add(n.add(m,n.mul(I,o.a)),o.b)}function b(I,g){let m=n.sqr(g),S=x(I);return n.eql(m,S)}if(!b(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let _=n.mul(n.pow(o.a,py),Mre),v=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(_,v)))throw new Error("bad curve params: a or b");function w(I,g,m=!1){if(!n.isValid(g)||m&&n.is0(g))throw new Error(`bad point coordinate ${I}`);return g}function R(I){if(!(I instanceof E))throw new Error("Weierstrass Point expected")}function N(I){if(!c||!c.basises)throw new Error("no endo");return Ore(I,c.basises,s.ORDER)}let O=Sh((I,g)=>{let{X:m,Y:S,Z:T}=I;if(n.eql(T,n.ONE))return{x:m,y:S};let P=I.is0();g==null&&(g=P?n.ONE:n.inv(T));let C=n.mul(m,g),k=n.mul(S,g),D=n.mul(T,g);if(P)return{x:n.ZERO,y:n.ZERO};if(!n.eql(D,n.ONE))throw new Error("invZ was invalid");return{x:C,y:k}}),F=Sh(I=>{if(I.is0()){if(e.allowInfinityPoint&&!n.is0(I.Y))return;throw new Error("bad point: ZERO")}let{x:g,y:m}=I.toAffine();if(!n.isValid(g)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!b(g,m))throw new Error("bad point: equation left != right");if(!I.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function A(I,g,m,S,T){return m=new E(n.mul(m.X,I),m.Y,m.Z),g=Pp(S,g),m=Pp(T,m),g.add(m)}let B=class B{constructor(g,m,S){l(this,"X");l(this,"Y");l(this,"Z");this.X=w("x",g),this.Y=w("y",m,!0),this.Z=w("z",S),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){let{x:m,y:S}=g||{};if(!g||!n.isValid(m)||!n.isValid(S))throw new Error("invalid affine point");if(g instanceof B)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(S)?B.ZERO:new B(m,S,n.ONE)}static fromBytes(g){let m=B.fromAffine(y(Te(g,void 0,"point")));return m.assertValidity(),m}static fromHex(g){return B.fromBytes(Bi(g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,m=!0){return U.createCache(this,g),m||this.multiply(py),this}assertValidity(){F(this)}hasEvenY(){let{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.eql(n.mul(m,k),n.mul(P,T)),M=n.eql(n.mul(S,k),n.mul(C,T));return D&&M}negate(){return new B(this.X,n.neg(this.Y),this.Z)}double(){let{a:g,b:m}=o,S=n.mul(m,py),{X:T,Y:P,Z:C}=this,k=n.ZERO,D=n.ZERO,M=n.ZERO,q=n.mul(T,T),W=n.mul(P,P),G=n.mul(C,C),$=n.mul(T,P);return $=n.add($,$),M=n.mul(T,C),M=n.add(M,M),k=n.mul(g,M),D=n.mul(S,G),D=n.add(k,D),k=n.sub(W,D),D=n.add(W,D),D=n.mul(k,D),k=n.mul($,k),M=n.mul(S,M),G=n.mul(g,G),$=n.sub(q,G),$=n.mul(g,$),$=n.add($,M),M=n.add(q,q),q=n.add(M,q),q=n.add(q,G),q=n.mul(q,$),D=n.add(D,q),G=n.mul(P,C),G=n.add(G,G),q=n.mul(G,$),k=n.sub(k,q),M=n.mul(G,W),M=n.add(M,M),M=n.add(M,M),new B(k,D,M)}add(g){R(g);let{X:m,Y:S,Z:T}=this,{X:P,Y:C,Z:k}=g,D=n.ZERO,M=n.ZERO,q=n.ZERO,W=o.a,G=n.mul(o.b,py),$=n.mul(m,P),X=n.mul(S,C),Q=n.mul(T,k),J=n.add(m,S),Y=n.add(P,C);J=n.mul(J,Y),Y=n.add($,X),J=n.sub(J,Y),Y=n.add(m,T);let re=n.add(P,k);return Y=n.mul(Y,re),re=n.add($,Q),Y=n.sub(Y,re),re=n.add(S,T),D=n.add(C,k),re=n.mul(re,D),D=n.add(X,Q),re=n.sub(re,D),q=n.mul(W,Y),D=n.mul(G,Q),q=n.add(D,q),D=n.sub(X,q),q=n.add(X,q),M=n.mul(D,q),X=n.add($,$),X=n.add(X,$),Q=n.mul(W,Q),Y=n.mul(G,Y),X=n.add(X,Q),Q=n.sub($,Q),Q=n.mul(W,Q),Y=n.add(Y,Q),$=n.mul(X,Y),M=n.add(M,$),$=n.mul(re,Y),D=n.mul(J,D),D=n.sub(D,$),$=n.mul(J,X),q=n.mul(re,q),q=n.add(q,$),new B(D,M,q)}subtract(g){return this.add(g.negate())}is0(){return this.equals(B.ZERO)}multiply(g){let{endo:m}=e;if(!s.isValidNot0(g))throw new Error("invalid scalar: out of range");let S,T,P=C=>U.cached(this,C,k=>Wl(B,k));if(m){let{k1neg:C,k1:k,k2neg:D,k2:M}=N(g),{p:q,f:W}=P(k),{p:G,f:$}=P(M);T=W.add($),S=A(m.beta,q,G,C,D)}else{let{p:C,f:k}=P(g);S=C,T=k}return Wl(B,[S,T])[0]}multiplyUnsafe(g){let{endo:m}=e,S=this;if(!s.isValid(g))throw new Error("invalid scalar: out of range");if(g===Ni||S.is0())return B.ZERO;if(g===Ph)return S;if(U.hasCache(this))return this.multiply(g);if(m){let{k1neg:T,k1:P,k2neg:C,k2:k}=N(g),{p1:D,p2:M}=iK(B,S,P,k);return A(m.beta,D,M,T,C)}else return U.unsafe(S,g)}toAffine(g){return O(this,g)}isTorsionFree(){let{isTorsionFree:g}=e;return i===Ph?!0:g?g(B,this):U.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:g}=e;return i===Ph?this:g?g(B,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return Li(g,"isCompressed"),this.assertValidity(),p(B,this,g)}toHex(g=!0){return Di(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};l(B,"BASE",new B(o.Gx,o.Gy,n.ONE)),l(B,"ZERO",new B(n.ZERO,n.ONE,n.ZERO)),l(B,"Fp",n),l(B,"Fn",s);let E=B,L=s.BITS,U=new Ih(E,e.endo?Math.ceil(L/2):L);return E.BASE.precompute(8),E}function NK(r){return Uint8Array.of(r?2:3)}function OK(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Ure(r,e={}){let{Fn:t}=r,n=e.randomBytes||xh,s=Object.assign(OK(r.Fp,t),{seed:ES(t.ORDER)});function o(p){try{let y=t.fromBytes(p);return t.isValidNot0(y)}catch{return!1}}function i(p,y){let{publicKey:x,publicKeyUncompressed:b}=s;try{let _=p.length;return y===!0&&_!==x||y===!1&&_!==b?!1:!!r.fromBytes(p)}catch{return!1}}function a(p=n(s.seed)){return vS(Te(p,s.seed,"seed"),t.ORDER)}function c(p,y=!0){return r.BASE.multiply(t.fromBytes(p)).toBytes(y)}function u(p){let{secretKey:y,publicKey:x,publicKeyUncompressed:b}=s;if(!Vl(p)||"_lengths"in t&&t._lengths||y===x)return;let _=Te(p,void 0,"key").length;return _===x||_===b}function f(p,y,x=!0){if(u(p)===!0)throw new Error("first arg must be private key");if(u(y)===!1)throw new Error("second arg must be public key");let b=t.fromBytes(p);return r.fromBytes(y).multiply(b).toBytes(x)}let h={isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a},d=oy(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:d,Point:r,utils:h,lengths:s})}function MK(r,e,t={}){Q6(e),Za(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||xh,s=t.hmac||((g,m)=>JS(e,g,m)),{Fp:o,Fn:i}=r,{ORDER:a,BITS:c}=i,{keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p}=Ure(r,t),y={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},x=a*LK<o.ORDER;function b(g){let m=a>>Ph;return g>m}function _(g,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${g}: out of range 1..Point.Fn.ORDER`);return m}function v(){if(x)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(g,m){t_(m);let S=p.signature,T=m==="compact"?S:m==="recovered"?S+1:void 0;return Te(g,T)}class R{constructor(m,S,T){l(this,"r");l(this,"s");l(this,"recovery");if(this.r=_("r",m),this.s=_("s",S),T!=null){if(v(),![0,1,2,3].includes(T))throw new Error("invalid recovery id");this.recovery=T}Object.freeze(this)}static fromBytes(m,S=y.format){w(m,S);let T;if(S==="der"){let{r:D,s:M}=Qa.toSig(Te(m));return new R(D,M)}S==="recovered"&&(T=m[0],S="compact",m=m.subarray(1));let P=p.signature/2,C=m.subarray(0,P),k=m.subarray(P,P*2);return new R(i.fromBytes(C),i.fromBytes(k),T)}static fromHex(m,S){return this.fromBytes(Bi(m),S)}assertRecovery(){let{recovery:m}=this;if(m==null)throw new Error("invalid recovery id: must be present");return m}addRecoveryBit(m){return new R(this.r,this.s,m)}recoverPublicKey(m){let{r:S,s:T}=this,P=this.assertRecovery(),C=P===2||P===3?S+a:S;if(!o.isValid(C))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let k=o.toBytes(C),D=r.fromBytes(mn(NK((P&1)===0),k)),M=i.inv(C),q=O(Te(m,void 0,"msgHash")),W=i.create(-q*M),G=i.create(T*M),$=r.BASE.multiplyUnsafe(W).add(D.multiplyUnsafe(G));if($.is0())throw new Error("invalid recovery: point at infinify");return $.assertValidity(),$}hasHighS(){return b(this.s)}toBytes(m=y.format){if(t_(m),m==="der")return Bi(Qa.hexFromSig(this));let{r:S,s:T}=this,P=i.toBytes(S),C=i.toBytes(T);return m==="recovered"?(v(),mn(Uint8Array.of(this.assertRecovery()),P,C)):mn(P,C)}toHex(m){return Di(this.toBytes(m))}}let N=t.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");let S=vh(m),T=m.length*8-c;return T>0?S>>BigInt(T):S},O=t.bits2int_modN||function(m){return i.create(N(m))},F=Dp(c);function A(g){return Cp("num < 2^"+c,g,Ni,F),i.toBytes(g)}function E(g,m){return Te(g,void 0,"message"),m?Te(e(g),void 0,"prehashed message"):g}function L(g,m,S){let{lowS:T,prehash:P,extraEntropy:C}=e_(S,y);g=E(g,P);let k=O(g),D=i.fromBytes(m);if(!i.isValidNot0(D))throw new Error("invalid private key");let M=[A(D),A(k)];if(C!=null&&C!==!1){let $=C===!0?n(p.secretKey):C;M.push(Te($,void 0,"extraEntropy"))}let q=mn(...M),W=k;function G($){let X=N($);if(!i.isValidNot0(X))return;let Q=i.inv(X),J=r.BASE.multiply(X).toAffine(),Y=i.create(J.x);if(Y===Ni)return;let re=i.create(Q*i.create(W+Y*D));if(re===Ni)return;let sr=(J.x===Y?0:2)|Number(J.y&Ph),or=re;return T&&b(re)&&(or=i.neg(re),sr^=1),new R(Y,or,x?void 0:sr)}return{seed:q,k2sig:G}}function U(g,m,S={}){let{seed:T,k2sig:P}=L(g,m,S);return qU(e.outputLen,i.BYTES,s)(T,P).toBytes(S.format)}function B(g,m,S,T={}){let{lowS:P,prehash:C,format:k}=e_(T,y);if(S=Te(S,void 0,"publicKey"),m=E(m,C),!Vl(g)){let D=g instanceof R?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+D)}w(g,k);try{let D=R.fromBytes(g,k),M=r.fromBytes(S);if(P&&D.hasHighS())return!1;let{r:q,s:W}=D,G=O(m),$=i.inv(W),X=i.create(G*$),Q=i.create(q*$),J=r.BASE.multiplyUnsafe(X).add(M.multiplyUnsafe(Q));return J.is0()?!1:i.create(J.x)===q}catch{return!1}}function I(g,m,S={}){let{prehash:T}=e_(S,y);return m=E(m,T),R.fromBytes(g,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:u,getPublicKey:f,getSharedSecret:h,utils:d,lengths:p,Point:r,sign:U,verify:B,recoverPublicKey:I,Signature:R,hash:e})}var s_={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Kre={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var UK=BigInt(2);function Fre(r){let e=s_.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,f=u*u*r%e,h=ht(f,t,e)*f%e,d=ht(h,t,e)*f%e,p=ht(d,UK,e)*u%e,y=ht(p,s,e)*p%e,x=ht(y,o,e)*y%e,b=ht(x,a,e)*x%e,_=ht(b,c,e)*b%e,v=ht(_,a,e)*x%e,w=ht(v,t,e)*f%e,R=ht(w,i,e)*y%e,N=ht(R,n,e)*u%e,O=ht(N,UK,e);if(!n_.eql(n_.sqr(O),r))throw new Error("Cannot find square root");return O}var n_=_h(s_.p,{sqrt:Fre}),Vre=kK(s_,{Fp:n_,endo:Kre}),Lh=MK(Vre,Eh);function KK(r,e,t,n){let s=Ee.digest(t instanceof Uint8Array?t:t.subarray());if(cy(s))return s.then(({digest:o})=>(n?.signal?.throwIfAborted(),Lh.verify(e,o,r,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new Lp(String(o))});try{return n?.signal?.throwIfAborted(),Lh.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(o){throw new Lp(String(o))}}var my=class{constructor(e){l(this,"type","secp256k1");l(this,"raw");l(this,"_key");this._key=VK(e),this.raw=FK(this._key)}toMultihash(){return ge.digest($a(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return ie.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:j(this.raw,e.raw)}verify(e,t,n){return KK(this._key,t,e,n)}};function HK(r){return new my(r)}function FK(r){return Lh.Point.fromBytes(r).toBytes()}function VK(r){try{return Lh.Point.fromBytes(r),r}catch(e){throw new Fl(String(e))}}function qK(r,e){let{Type:t,Data:n}=ki.decode(r),s=n??new Uint8Array;switch(t){case nr.RSA:return XS(s,e);case nr.Ed25519:return mK(s);case nr.secp256k1:return HK(s);case nr.ECDSA:return SU(s);default:throw new vp}}function $a(r){return ki.encode({Type:nr[r.type],Data:r.raw})}var Up;(function(r){let e;r.codec=()=>(e==null&&(e=Dh((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={publicKey:fe(0),payloadType:fe(0),payload:fe(0),signature:fe(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=t.bytes();break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Rh(t,r.codec()),r.decode=(t,n)=>Th(t,r.codec(),n)})(Up||(Up={}));var gy=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var Ja=class Ja{constructor(e){l(this,"publicKey");l(this,"payloadType");l(this,"payload");l(this,"signature");l(this,"marshaled");let{publicKey:t,payloadType:n,payload:s,signature:o}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=o}marshal(){return this.marshaled==null&&(this.marshaled=Up.encode({publicKey:$a(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:j(this.marshal(),e.marshal())}async validate(e,t){let n=zK(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}};l(Ja,"createFromProtobuf",e=>{let t=Up.decode(e),n=qK(t.publicKey);return new Ja({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),l(Ja,"seal",async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let s=e.domain,o=e.codec,i=e.marshal(),a=zK(s,o,i),c=await t.sign(a.subarray(),n);return new Ja({publicKey:t.publicKey,payloadType:o,payload:i,signature:c})}),l(Ja,"openAndCertify",async(e,t,n)=>{let s=Ja.createFromProtobuf(e);if(!await s.validate(t,n))throw new gy("Envelope signature is not valid for the given domain");return s});var Kp=Ja,zK=(r,e,t)=>{let n=H(r),s=je(n.byteLength),o=je(e.length),i=je(t.length);return new Z(s,n,o,e,i,t)};var o_=1e3,$K=60*o_,yy=290,GK=15,WK=120*$K,YK=1,ZK=2e3,XK=100,i_="circuit-relay-source",Fp="circuit-relay-relay",by=`${Jv}-circuit-relay`,a_=`${Jv}-circuit-relay-source`,jK=2*$K,QK=BigInt(1<<17),co="/libp2p/circuit/relay/0.2.0/hop",Vp="/libp2p/circuit/relay/0.2.0/stop",JK=30*o_,jOe=30*o_,Hp=300,eF=4096,tF=.001;var Ge;(function(r){let e;(function(s){s.RESERVE="RESERVE",s.CONNECT="CONNECT",s.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.RESERVE=0]="RESERVE",s[s.CONNECT=1]="CONNECT",s[s.STATUS=2]="STATUS"})(t||(t={})),(function(s){s.codec=()=>Kl(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Wn((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.peer!=null&&(o.uint32(18),kh.codec().encode(s.peer,o)),s.reservation!=null&&(o.uint32(26),wy.codec().encode(s.reservation,o)),s.limit!=null&&(o.uint32(34),Nh.codec().encode(s.limit,o)),s.status!=null&&(o.uint32(40),Ce.codec().encode(s.status,o)),i.lengthDelimited!==!1&&o.ldelim()},(s,o,i={})=>{let a={},c=o==null?s.len:s.pos+o;for(;s.pos<c;){let u=s.uint32();switch(u>>>3){case 1:{a.type=r.Type.codec().decode(s);break}case 2:{a.peer=kh.codec().decode(s,s.uint32(),{limits:i.limits?.peer});break}case 3:{a.reservation=wy.codec().decode(s,s.uint32(),{limits:i.limits?.reservation});break}case 4:{a.limit=Nh.codec().decode(s,s.uint32(),{limits:i.limits?.limit});break}case 5:{a.status=Ce.codec().decode(s);break}default:{s.skipType(u&7);break}}}return a})),n),r.encode=s=>Gn(s,r.codec()),r.decode=(s,o)=>$n(s,r.codec(),o)})(Ge||(Ge={}));var Bn;(function(r){let e;(function(s){s.CONNECT="CONNECT",s.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.CONNECT=0]="CONNECT",s[s.STATUS=1]="STATUS"})(t||(t={})),(function(s){s.codec=()=>Kl(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Wn((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.peer!=null&&(o.uint32(18),kh.codec().encode(s.peer,o)),s.limit!=null&&(o.uint32(26),Nh.codec().encode(s.limit,o)),s.status!=null&&(o.uint32(32),Ce.codec().encode(s.status,o)),i.lengthDelimited!==!1&&o.ldelim()},(s,o,i={})=>{let a={},c=o==null?s.len:s.pos+o;for(;s.pos<c;){let u=s.uint32();switch(u>>>3){case 1:{a.type=r.Type.codec().decode(s);break}case 2:{a.peer=kh.codec().decode(s,s.uint32(),{limits:i.limits?.peer});break}case 3:{a.limit=Nh.codec().decode(s,s.uint32(),{limits:i.limits?.limit});break}case 4:{a.status=Ce.codec().decode(s);break}default:{s.skipType(u&7);break}}}return a})),n),r.encode=s=>Gn(s,r.codec()),r.decode=(s,o)=>$n(s,r.codec(),o)})(Bn||(Bn={}));var kh;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={id:fe(0),addrs:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&o.addrs.length===s.limits.addrs)throw new dp('Decode error - map field "addrs" had too many elements');o.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})(kh||(kh={}));var wy;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);t.voucher!=null&&(n.uint32(26),xy.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={expire:0n,addrs:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&o.addrs.length===s.limits.addrs)throw new dp('Decode error - map field "addrs" had too many elements');o.addrs.push(t.bytes());break}case 3:{o.voucher=xy.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})(wy||(wy={}));var Nh;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.duration=t.uint32();break}case 2:{o.data=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})(Nh||(Nh={}));var Ce;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Ce||(Ce={}));var c_;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(c_||(c_={}));(function(r){r.codec=()=>Kl(c_)})(Ce||(Ce={}));var Oh;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={relay:fe(0),peer:fe(0),expiration:0n},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.relay=t.bytes();break}case 2:{o.peer=t.bytes();break}case 3:{o.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})(Oh||(Oh={}));var xy;(function(r){let e;r.codec=()=>(e==null&&(e=Wn((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),Oh.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={publicKey:fe(0),payloadType:fe(0),signature:fe(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=Oh.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>Gn(t,r.codec()),r.decode=(t,n)=>$n(t,r.codec(),n)})(xy||(xy={}));var Ey=class extends Error{constructor(e="Transfer limit error"){super(e),this.name="TransferLimitError"}},qp=class extends Error{constructor(e="Duration limit error"){super(e),this.name="DurationLimitError"}};async function*rF(r,e,t){let n=e.remaining;for await(let s of r){let o=BigInt(s.byteLength);if(e.remaining-o<0){let i=Number(e.remaining);e.remaining=0n;try{i!==0&&(yield s.subarray(0,i))}catch(a){t.log.error(a)}throw new Ey(`data limit of ${n} bytes exceeded`)}e.remaining-=o,yield s}}function nF(r,e,t,n,s){function o(h){r.abort(h),e.abort(h)}let i=[t,n.signal];n.limit?.duration!=null&&(s.log("limiting relayed connection duration to %dms",n.limit.duration),i.push(AbortSignal.timeout(n.limit.duration)));let a=At(i),c=!1,u=!1,f;n.limit?.data!=null&&(f={remaining:n.limit.data}),queueMicrotask(()=>{let h=()=>{s.log("relayed connection reached time limit"),e.abort(new qp(`duration limit of ${n.limit?.duration} ms exceeded`))};a.addEventListener("abort",h,{once:!0}),e.sink(f==null?r.source:rF(r.source,f,s)).catch(d=>{s.log.error("error while relaying streams src -> dst",d),o(d)}).finally(()=>{c=!0,u&&(a.removeEventListener("abort",h),a.clear())})}),queueMicrotask(()=>{let h=()=>{s.log("relayed connection reached time limit"),r.abort(new qp(`duration limit of ${n.limit?.duration} ms exceeded`))};a.addEventListener("abort",h,{once:!0}),r.sink(f==null?e.source:rF(e.source,f,s)).catch(d=>{s.log.error("error while relaying streams dst -> src",d),o(d)}).finally(()=>{u=!0,c&&(a.removeEventListener("abort",h),a.clear())})})}function l_(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var zp=class{constructor(e){l(this,"expires");l(this,"bytes");e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},sF=Xe(Re(DP.matchers[0],Ae("p2p-circuit"),Ue(Fe())));function vy(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}var lo=class{constructor(e){l(this,"map");if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return vy(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return vy(this.map.values(),e=>e.key)}values(){return vy(this.map.values(),e=>e.value)}get size(){return this.map.size}};var $p={hash:r=>Number(Rc(r,{size:32})),hashV:(r,e)=>Hre($p.hash(r,e))};function Hre(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),H(e,"base16")}var u_=64,Rs=class{constructor(e,t,n,s=2){l(this,"fp");l(this,"h");l(this,"seed");if(s>u_)throw new TypeError("Invalid Fingerprint Size");let o=t.hashV(e,n),i=fe(s);for(let a=0;a<i.length;a++)i[a]=o[a];i.length===0&&(i[0]=7),this.fp=i,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?j(this.fp,e.fp):!1}};function Xl(r,e){return Math.floor(Math.random()*(e-r))+r}var jl=class{constructor(e){l(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Rs))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Rs))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Rs))throw new TypeError("Invalid Fingerprint");let t=Xl(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Rs))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var qre=500,Gp=class{constructor(e){l(this,"bucketSize");l(this,"filterSize");l(this,"fingerprintSize");l(this,"buckets");l(this,"count");l(this,"hash");l(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??$p,this.seed=e.seed??Xl(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=H(e));let t=new Rs(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new jl(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new jl(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;let o=[n,s],i=o[Xl(0,o.length-1)];this.buckets[i]==null&&(this.buckets[i]=new jl(this.bucketSize));for(let a=0;a<qre;a++){let c=this.buckets[i].swap(t);if(c!=null&&(i=(i^c.hash())%this.filterSize,this.buckets[i]==null&&(this.buckets[i]=new jl(this.bucketSize)),this.buckets[i].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=H(e));let t=new Rs(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;let o=(n^t.hash())%this.filterSize;return this.buckets[o]?.has(t)??!1}remove(e){typeof e=="string"&&(e=H(e));let t=new Rs(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;let o=(n^t.hash())%this.filterSize,i=this.buckets[o]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},zre={1:.5,2:.84,4:.95,8:.98};function $re(r=.001){return r>.002?2:r>1e-5?4:8}function oF(r,e=.001){let t=$re(e),n=zre[t],s=Math.round(r/n),o=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),u_);return{filterSize:s,bucketSize:t,fingerprintSize:o}}var Sy=class{constructor(e){l(this,"filterSize");l(this,"bucketSize");l(this,"fingerprintSize");l(this,"scale");l(this,"filterSeries");l(this,"hash");l(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??$p,this.seed=e.seed??Xl(0,Math.pow(2,10)),this.filterSeries=[new Gp({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=H(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Gp({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=H(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=H(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function f_(r,e=.001,t){return new Sy({...oF(r,e),...t??{}})}var _y=class{constructor(e,t){l(this,"filter");this.filter=f_(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function h_(r,e=.001){return new _y(r,e)}var d_=class extends lo{constructor(t){super();l(this,"metric");let{name:n,metrics:s}=t;this.metric=s.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){let n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function p_(r){let{name:e,metrics:t}=r,n;return t!=null?n=new d_({name:e,metrics:t}):n=new lo,n}var m_=class extends Error{constructor(t,n,s){super(t??"The operation was aborted");l(this,"type");l(this,"code");this.type="aborted",this.name=s??"AbortError",this.code=n??"ABORT_ERR"}};function iF(r,e){let t=new m_(e?.errorMessage,e?.errorCode,e?.errorName),n=new AbortController,s=()=>{n.abort(t)},o=AbortSignal.timeout(r);o.addEventListener("abort",s);let i=n.signal;return i.reset=a=>{o?.removeEventListener("abort",s),o=AbortSignal.timeout(a??r),o.addEventListener("abort",()=>{n.abort(t)})},i.clear=()=>{o?.removeEventListener("abort",s),o=void 0},i}var Ay=class{constructor(e,t={}){l(this,"reservations");l(this,"maxReservations");l(this,"applyDefaultLimit");l(this,"reservationTtl");l(this,"defaultDurationLimit");l(this,"defaultDataLimit");l(this,"log");this.log=e.logger.forComponent("libp2p:circuit-relay:server:reservation-store"),this.maxReservations=t.maxReservations??GK,this.applyDefaultLimit=t.applyDefaultLimit!==!1,this.reservationTtl=t.reservationTtl??WK,this.defaultDurationLimit=t.defaultDurationLimit??jK,this.defaultDataLimit=t.defaultDataLimit??QK,this.reservations=p_({metrics:e.metrics,name:"libp2p_circuit_relay_server_reservations_total"})}reserve(e,t,n){let s=this.reservations.get(e);if(this.reservations.size>=this.maxReservations&&s==null)return{status:Ce.RESERVATION_REFUSED};let o=new Date(Date.now()+this.reservationTtl),i;return this.applyDefaultLimit&&(i=n??{data:this.defaultDataLimit,duration:this.defaultDurationLimit}),s!=null?(this.log("refreshing reservation for client %p",e),s.signal.reset(this.reservationTtl)):(this.log("creating new reservation for client %p",e),s={addr:t,expiry:o,limit:i,signal:iF(this.reservationTtl)}),this.reservations.set(e,s),s.signal.addEventListener("abort",()=>{this.reservations.delete(e)}),{status:Ce.OK,expire:Math.round(o.getTime()/1e3)}}removeReservation(e){this.reservations.delete(e)}get(e){return this.reservations.get(e)}clear(){this.reservations.clear()}};var Iy=class r{constructor({relay:e,peer:t,expiration:n}){l(this,"domain","libp2p-relay-rsvp");l(this,"codec",new Uint8Array([3,2]));l(this,"relay");l(this,"peer");l(this,"expiration");this.relay=e,this.peer=t,this.expiration=n}marshal(){return Oh.encode({relay:this.relay.toMultihash().bytes,peer:this.peer.toMultihash().bytes,expiration:BigInt(this.expiration)})}equals(e){return!(!(e instanceof r)||!this.peer.equals(e.peer)||!this.relay.equals(e.relay)||this.expiration!==e.expiration)}};var aF=r=>r.protoCodes().includes(yy),Gre={maxOutboundStopStreams:Hp},cF,lF,g_=class extends(lF=Je,cF=Symbol.toStringTag,lF){constructor(t,n={}){super();l(this,"registrar");l(this,"peerStore");l(this,"addressManager");l(this,"peerId");l(this,"privateKey");l(this,"connectionManager");l(this,"connectionGater");l(this,"reservationStore");l(this,"started");l(this,"hopTimeout");l(this,"shutdownController");l(this,"maxInboundHopStreams");l(this,"maxOutboundHopStreams");l(this,"maxOutboundStopStreams");l(this,"log");l(this,cF,"@libp2p/circuit-relay-v2-server");this.log=t.logger.forComponent("libp2p:circuit-relay:server"),this.registrar=t.registrar,this.peerStore=t.peerStore,this.addressManager=t.addressManager,this.peerId=t.peerId,this.privateKey=t.privateKey,this.connectionManager=t.connectionManager,this.connectionGater=t.connectionGater,this.started=!1,this.hopTimeout=n?.hopTimeout??JK,this.maxInboundHopStreams=n.maxInboundHopStreams,this.maxOutboundHopStreams=n.maxOutboundHopStreams,this.maxOutboundStopStreams=n.maxOutboundStopStreams??Gre.maxOutboundStopStreams,this.reservationStore=new Ay(t,n.reservations),this.shutdownController=new AbortController,this.shutdownController.signal}isStarted(){return this.started}async start(){this.started||(await this.registrar.handle(co,t=>{this.onHop(t).catch(n=>{this.log.error(n)})},{maxInboundStreams:this.maxInboundHopStreams,maxOutboundStreams:this.maxOutboundHopStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){this.reservationStore.clear(),this.shutdownController.abort(),await this.registrar.unhandle(co),this.started=!1}async onHop({connection:t,stream:n}){this.log("received circuit v2 hop protocol stream from %p",t.remotePeer);let s={signal:AbortSignal.timeout(this.hopTimeout)},o=bt(n);try{let i=await o.pb(Ge).read(s);if(i?.type==null)throw new Error("request was invalid, could not read from stream");this.log("received",i.type),await this.handleHopProtocol({connection:t,stream:o,request:i},s)}catch(i){this.log.error("error while handling hop",i),await o.pb(Ge).write({type:Ge.Type.STATUS,status:Ce.MALFORMED_MESSAGE},s),n.abort(i)}}async handleHopProtocol({stream:t,request:n,connection:s},o){switch(this.log("received hop message"),n.type){case Ge.Type.RESERVE:await this.handleReserve({stream:t,request:n,connection:s},o);break;case Ge.Type.CONNECT:await this.handleConnect({stream:t,request:n,connection:s},o);break;default:this.log.error("invalid hop request type %s via peer %p",n.type,s.remotePeer),await t.pb(Ge).write({type:Ge.Type.STATUS,status:Ce.UNEXPECTED_MESSAGE})}}async handleReserve({stream:t,connection:n},s){let o=t.pb(Ge);if(this.log("hop reserve request from %p",n.remotePeer),aF(n.remoteAddr)){this.log.error("relay reservation over circuit connection denied for peer: %p",n.remotePeer),await o.write({type:Ge.Type.STATUS,status:Ce.PERMISSION_DENIED},s);return}if(await this.connectionGater.denyInboundRelayReservation?.(n.remotePeer)===!0){this.log.error("reservation for %p denied by connection gater",n.remotePeer),await o.write({type:Ge.Type.STATUS,status:Ce.PERMISSION_DENIED},s);return}let i=this.reservationStore.reserve(n.remotePeer,n.remoteAddr);try{if(i.status!==Ce.OK){await o.write({type:Ge.Type.STATUS,status:i.status},s);return}if(i.expire!=null){let a=i.expire*1e3-Date.now();await this.peerStore.merge(n.remotePeer,{tags:{[i_]:{value:1,ttl:a},[a_]:{value:1,ttl:a}}})}await o.write({type:Ge.Type.STATUS,status:Ce.OK,reservation:await this.makeReservation(n.remotePeer,BigInt(i.expire??0)),limit:this.reservationStore.get(n.remotePeer)?.limit},s),this.log("sent confirmation response to %s",n.remotePeer)}catch(a){this.log.error("failed to send confirmation response to %p - %e",n.remotePeer,a),this.reservationStore.removeReservation(n.remotePeer);try{await this.peerStore.merge(n.remotePeer,{tags:{[i_]:void 0,[a_]:void 0}})}catch(c){this.log.error("failed to untag relay source peer %p - %e",n.remotePeer,c)}}}async makeReservation(t,n){let s=[];for(let i of this.addressManager.getAddresses())i.toString().includes("/p2p-circuit")||s.push(i.bytes);let o=await Kp.seal(new Iy({peer:t,relay:this.peerId,expiration:n}),this.privateKey);return{addrs:s,expire:n,voucher:{publicKey:Na(o.publicKey),payloadType:o.payloadType,payload:{peer:t.toMultihash().bytes,relay:this.peerId.toMultihash().bytes,expiration:n},signature:o.signature}}}async handleConnect({stream:t,request:n,connection:s},o){let i=t.pb(Ge);if(aF(s.remoteAddr)){this.log.error("relay reservation over circuit connection denied for peer: %p",s.remotePeer),await i.write({type:Ge.Type.STATUS,status:Ce.PERMISSION_DENIED},o);return}this.log("hop connect request from %p",s.remotePeer);let a;try{if(n.peer==null)throw this.log.error("no peer info in hop connect request"),new Error("no peer info in request");n.peer.addrs.forEach(xe),a=yh(mt(n.peer.id))}catch(p){this.log.error("invalid hop connect request via peer %p %s",s.remotePeer,p),await i.write({type:Ge.Type.STATUS,status:Ce.MALFORMED_MESSAGE},o);return}let c=this.reservationStore.get(a);if(c==null){this.log.error("hop connect denied for destination peer %p not having a reservation for %p with status %s",a,s.remotePeer,Ce.NO_RESERVATION),await i.write({type:Ge.Type.STATUS,status:Ce.NO_RESERVATION},o);return}if(await this.connectionGater.denyOutboundRelayedConnection?.(s.remotePeer,a)===!0){this.log.error("hop connect for %p to %p denied by connection gater",s.remotePeer,a),await i.write({type:Ge.Type.STATUS,status:Ce.PERMISSION_DENIED},o);return}let u=this.connectionManager.getConnections(a);if(u.length===0){this.log("hop connect denied for destination peer %p not having a connection for %p as there is no destination connection",a,s.remotePeer),await i.write({type:Ge.Type.STATUS,status:Ce.NO_RESERVATION},o);return}let f=u[0],h=await this.stopHop({connection:f,request:{type:Bn.Type.CONNECT,peer:{id:s.remotePeer.toMultihash().bytes,addrs:[]},limit:c?.limit}},o);if(h==null){this.log.error("failed to open stream to destination peer %p",f?.remotePeer),await i.write({type:Ge.Type.STATUS,status:Ce.CONNECTION_FAILED},o);return}await i.write({type:Ge.Type.STATUS,status:Ce.OK,limit:c?.limit},o);let d=t.unwrap();this.log("connection from %p to %p established - merging streams",s.remotePeer,a),nF(d,h,this.shutdownController.signal,c,{log:this.log})}async stopHop({connection:t,request:n},s){this.log("starting circuit relay v2 stop request to %s",t.remotePeer);let o=await t.newStream([Vp],{maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0,...s}),i=bt(o),a=i.pb(Bn);await a.write(n,s);let c;try{c=await a.read(s)}catch{this.log.error("error parsing stop message response from %p",t.remotePeer)}if(c==null){this.log.error("could not read response from %p",t.remotePeer),await o.close(s);return}if(c.status===Ce.OK)return this.log("stop request to %p was successful",t.remotePeer),i.unwrap();this.log("stop request failed with code %d",c.status),await o.close(s)}get reservations(){return this.reservationStore.reservations}};function Ty(r={}){return e=>new g_(e,r)}function Wre(r){return r[Symbol.asyncIterator]!=null}function uF(r){return r?.then!=null}function Yre(r,e){let t=0;if(Wre(r))return(async function*(){for await(let c of r){let u=e(c,t++);uF(u)&&await u,yield c}})();let n=af(r),{value:s,done:o}=n.next();if(o===!0)return(function*(){})();let i=e(s,t++);if(typeof i?.then=="function")return(async function*(){await i,yield s;for(let c of n){let u=e(c,t++);uF(u)&&await u,yield c}})();let a=e;return(function*(){yield s;for(let c of n)a(c,t++),yield c})()}var Ry=Yre;function y_(r){let{stream:e,remoteAddr:t,log:n,onDataRead:s,onDataWrite:o}=r,i=!1,a=!1,c=e.close.bind(e);e.close=async p=>{await c(p),d(!0)};let u=e.abort.bind(e);e.abort=p=>{u(p),d(!0)};let f=e.sink.bind(e);e.sink=async p=>{try{await f(at(p,y=>Ry(y,x=>o?.(x))))}catch(y){h.log.error("errored - %e",y),y.type!=="aborted"&&h.log.error("%s error in sink - %e",t,y)}finally{a=!0,d()}};let h={log:n.newScope("stream-to-maconn"),sink:e.sink,source:(async function*(){try{for await(let p of e.source)s?.(p),yield p}finally{i=!0,d()}})(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function d(p){p===!0&&(i=!0,a=!0),i&&a&&h.timeline.close==null&&(h.timeline.close=Date.now())}return h}function b_(r,e){let t,n=function(){let s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var Wp=class extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};l(Wp,"name","QueueFullError");var Cy=class{constructor(e){l(this,"deferred");l(this,"signal");this.signal=e,this.deferred=ue(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new oo)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Zre(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var Dy=class{constructor(e,t){l(this,"id");l(this,"fn");l(this,"options");l(this,"recipients");l(this,"status");l(this,"timeline");l(this,"controller");this.id=Zre(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new oo),this.cleanup())}async join(e={}){let t=new Cy(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await $e(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var By=class extends Je{constructor(t={}){super();l(this,"concurrency");l(this,"maxSize");l(this,"queue");l(this,"pending");l(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&t.metrics?.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=t.sort,this.queue=[],this.emitEmpty=b_(this.emitEmpty.bind(this),1),this.emitIdle=b_(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let n of this.queue)if(n.status==="queued"){t=n;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let n=0;n<this.queue.length;n++)if(this.queue[n]===t){this.queue.splice(n,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,n){if(n?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Wp;let s=new Dy(t,n);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(n).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===s){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new oo)}),this.clear()}async onEmpty(t){this.size!==0&&await Un(this,"empty",t?.signal)}async onSizeLessThan(t,n){this.size<t||await Un(this,"next",n?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Un(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let n=We({objectMode:!0}),s=u=>{u!=null?this.abort():this.clear(),n.end(u)},o=u=>{u.detail!=null&&n.push(u.detail)},i=u=>{s(u.detail.error)},a=()=>{s()},c=()=>{s(new oo("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("failure",i),this.addEventListener("idle",a),t?.signal?.addEventListener("abort",c);try{yield*n}finally{this.removeEventListener("completed",o),this.removeEventListener("failure",i),this.removeEventListener("idle",a),t?.signal?.removeEventListener("abort",c),s()}}};var Mh=class extends By{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var Py=class extends Je{constructor(t,n={}){super();l(this,"peerStore");l(this,"registrar");l(this,"connectionManager");l(this,"randomWalk");l(this,"started");l(this,"running");l(this,"topologyId");l(this,"log");l(this,"discoveryController");l(this,"filter");this.log=t.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=t.peerStore,this.registrar=t.registrar,this.connectionManager=t.connectionManager,this.randomWalk=t.randomWalk,this.filter=n.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(co,{filter:this.filter,onConnect:t=>{this.log.trace("discovered relay %p",t),this.safeDispatchEvent("relay:discover",{detail:t})}}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{this.log("searching peer store for relays");let t=await this.peerStore.all({filters:[s=>s.protocols.includes(co)],orders:[()=>Math.random()<.5?1:-1]});for(let s of t)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",t.length);let n=new Mh({concurrency:5});this.log("start random walk");for await(let s of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),n.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(this.connectionManager.getConnections(s.id)?.length>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(o=>o.toString()));continue}this.log.trace("wait for space in queue for %p",s.id),await $e(n.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",s.id,n.size),n.add(async()=>{let o=At([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(s.id,{signal:o})}finally{o.clear()}},{peerId:s.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",s.id,o)})}await n.onIdle()}).catch(t=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",t)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}};var w_=class extends Je{constructor(t){super();l(this,"connectionManager");l(this,"reservationStore");l(this,"listeningAddrs");l(this,"log");l(this,"_onRemoveRelayPeer",t=>{let n=this.listeningAddrs.has(t.detail);this.log("relay peer removed %p - had reservation",t.detail,n),n&&(this.listeningAddrs.delete(t.detail),this.safeDispatchEvent("listening"))});this.log=t.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=t.connectionManager,this.reservationStore=t.relayStore,this.listeningAddrs=new lo,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}async listen(t){this.log("listen on %a",t);let n=t.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n);if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer),await this.reservationStore.addRelay(s.remotePeer,"configured");return}let o=this.reservationStore.getReservation(s.remotePeer);if(o==null)throw new wp("Did not have reservation after making reservation");if(this.listeningAddrs.has(s.remotePeer)){this.log("already listening on relay %p",s.remotePeer);return}this.listeningAddrs.set(s.remotePeer,o.addrs.map(i=>xe(i).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening")}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){await this.reservationStore.cancelReservations(),this.listeningAddrs.clear(),this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close")}};function fF(r){return new w_(r)}var Ly={hash:r=>Number(Rc(r,{size:32})),hashV:(r,e)=>Xre(Ly.hash(r,e))};function Xre(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),H(e,"base16")}var jre=Math.LN2*Math.LN2,ky=class{constructor(e={}){l(this,"seeds");l(this,"bits");l(this,"buffer");e.seeds!=null?this.seeds=e.seeds:this.seeds=Jre(e.hashes??8),this.bits=e.bits??1024,this.buffer=fe(Math.ceil(this.bits/8))}add(e){typeof e=="string"&&(e=H(e));for(let t=0;t<this.seeds.length;t++){let s=Ly.hash(e,this.seeds[t])%this.bits;this.setbit(s)}}has(e){typeof e=="string"&&(e=H(e));for(let t=0;t<this.seeds.length;t++){let s=Ly.hash(e,this.seeds[t])%this.bits;if(!this.getbit(s))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=Math.floor(e/8),n=e%8,s=this.buffer[t];s|=1<<n,this.buffer[t]=s}getbit(e){let t=Math.floor(e/8),n=e%8;return(this.buffer[t]&1<<n)!==0}};function x_(r,e=.005){let t=Qre(r,e);return new ky(t)}function Qre(r,e=.005){let t=Math.round(-1*r*Math.log(e)/jre),n=Math.round(t/r*Math.LN2);return{bits:t,hashes:n}}function Jre(r){let e,t,n=[];for(let s=0;s<r;s++)for(e=new Z(z6(4)),n[s]=e.getUint32(0,!0),t=0;t<s;t++)if(n[s]===n[t]){s--;break}return n}var ene=60*1e3*10,tne=60*1e3*5,rne=30*1e3,uo,hF,Uh,Ny=class extends Je{constructor(t,n){super();ne(this,uo);l(this,"peerId");l(this,"connectionManager");l(this,"transportManager");l(this,"peerStore");l(this,"events");l(this,"reserveQueue");l(this,"reservations");l(this,"maxDiscoveredRelays");l(this,"maxReservationQueueLength");l(this,"reservationCompletionTimeout");l(this,"started");l(this,"log");l(this,"relayFilter");this.log=t.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=t.peerId,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.peerStore=t.peerStore,this.events=t.events,this.reservations=new lo,this.maxDiscoveredRelays=n?.discoverRelays??0,this.maxReservationQueueLength=n?.maxReservationQueueLength??XK,this.reservationCompletionTimeout=n?.reservationCompletionTimeout??ZK,this.started=!1,this.relayFilter=x_(100),this.reserveQueue=new Mh({concurrency:n?.reservationConcurrency??YK,metricName:"libp2p_relay_reservation_queue",metrics:t.metrics}),this.events.addEventListener("connection:close",s=>{let o=[...this.reservations.values()].find(i=>i.connection===s.detail.id);o!=null&&ee(this,uo,Uh).call(this,s.detail.remotePeer,o).catch(i=>{this.log("could not remove relay %p - %e",s.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let t=await this.peerStore.all({filters:[n=>n.tags.has(Fp)]});this.log("removing tag from %d old relays",t.length),await Promise.all(t.map(async n=>{await this.peerStore.merge(n.id,{tags:{[Fp]:void 0,[by]:void 0}})})),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}).catch(t=>{this.log.error(t)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:t})=>{clearTimeout(t)}),this.reservations.clear(),this.started=!1}async addRelay(t,n){if(this.peerId.equals(t)){this.log.trace("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){this.log.trace("not adding potential relay peer %p as the queue is full",t);return}if(this.reserveQueue.has(t)){this.log.trace("potential relay peer %p is already in the reservation queue",t);return}if(this.relayFilter.has(t.toMultihash().bytes)){this.log.trace("potential relay peer %p has failed previously, not trying again",t);return}this.log.trace("try to reserve relay slot with %p",t),await this.reserveQueue.add(async()=>{let s=Date.now();try{let o=this.reservations.get(t);if(o!=null){let d=this.connectionManager.getConnections(t),p=!1;if(d.length===0&&this.log("already have relay reservation with %p but we are no longer connected",t),d.map(y=>y.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",t),p=!0),p&&l_(o.reservation.expire)>ene){this.log("already have relay reservation with %p but we are still connected and it does not expire soon",t);return}await ee(this,uo,Uh).call(this,t,o)}if(n==="discovered"&&[...this.reservations.values()].reduce((d,p)=>(p.type==="discovered"&&d++,d),0)>=this.maxDiscoveredRelays){this.log.trace("already have enough discovered relays");return}let i=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(t,{signal:i});if(a.remoteAddr.protoNames().includes("p2p-circuit")){this.log("not creating reservation over relayed connection");return}let c=await ee(this,uo,hF).call(this,a,{signal:i}),u=l_(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",t,new Date(Date.now()+u).toString());let f=Math.min(Math.max(u-tne,rne),Math.pow(2,31)-1),h=setTimeout(()=>{this.log("refresh reservation to relay %p",t),this.addRelay(t,n).catch(async d=>{this.log.error("could not refresh reservation to relay %p - %e",t,d);let p=this.reservations.get(t);if(p==null){this.log.error("did not have reservation after refreshing reservation failed %p",t);return}await ee(this,uo,Uh).call(this,t,p)}).catch(d=>{this.log.error("could not remove expired reservation to relay %p - %e",t,d)})},f);this.reservations.set(t,{timeout:h,reservation:c,type:n,connection:a.id}),await this.peerStore.merge(t,{tags:{[Fp]:{value:1,ttl:u},[by]:{value:1,ttl:u}}}),await this.transportManager.listen([xe(`/p2p/${t.toString()}/p2p-circuit/p2p/${this.peerId.toString()}`)]),this.safeDispatchEvent("relay:created-reservation",{detail:t})}catch(o){this.log.error("could not reserve slot on %p after %dms",t,Date.now()-s,o),this.relayFilter.add(t.toMultihash().bytes);let i=this.reservations.get(t);i!=null&&ee(this,uo,Uh).call(this,t,i).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",t,a)})}},{peerId:t})}hasReservation(t){return this.reservations.has(t)}getReservation(t){return this.reservations.get(t)?.reservation}reservationCount(){return this.reservations.size}async cancelReservations(){await Promise.all([...this.reservations.entries()].map(async([t,n])=>{await ee(this,uo,Uh).call(this,t,n)}))}};uo=new WeakSet,hF=async function(t,n){n.signal?.throwIfAborted(),this.log("requesting reservation from %p",t.remotePeer);let s=await t.newStream(co,n),i=bt(s).pb(Ge);await i.write({type:Ge.Type.RESERVE},n);let a;try{a=await i.read(n)}catch(u){throw s.abort(u),u}finally{s.status!=="closed"&&await s.close(n)}if(a.status===Ce.OK&&a.reservation!=null){let u=new Set;u.add(t.remoteAddr.toString());for(let f of a.reservation.addrs){let h=xe(f);h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${t.remotePeer}`)),h=xe(h.toString().replace(`/p2p/${t.remotePeer}/p2p/${t.remotePeer}`,`/p2p/${t.remotePeer}`)),u.add(h.toString())}return a.reservation.addrs=[...u].map(f=>xe(f).bytes),a.reservation}let c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)},Uh=async function(t,n){if(!this.reservations.has(t)){this.log("not removing relay reservation with %p from local store as we do not have a reservation with this peer",t);return}this.log("removing relay reservation with %p from local store",t),clearTimeout(n.timeout),this.reservations.delete(t),await this.peerStore.merge(t,{tags:{[Fp]:void 0,[by]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:t}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))};var nne=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(xe)}catch{return!1}return!0},E_={maxInboundStopStreams:Hp,maxOutboundStopStreams:Hp,stopTimeout:3e4},dF,pF,mF,gF,Oy=class{constructor(e,t){l(this,"discovery");l(this,"registrar");l(this,"peerStore");l(this,"connectionManager");l(this,"transportManager");l(this,"peerId");l(this,"upgrader");l(this,"addressManager");l(this,"connectionGater");l(this,"reservationStore");l(this,"logger");l(this,"maxInboundStopStreams");l(this,"maxOutboundStopStreams");l(this,"stopTimeout");l(this,"started");l(this,"log");l(this,gF,"@libp2p/circuit-relay-v2-transport");l(this,mF,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);l(this,dF,!0);this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??E_.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??E_.maxOutboundStopStreams,this.stopTimeout=t.stopTimeout??E_.stopTimeout;let n=t.discoverRelays??0;n>0&&(this.discovery=new Py(e,{filter:t.discoveryFilter??h_(eF,tF)}),this.discovery.addEventListener("relay:discover",s=>{this.reservationStore.addRelay(s.detail,"discovered").catch(o=>{this.log.error("could not add discovered relay %p",s.detail,o)})})),this.reservationStore=new Ny(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:created-reservation",()=>{this.reservationStore.reservationCount()>=n&&this.discovery?.stopDiscovery()}),this.started=!1}get[(gF=Symbol.toStringTag,mF=pU,pF=mU,dF=uU,pF)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){await this.registrar.handle(Vp,e=>{this.onStop(e).catch(t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await hU(this.discovery,this.reservationStore),this.started=!0}async stop(){await dU(this.discovery,this.reservationStore),await this.registrar.unhandle(Vp),this.started=!1}async dial(e,t){if(e.protoCodes().filter(y=>y===yy).length!==1){let y="Invalid circuit relay address";throw this.log.error(y,e),new gh(y)}let n=e.toString().split("/p2p-circuit"),s=xe(n[0]),o=xe(n[n.length-1]),i=s.getPeerId(),a=o.getPeerId();if(i==null||a==null){let y=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${y}`),new gh(`C${y}`)}let c=eS(i),u=eS(a),f=!1,d=this.connectionManager.getConnections(c)[0];d==null?(await this.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new ve("circuit-relay:open-connection")),d=await this.connectionManager.openConnection(c,t),f=!0):t.onProgress?.(new ve("circuit-relay:reuse-connection"));let p;try{return t.onProgress?.(new ve("circuit-relay:open-hop-stream")),p=await d.newStream(co),await this.connectV2({stream:p,connection:d,destinationPeer:u,destinationAddr:o,relayAddr:s,ma:e,disconnectOnFailure:f,onProgress:t.onProgress})}catch(y){throw this.log.error("circuit relay dial to destination %p via relay %p failed",u,c,y),p?.abort(y),f&&await d.close(),y}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:s,relayAddr:o,ma:i,disconnectOnFailure:a,onProgress:c}){try{let u=bt(e),f=u.pb(Ge);c?.(new ve("circuit-relay:write-connect-message")),await f.write({type:Ge.Type.CONNECT,peer:{id:n.toMultihash().bytes,addrs:[xe(s).bytes]}}),c?.(new ve("circuit-relay:read-connect-response"));let h=await f.read();if(h.status!==Ce.OK)throw new bp(`failed to connect via relay with status ${h?.status?.toString()??"undefined"}`);let d=new zp(h.limit),p=y_({stream:u.unwrap(),remoteAddr:i,localAddr:o.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:d.onData,onDataWrite:d.onData});return this.log("new outbound relayed connection %a",p.remoteAddr),await this.upgrader.upgradeOutbound(p,{limits:d.getLimits(),onProgress:c})}catch(u){throw this.log.error(`circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,u),a&&await t.close(),u}}createListener(e){return fF({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>sF.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>BP.exactMatch(t))}async onStop({connection:e,stream:t}){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(h){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",h)}let n=AbortSignal.timeout(this.stopTimeout),s=bt(t).pb(Bn),o=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,o.type),o?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:Bn.Type.STATUS,status:Ce.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(o.type!==Bn.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Bn.Type.STATUS,status:Ce.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!nne(o)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Bn.Type.STATUS,status:Ce.MALFORMED_MESSAGE},{signal:n}),await t.close();return}let i=yh(mt(o.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,i)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:Bn.Type.STATUS,status:Ce.PERMISSION_DENIED},{signal:n}),await t.close();return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:Bn.Type.STATUS,status:Ce.OK},{signal:n});let a=new zp(o.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${i.toString()}`),u=this.addressManager.getAddresses()[0],f=y_({stream:s.unwrap().unwrap(),remoteAddr:c,localAddr:u,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",f.remoteAddr),await this.upgrader.upgradeInbound(f,{limits:a.getLimits()}),this.log("%s connection %a upgraded","inbound",f.remoteAddr)}};function My(r={}){return e=>new Oy(e,r)}var yF={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var Yp;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.publicKey=t.bytes();break;case 2:s.payloadType=t.bytes();break;case 3:s.payload=t.bytes();break;case 5:s.signature=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(Yp||(Yp={}));var ec=class ec{constructor(e){l(this,"peerId");l(this,"payloadType");l(this,"payload");l(this,"signature");l(this,"marshaled");let{peerId:t,payloadType:n,payload:s,signature:o}=e;this.peerId=t,this.payloadType=n,this.payload=s,this.signature=o}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=Yp.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return j(this.marshal(),e.marshal())}async validate(e){let t=bF(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return ka(this.peerId.publicKey).verify(t.subarray(),this.signature)}};l(ec,"createFromProtobuf",async e=>{let t=Yp.decode(e),n=await ds(t.publicKey);return new ec({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),l(ec,"seal",async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");let n=e.domain,s=e.codec,o=e.marshal(),i=bF(n,s,o),c=await(await yi(t.privateKey)).sign(i.subarray());return new ec({peerId:t,payloadType:s,payload:o,signature:c})}),l(ec,"openAndCertify",async(e,t)=>{let n=await ec.createFromProtobuf(e);if(!await n.validate(t))throw new K("envelope signature is not valid for the given domain",yF.ERR_SIGNATURE_NOT_VALID);return n});var tc=ec,bF=(r,e,t)=>{let n=H(r),s=je(n.byteLength),o=je(e.length),i=je(t.length);return new Z(s,n,o,e,i,t)};function wF(r,e){let t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}var xF="libp2p-peer-record",EF=Uint8Array.from([3,1]);var Zp;(function(r){let e;(function(n){let s;n.codec=()=>(s==null&&(s=Ne((o,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),o.multiaddr!=null&&o.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(o.multiaddr)),a.lengthDelimited!==!1&&i.ldelim()},(o,i)=>{let a={multiaddr:new Uint8Array(0)},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let u=o.uint32();u>>>3===1?a.multiaddr=o.bytes():o.skipType(u&7)}return a})),s),n.encode=o=>ke(o,n.codec()),n.decode=o=>Le(o,n.codec())})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=Ne((n,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(s.uint32(10),s.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(s.uint32(16),s.uint64(n.seq)),n.addresses!=null)for(let i of n.addresses)s.uint32(26),r.AddressInfo.codec().encode(i,s);o.lengthDelimited!==!1&&s.ldelim()},(n,s)=>{let o={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=s==null?n.len:n.pos+s;for(;n.pos<i;){let a=n.uint32();switch(a>>>3){case 1:o.peerId=n.bytes();break;case 2:o.seq=n.uint64();break;case 3:o.addresses.push(r.AddressInfo.codec().decode(n,n.uint32()));break;default:n.skipType(a&7);break}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=n=>Le(n,r.codec())})(Zp||(Zp={}));var Oi=class Oi{constructor(e){l(this,"peerId");l(this,"multiaddrs");l(this,"seqNumber");l(this,"domain",Oi.DOMAIN);l(this,"codec",Oi.CODEC);l(this,"marshaled");let{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Zp.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Oi)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!wF(this.multiaddrs,e.multiaddrs))}};l(Oi,"createFromProtobuf",e=>{let t=Zp.decode(e),n=Wt(t.peerId),s=(t.addresses??[]).map(i=>xe(i.multiaddr)),o=t.seq;return new Oi({peerId:n,multiaddrs:s,seqNumber:o})}),l(Oi,"DOMAIN",xF),l(Oi,"CODEC",EF);var Mi=Oi;var vF="0.1.0";var SF="1.0.0";var Xp;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let o of t.listenAddrs)n.uint32(18),n.bytes(o);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let o of t.protocols)n.uint32(26),n.string(o);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 5:s.protocolVersion=t.string();break;case 6:s.agentVersion=t.string();break;case 1:s.publicKey=t.bytes();break;case 2:s.listenAddrs.push(t.bytes());break;case 4:s.observedAddr=t.bytes();break;case 3:s.protocols.push(t.string());break;case 8:s.signedPeerRecord=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(Xp||(Xp={}));var fo={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnTransientConnection:!0,concurrency:32};function _F(r){if(r!=null&&r.length>0)try{return xe(r)}catch{}}function ine(r,e){return e!=null||(e=`${r.name}/${r.version}`,MO||NO?e+=` UserAgent=${globalThis.process.version}`:(A6||I6||OO||UO)&&(e+=` UserAgent=${globalThis.navigator.userAgent}`)),e}async function AF(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new K("message was null or undefined","ERR_INVALID_MESSAGE");let o={};if(s.listenAddrs.length>0&&(o.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:xe(c)}))),s.protocols.length>0&&(o.protocols=s.protocols),s.publicKey!=null&&(o.publicKey=s.publicKey,!(await ds(s.publicKey)).equals(n.remotePeer)))throw new K("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let i;if(s.signedPeerRecord!=null){t("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord,u=await tc.openAndCertify(c,Mi.DOMAIN),f=Mi.createFromProtobuf(u.payload);if(!f.peerId.equals(u.peerId))throw new K("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!n.remotePeer.equals(f.peerId))throw new K("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");let h;try{h=await r.get(f.peerId)}catch(d){if(d.code!=="ERR_NOT_FOUND")throw d}if(h!=null&&(o.metadata=h.metadata,h.peerRecordEnvelope!=null)){let d=await tc.createFromProtobuf(h.peerRecordEnvelope),p=Mi.createFromProtobuf(d.payload);p.seqNumber>=f.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,f.seqNumber),f=p,c=h.peerRecordEnvelope)}o.peerRecordEnvelope=c,o.addresses=f.multiaddrs.map(d=>({isCertified:!0,multiaddr:d})),i={seq:f.seqNumber,addresses:f.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t("patching %p with",n.remotePeer,o),await r.patch(n.remotePeer,o),s.agentVersion!=null||s.protocolVersion!=null){let c={};s.agentVersion!=null&&(c.AgentVersion=H(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=H(s.protocolVersion)),t("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}let a={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>xe(c)),observedAddr:s.observedAddr==null?void 0:xe(s.observedAddr),protocols:s.protocols,signedPeerRecord:i,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}var Uy=class{constructor(e,t){l(this,"host");l(this,"protocol");l(this,"started");l(this,"timeout");l(this,"peerId");l(this,"peerStore");l(this,"registrar");l(this,"addressManager");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"maxMessageSize");l(this,"maxObservedAddresses");l(this,"events");l(this,"runOnTransientConnection");l(this,"log");this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??fo.timeout,this.maxInboundStreams=t.maxInboundStreams??fo.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??fo.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??fo.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??fo.maxObservedAddresses,this.runOnTransientConnection=t.runOnTransientConnection??fo.runOnTransientConnection,this.host={protocolVersion:`${t.protocolPrefix??fo.protocolPrefix}/${vF}`,agentVersion:ine(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:H(this.host.agentVersion),ProtocolVersion:H(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}};var IF,TF,Ky=class extends(TF=Uy,IF=Gt,TF){constructor(t,n={}){super(t,{...n,protocol:`/${n.protocolPrefix??fo.protocolPrefix}/${"id"}/${SF}`,log:t.logger.forComponent("libp2p:identify")});l(this,IF,["@libp2p/identify"]);(n.runOnConnectionOpen??fo.runOnConnectionOpen)&&t.events.addEventListener("connection:open",s=>{let o=s.detail;this.identify(o).catch(i=>{this.log.error("error during identify trigged by connection:open",i)})})}async _identify(t,n={}){let s;if(n.signal==null){let o=AbortSignal.timeout(this.timeout);Ze(1/0,o),n={...n,signal:o}}try{s=await t.newStream(this.protocol,{...n,runOnTransientConnection:this.runOnTransientConnection});let i=await bt(s,{maxDataLength:this.maxMessageSize}).pb(Xp).read(n);return await s.close(n),i}catch(o){throw this.log.error("error while reading identify message",o),s?.abort(o),o}}async identify(t,n={}){let s=await this._identify(t,n),{publicKey:o,protocols:i,observedAddr:a}=s;if(o==null)throw new K("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");let c=await ds(o);if(!t.remotePeer.equals(c))throw new K("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(c))throw new K("identified peer is our own peer id?","ERR_INVALID_PEER");let u=_F(a);return this.log("identify completed for peer %p and protocols %o",c,i),this.log("our observed address is %a",u),u!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",u),this.addressManager.addObservedAddr(u)),AF(this.peerStore,this.events,this.log,t,s)}async handleProtocol(t){let{connection:n,stream:s}=t,o=AbortSignal.timeout(this.timeout);Ze(1/0,o);try{let i=this.peerId.publicKey??new Uint8Array(0),a=await this.peerStore.get(this.peerId),c=this.addressManager.getAddresses().map(d=>d.decapsulateCode(Ot("p2p").code)),u=a.peerRecordEnvelope;if(c.length>0&&u==null){let d=new Mi({peerId:this.peerId,multiaddrs:c});u=(await tc.seal(d,this.peerId)).marshal().subarray()}let f=n.remoteAddr.bytes;_P.matches(n.remoteAddr)||(f=void 0),await bt(s).pb(Xp).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:i,listenAddrs:c.map(d=>d.bytes),signedPeerRecord:u,observedAddr:f,protocols:a.protocols},{signal:o}),await s.close({signal:o})}catch(i){this.log.error("could not respond to identify request",i),s.abort(i)}}};function v_(r={}){return e=>new Ky(e,r)}var Kh="ERR_INVALID_FRAME",S_="ERR_UNREQUESTED_PING",__="ERR_NOT_MATCHING_PING",A_="ERR_STREAM_ALREADY_EXISTS",I_="ERR_DECODE_INVALID_VERSION",T_="ERR_BOTH_CLIENTS",R_="ERR_RECV_WINDOW_EXCEEDED",RF=new Set([Kh,S_,__,A_,I_,T_,R_]),rc="ERR_INVALID_CONFIG",Fy="ERR_MUXER_LOCAL_CLOSED",C_="ERR_MUXER_REMOTE_CLOSED";var CF="ERR_STREAM_ABORT",DF="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",BF="ERR_DECODE_IN_PROGRESS",jp=256*1024,PF=16*1024*1024;var LF={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:jp,maxStreamWindowSize:PF,maxMessageSize:64*1024};function kF(r){if(r.keepAliveInterval<=0)throw new K("keep-alive interval must be positive",rc);if(r.maxInboundStreams<0)throw new K("max inbound streams must be larger or equal 0",rc);if(r.maxOutboundStreams<0)throw new K("max outbound streams must be larger or equal 0",rc);if(r.initialStreamWindowSize<jp)throw new K("InitialStreamWindowSize must be larger or equal 256 kB",rc);if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new K("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",rc);if(r.maxStreamWindowSize>2**32-1)throw new K("MaxStreamWindowSize must be less than equal MAX_UINT32",rc);if(r.maxMessageSize<1024)throw new K("MaxMessageSize must be greater than a kilobyte",rc)}var vt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(vt||(vt={}));var dt;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(dt||(dt={}));var sVe=Object.values(dt).filter(r=>typeof r!="string"),NF=0,Zn;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Zn||(Zn={}));var nc=12;var OF=2**24;function cne(r){if(r[0]!==NF)throw new K("Invalid frame version",I_);return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*OF+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*OF+(r[9]<<16)+(r[10]<<8)+r[11]}}var Vy=class{constructor(e){l(this,"source");l(this,"buffer");l(this,"frameInProgress");this.source=lne(e),this.buffer=new Z,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:s}=t;n===vt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new K("decoding frame already in progress",BF);if(this.buffer.length<nc)return;let e=cne(this.buffer.subarray(0,nc));return this.buffer.consume(nc),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function lne(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function D_(r){let e=new Uint8Array(nc);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function MF(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function UF(r,e){let t=ga(r).return?.();MF(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var une="ERR_STREAM_RESET",fne="ERR_SINK_INVALID_STATE",hne=5e3;function B_(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Hy=class{constructor(e){l(this,"id");l(this,"direction");l(this,"timeline");l(this,"protocol");l(this,"metadata");l(this,"source");l(this,"status");l(this,"readStatus");l(this,"writeStatus");l(this,"log");l(this,"sinkController");l(this,"sinkEnd");l(this,"closed");l(this,"endErr");l(this,"streamSource");l(this,"onEnd");l(this,"onCloseRead");l(this,"onCloseWrite");l(this,"onReset");l(this,"onAbort");l(this,"sendCloseWriteTimeout");l(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=ue(),this.closed=ue(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??hne,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=We({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new K(`writable end state is "${this.writeStatus}" not "ready"`,fne);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let s=this.sendNewStream(t);B_(s)&&await s}let n=()=>{UF(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Z(s):s;let o=this.sendData(s,t);B_(o)&&(this.sendingData=ue(),await o,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await $e(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await $e(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await $e(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await $e(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();B_(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new K("stream reset",une);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var Xn;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(Xn||(Xn={}));var qy=class extends Hy{constructor(t){super({...t,onEnd:n=>{this.state=Xn.Finished,t.onEnd?.(n)}});l(this,"name");l(this,"state");l(this,"config");l(this,"_id");l(this,"sendWindowCapacity");l(this,"sendWindowCapacityUpdate");l(this,"recvWindow");l(this,"recvWindowCapacity");l(this,"epochStart");l(this,"getRTT");l(this,"sendFrame");this.config=t.config,this._id=parseInt(t.id,10),this.name=t.name,this.state=t.state,this.sendWindowCapacity=jp,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=t.getRTT,this.sendFrame=t.sendFrame,this.source=Ry(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(t,n={}){for(t=t.sublist();t.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(n),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}let s=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-nc,t.length),o=this.getSendFlags();this.sendFrame({type:vt.Data,flag:o,streamID:this._id,length:s},t.sublist(0,s)),this.sendWindowCapacity-=s,t.consume(s)}}async sendReset(){this.sendFrame({type:vt.WindowUpdate,flag:dt.RST,streamID:this._id,length:0})}async sendCloseWrite(){let t=this.getSendFlags()|dt.FIN;this.sendFrame({type:vt.WindowUpdate,flag:t,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(t={}){if(this.sendWindowCapacity>0)return;let n,s,o=()=>{this.status==="open"||this.status==="closing"?s(new K("stream aborted",CF)):n()};t.signal?.addEventListener("abort",o);try{await new Promise((i,a)=>{this.sendWindowCapacityUpdate=()=>{i()},s=a,n=i})}finally{t.signal?.removeEventListener("abort",o)}}handleWindowUpdate(t){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(t.flag);let n=this.sendWindowCapacity;this.sendWindowCapacity+=t.length,n===0&&t.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(t,n){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(t.flag),this.recvWindowCapacity<t.length)throw new K("receive window exceeded",R_,{available:this.recvWindowCapacity,recv:t.length});let s=await n();this.recvWindowCapacity-=t.length,this.sourcePush(s)}processFlags(t){(t&dt.ACK)===dt.ACK&&this.state===Xn.SYNSent&&(this.state=Xn.Established),(t&dt.FIN)===dt.FIN&&this.remoteCloseWrite(),(t&dt.RST)===dt.RST&&this.reset()}getSendFlags(){switch(this.state){case Xn.Init:return this.state=Xn.SYNSent,dt.SYN;case Xn.SYNReceived:return this.state=Xn.Established,dt.ACK;default:return 0}}sendWindowUpdate(){let t=this.getSendFlags(),n=Date.now(),s=this.getRTT();if(t===0&&s>-1&&n-this.epochStart<s*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&t===0)return;let o=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=n,this.sendFrame({type:vt.WindowUpdate,flag:t,streamID:this._id,length:o})}};var KF="/yamux/1.0.0",dne=500,zy=class{constructor(e,t={}){l(this,"protocol",KF);l(this,"_components");l(this,"_init");this._components=e,this._init=t}createStreamMuxer(e){return new P_(this._components,{...this._init,...e})}},P_=class{constructor(e,t){l(this,"protocol",KF);l(this,"source");l(this,"sink");l(this,"config");l(this,"log");l(this,"logger");l(this,"closeController");l(this,"nextStreamID");l(this,"_streams");l(this,"nextPingID");l(this,"activePing");l(this,"rtt");l(this,"client");l(this,"localGoAway");l(this,"remoteGoAway");l(this,"numInboundStreams");l(this,"numOutboundStreams");l(this,"onIncomingStream");l(this,"onStreamEnd");this.client=t.direction==="outbound",this.config={...LF,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),kF(this.config),this.closeController=new AbortController,Ze(1/0,this.closeController.signal),this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=We({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{let s=()=>{let a=ga(n);if(a.return!=null){let c=a.return();pne(c)&&c.catch(u=>{this.log?.("could not cause sink source to return",u)})}},o,i;try{let a=new Vy(n);try{this.closeController.signal.addEventListener("abort",s);for await(let c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}o=Zn.NormalTermination}catch(a){let c=a.code;RF.has(c)?(this.log?.error("protocol error in sink",a),o=Zn.ProtocolError):(this.log?.error("internal error in sink",a),o=Zn.InternalError),i=a}this.log?.trace("muxer sink ended"),i!=null?this.abort(i,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new K("muxer closed remotely",C_);if(this.localGoAway!==void 0)throw new K("muxer closed locally",Fy);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new K("max outbound streams exceeded",DF);this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,Xn.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new K("muxer closed remotely",C_);if(this.localGoAway!==void 0)throw new K("muxer closed locally",Fy);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,o)=>{let i=()=>{o(new K("muxer closed locally",Fy))};this.closeController.signal.addEventListener("abort",i,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",i),s()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??Zn.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){let n=AbortSignal.timeout(dne);Ze(1/0,n),e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Zn.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new K("Stream already exists",A_,{id:e});let o=new qy({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(o)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return o}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:s,length:o}=e;if(this.log?.trace("received frame %o",e),n===0)switch(s){case vt.Ping:{this.handlePing(e);return}case vt.GoAway:{this.handleGoAway(o);return}default:throw new K("Invalid frame type",Kh,{header:e})}else switch(e.type){case vt.Data:case vt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new K("Invalid frame type",Kh,{header:e})}}handlePing(e){if(e.flag===dt.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,dt.ACK);else if(e.flag===dt.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new K("Invalid frame flag",Kh,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new K("ping not requested",S_);if(this.activePing.id!==e)throw new K("ping doesn't match our id",__);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Zn[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:s,type:o}=e;(s&dt.SYN)===dt.SYN&&this.incomingStream(n);let i=this._streams.get(n);if(i===void 0){if(o===vt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n);return}switch(o){case vt.WindowUpdate:{i.handleWindowUpdate(e);return}case vt.Data:{if(t===void 0)throw new Error("unreachable");await i.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new K("both endpoints are clients",T_);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:vt.WindowUpdate,flag:dt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:vt.WindowUpdate,flag:dt.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,Xn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===vt.Data){if(t===void 0)throw new K("invalid frame",Kh);this.source.push(new Z(D_(e),t))}else this.source.push(D_(e))}sendPing(e,t=dt.SYN){t===dt.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:vt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Zn.NormalTermination){this.log?.("sending GoAway reason=%s",Zn[e]),this.localGoAway=e,this.sendFrame({type:vt.GoAway,flag:0,streamID:0,length:e})}};function pne(r){return r!=null&&typeof r.then=="function"}function L_(r={}){return e=>new zy(e,r)}var k_="/floodsub/1.0.0",N_="/meshsub/1.0.0",O_="/meshsub/1.1.0";var FF="ERR_TOPIC_VALIDATOR_REJECT",VF="ERR_TOPIC_VALIDATOR_IGNORE";var HF={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var Ui;(function(r){let e;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{y.lengthDelimited!==!1&&p.fork(),d.subscribe!=null&&(p.uint32(8),p.bool(d.subscribe)),d.topic!=null&&(p.uint32(18),p.string(d.topic)),y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{x.subscribe=d.bool();break}case 2:{x.topic=d.string();break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(e=r.SubOpts||(r.SubOpts={}));let t;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{y.lengthDelimited!==!1&&p.fork(),d.from!=null&&(p.uint32(10),p.bytes(d.from)),d.data!=null&&(p.uint32(18),p.bytes(d.data)),d.seqno!=null&&(p.uint32(26),p.bytes(d.seqno)),d.topic!=null&&d.topic!==""&&(p.uint32(34),p.string(d.topic)),d.signature!=null&&(p.uint32(42),p.bytes(d.signature)),d.key!=null&&(p.uint32(50),p.bytes(d.key)),y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={topic:""},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{x.from=d.bytes();break}case 2:{x.data=d.bytes();break}case 3:{x.seqno=d.bytes();break}case 4:{x.topic=d.string();break}case 5:{x.signature=d.bytes();break}case 6:{x.key=d.bytes();break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(t=r.Message||(r.Message={}));let n;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{if(y.lengthDelimited!==!1&&p.fork(),d.ihave!=null)for(let x of d.ihave)p.uint32(10),r.ControlIHave.codec().encode(x,p);if(d.iwant!=null)for(let x of d.iwant)p.uint32(18),r.ControlIWant.codec().encode(x,p);if(d.graft!=null)for(let x of d.graft)p.uint32(26),r.ControlGraft.codec().encode(x,p);if(d.prune!=null)for(let x of d.prune)p.uint32(34),r.ControlPrune.codec().encode(x,p);y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={ihave:[],iwant:[],graft:[],prune:[]},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{if(y.limits?.ihave!=null&&x.ihave.length===y.limits.ihave)throw new Vr('decode error - map field "ihave" had too many elements',"ERR_MAX_LENGTH");x.ihave.push(r.ControlIHave.codec().decode(d,d.uint32()));break}case 2:{if(y.limits?.iwant!=null&&x.iwant.length===y.limits.iwant)throw new Vr('decode error - map field "iwant" had too many elements',"ERR_MAX_LENGTH");x.iwant.push(r.ControlIWant.codec().decode(d,d.uint32()));break}case 3:{if(y.limits?.graft!=null&&x.graft.length===y.limits.graft)throw new Vr('decode error - map field "graft" had too many elements',"ERR_MAX_LENGTH");x.graft.push(r.ControlGraft.codec().decode(d,d.uint32()));break}case 4:{if(y.limits?.prune!=null&&x.prune.length===y.limits.prune)throw new Vr('decode error - map field "prune" had too many elements',"ERR_MAX_LENGTH");x.prune.push(r.ControlPrune.codec().decode(d,d.uint32()));break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(n=r.ControlMessage||(r.ControlMessage={}));let s;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{if(y.lengthDelimited!==!1&&p.fork(),d.topicID!=null&&(p.uint32(10),p.string(d.topicID)),d.messageIDs!=null)for(let x of d.messageIDs)p.uint32(18),p.bytes(x);y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={messageIDs:[]},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{x.topicID=d.string();break}case 2:{if(y.limits?.messageIDs!=null&&x.messageIDs.length===y.limits.messageIDs)throw new Vr('decode error - map field "messageIDs" had too many elements',"ERR_MAX_LENGTH");x.messageIDs.push(d.bytes());break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(s=r.ControlIHave||(r.ControlIHave={}));let o;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{if(y.lengthDelimited!==!1&&p.fork(),d.messageIDs!=null)for(let x of d.messageIDs)p.uint32(10),p.bytes(x);y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={messageIDs:[]},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{if(y.limits?.messageIDs!=null&&x.messageIDs.length===y.limits.messageIDs)throw new Vr('decode error - map field "messageIDs" had too many elements',"ERR_MAX_LENGTH");x.messageIDs.push(d.bytes());break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(o=r.ControlIWant||(r.ControlIWant={}));let i;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{y.lengthDelimited!==!1&&p.fork(),d.topicID!=null&&(p.uint32(10),p.string(d.topicID)),y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();_>>>3===1?x.topicID=d.string():d.skipType(_&7)}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(i=r.ControlGraft||(r.ControlGraft={}));let a;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{if(y.lengthDelimited!==!1&&p.fork(),d.topicID!=null&&(p.uint32(10),p.string(d.topicID)),d.peers!=null)for(let x of d.peers)p.uint32(18),r.PeerInfo.codec().encode(x,p);d.backoff!=null&&(p.uint32(24),p.uint64Number(d.backoff)),y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={peers:[]},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{x.topicID=d.string();break}case 2:{if(y.limits?.peers!=null&&x.peers.length===y.limits.peers)throw new Vr('decode error - map field "peers" had too many elements',"ERR_MAX_LENGTH");x.peers.push(r.PeerInfo.codec().decode(d,d.uint32()));break}case 3:{x.backoff=d.uint64Number();break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(a=r.ControlPrune||(r.ControlPrune={}));let c;(function(f){let h;f.codec=()=>(h==null&&(h=Ne((d,p,y={})=>{y.lengthDelimited!==!1&&p.fork(),d.peerID!=null&&(p.uint32(10),p.bytes(d.peerID)),d.signedPeerRecord!=null&&(p.uint32(18),p.bytes(d.signedPeerRecord)),y.lengthDelimited!==!1&&p.ldelim()},(d,p,y={})=>{let x={},b=p==null?d.len:d.pos+p;for(;d.pos<b;){let _=d.uint32();switch(_>>>3){case 1:{x.peerID=d.bytes();break}case 2:{x.signedPeerRecord=d.bytes();break}default:{d.skipType(_&7);break}}}return x})),h),f.encode=d=>ke(d,f.codec()),f.decode=(d,p)=>Le(d,f.codec(),p)})(c=r.PeerInfo||(r.PeerInfo={}));let u;r.codec=()=>(u==null&&(u=Ne((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.subscriptions!=null)for(let p of f.subscriptions)h.uint32(10),r.SubOpts.codec().encode(p,h);if(f.messages!=null)for(let p of f.messages)h.uint32(18),r.Message.codec().encode(p,h);f.control!=null&&(h.uint32(26),r.ControlMessage.codec().encode(f.control,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let p={subscriptions:[],messages:[]},y=h==null?f.len:f.pos+h;for(;f.pos<y;){let x=f.uint32();switch(x>>>3){case 1:{if(d.limits?.subscriptions!=null&&p.subscriptions.length===d.limits.subscriptions)throw new Vr('decode error - map field "subscriptions" had too many elements',"ERR_MAX_LENGTH");p.subscriptions.push(r.SubOpts.codec().decode(f,f.uint32()));break}case 2:{if(d.limits?.messages!=null&&p.messages.length===d.limits.messages)throw new Vr('decode error - map field "messages" had too many elements',"ERR_MAX_LENGTH");p.messages.push(r.Message.codec().decode(f,f.uint32()));break}case 3:{p.control=r.ControlMessage.codec().decode(f,f.uint32());break}default:{f.skipType(x&7);break}}}return p})),u),r.encode=f=>ke(f,r.codec()),r.decode=(f,h)=>Le(f,r.codec(),h)})(Ui||(Ui={}));var $y=class{constructor(e,t,n){l(this,"gossip");l(this,"msgs",new Map);l(this,"msgIdToStrFn");l(this,"history",[]);l(this,"notValidatedCount",0);this.gossip=e,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){let{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){let n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){let n=this.msgs.get(e);if(n==null)return null;let s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){let t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&e.has(s.topic)){let i=t.get(s.topic);i==null&&(i=[],t.set(s.topic,i)),i.push(s.msgId)}});return t}validate(e){let t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;let{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{let n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){let t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}};var qF;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(qF||(qF={}));var sc;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(sc||(sc={}));var Yr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Yr||(Yr={}));var Cr;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Cr||(Cr={}));var Dr;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Dr||(Dr={}));function M_(r){switch(r){case Kr.Ignore:return Yr.Ignore;case Kr.Reject:return Yr.Reject;default:throw new Error("Unreachable")}}var zF;(function(r){r.forward="forward",r.publish="publish"})(zF||(zF={}));var Zr;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(Zr||(Zr={}));var Cs;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(Cs||(Cs={}));var Vh;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(Vh||(Vh={}));var Hh;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(Hh||(Hh={}));var Fh;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Fh||(Fh={}));function $F(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,o){let i=this.toTopic(n);switch(s){case Zr.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:i},o);break;case Zr.Random:this.meshPeerInclusionEventsRandom.inc({topic:i},o);break;case Zr.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:i},o);break;case Zr.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:i},o);break;case Zr.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:i},o);break;case Zr.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:i},o);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:i},o);break}},onRemoveFromMesh(n,s,o){let i=this.toTopic(n);switch(s){case Cs.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:i},o);break;case Cs.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:i},o);break;case Cs.Prune:this.meshPeerChurnEventsPrune.inc({topic:i},o);break;case Cs.Excess:this.meshPeerChurnEventsExcess.inc({topic:i},o);break;default:this.meshPeerChurnEventsUnknown.inc({topic:i},o);break}},onReportValidation(n,s,o){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){let i=this.toTopic(n.message.topic);switch(s){case Kr.Accept:this.acceptedMessagesTotal.inc({topic:i});break;case Kr.Ignore:this.ignoredMessagesTotal.inc({topic:i});break;case Kr.Reject:this.rejectedMessagesTotal.inc({topic:i});break;default:this.unknownValidationResultsTotal.inc({topic:i});break}}o!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-o)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,o){let i=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:i},s),this.ihaveRcvNotSeenMsgids.inc({topic:i},o)},onIwantRcv(n,s){for(let[o,i]of n){let a=this.toTopic(o);this.iwantRcvMsgids.inc({topic:a},i)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){let o=this.toTopic(n);this.msgForwardCount.inc({topic:o},1),this.msgForwardPeers.inc({topic:o},s)},onPublishMsg(n,s,o,i,a){let c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},o*i),this.msgPublishPeersByTopic.inc({topic:c},o),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){let s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){let s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(n,s){let o=this.toTopic(n);switch(s){case Dr.duplicate:this.prevalidationDuplicateTotal.inc({topic:o});break;case Dr.invalid:this.prevalidationInvalidTotal.inc({topic:o});break;case Dr.valid:this.prevalidationValidTotal.inc({topic:o});break;default:this.prevalidationUnknownTotal.inc({topic:o});break}},onMsgRecvInvalid(n,s){let o=this.toTopic(n),i=s.reason===Yr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:i},1),this.msgReceivedInvalidByTopic.inc({topic:o},1)},onDuplicateMsgDelivery(n,s,o){let i=this.toTopic(n);this.duplicateMsgDeliveryDelay.observe({topic:i},s/1e3),o&&this.duplicateMsgLateDelivery.inc({topic:i},1)},onPublishDuplicateMsg(n){let s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){let o=n.control.ihave?.length??0,i=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;o>0&&this.rpcSentIHave.inc(o),i>0&&this.rpcSentIWant.inc(i),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(o>0||i>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let o=0,i=0,a=0,c=0;for(let u of n)u>=s.graylistThreshold&&o++,u>=s.publishThreshold&&i++,u>=s.gossipThreshold&&a++,u>=0&&c++;this.peersByScoreThreshold.set({threshold:Fh.graylist},o),this.peersByScoreThreshold.set({threshold:Fh.publish},i),this.peersByScoreThreshold.set({threshold:Fh.gossip},a),this.peersByScoreThreshold.set({threshold:Fh.mesh},c),this.score.set(n)},registerScoreWeights(n){for(let[s,o]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},o.p1w),this.scoreWeights.set({topic:s,p:"p2"},o.p2w),this.scoreWeights.set({topic:s,p:"p3"},o.p3w),this.scoreWeights.set({topic:s,p:"p3b"},o.p3bw),this.scoreWeights.set({topic:s,p:"p4"},o.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){let o=new Map;n.forEach((i,a)=>{let c=this.topicStrToLabel.get(a)??"unknown",u=o.get(c);u==null&&(u=new Set,o.set(c,u)),i.forEach(f=>u?.add(f))});for(let[i,a]of o){let c=[];a.forEach(u=>{c.push(s.get(u)??0)}),this.scorePerMesh.set({topic:i},c)}}}}var Ye="ERR_INVALID_PEER_SCORE_PARAMS";var gne={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},yne={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function GF(r={}){return{...gne,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=bne(n),e),{}):{}}}function bne(r={}){return{...yne,...r}}function WF(r){for(let[e,t]of Object.entries(r.topics))try{wne(t)}catch(n){throw new K(`invalid score parameters for topic ${e}: ${n.message}`,Ye)}if(r.topicScoreCap<0)throw new K("invalid topic score cap; must be positive (or 0 for no cap)",Ye);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new K("missing application specific score function",Ye);if(r.IPColocationFactorWeight>0)throw new K("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Ye);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new K("invalid IPColocationFactorThreshold; must be at least 1",Ye);if(r.behaviourPenaltyWeight>0)throw new K("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Ye);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new K("invalid BehaviourPenaltyDecay; must be between 0 and 1",Ye);if(r.decayInterval<1e3)throw new K("invalid DecayInterval; must be at least 1s",Ye);if(r.decayToZero<=0||r.decayToZero>=1)throw new K("invalid DecayToZero; must be between 0 and 1",Ye)}function wne(r){if(r.topicWeight<0)throw new K("invalid topic weight; must be >= 0",Ye);if(r.timeInMeshQuantum===0)throw new K("invalid TimeInMeshQuantum; must be non zero",Ye);if(r.timeInMeshWeight<0)throw new K("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Ye);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new K("invalid TimeInMeshQuantum; must be positive",Ye);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new K("invalid TimeInMeshCap; must be positive",Ye);if(r.firstMessageDeliveriesWeight<0)throw new K("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Ye);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new K("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Ye);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new K("invalid FirstMessageDeliveriesCap; must be positive",Ye);if(r.meshMessageDeliveriesWeight>0)throw new K("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Ye);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new K("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Ye);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new K("invalid MeshMessageDeliveriesCap; must be positive",Ye);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new K("invalid MeshMessageDeliveriesThreshold; must be positive",Ye);if(r.meshMessageDeliveriesWindow<0)throw new K("invalid MeshMessageDeliveriesWindow; must be non-negative",Ye);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new K("invalid MeshMessageDeliveriesActivation; must be at least 1s",Ye);if(r.meshFailurePenaltyWeight>0)throw new K("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Ye);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new K("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Ye);if(r.invalidMessageDeliveriesWeight>0)throw new K("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Ye);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new K("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Ye)}var xne={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function YF(r={}){return{...xne,...r}}function Wy(r,e,t=()=>!0){let n=new Set;if(e<=0)return n;for(let s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function ZF(r,e){return Wy(r,e,()=>!0)}var Gy=class extends Map{constructor(t){super();l(this,"getDefault");this.getDefault=t}getOrDefault(t){let n=super.get(t);return n===void 0&&(n=this.getDefault(),this.set(t,n)),n}};function XF(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([i,a])=>{let c=t.topics[i];if(c===void 0)return;let u=0;if(a.inMesh){let p=a.meshTime/c.timeInMeshQuantum;p>c.timeInMeshCap&&(p=c.timeInMeshCap),u+=p*c.timeInMeshWeight}let f=a.firstMessageDeliveries;if(f>c.firstMessageDeliveriesCap&&(f=c.firstMessageDeliveriesCap),u+=f*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){let p=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,y=p*p;u+=y*c.meshMessageDeliveriesWeight}let h=a.meshFailurePenalty;u+=h*c.meshFailurePenaltyWeight;let d=a.invalidMessageDeliveries*a.invalidMessageDeliveries;u+=d*c.invalidMessageDeliveriesWeight,s+=u*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);let o=t.appSpecificScore(r);if(s+=o*t.appSpecificWeight,e.knownIPs.forEach(i=>{if(t.IPColocationFactorWhitelist.has(i))return;let a=n.get(i),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){let u=c-t.IPColocationFactorThreshold,f=u*u;s+=f*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){let i=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=i*i;s+=a*t.behaviourPenaltyWeight}return s}var JF=go(QF(),1);var Xr;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Xr||(Xr={}));var Yy=class{constructor(){l(this,"records");l(this,"queue");this.records=new Map,this.queue=new JF.default}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:Xr.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);let n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){let e=Date.now(),t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}};var Zy=class{constructor(e,t,n,s){l(this,"params");l(this,"metrics");l(this,"peerStats",new Map);l(this,"peerIPs",new Gy(()=>new Set));l(this,"scoreCache",new Map);l(this,"deliveryRecords",new Yy);l(this,"_backgroundInterval");l(this,"scoreCacheValidityMs");l(this,"computeScore");l(this,"log");this.params=e,this.metrics=t,WF(e),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??XF,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){let t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){let e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([o,i])=>{let a=this.params.topics[o];a!==void 0&&(i.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,i.firstMessageDeliveries<t&&(i.firstMessageDeliveries=0),i.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,i.meshMessageDeliveries<t&&(i.meshMessageDeliveries=0),i.meshFailurePenalty*=a.meshFailurePenaltyDecay,i.meshFailurePenalty<t&&(i.meshFailurePenalty=0),i.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,i.invalidMessageDeliveries<t&&(i.invalidMessageDeliveries=0),i.inMesh&&(i.meshTime=e-i.graftTime,i.meshTime>a.meshMessageDeliveriesActivation&&(i.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();let t=this.peerStats.get(e);if(t==null)return 0;let n=Date.now(),s=this.scoreCache.get(e);if(s!=null&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();let o=this.computeScore(e,t,this.params,this.peerIPs),i=n+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(o-s.score)),s.score=o,s.cacheUntil=i):this.scoreCache.set(e,{score:o,cacheUntil:i}),o}addPenalty(e,t,n){let s=this.peerStats.get(e);s!=null&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){let t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){let n=this.peerStats.get(e);n?.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){let n=this.peerStats.get(e);n?.knownIPs.delete(t);let s=this.peerIPs.get(t);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){let t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;let o=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<o){let i=o-s.meshMessageDeliveries;s.meshFailurePenalty+=i*i}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);if(s!=null){let o=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<o){let i=o-s.meshMessageDeliveries;s.meshFailurePenalty+=i*i}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);let s=this.deliveryRecords.ensureRecord(t),o=Date.now();if(s.status!==Xr.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,o-s.firstSeenTsMs,Xr[s.status]);return}s.status=Xr.valid,s.validated=o,s.peers.forEach(i=>{i!==e.toString()&&this.markDuplicateMessageDelivery(i,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Yr.Error:this.markInvalidMessageDelivery(e,n);return;case Yr.Blacklisted:return}let o=this.deliveryRecords.ensureRecord(t);if(o.status!==Xr.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-o.firstSeenTsMs,Xr[o.status]);return}if(s===Yr.Ignore){o.status=Xr.ignored,o.peers.clear();return}o.status=Xr.invalid,this.markInvalidMessageDelivery(e,n),o.peers.forEach(i=>{this.markInvalidMessageDelivery(i,n)}),o.peers.clear()}duplicateMessage(e,t,n){let s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case Xr.unknown:s.peers.add(e);break;case Xr.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case Xr.invalid:this.markInvalidMessageDelivery(e,n);break;case Xr.ignored:break}}markInvalidMessageDelivery(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);if(s!=null){let o=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(o,s.firstMessageDeliveries+1),s.inMesh&&(o=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(o,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){let s=this.peerStats.get(e);if(s!=null){let o=n!==void 0?Date.now():0,i=this.getPtopicStats(s,t);if(i!=null&&i.inMesh){let a=this.params.topics[t];if(n!==void 0){let u=o-n,f=u>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,u,f),f)return}let c=a.meshMessageDeliveriesCap;i.meshMessageDeliveries=Math.min(c,i.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(let n of t){let s=this.peerIPs.get(n);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}};function Ene(r,e,t,n,s){let o=0,i=new Map;if(Object.entries(e.topics).forEach(([d,p])=>{let y=s.get(d)??"unknown",x=t.topics[d];if(x===void 0)return;let b=i.get(y);b==null&&(b={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},i.set(y,b));let _=0,v=0,w=0,R=0,N=0;if(p.inMesh){let E=Math.max(p.meshTime/x.timeInMeshQuantum,x.timeInMeshCap);_+=E*x.timeInMeshWeight}let O=p.firstMessageDeliveries;if(O>x.firstMessageDeliveriesCap&&(O=x.firstMessageDeliveriesCap),v+=O*x.firstMessageDeliveriesWeight,p.meshMessageDeliveriesActive&&p.meshMessageDeliveries<x.meshMessageDeliveriesThreshold){let E=x.meshMessageDeliveriesThreshold-p.meshMessageDeliveries,L=E*E;w+=L*x.meshMessageDeliveriesWeight}let F=p.meshFailurePenalty;R+=F*x.meshFailurePenaltyWeight;let A=p.invalidMessageDeliveries*p.invalidMessageDeliveries;N+=A*x.invalidMessageDeliveriesWeight,o+=(_+v+w+R+N)*x.topicWeight,b.p1w+=_,b.p2w+=v,b.p3w+=w,b.p3bw+=R,b.p4w+=N}),t.topicScoreCap>0&&o>t.topicScoreCap){o=t.topicScoreCap;let d=t.topicScoreCap/o;for(let p of i.values())p.p1w*=d,p.p2w*=d,p.p3w*=d,p.p3bw*=d,p.p4w*=d}let a=0,c=0,u=0,f=t.appSpecificScore(r);a+=f*t.appSpecificWeight,e.knownIPs.forEach(d=>{if(t.IPColocationFactorWhitelist.has(d))return;let p=n.get(d),y=p!=null?p.size:0;if(y>t.IPColocationFactorThreshold){let x=y-t.IPColocationFactorThreshold,b=x*x;c+=b*t.IPColocationFactorWeight}});let h=e.behaviourPenalty*e.behaviourPenalty;return u+=h*t.behaviourPenaltyWeight,o+=a+c+u,{byTopic:i,p5w:a,p6w:c,p7w:u,score:o}}function eV(r,e,t,n,s){let o={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(let i of r){let a=e.get(i);if(a!=null){let c=Ene(i,a,t,n,s);for(let[u,f]of c.byTopic){let h=o.byTopic.get(u);h==null&&(h={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},o.byTopic.set(u,h)),h.p1w.push(f.p1w),h.p2w.push(f.p2w),h.p3w.push(f.p3w),h.p3bw.push(f.p3bw),h.p4w.push(f.p4w)}o.p5w.push(c.p5w),o.p6w.push(c.p6w),o.p7w.push(c.p7w),o.score.push(c.score)}else o.p5w.push(0),o.p6w.push(0),o.p7w.push(0),o.score.push(0)}return o}var Xy=class{constructor(e,t,n){l(this,"rawStream");l(this,"pushable");l(this,"closeController");l(this,"maxBufferSize");this.rawStream=e,this.pushable=We(),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(s=>{e.abort(s)})}),at(this.pushable,this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(ps.single(e))}pushPrefixed(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return()}},jy=class{constructor(e,t={}){l(this,"source");l(this,"rawStream");l(this,"closeController");this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(n=>{e.abort(n)})}),this.source=at(this.rawStream,n=>ms(n,t))}async close(){this.closeController.abort()}};var Qy=class{constructor(e,t,n){l(this,"gossipsubIWantFollowupMs");l(this,"msgIdToStrFn");l(this,"metrics");l(this,"promises",new Map);l(this,"requestMsByMsg",new Map);l(this,"requestMsByMsgExpire");this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){let n=Math.floor(Math.random()*t.length),s=t[n],o=this.msgIdToStrFn(s),i=this.promises.get(o);i==null&&(i=new Map,this.promises.set(o,i));let a=Date.now();i.has(e)||(i.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(o)||this.requestMsByMsg.set(o,a)))}getBrokenPromises(){let e=Date.now(),t=new Map,n=0;return this.promises.forEach((s,o)=>{s.forEach((i,a)=>{i<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size===0&&this.promises.delete(o)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);let n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){this.trackMessage(e),t!==Yr.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){let e=Date.now()-this.requestMsByMsgExpire,t=0;for(let[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){let t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}};var tV=H("libp2p-pubsub:");async function rV(r,e,t,n){switch(r.type){case sc.Signing:{let s={from:r.author.toBytes(),data:n,seqno:ln(8),topic:e,signature:void 0,key:void 0},o=we([tV,Ui.Message.encode(s)]);s.signature=await r.privateKey.sign(o),s.key=r.key;let i={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${z(s.seqno,"base16")}`),topic:e,signature:s.signature,key:s.key};return{raw:s,msg:i}}case sc.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function nV(r,e){switch(r){case yf:return e.signature!=null?{valid:!1,error:Cr.SignaturePresent}:e.seqno!=null?{valid:!1,error:Cr.SeqnoPresent}:e.key!=null?{valid:!1,error:Cr.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case cl:{if(e.seqno==null)return{valid:!1,error:Cr.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Cr.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Cr.InvalidSignature};if(e.from==null)return{valid:!1,error:Cr.InvalidPeerId};let t;try{t=Wt(e.from)}catch{return{valid:!1,error:Cr.InvalidPeerId}}let n;if(e.key!=null){if(n=ka(e.key),t.publicKey!==void 0&&!j(n.bytes,t.publicKey))return{valid:!1,error:Cr.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Cr.InvalidPeerId};n=ka(t.publicKey)}let s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},o=we([tV,Ui.Message.encode(s)]);return await n.verify(o,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${z(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??IE(n)}}:{valid:!1,error:Cr.InvalidSignature}}default:throw new Error("Unreachable")}}function ho(r=[],e){return{subscriptions:[],messages:r,control:e!==void 0?{graft:e.graft??[],prune:e.prune??[],ihave:e.ihave??[],iwant:e.iwant??[]}:void 0}}function U_(r){return r.control===void 0&&(r.control={graft:[],prune:[],ihave:[],iwant:[]}),r}function po(r){if(r.length<=1)return r;let e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){let n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function sV(r){return z(r,"base64")}async function oV(r,e){switch(r){case cl:{if(e==null)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");let t=await yi(e.privateKey);return{type:sc.Signing,author:e,key:e.publicKey,privateKey:t}}case yf:return{type:sc.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}var iV=(r,e)=>{let t=H(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function aV(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return iV(r.from.toBytes(),r.sequenceNumber)}async function cV(r){return Ee.encode(r.data)}var Jy;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(Jy||(Jy={}));function lV(r){for(let e of r.tuples())switch(e[0]){case Jy.ip4:case Jy.ip6:return EP(e[0],e[1]);default:break}return null}var qh=class{constructor(e){l(this,"entries",new Map);l(this,"validityMs");this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){let e=Date.now();for(let[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){let t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}};var Pn;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(Pn||(Pn={}));var fV,hV,dV,pV,e5=class extends(pV=Pt,dV=Symbol.toStringTag,hV=Gt,fV=xf,pV){constructor(t,n={}){super();l(this,"globalSignaturePolicy");l(this,"multicodecs",[O_,N_]);l(this,"publishConfig");l(this,"dataTransform");l(this,"peers",new Set);l(this,"streamsInbound",new Map);l(this,"streamsOutbound",new Map);l(this,"outboundInflightQueue",We({objectMode:!0}));l(this,"direct",new Set);l(this,"floodsubPeers",new Set);l(this,"seenCache");l(this,"acceptFromWhitelist",new Map);l(this,"topics",new Map);l(this,"subscriptions",new Set);l(this,"mesh",new Map);l(this,"fanout",new Map);l(this,"fanoutLastpub",new Map);l(this,"gossip",new Map);l(this,"control",new Map);l(this,"peerhave",new Map);l(this,"iasked",new Map);l(this,"backoff",new Map);l(this,"outbound",new Map);l(this,"msgIdFn");l(this,"fastMsgIdFn");l(this,"msgIdToStrFn");l(this,"fastMsgIdCache");l(this,"publishedMessageIds");l(this,"mcache");l(this,"score");l(this,"topicValidators",new Map);l(this,"log");l(this,"heartbeatTicks",0);l(this,"gossipTracer");l(this,"components");l(this,"directPeerInitial",null);l(this,"opts");l(this,"decodeRpcLimits");l(this,"metrics");l(this,"status",{code:Pn.stopped});l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"runOnTransientConnection");l(this,"allowedTopics");l(this,"heartbeatTimer",null);l(this,dV,"@chainsafe/libp2p-gossipsub");l(this,hV,["@libp2p/pubsub"]);l(this,fV,["@libp2p/identify"]);l(this,"runHeartbeat",()=>{let t=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(n=>{this.log("Error running heartbeat",n)}).finally(()=>{if(t?.(),this.status.code===Pn.started){clearTimeout(this.status.heartbeatTimeout);let n=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;n<this.opts.heartbeatInterval*.25&&(n+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,n)}})});l(this,"tagMeshPeer",t=>{let{peerId:n,topic:s}=t.detail;this.components.peerStore.merge(Qe(n),{tags:{[s]:{value:100}}}).catch(o=>{this.log.error("Error tagging peer %s with topic %s",n,s,o)})});l(this,"untagMeshPeer",t=>{let{peerId:n,topic:s}=t.detail;this.components.peerStore.merge(Qe(n),{tags:{[s]:void 0}}).catch(o=>{this.log.error("Error untagging peer %s with topic %s",n,s,o)})});let s={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,gossipFactor:.25,...n,scoreParams:GF(n.scoreParams),scoreThresholds:YF(n.scoreThresholds)};if(this.components=t,this.decodeRpcLimits=s.decodeRpcLimits??HF,this.globalSignaturePolicy=s.globalSignaturePolicy??cl,s.fallbackToFloodsub&&this.multicodecs.push(k_),this.log=t.logger.forComponent(s.debugName??"libp2p:gossipsub"),this.opts=s,this.direct=new Set(s.directPeers.map(o=>o.id.toString())),this.seenCache=new qh({validityMs:s.seenTTL}),this.publishedMessageIds=new qh({validityMs:s.seenTTL}),n.msgIdFn!=null)this.msgIdFn=n.msgIdFn;else switch(this.globalSignaturePolicy){case cl:this.msgIdFn=aV;break;case yf:this.msgIdFn=cV;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(n.fastMsgIdFn!=null&&(this.fastMsgIdFn=n.fastMsgIdFn,this.fastMsgIdCache=new qh({validityMs:s.seenTTL})),this.msgIdToStrFn=n.msgIdToStrFn??sV,this.mcache=n.messageCache??new $y(s.mcacheGossip,s.mcacheLength,this.msgIdToStrFn),n.dataTransform!=null&&(this.dataTransform=n.dataTransform),n.metricsRegister!=null){if(n.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");let o=Math.max(...Object.values(s.scoreParams.topics).map(a=>a.meshMessageDeliveriesWindow),1e3),i=$F(n.metricsRegister,n.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:s.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:o/1e3});i.mcacheSize.addCollect(()=>{this.onScrapeMetrics(i)});for(let a of this.multicodecs)i.protocolsEnabled.set({protocol:a},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new Qy(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new Zy(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:s.heartbeatInterval}),this.maxInboundStreams=n.maxInboundStreams,this.maxOutboundStreams=n.maxOutboundStreams,this.runOnTransientConnection=n.runOnTransientConnection,this.allowedTopics=s.allowedTopics!=null?new Set(s.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(t=>Qe(t))}isStarted(){return this.status.code===Pn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await oV(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=We({objectMode:!0}),at(this.outboundInflightQueue,async i=>{for await(let{peerId:a,connection:c}of i)await this.createOutboundStream(a,c)}).catch(i=>{this.log.error("outbound inflight queue error",i)}),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.merge(i.id,{multiaddrs:i.addrs})}));let t=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>t.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection})));let n={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnTransient:this.runOnTransientConnection},s=await Promise.all(this.multicodecs.map(async i=>t.register(i,n))),o=setTimeout(this.runHeartbeat,100);this.status={code:Pn.started,registrarTopologyIds:s,heartbeatTimeout:o,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>this.connect(i)))}).catch(i=>{this.log(i)})},1e3),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Pn.started)return;let{registrarTopologyIds:t}=this.status;this.status={code:Pn.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));let n=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>n.unhandle(o))),t.forEach(o=>{n.unregister(o)}),this.outboundInflightQueue.end();let s=[];for(let o of this.streamsOutbound.values())s.push(o.close());this.streamsOutbound.clear();for(let o of this.streamsInbound.values())s.push(o.close());this.streamsInbound.clear(),await Promise.all(s),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:t,connection:n}){if(!this.isStarted())return;let s=n.remotePeer;this.addPeer(s,n.direction,n.remoteAddr),this.createInboundStream(s,t),this.outboundInflightQueue.push({peerId:s,connection:n})}onPeerConnected(t,n){this.metrics?.newConnectionCount.inc({status:n.status}),!(!this.isStarted()||n.status!=="open")&&(this.addPeer(t,n.direction,n.remoteAddr),this.outboundInflightQueue.push({peerId:t,connection:n}))}onPeerDisconnected(t){this.log("connection ended %p",t),this.removePeer(t)}async createOutboundStream(t,n){if(!this.isStarted())return;let s=t.toString();if(this.peers.has(s)&&!this.streamsOutbound.has(s))try{let o=new Xy(await n.newStream(this.multicodecs,{runOnTransientConnection:this.runOnTransientConnection}),a=>{this.log.error("outbound pipe error",a)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",t),this.streamsOutbound.set(s,o);let i=o.protocol;i===k_&&this.floodsubPeers.add(s),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",s),this.sendSubscriptions(s,Array.from(this.subscriptions),!0))}catch(o){this.log.error("createOutboundStream error",o)}}createInboundStream(t,n){if(!this.isStarted())return;let s=t.toString();if(!this.peers.has(s))return;let o=this.streamsInbound.get(s);o!==void 0&&(this.log("replacing existing inbound steam %s",s),o.close().catch(a=>{this.log.error(a)})),this.log("create inbound stream %s",s);let i=new jy(n,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(s,i),this.pipePeerReadStream(t,i.source).catch(a=>{this.log(a)})}addPeer(t,n,s){let o=t.toString();if(!this.peers.has(o)){this.log("new peer %p",t),this.peers.add(o),this.score.addPeer(o);let i=lV(s);i!==null?this.score.addIP(o,i):this.log("Added peer has no IP in current address %s %s",o,s.toString()),this.outbound.has(o)||this.outbound.set(o,n==="outbound")}}removePeer(t){let n=t.toString();if(!this.peers.has(n))return;this.log("delete peer %p",t),this.peers.delete(n);let s=this.streamsOutbound.get(n),o=this.streamsInbound.get(n);s!=null&&this.metrics?.peersPerProtocol.inc({protocol:s.protocol},-1),s?.close().catch(i=>{this.log.error(i)}),o?.close().catch(i=>{this.log.error(i)}),this.streamsOutbound.delete(n),this.streamsInbound.delete(n);for(let i of this.topics.values())i.delete(n);for(let[i,a]of this.mesh)a.delete(n)&&this.metrics?.onRemoveFromMesh(i,Cs.Dc,1);for(let i of this.fanout.values())i.delete(n);this.floodsubPeers.delete(n),this.gossip.delete(n),this.control.delete(n),this.outbound.delete(n),this.score.removePeer(n),this.acceptFromWhitelist.delete(n)}get started(){return this.status.code===Pn.started}getMeshPeers(t){let n=this.mesh.get(t);return n!=null?Array.from(n):[]}getSubscribers(t){let n=this.topics.get(t);return(n!=null?Array.from(n):[]).map(s=>Qe(s))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(t,n){try{await at(n,async s=>{for await(let o of s)try{let i=o.subarray(),a=Ui.decode(i,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos}}}});if(this.metrics?.onRpcRecv(a,i.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(t,a)}catch(c){this.metrics?.onRpcRecvError(),this.log(c)}else this.handleReceivedRpc(t,a).catch(c=>{this.metrics?.onRpcRecvError(),this.log(c)})}catch(i){this.metrics?.onRpcDataError(),this.log(i)}})}catch(s){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(s,t)}}handlePeerReadStreamError(t,n){this.log.error(t),this.onPeerDisconnected(n)}async handleReceivedRpc(t,n){if(!this.acceptFrom(t.toString())){this.log("received message from unacceptable peer %p",t),this.metrics?.rpcRecvNotAccepted.inc();return}let s=n.subscriptions!=null?n.subscriptions.length:0,o=n.messages!=null?n.messages.length:0,i=0,a=0,c=0,u=0;if(n.control!=null&&(n.control.ihave!=null&&(i=n.control.ihave.length),n.control.iwant!=null&&(a=n.control.iwant.length),n.control.graft!=null&&(c=n.control.graft.length),n.control.prune!=null&&(u=n.control.prune.length)),this.log(`rpc.from ${t.toString()} subscriptions ${s} messages ${o} ihave ${i} iwant ${a} graft ${c} prune ${u}`),n.subscriptions!=null&&n.subscriptions.length>0){let f=[];n.subscriptions.forEach(h=>{let d=h.topic,p=h.subscribe===!0;if(d!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(d))return;this.handleReceivedSubscription(t,d,p),f.push({topic:d,subscribe:p})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:t,subscriptions:f}})}for(let f of n.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(f.topic))continue;let h=this.handleReceivedMessage(t,f).catch(d=>{this.metrics?.onMsgRecvError(f.topic),this.log(d)});this.opts.awaitRpcMessageHandler&&await h}n.control!=null&&await this.handleControlMessage(t.toString(),n.control)}handleReceivedSubscription(t,n,s){this.log("subscription update from %p topic %s",t,n);let o=this.topics.get(n);o==null&&(o=new Set,this.topics.set(n,o)),s?o.add(t.toString()):o.delete(t.toString())}async handleReceivedMessage(t,n){this.metrics?.onMsgRecvPreValidation(n.topic);let s=await this.validateReceivedMessage(t,n);this.metrics?.onPrevalidationResult(n.topic,s.code);let o=s.code;switch(o){case Dr.duplicate:this.score.duplicateMessage(t.toString(),s.msgIdStr,n.topic),this.gossipTracer.deliverMessage(s.msgIdStr,!0),this.mcache.observeDuplicate(s.msgIdStr,t.toString());return;case Dr.invalid:if(s.msgIdStr!=null){let i=s.msgIdStr;this.score.rejectMessage(t.toString(),i,n.topic,s.reason),this.gossipTracer.rejectMessage(i,s.reason)}else this.score.rejectInvalidMessage(t.toString(),n.topic);this.metrics?.onMsgRecvInvalid(n.topic,s);return;case Dr.valid:this.score.validateMessage(s.messageId.msgIdStr),this.gossipTracer.deliverMessage(s.messageId.msgIdStr),this.mcache.put(s.messageId,n,!this.opts.asyncValidation),this.subscriptions.has(n.topic)&&(!this.components.peerId.equals(t)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:t,msgId:s.messageId.msgIdStr,msg:s.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:s.msg}))),this.opts.asyncValidation||this.forwardMessage(s.messageId.msgIdStr,n,t.toString());break;default:throw new Error(`Invalid validation result: ${o}`)}}async validateReceivedMessage(t,n){let s=this.fastMsgIdFn?.(n),o=s!==void 0?this.fastMsgIdCache?.get(s):void 0;if(o!=null)return{code:Dr.duplicate,msgIdStr:o};let i=await nV(this.globalSignaturePolicy,n);if(!i.valid)return{code:Dr.invalid,reason:Yr.Error,error:i.error};let a=i.message;try{this.dataTransform!=null&&(a.data=this.dataTransform.inboundTransform(n.topic,a.data))}catch(d){return this.log("Invalid message, transform failed",d),{code:Dr.invalid,reason:Yr.Error,error:Cr.TransformFailed}}let c=await this.msgIdFn(a),u=this.msgIdToStrFn(c),f={msgId:c,msgIdStr:u};if(s!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(s,u)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(u))return{code:Dr.duplicate,msgIdStr:u};this.seenCache.put(u);let h=this.topicValidators.get(n.topic);if(h!=null){let d;try{d=await h(t,a)}catch(p){let y=p.code;y===VF&&(d=Kr.Ignore),y===FF?d=Kr.Reject:d=Kr.Ignore}if(d!==Kr.Accept)return{code:Dr.invalid,reason:M_(d),msgIdStr:u}}return{code:Dr.valid,messageId:f,msg:a}}getScore(t){return this.score.score(t)}sendSubscriptions(t,n,s){this.sendRpc(t,{subscriptions:n.map(o=>({topic:o,subscribe:s})),messages:[]})}async handleControlMessage(t,n){if(n===void 0)return;let s=n.ihave!=null?this.handleIHave(t,n.ihave):[],o=n.iwant!=null?this.handleIWant(t,n.iwant):[],i=n.graft!=null?await this.handleGraft(t,n.graft):[];if(n.prune!=null&&await this.handlePrune(t,n.prune),s.length===0&&o.length===0&&i.length===0)return;let a=this.sendRpc(t,ho(o,{iwant:s,prune:i})),c=s[0]?.messageIDs;c!=null&&(a?this.gossipTracer.addPromise(t,c):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(t){if(this.direct.has(t))return!0;let n=Date.now(),s=this.acceptFromWhitelist.get(t);if(s!=null&&s.messagesAccepted<128&&s.acceptUntil>=n)return s.messagesAccepted+=1,!0;let o=this.score.score(t);return o>=0?this.acceptFromWhitelist.set(t,{messagesAccepted:0,acceptUntil:n+1e3}):this.acceptFromWhitelist.delete(t),o>=this.opts.scoreThresholds.graylistThreshold}handleIHave(t,n){if(n.length===0)return[];let s=this.score.score(t);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",t,s),this.metrics?.ihaveRcvIgnored.inc({reason:Hh.LowScore}),[];let o=(this.peerhave.get(t)??0)+1;if(this.peerhave.set(t,o),o>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",t,o),this.metrics?.ihaveRcvIgnored.inc({reason:Hh.MaxIhave}),[];let i=this.iasked.get(t)??0;if(i>=5e3)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",t,i),this.metrics?.ihaveRcvIgnored.inc({reason:Hh.MaxIasked}),[];let a=new Map;if(n.forEach(({topicID:f,messageIDs:h})=>{if(f==null||h==null||!this.mesh.has(f))return;let d=0;h.forEach(p=>{let y=this.msgIdToStrFn(p);this.seenCache.has(y)||(a.set(y,p),d++)}),this.metrics?.onIhaveRcv(f,h.length,d)}),a.size===0)return[];let c=a.size;c+i>5e3&&(c=5e3-i),this.log("IHAVE: Asking for %d out of %d messages from %s",c,a.size,t);let u=Array.from(a.values());return po(u),u=u.slice(0,c),this.iasked.set(t,i+c),[{messageIDs:u}]}handleIWant(t,n){if(n.length===0)return[];let s=this.score.score(t);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",t,s),[];let o=new Map,i=new Map,a=0;return n.forEach(({messageIDs:c})=>{c?.forEach(u=>{let f=this.msgIdToStrFn(u),h=this.mcache.getWithIWantCount(f,t);if(h==null){a++;return}if(i.set(h.msg.topic,1+(i.get(h.msg.topic)??0)),h.count>3){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",t,u);return}o.set(f,h.msg)})}),this.metrics?.onIwantRcv(i,a),o.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",t),[]):(this.log("IWANT: Sending %d messages to %s",o.size,t),Array.from(o.values()))}async handleGraft(t,n){let s=[],o=this.score.score(t),i=Date.now(),a=this.opts.doPX;if(n.forEach(({topicID:u})=>{if(u==null)return;let f=this.mesh.get(u);if(f==null){a=!1;return}if(f.has(t))return;let h=this.backoff.get(u)?.get(t);if(this.direct.has(t))this.log("GRAFT: ignoring request from direct peer %s",t),s.push(u),a=!1;else if(typeof h=="number"&&i<h){this.log("GRAFT: ignoring backed off peer %s",t),this.score.addPenalty(t,1,Vh.GraftBackoff),a=!1;let d=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<d&&this.score.addPenalty(t,1,Vh.GraftBackoff),this.addBackoff(t,u),s.push(u)}else o<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",t,o,u),s.push(u),a=!1,this.addBackoff(t,u)):f.size>=this.opts.Dhi&&!(this.outbound.get(t)??!1)?(s.push(u),this.addBackoff(t,u)):(this.log("GRAFT: Add mesh link from %s in %s",t,u),this.score.graft(t,u),f.add(t),this.metrics?.onAddToMesh(u,Zr.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:t,topic:u,direction:"inbound"}})}),s.length===0)return[];let c=!1;return Promise.all(s.map(async u=>this.makePrune(t,u,a,c)))}async handlePrune(t,n){let s=this.score.score(t);for(let{topicID:o,backoff:i,peers:a}of n){if(o==null)continue;let c=this.mesh.get(o);if(c==null)return;this.log("PRUNE: Remove mesh link to %s in %s",t,o),this.score.prune(t,o),c.has(t)&&(c.delete(t),this.metrics?.onRemoveFromMesh(o,Cs.Prune,1)),typeof i=="number"&&i>0?this.doAddBackoff(t,o,i*1e3):this.addBackoff(t,o),a!=null&&a.length>0&&(s<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",t,s,o):await this.pxConnect(a)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:t,topic:o,direction:"inbound"}})}}addBackoff(t,n){this.doAddBackoff(t,n,this.opts.pruneBackoff)}doAddBackoff(t,n,s){let o=this.backoff.get(n);o==null&&(o=new Map,this.backoff.set(n,o));let i=Date.now()+s;(o.get(t)??0)<i&&o.set(t,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((t,n)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",n,t),this.score.addPenalty(n,t,Vh.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%15!==0)return;let t=Date.now();this.backoff.forEach((n,s)=>{n.forEach((o,i)=>{o+1*this.opts.heartbeatInterval<t&&n.delete(i)}),n.size===0&&this.backoff.delete(s)})}async directConnect(){let t=[];this.direct.forEach(n=>{this.streamsOutbound.has(n)||t.push(n)}),await Promise.all(t.map(async n=>this.connect(n)))}async pxConnect(t){t.length>this.opts.prunePeers&&(po(t),t=t.slice(0,this.opts.prunePeers));let n=[];await Promise.all(t.map(async s=>{if(s.peerID==null)return;let o=Wt(s.peerID),i=o.toString();if(!this.peers.has(i)){if(s.signedPeerRecord==null){n.push(i);return}try{if(!await this.components.peerStore.consumePeerRecord(s.signedPeerRecord,o)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}n.push(i)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),n.length!==0&&await Promise.all(n.map(async s=>this.connect(s)))}async connect(t){this.log("Initiating connection with %s",t);let n=Qe(t),s=await this.components.connectionManager.openConnection(n);for(let o of this.multicodecs)for(let i of this.components.registrar.getTopologies(o))i.onConnect?.(n,s)}subscribe(t){if(this.status.code!==Pn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(t)){this.subscriptions.add(t);for(let n of this.peers.keys())this.sendSubscriptions(n,[t],!0)}this.join(t)}unsubscribe(t){if(this.status.code!==Pn.started)throw new Error("Pubsub is not started");let n=this.subscriptions.delete(t);if(this.log("unsubscribe from %s - am subscribed %s",t,n),n)for(let s of this.peers.keys())this.sendSubscriptions(s,[t],!1);this.leave(t)}join(t){if(this.status.code!==Pn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(t))return;this.log("JOIN %s",t),this.metrics?.onJoin(t);let n=new Set,s=this.backoff.get(t),o=this.fanout.get(t);if(o!=null&&(this.fanout.delete(t),this.fanoutLastpub.delete(t),o.forEach(i=>{!this.direct.has(i)&&this.score.score(i)>=0&&(s==null||!s.has(i))&&n.add(i)}),this.metrics?.onAddToMesh(t,Zr.Fanout,n.size)),n.size<this.opts.D){let i=n.size;this.getRandomGossipPeers(t,this.opts.D,c=>!n.has(c)&&!this.direct.has(c)&&this.score.score(c)>=0&&(s==null||!s.has(c))).forEach(c=>{n.add(c)}),this.metrics?.onAddToMesh(t,Zr.Random,n.size-i)}this.mesh.set(t,n),n.forEach(i=>{this.log("JOIN: Add mesh link to %s in %s",i,t),this.sendGraft(i,t)})}leave(t){if(this.status.code!==Pn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",t),this.metrics?.onLeave(t);let n=this.mesh.get(t);n!=null&&(Promise.all(Array.from(n).map(async s=>{this.log("LEAVE: Remove mesh link to %s in %s",s,t),await this.sendPrune(s,t)})).catch(s=>{this.log("Error sending prunes to mesh peers",s)}),this.mesh.delete(t))}selectPeersToForward(t,n,s){let o=new Set,i=this.topics.get(t);i!=null&&(this.direct.forEach(c=>{i.has(c)&&n!==c&&!(s?.has(c)??!1)&&o.add(c)}),this.floodsubPeers.forEach(c=>{i.has(c)&&n!==c&&!(s?.has(c)??!1)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold&&o.add(c)}));let a=this.mesh.get(t);return a!=null&&a.size>0&&a.forEach(c=>{n!==c&&!(s?.has(c)??!1)&&o.add(c)}),o}selectPeersToPublish(t){let n=new Set,s={direct:0,floodsub:0,mesh:0,fanout:0},o=this.topics.get(t);if(o!=null)if(this.opts.floodPublish)o.forEach(i=>{this.direct.has(i)?(n.add(i),s.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(n.add(i),s.floodsub++)});else{this.direct.forEach(a=>{o.has(a)&&(n.add(a),s.direct++)}),this.floodsubPeers.forEach(a=>{o.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&(n.add(a),s.floodsub++)});let i=this.mesh.get(t);if(i!=null&&i.size>0)i.forEach(a=>{n.add(a),s.mesh++}),i.size<this.opts.D&&this.getRandomGossipPeers(t,this.opts.D-i.size,c=>!i.has(c)&&!this.direct.has(c)&&!this.floodsubPeers.has(c)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold).forEach(c=>{n.add(c),s.mesh++});else{let a=this.fanout.get(t);if(a!=null&&a.size>0)a.forEach(c=>{n.add(c),s.fanout++});else{let c=this.getRandomGossipPeers(t,this.opts.D,u=>this.score.score(u)>=this.opts.scoreThresholds.publishThreshold);c.size>0&&(this.fanout.set(t,c),c.forEach(u=>{n.add(u),s.fanout++}))}this.fanoutLastpub.set(t,Date.now())}}return{tosend:n,tosendCount:s}}forwardMessage(t,n,s,o){s!=null&&this.score.deliverMessage(s,t,n.topic);let i=this.selectPeersToForward(n.topic,s,o);i.forEach(a=>{this.sendRpc(a,ho([n]))}),this.metrics?.onForwardMsg(n.topic,i.size)}async publish(t,n,s){let o=Date.now(),i=this.dataTransform!=null?this.dataTransform.outboundTransform(t,n):n;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");let{raw:a,msg:c}=await rV(this.publishConfig,t,n,i),u=await this.msgIdFn(c),f=this.msgIdToStrFn(u),h=s?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(f)){if(h)return this.metrics?.onPublishDuplicateMsg(t),{recipients:[]};throw Error("PublishError.Duplicate")}let{tosend:d,tosendCount:p}=this.selectPeersToPublish(t),y=this.opts.emitSelf&&this.subscriptions.has(t),x=s?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(d.size===0&&!x&&!y)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(f),this.mcache.put({msgId:u,msgIdStr:f},a,!0),this.publishedMessageIds.put(f);let b=s?.batchPublish??this.opts.batchPublish,_=ho([a]);if(b)this.sendRpcInBatch(d,_);else for(let w of d)this.sendRpc(w,_)||d.delete(w);let v=Date.now()-o;return this.metrics?.onPublishMsg(t,p,d.size,a.data!=null?a.data.length:0,v),y&&(d.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:f,msg:c}})),super.dispatchEvent(new CustomEvent("message",{detail:c}))),{recipients:Array.from(d.values()).map(w=>Qe(w))}}sendRpcInBatch(t,n){let s=Ui.encode(n),o=ps.single(s);for(let i of t){let a=this.streamsOutbound.get(i);if(a==null){this.log(`Cannot send RPC to ${i} as there is no open stream to it available`),t.delete(i);continue}try{a.pushPrefixed(o)}catch(c){t.delete(i),this.log.error(`Cannot send rpc to ${i}`,c)}this.metrics?.onRpcSent(n,s.length)}}reportMessageValidationResult(t,n,s){let o;if(s===Kr.Accept){if(o=this.mcache.validate(t),o!=null){let{message:a,originatingPeers:c}=o;this.score.deliverMessage(n,t,a.topic),this.forwardMessage(t,o.message,n,c)}}else if(o=this.mcache.remove(t),o!=null){let a=M_(s),{message:c,originatingPeers:u}=o;this.score.rejectMessage(n,t,c.topic,a);for(let f of u)this.score.rejectMessage(f,t,c.topic,a)}let i=this.score.messageFirstSeenTimestampMs(t);this.metrics?.onReportValidation(o,s,i)}sendGraft(t,n){let o=ho([],{graft:[{topicID:n}]});this.sendRpc(t,o)}async sendPrune(t,n){let o=[await this.makePrune(t,n,this.opts.doPX,!0)],i=ho([],{prune:o});this.sendRpc(t,i)}sendRpc(t,n){let s=this.streamsOutbound.get(t);if(s==null)return this.log(`Cannot send RPC to ${t} as there is no open stream to it available`),!1;let o=this.control.get(t);o!=null&&(this.piggybackControl(t,n,o),this.control.delete(t));let i=this.gossip.get(t);i!=null&&(this.piggybackGossip(t,n,i),this.gossip.delete(t));let a=Ui.encode(n);try{s.push(a)}catch(c){return this.log.error(`Cannot send rpc to ${t}`,c),o!=null&&this.control.set(t,o),i!=null&&this.gossip.set(t,i),!1}if(this.metrics?.onRpcSent(n,a.length),n.control?.graft!=null)for(let c of n.control?.graft)c.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:t,topic:c.topicID,direction:"outbound"}});if(n.control?.prune!=null)for(let c of n.control?.prune)c.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:t,topic:c.topicID,direction:"outbound"}});return!0}piggybackControl(t,n,s){let o=U_(n);for(let i of s.graft)i.topicID!=null&&(this.mesh.get(i.topicID)?.has(t)??!1)&&o.control.graft.push(i);for(let i of s.prune)i.topicID!=null&&!(this.mesh.get(i.topicID)?.has(t)??!1)&&o.control.prune.push(i)}piggybackGossip(t,n,s){let o=U_(n);o.control.ihave=s}async sendGraftPrune(t,n,s){let o=this.opts.doPX,i=!1;for(let[a,c]of t){let u=c.map(d=>({topicID:d})),f=[],h=n.get(a);h!=null&&(f=await Promise.all(h.map(async d=>this.makePrune(a,d,o&&!(s.get(a)??!1),i))),n.delete(a)),this.sendRpc(a,ho([],{graft:u,prune:f}))}for(let[a,c]of n){let u=await Promise.all(c.map(async f=>this.makePrune(a,f,o&&!(s.get(a)??!1),i)));this.sendRpc(a,ho([],{prune:u}))}}emitGossip(t){let n=this.mcache.getGossipIDs(new Set(t.keys()));for(let[s,o]of t)this.doEmitGossip(s,o,n.get(s)??[])}doEmitGossip(t,n,s){if(s.length===0||(po(s),s.length>5e3&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",s.length),n.size===0))return;let o=this.opts.Dlazy,a=this.opts.gossipFactor*n.size,c=n;a>o&&(o=a),o>c.size?o=c.size:c=po(Array.from(c)).slice(0,o),c.forEach(u=>{let f=s;s.length>5e3&&(f=po(f.slice()).slice(0,5e3)),this.pushGossip(u,{topicID:t,messageIDs:f})})}flush(){for(let[t,n]of this.gossip.entries())this.gossip.delete(t),this.sendRpc(t,ho([],{ihave:n}));for(let[t,n]of this.control.entries()){this.control.delete(t);let s=ho([],{graft:n.graft,prune:n.prune});this.sendRpc(t,s)}}pushGossip(t,n){this.log("Add gossip to %s",t);let s=this.gossip.get(t)??[];this.gossip.set(t,s.concat(n))}async makePrune(t,n,s,o){if(this.score.prune(t,n),this.streamsOutbound.get(t)?.protocol===N_)return{topicID:n,peers:[]};let i=o?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,a=i/1e3;if(this.doAddBackoff(t,n,i),!s)return{topicID:n,peers:[],backoff:a};let c=this.getRandomGossipPeers(n,this.opts.prunePeers,f=>f!==t&&this.score.score(f)>=0),u=await Promise.all(Array.from(c).map(async f=>{let h=Qe(f),d;try{d=await this.components.peerStore.get(h)}catch(p){if(p.code!=="ERR_NOT_FOUND")throw p}return{peerID:h.toBytes(),signedPeerRecord:d?.peerRecordEnvelope}}));return{topicID:n,peers:u,backoff:a}}async heartbeat(){let{D:t,Dlo:n,Dhi:s,Dscore:o,Dout:i,fanoutTTL:a}=this.opts;this.heartbeatTicks++;let c=new Map,u=x=>{let b=c.get(x);return b===void 0&&(b=this.score.score(x),c.set(x,b)),b},f=new Map,h=new Map,d=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();let p=new Map;this.mesh.forEach((x,b)=>{let _=this.topics.get(b),v=new Set,w=new Set;if(p.set(b,w),_!=null){let O=po(Array.from(_)),F=this.backoff.get(b);for(let A of O){let E=this.streamsOutbound.get(A);if(E!=null&&this.multicodecs.includes(E.protocol)&&!x.has(A)&&!this.direct.has(A)){let L=u(A);(F==null||!F.has(A))&&L>=0&&v.add(A),L>=this.opts.scoreThresholds.gossipThreshold&&w.add(A)}}}let R=(O,F)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",O,b),this.addBackoff(O,b),x.delete(O),u(O)>=this.opts.scoreThresholds.gossipThreshold&&w.add(O),this.metrics?.onRemoveFromMesh(b,F,1);let A=h.get(O);A==null?h.set(O,[b]):A.push(b)},N=(O,F)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",O,b),this.score.graft(O,b),x.add(O),w.delete(O),this.metrics?.onAddToMesh(b,F,1);let A=f.get(O);A==null?f.set(O,[b]):A.push(b)};if(x.forEach(O=>{let F=u(O);F<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",O,F,b),R(O,Cs.BadScore),d.set(O,!0))}),x.size<n){let O=t-x.size;ZF(v,O).forEach(A=>{N(A,Zr.NotEnough)})}if(x.size>s){let O=Array.from(x);O.sort((A,E)=>u(E)-u(A)),O=O.slice(0,o).concat(po(O.slice(o)));let F=0;if(O.slice(0,t).forEach(A=>{(this.outbound.get(A)??!1)&&F++}),F<i){let A=L=>{let U=O[L];for(let B=L;B>0;B--)O[B]=O[B-1];O[0]=U};if(F>0){let L=F;for(let U=1;U<t&&L>0;U++)(this.outbound.get(O[U])??!1)&&(A(U),L--)}let E=t-F;for(let L=t;L<O.length&&E>0;L++)(this.outbound.get(O[L])??!1)&&(A(L),E--)}O.slice(t).forEach(A=>{R(A,Cs.Excess)})}if(x.size>=n){let O=0;if(x.forEach(F=>{(this.outbound.get(F)??!1)&&O++}),O<i){let F=i-O;Wy(v,F,E=>this.outbound.get(E)===!0).forEach(E=>{N(E,Zr.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&x.size>1){let O=Array.from(x).sort((E,L)=>u(E)-u(L)),F=Math.floor(x.size/2),A=u(O[F]);if(A<this.opts.scoreThresholds.opportunisticGraftThreshold){let E=this.opts.opportunisticGraftPeers,L=Wy(v,E,U=>u(U)>A);for(let U of L)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",U,b),N(U,Zr.Opportunistic)}}});let y=Date.now();this.fanoutLastpub.forEach((x,b)=>{x+a<y&&(this.fanout.delete(b),this.fanoutLastpub.delete(b))}),this.fanout.forEach((x,b)=>{let _=this.topics.get(b);x.forEach(N=>{(!(_?.has(N)??!1)||u(N)<this.opts.scoreThresholds.publishThreshold)&&x.delete(N)});let v=this.topics.get(b),w=[],R=new Set;if(p.set(b,R),v!=null){let N=po(Array.from(v));for(let O of N){let F=this.streamsOutbound.get(O);if(F!=null&&this.multicodecs.includes(F.protocol)&&!x.has(O)&&!this.direct.has(O)){let A=u(O);A>=this.opts.scoreThresholds.publishThreshold&&w.push(O),A>=this.opts.scoreThresholds.gossipThreshold&&R.add(O)}}}if(x.size<t){let N=t-x.size;w.slice(0,N).forEach(O=>{x.add(O),R?.delete(O)})}}),this.emitGossip(p),await this.sendGraftPrune(f,h,d),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(t,n,s=()=>!0){let o=this.topics.get(t);if(o==null)return new Set;let i=[];return o.forEach(a=>{let c=this.streamsOutbound.get(a);c!=null&&this.multicodecs.includes(c.protocol)&&s(a)&&i.push(a)}),i=po(i),n>0&&i.length>n&&(i=i.slice(0,n)),new Set(i)}onScrapeMetrics(t){t.mcacheSize.set(this.mcache.size),t.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),t.cacheSize.set({cache:"direct"},this.direct.size),t.cacheSize.set({cache:"seenCache"},this.seenCache.size),t.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),t.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),t.cacheSize.set({cache:"mcache"},this.mcache.size),t.cacheSize.set({cache:"score"},this.score.size),t.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),t.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),t.cacheSize.set({cache:"topics"},this.topics.size),t.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),t.cacheSize.set({cache:"mesh"},this.mesh.size),t.cacheSize.set({cache:"fanout"},this.fanout.size),t.cacheSize.set({cache:"peers"},this.peers.size),t.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),t.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),t.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),t.cacheSize.set({cache:"gossip"},this.gossip.size),t.cacheSize.set({cache:"control"},this.control.size),t.cacheSize.set({cache:"peerhave"},this.peerhave.size),t.cacheSize.set({cache:"outbound"},this.outbound.size);let n=0,s=Date.now();t.connectedPeersBackoffSec.reset();for(let c of this.backoff.values()){n+=c.size;for(let[u,f]of c.entries())this.peers.has(u)&&t.connectedPeersBackoffSec.observe(Math.max(0,f-s)/1e3)}t.cacheSize.set({cache:"backoff"},n);for(let[c,u]of this.topics)t.topicPeersCount.set({topicStr:c},u.size);for(let[c,u]of this.mesh)t.meshPeerCounts.set({topicStr:c},u.size);let o=[],i=new Map;t.behaviourPenalty.reset();for(let c of this.peers.keys()){let u=this.score.score(c);o.push(u),i.set(c,u),t.behaviourPenalty.observe(this.score.peerStats.get(c)?.behaviourPenalty??0)}t.registerScores(o,this.opts.scoreThresholds),t.registerScorePerMesh(this.mesh,i);let a=eV(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,t.topicStrToLabel);t.registerScoreWeights(a)}};l(e5,"multicodec",O_);function K_(r={}){return e=>new e5(e,r)}var mV="/ipfs/kad/1.0.0",gV="/dht/record",F_="/dht/provider";var V_=new Float32Array([-0]),oc=new Uint8Array(V_.buffer);function yV(r,e,t){V_[0]=r,e[t]=oc[0],e[t+1]=oc[1],e[t+2]=oc[2],e[t+3]=oc[3]}function bV(r,e){return oc[0]=r[e],oc[1]=r[e+1],oc[2]=r[e+2],oc[3]=r[e+3],V_[0]}var H_=new Float64Array([-0]),Br=new Uint8Array(H_.buffer);function wV(r,e,t){H_[0]=r,e[t]=Br[0],e[t+1]=Br[1],e[t+2]=Br[2],e[t+3]=Br[3],e[t+4]=Br[4],e[t+5]=Br[5],e[t+6]=Br[6],e[t+7]=Br[7]}function xV(r,e){return Br[0]=r[e],Br[1]=r[e+1],Br[2]=r[e+2],Br[3]=r[e+3],Br[4]=r[e+4],Br[5]=r[e+5],Br[6]=r[e+6],Br[7]=r[e+7],H_[0]}var Wne=BigInt(Number.MAX_SAFE_INTEGER),Yne=BigInt(Number.MIN_SAFE_INTEGER),Ln=class r{constructor(e,t){l(this,"lo");l(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Ql;if(e<Wne&&e>Yne)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>EV&&(s=0n,++n>EV&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return Ql;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Ql}},Ql=new Ln(0,0);Ql.toBigInt=function(){return 0n};Ql.zzEncode=Ql.zzDecode=function(){return this};Ql.length=function(){return 1};var EV=4294967296n;function vV(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function SV(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function q_(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function Ds(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function t5(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var z_=class{constructor(e){l(this,"buf");l(this,"pos");l(this,"len");l(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Ds(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Ds(this,4);return t5(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Ds(this,4);return t5(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Ds(this,4);let e=bV(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Ds(this,4);let e=xV(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Ds(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return SV(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Ds(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Ds(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Ln(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Ds(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Ds(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Ds(this,8);let e=t5(this.buf,this.pos+=4),t=t5(this.buf,this.pos+=4);return new Ln(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=gn(this.buf,this.pos);return this.pos+=ce(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function $_(r){return new z_(r instanceof Uint8Array?r:r.subarray())}function G_(r,e,t){let n=$_(r);return e.decode(n,void 0,t)}function W_(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return pe(i);s+i>e&&(n=pe(e),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var Jl=class{constructor(e,t,n){l(this,"fn");l(this,"len");l(this,"next");l(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}};function Y_(){}var X_=class{constructor(e){l(this,"head");l(this,"tail");l(this,"len");l(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},Zne=W_();function Xne(r){return globalThis.Buffer!=null?pe(r):Zne(r)}var Jp=class{constructor(){l(this,"len");l(this,"head");l(this,"tail");l(this,"states");this.len=0,this.head=new Jl(Y_,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Jl(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new j_((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(r5,10,Ln.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Ln.fromBigInt(e);return this._push(r5,t.length(),t)}uint64Number(e){return this._push(Et,ce(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Ln.fromBigInt(e).zzEncode();return this._push(r5,t.length(),t)}sint64Number(e){let t=Ln.fromNumber(e).zzEncode();return this._push(r5,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Z_,1,e?1:0)}fixed32(e){return this._push(Qp,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Ln.fromBigInt(e);return this._push(Qp,4,t.lo)._push(Qp,4,t.hi)}fixed64Number(e){let t=Ln.fromNumber(e);return this._push(Qp,4,t.lo)._push(Qp,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(yV,4,e)}double(e){return this._push(wV,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(Z_,1,0):this.uint32(t)._push(Qne,t,e)}string(e){let t=vV(e);return t!==0?this.uint32(t)._push(q_,t,e):this._push(Z_,1,0)}fork(){return this.states=new X_(this),this.head=this.tail=new Jl(Y_,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Jl(Y_,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=Xne(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function Z_(r,e,t){e[t]=r&255}function jne(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var j_=class extends Jl{constructor(t,n){super(jne,t,n);l(this,"next");this.next=void 0}};function r5(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Qp(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Qne(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Jp.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(Jne,e,r),this},Jp.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(ese,e,r),this});function Jne(r,e,t){e.set(r,t)}function ese(r,e,t){r.length<40?q_(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(H(r),t)}function Q_(){return new Jp}function J_(r,e){let t=Q_();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var e2;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(e2||(e2={}));function eA(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function tA(r,e){return eA("message",e2.LENGTH_DELIMITED,r,e)}var t2;(function(r){let e;r.codec=()=>(e==null&&(e=tA((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{let o={key:fe(0),value:fe(0),timeReceived:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let a=t.uint32();switch(a>>>3){case 1:{o.key=t.bytes();break}case 2:{o.value=t.bytes();break}case 5:{o.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>J_(t,r.codec()),r.decode=(t,n)=>G_(t,r.codec(),n)})(t2||(t2={}));function AV(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),o=String(r.getUTCMinutes()).padStart(2,"0"),i=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${o}:${i}.${c}Z`}function IV(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),s=parseInt(t[2],10)-1,o=parseInt(t[3],10),i=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,o,i,a,c,u))}var gr=class r{constructor(e,t,n){l(this,"key");l(this,"value");l(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return t2.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:AV(this.timeReceived)}}static deserialize(e){let t=t2.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=IV(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};function rse(r){return r[Symbol.asyncIterator]!=null}function nse(r,e){let t=0;if(rse(r))return(async function*(){for await(let c of r)yield e(c,t++)})();let n=af(r),{value:s,done:o}=n.next();if(o===!0)return(function*(){})();let i=e(s,t++);if(typeof i.then=="function")return(async function*(){yield await i;for(let c of n)yield e(c,t++)})();let a=e;return(function*(){yield i;for(let c of n)yield a(c,t++)})()}var $h=nse;var TV;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(TV||(TV={}));var Ke;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(Ke||(Ke={}));var n5;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(n5||(n5={}));(function(r){r.codec=()=>Fn(n5)})(Ke||(Ke={}));var Wh;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Wh||(Wh={}));var rA;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(rA||(rA={}));(function(r){r.codec=()=>Fn(rA)})(Wh||(Wh={}));var Gh;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let o of t.multiaddrs)n.uint32(18),n.bytes(o);t.connection!=null&&(n.uint32(24),Wh.codec().encode(t.connection,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={id:fe(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.id=t.bytes();break}case 2:{s.multiaddrs.push(t.bytes());break}case 3:{s.connection=Wh.codec().decode(t);break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(Gh||(Gh={}));var jn;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.type!=null&&n5[t.type]!==0&&(n.uint32(8),Ke.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let o of t.closer)n.uint32(66),Gh.codec().encode(o,n);if(t.providers!=null)for(let o of t.providers)n.uint32(74),Gh.codec().encode(o,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={type:Ke.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.type=Ke.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{s.closer.push(Gh.codec().decode(t,t.uint32()));break}case 9:{s.providers.push(Gh.codec().decode(t,t.uint32()));break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(jn||(jn={}));function nA(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new En("kad-dht:query:send-query",{detail:t})),t}function r2(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new En("kad-dht:query:peer-response",{detail:t})),t}function s5(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new En("kad-dht:query:final-peer",{detail:t})),t}function kn(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new En("kad-dht:query:query-error",{detail:t})),t}function sA(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new En("kad-dht:query:provider",{detail:t})),t}function n2(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new En("kad-dht:query:value",{detail:t})),t}function oA(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new En("kad-dht:query:dial-peer",{detail:t})),t}function RV(r,e,t){if(t.length===0){let i="No records given";throw new K(i,"ERR_NO_RECORDS_RECEIVED")}let s=z(e).split("/");if(s.length<3){let i="Record key does not have a selector function";throw new K(i,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}let o=r[s[1].toString()];if(o==null){let i=`No selector function configured for key type "${s[1]}"`;throw new K(i,"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:o(e,t)}function sse(r,e){return 0}var CV={pk:sse};async function Yh(r,e){let t=e.key,s=z(t).split("/");if(s.length<3)return;let o=r[s[1].toString()];if(o==null){let i=`No validator available for key type "${s[1]}"`;throw new K(i,"ERR_INVALID_RECORD_KEY_TYPE")}await o(t,e.value)}var ose=async(r,e)=>{if(!(r instanceof Uint8Array))throw new K('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw new K("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(z(r.subarray(0,4))!=="/pk/")throw new K("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");let n=r.slice(4),s=await Ee.digest(e);if(!j(n,s.bytes))throw new K("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},DV={pk:ose};var BV=go(Nb(),1),ise=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],ase=ise.map(r=>new BV.Netmask(r));function iA(r){for(let e of ase)if(e.contains(r))return!0;return!1}function cse(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function lse(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return iA(s)}function use(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function fse(r){let e=r.split(":"),t=e[e.length-1];return iA(t)}function hse(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function o5(r){return gt(r)?iA(r):cse(r)?lse(r):use(r)?fse(r):Nn(r)?hse(r):void 0}var Ki="/",PV=new TextEncoder().encode(Ki),i5=PV[0],Zh=class r{constructor(e,t){l(this,"_buf");if(typeof e=="string")this._buf=H(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==i5)throw new Error("Invalid key")}toString(e="utf8"){return z(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Ki))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=PV),this._buf[0]!==i5){let e=new Uint8Array(this._buf.byteLength+1);e.fill(i5,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===i5;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;let o=t[s],i=n[s];if(o<i)return!0;if(o>i)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Ki).slice(1)}type(){return dse(this.baseNamespace())}name(){return pse(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Ki)||(e+=Ki),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Ki):new r(e.slice(0,-1).join(Ki))}child(e){return this.toString()===Ki?e:e.toString()===Ki?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...mse(e.map(t=>t.namespaces()))])}};function dse(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function pse(r){let e=r.split(":");return e[e.length-1]}function mse(r){return[].concat(...r)}var gse=H("/pk/");function Xh(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let s=o5(n);return s==null?!0:!s})}}function a5(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(n==="localhost")return!0;if(t!==4&&t!==6||n==null)return!1;let s=o5(n);return s??!1})}}async function ic(r){return(await Ee.digest(r)).digest}async function Qn(r){return ic(r.toBytes())}function ac(r){return new Zh(`${gV}/${z(r,"base32")}`,!1)}function LV(r){return we([gse,r.toBytes()])}function kV(r){return z(r.subarray(0,4))==="/pk/"}function NV(r){return Wt(r.subarray(4))}function aA(r,e){let t=new Date;return new gr(r,e,t).serialize()}function OV(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>{r()},e)}}var yse=290,bse=54,wse=55,xse=56,Ese=4,vse=41;function MV(r){let e=r.stringTuples();for(let t of e)if(t[0]===yse)return!1;if(e[0][0]===bse||e[0][0]===wse||e[0][0]===xse)return!0;if(e[0][0]===Ese||e[0][0]===vse){let t=o5(`${e[0][1]}`);return t==null||!t}return!1}var c5=class{constructor(e,t){l(this,"log");l(this,"components");l(this,"validators");l(this,"selectors");l(this,"peerRouting");l(this,"queryManager");l(this,"network");let{validators:n,selectors:s,peerRouting:o,queryManager:i,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=o,this.queryManager=i,this.network=a}async getLocal(e){this.log("getLocal %b",e);let t=ac(e);this.log("fetching record for key %k",t);let n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);let s=gr.deserialize(n);return await Yh(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);let o=aA(e,n);for(let{value:i,from:a}of t){if(j(i,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let f=ac(e);this.log(`Storing corrected record for key ${f.toString()}`),await this.components.datastore.put(f,o.subarray())}catch(f){this.log.error("Failed error correcting self",f)}continue}let c=!1,u={type:Ke.PUT_VALUE,key:e,record:o};for await(let f of this.network.sendRequest(a,u,s))f.name==="PEER_RESPONSE"&&f.record!=null&&j(f.record.value,gr.deserialize(o).value)&&(c=!0),yield f;c||(yield kn({from:a,error:new K("value not put correctly","ERR_PUT_VALUE_INVALID")},s)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);let s=aA(e,t),o=ac(e);this.log(`storing record for key ${o.toString()}`),await this.components.datastore.put(o,s.subarray()),yield*at(this.peerRouting.getClosestPeers(e,{signal:n.signal}),i=>$h(i,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],u={type:Ke.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(let f of this.network.sendRequest(a.peer.id,u,n))c.push(f),f.name==="PEER_RESPONSE"&&(f.record!=null&&j(f.record.value,gr.deserialize(s).value)||c.push(kn({from:a.peer.id,error:new K("value not put correctly","ERR_PUT_VALUE_INVALID")},n)));return c}),i=>il(i,{ordered:!1,concurrency:3}),async function*(i){for await(let a of i)yield*a})}async*get(e,t={}){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;let s=n.map(a=>a.value),o=0;try{o=RV(this.selectors,e,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}let i=s[o];if(this.log("GetValue %b %b",e,i),i==null)throw new K("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,i,t),yield n[o]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let o=await this.getLocal(e);yield n2({value:o.value,from:this.components.peerId},t)}catch(o){this.log("error getting local value for %b",e,o)}let n=this,s=async function*({peer:o,signal:i}){for await(let a of n.peerRouting.getValueOrPeers(o,e,{signal:i}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield n2({from:o,value:a.record.value},t))};yield*this.queryManager.run(e,s,t)}};function lA(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}var mo=class r{constructor(e){l(this,"set");if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return lA(this.set.entries(),e=>{let t=Qe(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=Qe(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return lA(this.set.values(),e=>Qe(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};function KV(r,e){return{id:r.id.toBytes(),multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function s2(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:Wt(r.id),multiaddrs:(r.multiaddrs??[]).map(e=>xe(e))}}var l5=class{constructor(e,t){l(this,"log");l(this,"components");l(this,"network");l(this,"peerRouting");l(this,"queryManager");l(this,"routingTable");l(this,"providers");let{network:n,peerRouting:s,queryManager:o,routingTable:i,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=o,this.routingTable=i,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e);let s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);let o={type:Ke.ADD_PROVIDER,key:s,providers:[KV({id:this.components.peerId,multiaddrs:t})]},i=0,a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];let u=[];this.log("putProvider %s to %p",e,c.peer.id);try{this.log("sending provider record for %s to %p",e,c.peer.id);for await(let f of this.network.sendMessage(c.peer.id,o,n))f.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,c.peer.id),i++),u.push(f)}catch(f){this.log.error("error sending provide record to peer %p",c.peer.id,f),u.push(kn({from:c.peer.id,error:f},n))}return u};yield*at(this.peerRouting.getClosestPeers(s,n),c=>$h(c,u=>a(u)),c=>il(c,{ordered:!1,concurrency:3}),async function*(c){for await(let u of c)yield*u}),this.log("sent provider records to %d peers",i)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,s=0,o=e.multihash.bytes,i=this;this.log("findProviders %c",e);let a=await this.providers.getProviders(e);if(a.length>0){let f=[];for(let h of a.slice(0,n))try{let d=await this.components.peerStore.get(h);f.push({id:h,multiaddrs:d.addresses.map(({multiaddr:p})=>p)})}catch(d){if(d.code!=="ERR_NOT_FOUND")throw d;this.log("no peer store entry for %p",h)}if(yield r2({from:this.components.peerId,messageType:Ke.GET_PROVIDERS,providers:f},t),yield sA({from:this.components.peerId,providers:f},t),s+=f.length,s>=n)return}let c=async function*({peer:f,signal:h}){let d={type:Ke.GET_PROVIDERS,key:o};yield*i.network.sendRequest(f,d,{...t,signal:h})},u=new mo(a);for await(let f of this.queryManager.run(o,c,t))if(yield f,f.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",f.providers.length,e,f.closer.length);let h=[];for(let d of f.providers)u.has(d.id)||(u.add(d.id),h.push(d));if(h.length>0&&(yield sA({from:f.from,providers:h},t),s+=h.length,s>=n))return}}};var jh=class{constructor(e){l(this,"movingAverage");l(this,"variance");l(this,"deviation");l(this,"forecast");l(this,"timespan");l(this,"previousTime");this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),s=e-this.movingAverage,o=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*o),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}};var Sse=1.2,_se=2,Ase=2e3,u5=class{constructor(e={}){l(this,"success");l(this,"failure");l(this,"next");l(this,"metric");l(this,"timeoutMultiplier");l(this,"failureMultiplier");l(this,"minTimeout");this.success=new jh(e.interval??5e3),this.failure=new jh(e.interval??5e3),this.next=new jh(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??_se,this.timeoutMultiplier=e.timeoutMultiplier??Sse,this.minTimeout=e.minTimeout??Ase,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(t),s=At([e.signal,n]);return Ze(1/0,s,n),s.start=Date.now(),s.timeout=t,s}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};var f5=class extends Pt{constructor(t,n){super();l(this,"log");l(this,"protocol");l(this,"running");l(this,"components");l(this,"timeout");let{protocol:s}=n;this.components=t,this.log=t.logger.forComponent(`${n.logPrefix}:network`),this.running=!1,this.protocol=s,this.timeout=new u5({...n.timeout??{},metrics:t.metrics,metricName:`${n.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,n,s={}){if(!this.running)return;let o=n.type;if(o==null)throw new Vr("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",n.type,t),yield oA({peer:t},s),yield nA({to:t,type:o},s);let i,a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{i=await(await this.components.connectionManager.openConnection(t,s)).newStream(this.protocol,s);let u=await this._writeReadMessage(i,n,s);i.close(s).catch(f=>{this.log.error("error closing stream to %p",t,f),i?.abort(f)}),yield r2({from:t,messageType:u.type,closer:u.closer.map(s2),providers:u.providers.map(s2),record:u.record==null?void 0:gr.deserialize(u.record)},s)}catch(c){i?.abort(c),this.log.error("could not send %s to %p",n.type,t,c),yield kn({from:t,error:c},s)}finally{this.timeout.cleanUp(a)}}async*sendMessage(t,n,s={}){if(!this.running)return;let o=n.type;if(o==null)throw new Vr("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",n.type,t),yield oA({peer:t},s),yield nA({to:t,type:o},s);let i,a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{i=await(await this.components.connectionManager.openConnection(t,s)).newStream(this.protocol,s),await this._writeMessage(i,n,s),i.close(s).catch(u=>{this.log.error("error closing stream to %p",t,u),i?.abort(u)}),yield r2({from:t,messageType:o},s)}catch(c){i?.abort(c),yield kn({from:t,error:c},s)}finally{this.timeout.cleanUp(a)}}async _writeMessage(t,n,s){let o=bt(t);await o.write(n,jn,s),await o.unwrap().close(s)}async _writeReadMessage(t,n,s){let o=bt(t);await o.write(n,jn,s);let i=await o.read(jn,s);return await o.unwrap().close(s),i.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:s2(a)})}),i.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:s2(a)})}),i}};function Qh(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}var Jh=class{constructor(e,t){l(this,"originDhtKey");l(this,"capacity");l(this,"peerDistances");this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){let t=await Qn(e.id);this.addWitKadId(e,t)}addWitKadId(e,t){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;let n={peer:e,distance:vs(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((s,o)=>Qh(s.distance,o.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){if(this.length===0)return!0;let t=await Qn(e),n=vs(t,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return Qh(n,s)===-1}async anyCloser(e){return e.length===0?!1:Promise.any(e.map(async t=>this.isCloser(t)))}};var h5=class{constructor(e,t){l(this,"log");l(this,"routingTable");l(this,"network");l(this,"validators");l(this,"queryManager");l(this,"peerStore");l(this,"peerId");let{routingTable:n,network:s,validators:o,queryManager:i,logPrefix:a}=t;this.routingTable=n,this.network=s,this.validators=o,this.queryManager=i,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${a}:peer-routing`)}async findPeerLocal(e){let t,n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(t==null)try{t=await this.peerStore.get(e)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(e,t,n={}){let s={type:Ke.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){let n=LV(e);for await(let s of this._getValueSingle(e,n,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){let o=await ds(c6.marshalPublicKey({bytes:s.record.value}));if(!o.equals(e))throw new K("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(o.publicKey==null)throw new K("public key missing","ERR_PUBLIC_KEY_MISSING");yield n2({from:e,value:o.publicKey},t)}throw new K(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let s=await this.findPeerLocal(e);if(s!=null){this.log("found local"),yield s5({from:this.peerId,peer:s},t);return}}let n=!1;if(t.useNetwork!==!1){let s=this,o=async function*({peer:i,signal:a}){let c={type:Ke.FIND_NODE,key:e.toBytes()};for await(let u of s.network.sendRequest(i,c,{...t,signal:a}))if(yield u,u.name==="PEER_RESPONSE"){let f=u.closer.find(h=>h.id.equals(e));f!=null&&(yield s5({from:u.from,peer:f},t))}};for await(let i of this.queryManager.run(e.toBytes(),o,t))i.name==="FINAL_PEER"&&(n=!0),yield i}n||(yield kn({from:this.peerId,error:new K("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await ic(e),s=this.routingTable.closestPeers(n),o=this,i=new Jh(n,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await i.add({id:c,multiaddrs:[]})}));let a=async function*({peer:c,signal:u}){o.log("closerPeersSingle %s from %p",z(e,"base32"),c);let f={type:Ke.FIND_NODE,key:e};yield*o.network.sendRequest(c,f,{...t,signal:u})};for await(let c of this.queryManager.run(e,a,t))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async u=>{await i.add(u)})),yield c;this.log("found %d peers close to %b",i.length,e);for(let c of i.peers)yield s5({from:this.peerId,peer:c},t)}async*getValueOrPeers(e,t,n={}){for await(let s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{let i="invalid record received, discarded";this.log(i),yield kn({from:s.from,error:new K(i,"ERR_INVALID_RECORD")},n);continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new K("invalid record received","ERR_INVALID_RECORD");await Yh(this.validators,new gr(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){let n=await ic(e),s=this.routingTable.closestPeers(n),o=[];for(let i of s)if(!i.equals(t))try{let a=await this.peerStore.get(i);o.push({id:i,multiaddrs:a.addresses.map(({multiaddr:c})=>c)})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return o.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",o.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),o}};var GV=go(hw(),1);function uA(r,e,t){let n=0,s=r.length;for(;s>0;){let o=Math.trunc(s/2),i=n+o;t(r[i],e)<=0?(n=++i,s-=o+1):s=o}return n}var Jn,o2=class{constructor(){ne(this,Jn,[])}enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,id:t.id,run:e};if(this.size===0||V(this,Jn)[this.size-1].priority>=t.priority){V(this,Jn).push(n);return}let s=uA(V(this,Jn),n,(o,i)=>i.priority-o.priority);V(this,Jn).splice(s,0,n)}setPriority(e,t){let n=V(this,Jn).findIndex(o=>o.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[s]=V(this,Jn).splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return V(this,Jn).shift()?.run}filter(e){return V(this,Jn).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return V(this,Jn).length}};Jn=new WeakMap;var ed,td,cc,a2,rd,c2,es,nd,jr,l2,ts,sd,Fi,u2,g5,Ve,FV,VV,HV,qV,zV,d5,fA,hA,p5,$V,m5,i2=class extends Z0.default{constructor(t){super();ne(this,Ve);ne(this,ed);ne(this,td);ne(this,cc,0);ne(this,a2);ne(this,rd);ne(this,c2,0);ne(this,es);ne(this,nd);ne(this,jr);ne(this,l2);ne(this,ts,0);ne(this,sd);ne(this,Fi);ne(this,u2);ne(this,g5,1n);l(this,"timeout");if(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:o2,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${t.intervalCap?.toString()??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${t.interval?.toString()??""}\` (${typeof t.interval})`);le(this,ed,t.carryoverConcurrencyCount),le(this,td,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),le(this,a2,t.intervalCap),le(this,rd,t.interval),le(this,jr,new t.queueClass),le(this,l2,t.queueClass),this.concurrency=t.concurrency,this.timeout=t.timeout,le(this,u2,t.throwOnTimeout===!0),le(this,Fi,t.autoStart===!1)}get concurrency(){return V(this,sd)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);le(this,sd,t),ee(this,Ve,p5).call(this)}setPriority(t,n){V(this,jr).setPriority(t,n)}async add(t,n={}){return n.id??(n.id=(rs(this,g5)._++).toString()),n={timeout:this.timeout,throwOnTimeout:V(this,u2),...n},new Promise((s,o)=>{V(this,jr).enqueue(async()=>{rs(this,ts)._++;try{n.signal?.throwIfAborted(),rs(this,cc)._++;let i=t({signal:n.signal});n.timeout&&(i=bn(Promise.resolve(i),{milliseconds:n.timeout})),n.signal&&(i=Promise.race([i,ee(this,Ve,$V).call(this,n.signal)]));let a=await i;s(a),this.emit("completed",a)}catch(i){if(i instanceof Qi&&!n.throwOnTimeout){s();return}o(i),this.emit("error",i)}finally{ee(this,Ve,HV).call(this)}},n),this.emit("add"),ee(this,Ve,d5).call(this)})}async addAll(t,n){return Promise.all(t.map(async s=>this.add(s,n)))}start(){return V(this,Fi)?(le(this,Fi,!1),ee(this,Ve,p5).call(this),this):this}pause(){le(this,Fi,!0)}clear(){le(this,jr,new(V(this,l2)))}async onEmpty(){V(this,jr).size!==0&&await ee(this,Ve,m5).call(this,"empty")}async onSizeLessThan(t){V(this,jr).size<t||await ee(this,Ve,m5).call(this,"next",()=>V(this,jr).size<t)}async onIdle(){V(this,ts)===0&&V(this,jr).size===0||await ee(this,Ve,m5).call(this,"idle")}get size(){return V(this,jr).size}sizeBy(t){return V(this,jr).filter(t).length}get pending(){return V(this,ts)}get isPaused(){return V(this,Fi)}};ed=new WeakMap,td=new WeakMap,cc=new WeakMap,a2=new WeakMap,rd=new WeakMap,c2=new WeakMap,es=new WeakMap,nd=new WeakMap,jr=new WeakMap,l2=new WeakMap,ts=new WeakMap,sd=new WeakMap,Fi=new WeakMap,u2=new WeakMap,g5=new WeakMap,Ve=new WeakSet,FV=function(){return V(this,td)||V(this,cc)<V(this,a2)},VV=function(){return V(this,ts)<V(this,sd)},HV=function(){rs(this,ts)._--,ee(this,Ve,d5).call(this),this.emit("next")},qV=function(){ee(this,Ve,hA).call(this),ee(this,Ve,fA).call(this),le(this,nd,void 0)},zV=function(){let t=Date.now();if(V(this,es)===void 0){let n=V(this,c2)-t;if(n<0)le(this,cc,V(this,ed)?V(this,ts):0);else return V(this,nd)===void 0&&le(this,nd,setTimeout(()=>{ee(this,Ve,qV).call(this)},n)),!0}return!1},d5=function(){if(V(this,jr).size===0)return V(this,es)&&clearInterval(V(this,es)),le(this,es,void 0),this.emit("empty"),V(this,ts)===0&&this.emit("idle"),!1;if(!V(this,Fi)){let t=!V(this,Ve,zV);if(V(this,Ve,FV)&&V(this,Ve,VV)){let n=V(this,jr).dequeue();return n?(this.emit("active"),n(),t&&ee(this,Ve,fA).call(this),!0):!1}}return!1},fA=function(){V(this,td)||V(this,es)!==void 0||(le(this,es,setInterval(()=>{ee(this,Ve,hA).call(this)},V(this,rd))),le(this,c2,Date.now()+V(this,rd)))},hA=function(){V(this,cc)===0&&V(this,ts)===0&&V(this,es)&&(clearInterval(V(this,es)),le(this,es,void 0)),le(this,cc,V(this,ed)?V(this,ts):0),ee(this,Ve,p5).call(this)},p5=function(){for(;ee(this,Ve,d5).call(this););},$V=async function(t){return new Promise((n,s)=>{t.addEventListener("abort",()=>{s(t.reason)},{once:!0})})},m5=async function(t,n){return new Promise(s=>{let o=()=>{n&&!n()||(this.off(t,o),s())};this.on(t,o)})};var y5=class{constructor(e,t={}){l(this,"log");l(this,"datastore");l(this,"cache");l(this,"cleanupInterval");l(this,"provideValidity");l(this,"syncQueue");l(this,"started");l(this,"cleaner");let{cacheSize:n,cleanupInterval:s,provideValidity:o}=t;this.log=e.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=e.datastore,this.cleanupInterval=s??36e5,this.provideValidity=o??864e5,this.cache=(0,GV.default)(n??256),this.syncQueue=new i2({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{this.log.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{let e=Date.now(),t=0,n=0,s=new Map,o=this.datastore.batch(),i=this.datastore.query({prefix:F_});for await(let a of i)try{let{cid:c,peerId:u}=WV(a.key),f=YV(a.value).getTime(),h=Date.now(),d=h-f,p=d>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",h,f,d,this.provideValidity,p?"(expired)":""),p){n++,o.delete(a.key);let y=s.get(c)??new Set;y.add(u),s.set(c,y)}t++}catch(c){this.log.error(c.message)}s.size>0?(this.log("deleting %d / %d entries",n,t),await o.commit()):this.log("nothing to delete");for(let[a,c]of s){let u=f2(a),f=this.cache.get(u);if(f!=null){for(let h of c)f.delete(h);f.size===0?this.cache.remove(u):this.cache.set(u,f)}}this.log("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){let t=f2(e),n=this.cache.get(t);return n==null&&(n=await Dse(this.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add(async()=>{this.log("%p provides %s",t,e);let n=await this._getProvidersMap(e);this.log("loaded %s provs",n.size);let s=new Date;n.set(t.toString(),s);let o=f2(e);this.cache.set(o,n),await Cse(this.datastore,e,t,s)})}async getProviders(e){return this.syncQueue.add(async()=>(this.log("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>Qe(n))),{throwOnTimeout:!0})}};function f2(r){let e=typeof r=="string"?r:z(r.multihash.bytes,"base32");return`${F_}/${e}`}async function Cse(r,e,t,n){let s=[f2(e),"/",t.toString()].join(""),o=new Zh(s),i=je(n.getTime());await r.put(o,i)}function WV(r){let e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function Dse(r,e){let t=new Map,n=r.query({prefix:f2(e)});for await(let s of n){let{peerId:o}=WV(s.key);t.set(o,YV(s.value))}return t}function YV(r){return new Date(Nt(r))}var b5=class{constructor(e){l(this,"deferred");l(this,"signal");this.signal=e,this.deferred=ue(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new da)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Bse(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var w5=class{constructor(e,t){l(this,"id");l(this,"fn");l(this,"options");l(this,"recipients");l(this,"status");l(this,"timeline");l(this,"controller");this.id=Bse(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,Ze(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new da),this.cleanup())}async join(e={}){let t=new b5(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await $e(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var od=class extends Pt{constructor(t={}){super();l(this,"concurrency");l(this,"queue");l(this,"pending");l(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&t.metrics?.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=t.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let t;for(let n of this.queue)if(n.status==="queued"){t=n;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let n=0;n<this.queue.length;n++)if(this.queue[n]===t){this.queue.splice(n,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,n){n?.signal?.throwIfAborted();let s=new w5(t,n);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(n).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===s){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new da)}),this.clear()}async onEmpty(t){this.size!==0&&await Un(this,"empty",t?.signal)}async onSizeLessThan(t,n){this.size<t||await Un(this,"next",n?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Un(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let n=We({objectMode:!0}),s=u=>{u!=null?this.abort():this.clear(),n.end(u)},o=u=>{u.detail!=null&&n.push(u.detail)},i=u=>{s(u.detail)},a=()=>{s()},c=()=>{s(new K("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",o),this.addEventListener("error",i),this.addEventListener("idle",a),t?.signal?.addEventListener("abort",c);try{yield*n}finally{this.removeEventListener("completed",o),this.removeEventListener("error",i),this.removeEventListener("idle",a),t?.signal?.removeEventListener("abort",c),s()}}};async function*ZV(r){let{key:e,startingPeer:t,ourPeerId:n,signal:s,query:o,alpha:i,pathIndex:a,numPaths:c,queryFuncTimeout:u,log:f,peersSeen:h,connectionManager:d}=r,p=new od({concurrency:i,sort:(b,_)=>Qh(b.options.distance,_.options.distance)}),y=await ic(e);function x(b,_){if(b==null)return;h.add(b);let v=vs(_,y);p.add(async()=>{let w=[s];u!=null&&w.push(AbortSignal.timeout(u));let R=At(w);Ze(1/0,R);try{for await(let N of o({key:e,peer:b,signal:R,pathIndex:a,numPaths:c})){if(R.aborted)return;if(N.name==="PEER_RESPONSE")for(let O of N.closer){if(h.has(O.id)){f("already seen %p in query",O.id);continue}if(n.equals(O.id)){f("not querying ourselves");continue}if(!await d.isDialable(O.multiaddrs)){f("not querying undialable peer");continue}let F=await Qn(O.id),A=vs(F,y);if(Qh(A,v)!==-1){f("skipping %p as they are not closer to %b than %p",O.id,e,b);continue}f("querying closer peer %p",O.id),x(O.id,F)}p.safeDispatchEvent("completed",{detail:N})}}catch(N){if(!s.aborted)return kn({from:b,error:N},r)}finally{R.clear()}},{distance:v}).catch(w=>{f.error(w)})}x(t,await Qn(t));try{for await(let b of p.toGenerator({signal:s}))b!=null&&(yield b)}catch(b){throw s.aborted?new K("Query aborted","ERR_QUERY_ABORTED"):b}}var x5=class{constructor(e,t){l(this,"disjointPaths");l(this,"alpha");l(this,"shutDownController");l(this,"running");l(this,"queries");l(this,"logger");l(this,"peerId");l(this,"connectionManager");l(this,"routingTable");l(this,"initialQuerySelfHasRun");l(this,"logPrefix");l(this,"metrics");let{disjointPaths:n=20,alpha:s=3,logPrefix:o}=t;this.logPrefix=o,this.disjointPaths=n??20,this.running=!1,this.alpha=s??3,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,e.metrics!=null&&(this.metrics={runningQueries:e.metrics.registerMetric(`${o.replaceAll(":","_")}_running_queries`),queryTime:e.metrics.registerMetric(`${o.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,Ze(1/0,this.shutDownController.signal)}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,Ze(1/0,this.shutDownController.signal)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");let s=this.metrics?.queryTime.timer();if(n.signal==null){let f=AbortSignal.timeout(18e4);Ze(1/0,f),n={...n,signal:f}}let o=new AbortController,i=At([this.shutDownController.signal,o.signal,n.signal]);Ze(1/0,i,o.signal);let a=this.logger.forComponent(`${this.logPrefix}:query:`+z(e,"base58btc")),c=Date.now(),u=!1;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(a("waiting for initial query-self query before continuing"),await $e(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),a("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);let f=await ic(e),h=this.routingTable.closestPeers(f),d=h.slice(0,Math.min(this.disjointPaths,h.length));if(h.length===0){a.error("Running query with no peers");return}let p=new mo,y=d.map((x,b)=>ZV({key:e,startingPeer:x,ourPeerId:this.peerId,signal:i,query:t,pathIndex:b,numPaths:d.length,alpha:this.alpha,queryFuncTimeout:n.queryFuncTimeout,log:a,peersSeen:p,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(let x of Bo(...y)){if(x.name==="QUERY_ERROR"&&a.error("query error",x.error),x.name==="PEER_RESPONSE")for(let b of[...x.closer,...x.providers])await this.connectionManager.isDialable(b.multiaddrs)&&await this.routingTable.add(b.id);yield x}u=!0}catch(f){if(!(!this.running&&f.code==="ERR_QUERY_ABORTED"))throw f}finally{u||(a("query exited early"),o.abort()),i.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),s?.(),a("query:done in %dms",Date.now()-c)}}};function Pse(r){return r[Symbol.asyncIterator]!=null}function Lse(r){if(Pse(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var E5=Lse;var v5=class{constructor(e,t){l(this,"log");l(this,"peerId");l(this,"peerRouting");l(this,"routingTable");l(this,"count");l(this,"interval");l(this,"initialInterval");l(this,"queryTimeout");l(this,"started");l(this,"timeoutId");l(this,"controller");l(this,"initialQuerySelfHasRun");l(this,"querySelfPromise");let{peerRouting:n,logPrefix:s,count:o,interval:i,queryTimeout:a,routingTable:c}=t;this.peerId=e.peerId,this.log=e.logger.forComponent(`${s}:query-self`),this.started=!1,this.peerRouting=n,this.routingTable=c,this.count=o??20,this.interval=i??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=a??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=ue(),this.started){this.controller=new AbortController;let e=AbortSignal.timeout(this.queryTimeout),t=At([this.controller.signal,e]);Ze(1/0,t,this.controller.signal,e);try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await E1(this.routingTable,"peer:add",{signal:t})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let n=Date.now(),s=await at(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:t,isSelfQuery:!0}),o=>K0(o,this.count),async o=>E5(o));this.log("self-query found %d peers in %dms",s,Date.now()-n)}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};var S5=class extends od{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};function kse(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function jV(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array");if(e.byteLength!==32)throw new TypeError(r+" had incorrect length")}function h2(r){return Array.isArray(r?.peers)}var _5=class extends Pt{constructor(t){super();l(this,"root");l(this,"localPeer");l(this,"prefixLength");l(this,"splitThreshold");l(this,"kBucketSize");l(this,"numberOfNodesToPing");this.localPeer=t.localPeer,this.prefixLength=t.prefixLength,this.kBucketSize=t.kBucketSize??d2,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfNodesToPing??3,jV("options.localPeer.kadId",t.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(t){jV("peer.kadId",t?.kadId);let n=this._determineBucket(t.kadId);if(!(this._indexOf(n,t.kadId)>-1)){if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){this._split(n),this.add(t);return}if(n.peers.length<this.kBucketSize){n.peers.push(t),this.safeDispatchEvent("added",{detail:t});return}this.safeDispatchEvent("ping",{detail:{oldContacts:n.peers.slice(0,this.numberOfNodesToPing),newContact:t}})}}*closest(t,n=this.kBucketSize){let s=new Jh(t,n);for(let o of this.toIterable())s.addWitKadId({id:o.peerId,multiaddrs:[]},o.kadId);yield*$h(s.peers,o=>o.id)}count(){function t(n){if(h2(n))return n.peers.length;let s=0;return n.left!=null&&(s+=t(n.left)),n.right!=null&&(s+=t(n.right)),s}return t(this.root)}get(t){let n=this._determineBucket(t),s=this._indexOf(n,t);return n.peers[s]}remove(t){let n=this._determineBucket(t),s=this._indexOf(n,t);if(s>-1){let o=n.peers.splice(s,1)[0];this.safeDispatchEvent("removed",{detail:o})}}*toIterable(){function*t(n){if(h2(n)){yield*n.peers;return}yield*t(n.left),yield*t(n.right)}yield*t(this.root)}distance(t,n){return BigInt("0x"+z(vs(t,n),"base16"))}_determineBucket(t){let s=z(t,"base2").substring(0,this.prefixLength);function o(i,a=0){return h2(i)?i:s[a]==="0"?o(i.left,a+1):o(i.right,a+1)}return o(this.root)}_indexOf(t,n){return t.peers.findIndex(s=>kse(s.kadId,n))}_split(t){let n=t.depth+1,s={prefix:"0",depth:n,peers:[]},o={prefix:"1",depth:n,peers:[]};for(let i of t.peers)z(i.kadId,"base2")[n]==="0"?s.peers.push(i):o.peers.push(i);delete t.peers,t.left=s,t.right=o}};var Nse="kad-close",Ose=50,d2=20,Mse=32,Use=1e4,Kse=10,A5=class extends Pt{constructor(t,n){super();l(this,"kBucketSize");l(this,"kb");l(this,"pingQueue");l(this,"log");l(this,"components");l(this,"prefixLength");l(this,"splitThreshold");l(this,"pingTimeout");l(this,"pingConcurrency");l(this,"running");l(this,"protocol");l(this,"tagName");l(this,"tagValue");l(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${n.logPrefix}:routing-table`),this.kBucketSize=n.kBucketSize??d2,this.pingTimeout=n.pingTimeout??Use,this.pingConcurrency=n.pingConcurrency??Kse,this.running=!1,this.protocol=n.protocol,this.tagName=n.tagName??Nse,this.tagValue=n.tagValue??Ose,this.prefixLength=n.prefixLength??Mse,this.splitThreshold=n.splitThreshold??d2,this.pingQueue=new S5({concurrency:this.pingConcurrency,metricName:`${n.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",s=>{this.log.error("error pinging peer",s.detail)}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${n.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${n.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${n.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${n.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;let t=new _5({localPeer:{kadId:await Qn(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=t,t.addEventListener("ping",s=>{this._onPing(s).catch(o=>{this.log.error("could not process k-bucket ping event",o)})});let n=0;for(let s of await this.components.peerStore.all())if(s.protocols.includes(this.protocol)){let o=await Qn(s.id);this.kb.add({kadId:o,peerId:s.id}),n++}this.log("added %d peer store peers to the routing table",n),this._tagPeers(t)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(t){let n=new mo,s=OV(()=>{let o=new mo(t.closest(t.localPeer.kadId,d2)),i=o.difference(n),a=n.difference(o);Promise.resolve().then(async()=>{for(let c of i)await this.components.peerStore.merge(c,{tags:{[this.tagName]:{value:this.tagValue}}});for(let c of a)await this.components.peerStore.merge(c,{tags:{[this.tagName]:void 0}})}).catch(c=>{this.log.error("Could not update peer tags",c)}),n=o});t.addEventListener("added",o=>{s(),this.safeDispatchEvent("peer:add",{detail:o.detail.peerId})}),t.addEventListener("removed",o=>{s(),this.safeDispatchEvent("peer:remove",{detail:o.detail.peerId})})}async _onPing(t){if(!this.running)return;let{oldContacts:n,newContact:s}=t.detail,i=(await Promise.all(n.map(async a=>{let c=this.pingQueue.find(a.peerId);return c!=null?c.join():this.pingQueue.add(async()=>{let u;try{let f={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",a.peerId),u=await(await this.components.connectionManager.openConnection(a.peerId,f)).newStream(this.protocol,f);let d=bt(u);await d.write({type:Ke.PING},jn,f);let p=await d.read(jn,f);if(await d.unwrap().close(),p.type!==Ke.PING)throw new K(`Incorrect message type received, expected PING got ${p.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(f){return this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",a.peerId,f),this.log("evicting old contact after ping failed %p",a.peerId),this.kb.remove(a.kadId)),u?.abort(f),!1}finally{this.metrics?.routingTableSize.update(this.size)}},{peerId:a.peerId})}))).filter(a=>a).length;this.running&&i<n.length&&this.kb!=null&&(this.log("adding new contact %p",s.peerId),this.kb.add(s))}get size(){return this.kb==null?0:this.kb.count()}async find(t){let n=await Qn(t);return this.kb?.get(n)?.peerId}closestPeer(t){let n=this.closestPeers(t,1);if(n.length>0)return n[0]}closestPeers(t,n=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(t,n)]}async add(t){if(this.kb==null)throw new Error("RoutingTable is not started");let n=await Qn(t);this.kb.add({kadId:n,peerId:t}),this.log("added %p with kad id %b",t,n),this.updateMetrics()}async remove(t){if(this.kb==null)throw new Error("RoutingTable is not started");let n=await Qn(t);this.kb.remove(n),this.updateMetrics()}updateMetrics(){if(this.metrics==null||this.kb==null)return;let t=0,n=0,s=0;function o(i){if(h2(i)){i.depth>s&&(s=i.depth),n++,t+=i.peers.length;return}o(i.left),o(i.right)}o(this.kb.root),this.metrics.routingTableSize.update(t),this.metrics.routingTableKadBucketTotal.update(n),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(t/n)),this.metrics.routingTableKadBucketMaxDepth.update(s)}};var QV=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var I5=15,T5=class{constructor(e,t){l(this,"log");l(this,"peerRouting");l(this,"routingTable");l(this,"refreshInterval");l(this,"refreshQueryTimeout");l(this,"commonPrefixLengthRefreshedAt");l(this,"refreshTimeoutId");let{peerRouting:n,routingTable:s,refreshInterval:o,refreshQueryTimeout:i,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=s,this.refreshInterval=o??3e5,this.refreshQueryTimeout=i??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");let t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(n.map(async(s,o)=>{try{if(await this._refreshCommonPrefixLength(o,s,e),this._numPeersForCpl(t)===0){let i=Math.min(2*(o+1),n.length-1);for(let a=o+1;a<i+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(i){this.log.error(i)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);let o=AbortSignal.timeout(this.refreshQueryTimeout);Ze(1/0,o);let i=await E5(this.peerRouting.getClosestPeers(s.toBytes(),{signal:o}));this.log(`found ${i} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>I5&&(e=I5);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");let t=ln(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e);return Wt(s)}async _makePeerId(e,t,n){if(n>I5)throw new Error(`Cannot generate peer ID for common prefix length greater than ${I5}`);let i=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=i&a|t&~a,u=QV[c],f=new ArrayBuffer(34),h=new DataView(f,0,f.byteLength);return h.setUint8(0,Ee.code),h.setUint8(1,32),h.setUint32(2,u,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=vs(this.routingTable.kb.localPeer.kadId,e),n=0;for(let s of t)if(s===0)n++;else break;yield n}}};var R5=class{constructor(e,t){l(this,"providers");l(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.providers=t.providers}async handle(e,t){if(this.log("start"),t.key==null||t.key.length===0)throw new K("Missing key","ERR_MISSING_KEY");let n;try{n=se.decode(t.key)}catch{throw new K("Invalid CID","ERR_INVALID_CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),await Promise.all(t.providers.map(async s=>{if(!e.equals(s.id)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log("received provider %p for %s (addrs %s)",e,n,s.multiaddrs.map(o=>xe(o).toString())),await this.providers.addProvider(n,Wt(s.id))}))}};var C5=class{constructor(e,t){l(this,"peerRouting");l(this,"peerInfoMapper");l(this,"peerId");l(this,"addressManager");l(this,"log");let{peerRouting:n,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),t.key==null)throw new K("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");let n=await this.peerRouting.getCloserPeersOffline(t.key,e);j(this.peerId.toBytes(),t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(o=>o.decapsulateCode(Ot("p2p").code))});let s={type:Ke.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:o})=>o.length).map(o=>({id:o.id.toBytes(),multiaddrs:o.multiaddrs.map(i=>i.bytes)})),providers:[]};return s.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),s}};var D5=class{constructor(e,t){l(this,"peerRouting");l(this,"providers");l(this,"peerStore");l(this,"peerInfoMapper");l(this,"log");let{peerRouting:n,providers:s,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:get-providers`),this.peerStore=e.peerStore,this.peerRouting=n,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new K("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let n;try{n=se.decode(t.key)}catch{throw new K("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",e,n);let[s,o]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),i=await this._getPeers(s),a=await this._getPeers(o.map(({id:u})=>u)),c={type:Ke.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:a.map(this.peerInfoMapper).filter(({multiaddrs:u})=>u.length).map(u=>({id:u.id.toBytes(),multiaddrs:u.multiaddrs.map(f=>f.bytes)})),providers:i.map(this.peerInfoMapper).filter(({multiaddrs:u})=>u.length).map(u=>({id:u.id.toBytes(),multiaddrs:u.multiaddrs.map(f=>f.bytes)}))};return this.log("got %s providers %s closerPeers",c.providers.length,c.closer.length),c}async _getAddresses(e){return[]}async _getPeers(e){let t=[];for(let n of e)try{let s=await this.peerStore.get(n),o=this.peerInfoMapper({id:n,multiaddrs:s.addresses.map(({multiaddr:i})=>i)});o.multiaddrs.length>0&&t.push(o)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}return t}};var B5=class{constructor(e,t){l(this,"peerStore");l(this,"datastore");l(this,"peerRouting");l(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new K("Invalid key","ERR_INVALID_KEY");let s={type:Ke.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(kV(n)){this.log("is public key");let a=NV(n),c;try{let u=await this.peerStore.get(a);if(u.id.publicKey==null)throw new K("No public key found in key book","ERR_NOT_FOUND");c=u.id.publicKey}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u}if(c!=null)return this.log("returning found public key"),s.record=new gr(n,c,new Date).serialize(),s}let[o,i]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return o!=null&&(this.log("had record for %b in local datastore",n),s.record=o.serialize()),i.length>0&&(this.log("had %s closer peers in routing table",i.length),s.closer=i.map(a=>({id:a.id.toBytes(),multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=ac(e),n;try{n=await this.datastore.get(t)}catch(o){if(o.code==="ERR_NOT_FOUND")return;throw o}let s=gr.deserialize(n);if(s==null)throw new K("Invalid record","ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>1296e5){await this.datastore.delete(t);return}return s}};var P5=class{constructor(e,t){l(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var L5=class{constructor(e,t){l(this,"components");l(this,"validators");l(this,"log");let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){let s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new K(s,"ERR_EMPTY_RECORD")}try{let s=gr.deserialize(t.record);await Yh(this.validators,s),s.timeReceived=new Date;let o=ac(s.key);await this.components.datastore.put(o,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,o)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}};var k5=class{constructor(e,t){l(this,"handlers");l(this,"routingTable");l(this,"log");let{providers:n,peerRouting:s,validators:o,logPrefix:i,peerInfoMapper:a}=t;this.log=e.logger.forComponent(`${i}:rpc`),this.routingTable=t.routingTable,this.handlers={[Ke.GET_VALUE.toString()]:new B5(e,{peerRouting:s,logPrefix:i}),[Ke.PUT_VALUE.toString()]:new L5(e,{validators:o,logPrefix:i}),[Ke.FIND_NODE.toString()]:new C5(e,{peerRouting:s,logPrefix:i,peerInfoMapper:a}),[Ke.ADD_PROVIDER.toString()]:new R5(e,{providers:n,logPrefix:i}),[Ke.GET_PROVIDERS.toString()]:new D5(e,{peerRouting:s,providers:n,logPrefix:i,peerInfoMapper:a}),[Ke.PING.toString()]:new P5(e,{logPrefix:i})}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(s){this.log.error("Failed to update the kbucket store",s)}let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{let{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(i){this.log.error(i)}let o=this;await at(t,i=>ms(i),async function*(i){for await(let a of i){let c=jn.decode(a);o.log("incoming %s from %p",c.type,s);let u=await o.handleMessage(s,c);u!=null&&(yield jn.encode(u))}},i=>ps(i),t)}).catch(t=>{this.log.error(t)})}};var N5=class extends Pt{constructor(t,n){super();l(this,"log");l(this,"components");l(this,"protocol");l(this,"running");l(this,"registrarId");let{protocol:s,logPrefix:o}=n;this.components=t,this.log=t.logger.forComponent(`${o}:topology-listener`),this.running=!1,this.protocol=s}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new En("peer",{detail:t}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var dA=class{constructor(e){l(this,"dht");this.dht=e}async provide(e,t={}){await of(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await of(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new K("Not found","ERR_NOT_FOUND")}},pA=class{constructor(e){l(this,"dht");this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new K("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},Fse=32,Vse=64,JV,eH,tH,O5=class extends Pt{constructor(t,n={}){super();l(this,"protocol");l(this,"routingTable");l(this,"providers");l(this,"network");l(this,"peerRouting");l(this,"components");l(this,"log");l(this,"running");l(this,"kBucketSize");l(this,"clientMode");l(this,"validators");l(this,"selectors");l(this,"queryManager");l(this,"contentFetching");l(this,"contentRouting");l(this,"routingTableRefresh");l(this,"rpc");l(this,"topologyListener");l(this,"querySelf");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"dhtContentRouting");l(this,"dhtPeerRouting");l(this,"peerInfoMapper");l(this,tH,"@libp2p/kad-dht");l(this,eH,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);l(this,JV,["@libp2p/identify"]);let{kBucketSize:s,clientMode:o,validators:i,selectors:a,querySelfInterval:c,protocol:u,logPrefix:f,pingTimeout:h,pingConcurrency:d,maxInboundStreams:p,maxOutboundStreams:y,providers:x}=n,b=f??"libp2p:kad-dht";this.running=!1,this.components=t,this.log=t.logger.forComponent(b),this.protocol=u??mV,this.kBucketSize=s??20,this.clientMode=o??!0,this.maxInboundStreams=p??Fse,this.maxOutboundStreams=y??Vse,this.peerInfoMapper=n.peerInfoMapper??Xh,this.routingTable=new A5(t,{kBucketSize:s,pingTimeout:h,pingConcurrency:d,protocol:this.protocol,logPrefix:b}),this.providers=new y5(t,x??{}),this.validators={...DV,...i},this.selectors={...CV,...a},this.network=new f5(t,{protocol:this.protocol,logPrefix:b});let _=ue();n.allowQueryWithZeroPeers===!0&&_.resolve(),this.queryManager=new x5(t,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:b,initialQuerySelfHasRun:_,routingTable:this.routingTable}),this.peerRouting=new h5(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:b}),this.contentFetching=new c5(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:b}),this.contentRouting=new l5(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:b}),this.routingTableRefresh=new T5(t,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:b}),this.rpc=new k5(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:b,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new N5(t,{protocol:this.protocol,logPrefix:b}),this.querySelf=new v5(t,{peerRouting:this.peerRouting,interval:c,initialInterval:n.initialQuerySelfInterval,logPrefix:b,initialQuerySelfHasRun:_,routingTable:this.routingTable}),this.network.addEventListener("peer",v=>{let w=v.detail;this.onPeerConnect(w).catch(R=>{this.log.error("could not add %p to routing table",w.id,R)}),this.dispatchEvent(new En("peer",{detail:w}))}),this.topologyListener.addEventListener("peer",v=>{let w=v.detail;Promise.resolve().then(async()=>{let R=await this.components.peerStore.get(w),N={id:w,multiaddrs:R.addresses.map(({multiaddr:O})=>O),protocols:R.protocols};await this.onPeerConnect(N)}).catch(R=>{this.log.error("could not add %p to routing table",w,R)})}),this.dhtPeerRouting=new pA(this),this.dhtContentRouting=new dA(this),n.clientMode==null&&t.events.addEventListener("self:peer:update",v=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let w=v.detail.peer.addresses.some(({multiaddr:N})=>MV(N)),R=this.getMode();w&&R==="client"?await this.setMode("server"):R==="server"&&!w&&await this.setMode("client")}).catch(w=>{this.log.error("error setting dht server mode",w)})})}get[(tH=Symbol.toStringTag,eH=Gt,JV=xf,GB)](){return this.dhtContentRouting}get[YB](){return this.dhtPeerRouting}get[y3](){return this}async onPeerConnect(t){if(this.log("peer %p connected",t.id),t=this.peerInfoMapper(t),t.multiaddrs.length===0){this.log("ignoring %p as there were no valid addresses in %s after filtering",t.id,t.multiaddrs.map(n=>n.toString()));return}try{await this.routingTable.add(t.id)}catch(n){this.log.error("could not add %p to routing table",t.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(t){await this.components.registrar.unhandle(this.protocol),t==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await QB(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await JB(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(t,n,s={}){yield*this.contentFetching.put(t,n,s)}async*get(t,n={}){yield*this.contentFetching.get(t,n)}async*provide(t,n={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),n)}async*findProviders(t,n={}){yield*this.contentRouting.findProviders(t,n)}async*findPeer(t,n={}){yield*this.peerRouting.findPeer(t,n)}async*getClosestPeers(t,n={}){yield*this.peerRouting.getClosestPeers(t,n)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};var rH;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(rH||(rH={}));function mA(r={}){return e=>new O5(e,r)}var Hse="bootstrap",qse=50,zse=12e4,$se=1e3,nH,sH,oH,iH,M5=class extends(iH=Pt,oH=y3,sH=Symbol.toStringTag,nH=Gt,iH){constructor(t,n={list:[]}){if(n.list==null||n.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();l(this,"log");l(this,"timer");l(this,"list");l(this,"timeout");l(this,"components");l(this,"_init");l(this,oH,this);l(this,sH,"@libp2p/bootstrap");l(this,nH,["@libp2p/peer-discovery"]);this.components=t,this.log=t.logger.forComponent("libp2p:bootstrap"),this.timeout=n.timeout??$se,this.list=[];for(let s of n.list){if(!pL.matches(s)){this.log.error("Invalid multiaddr");continue}let o=xe(s),i=o.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}let a={id:Qe(i),multiaddrs:[o]};this.list.push(a)}this._init=n}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(t=>{this.log.error(t)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let t of this.list){if(await this.components.peerStore.merge(t.id,{tags:{[this._init.tagName??Hse]:{value:this._init.tagValue??qse,ttl:this._init.tagTTL??zse}}}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:t})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};l(M5,"tag","bootstrap");function gA(r){return e=>new M5(e,r)}function aH(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function U5(r,e){let t=ga(r).return?.();aH(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var cH=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},Gse=new WeakMap;function Wse({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(cH());let o,i,a,c=r??clearTimeout,u=()=>{c(o),a(cH())},f=()=>{s&&s.removeEventListener("abort",u)},h=new Promise((d,p)=>{i=()=>{f(),d(n)},a=p,o=(e??setTimeout)(i,t)});return s&&s.addEventListener("abort",u,{once:!0}),Gse.set(h,()=>{c(o),o=null,i()}),h}}var Yse=Wse(),lH=Yse;var K5=class{constructor(e={}){l(this,"memoryStorage");l(this,"points");l(this,"duration");l(this,"blockDuration");l(this,"execEvenly");l(this,"execEvenlyMinDelayMs");l(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new yA}async consume(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,t,o);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+t&&(i=this.memoryStorage.set(s,i.consumedPoints,this.blockDuration)),new K("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let a=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=i.consumedPoints*this.execEvenlyMinDelayMs),await lH(a)}return i}penalty(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,t,o);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,-t,o);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(e,t){let n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){let s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},yA=class{constructor(){l(this,"storage");this.storage=new Map}incrby(e,t,n){let s=this.storage.get(e);if(s!=null){let o=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||o>0?(s.value+=t,{remainingPoints:0,msBeforeNext:o,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let s=n*1e3,o=this.storage.get(e);o!=null&&clearTimeout(o.timeoutId);let i={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,i),s>0&&(i.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),i.timeoutId.unref!=null&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:i.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};var Me;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(Me||(Me={}));var p2=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),bA=Object.freeze({NEW_STREAM:Me.NEW_STREAM,MESSAGE:Me.MESSAGE_INITIATOR,CLOSE:Me.CLOSE_INITIATOR,RESET:Me.RESET_INITIATOR}),uH=Object.freeze({MESSAGE:Me.MESSAGE_RECEIVER,CLOSE:Me.CLOSE_RECEIVER,RESET:Me.RESET_RECEIVER});var wA=1<<20,Zse=4<<20,F5=class{constructor(e=wA,t=Zse){l(this,"_buffer");l(this,"_headerInfo");l(this,"_maxMessageSize");l(this,"_maxUnprocessedMessageQueueSize");this._buffer=new Z,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if(u.code==="ERR_MSG_TOO_BIG")throw u;break}let{id:n,type:s,length:o,offset:i}=this._headerInfo;if(this._buffer.length-i<o)break;let c={id:n,type:s};(s===Me.NEW_STREAM||s===Me.MESSAGE_INITIATOR||s===Me.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(i,i+o)),t.push(c),this._buffer.consume(i+o),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=hH(e),{value:s,offset:o}=hH(e,n),i=t&7;if(p2[i]==null)throw new Error(`Invalid type received: ${i}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:i,offset:n+o,length:s}}},Xse=128,fH=127;function hH(r,e=0){let t=0,n=0,s=e,o,i=r.length;do{if(s>=i||n>49)throw e=0,new RangeError("Could not decode varint");o=r.get(s++),t+=n<28?(o&fH)<<n:(o&fH)*Math.pow(2,n),n+=7}while(o>=Xse);return e=s-e,{value:t,offset:e}}var xA=10*1024,EA=class{constructor(){l(this,"_pool");l(this,"_poolOffset");this._pool=pe(xA),this._poolOffset=0}write(e,t){let n=this._pool,s=this._poolOffset;je(e.id<<3|e.type,n,s),s+=ce(e.id<<3|e.type),(e.type===Me.NEW_STREAM||e.type===Me.MESSAGE_INITIATOR||e.type===Me.MESSAGE_RECEIVER)&&e.data!=null?(je(e.data.length,n,s),s+=ce(e.data.length)):(je(0,n,s),s+=ce(0));let o=n.subarray(this._poolOffset,s);xA-s<100?(this._pool=pe(xA),this._poolOffset=0):this._poolOffset=s,t.append(o),(e.type===Me.NEW_STREAM||e.type===Me.MESSAGE_INITIATOR||e.type===Me.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},jse=new EA;async function*dH(r){for await(let e of r){let t=new Z;jse.write(e,t),yield t}}var Qse="ERR_STREAM_RESET",Jse="ERR_SINK_INVALID_STATE",eoe=5e3;function vA(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var V5=class{constructor(e){l(this,"id");l(this,"direction");l(this,"timeline");l(this,"protocol");l(this,"metadata");l(this,"source");l(this,"status");l(this,"readStatus");l(this,"writeStatus");l(this,"log");l(this,"sinkController");l(this,"sinkEnd");l(this,"closed");l(this,"endErr");l(this,"streamSource");l(this,"onEnd");l(this,"onCloseRead");l(this,"onCloseWrite");l(this,"onReset");l(this,"onAbort");l(this,"sendCloseWriteTimeout");l(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=ue(),this.closed=ue(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??eoe,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=We({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new K(`writable end state is "${this.writeStatus}" not "ready"`,Jse);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let s=this.sendNewStream(t);vA(s)&&await s}let n=()=>{U5(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Z(s):s;let o=this.sendData(s,t);vA(o)&&(this.sendingData=ue(),await o,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await $e(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await $e(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await $e(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await $e(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();vA(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new K("stream reset",Qse);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var SA=class extends V5{constructor(t){super(t);l(this,"name");l(this,"streamId");l(this,"send");l(this,"types");l(this,"maxDataSize");this.types=t.direction==="outbound"?bA:uH,this.send=t.send,this.name=t.name,this.streamId=t.streamId,this.maxDataSize=t.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:bA.NEW_STREAM,data:new Z(H(this.name))})}async sendData(t){for(t=t.sublist();t.byteLength>0;){let n=Math.min(t.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:t.sublist(0,n)}),t.consume(n)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function pH(r){let{id:e,name:t,send:n,onEnd:s,type:o="initiator",maxMsgSize:i=wA}=r;return new SA({id:o==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:o==="initiator"?"outbound":"inbound",maxDataSize:i,onEnd:s,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${o}:${e}`)})}var toe=1024,roe=1024,noe=1024*1024*4,soe=5,ooe=500;function mH(r){let e={...r,type:`${p2[r.type]} (${r.type})`};return r.type===Me.NEW_STREAM&&(e.data=z(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===Me.MESSAGE_INITIATOR||r.type===Me.MESSAGE_RECEIVER)&&(e.data=z(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var H5=class{constructor(e,t){l(this,"protocol","/mplex/6.7.0");l(this,"sink");l(this,"source");l(this,"log");l(this,"_streamId");l(this,"_streams");l(this,"_init");l(this,"_source");l(this,"closeController");l(this,"rateLimiter");l(this,"closeTimeout");l(this,"logger");t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??ooe,this.sink=this._createSink(),this._source=We({objectMode:!0,onEnd:()=>{for(let n of this._streams.initiators.values())n.destroy();for(let n of this._streams.receivers.values())n.destroy()}}),this.source=at(this._source,n=>dH(n)),this.closeController=new AbortController,this.rateLimiter=new K5({points:t.disconnectThreshold??soe,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){let{id:t,name:n,type:s,registry:o}=e;if(this.log("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??roe))throw new K("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(o.has(t))throw new Error(`${s} stream ${t} already exists!`);let c=pH({id:t,name:n,send:async u=>{this.log.enabled&&this.log.trace("%s stream %s send",s,t,mH(u)),this._source.push(u)},type:s,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",s,t,c.protocol),o.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return o.set(t,c),c}_createSink(){return async t=>{let n=()=>{U5(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{let s=new F5(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let o of t)for(let i of s.write(o))await this._handleIncoming(i);this._source.end()}catch(s){this.log("error in sink",s),this._source.end(s)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",mH(e)),e.type===Me.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??toe)){this.log("too many inbound streams open"),this._source.push({id:t,type:Me.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:z(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let o=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(o==null){this.log("missing stream %s for message type %s",t,p2[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let i=this._init.maxStreamBufferSize??noe;try{switch(n){case Me.MESSAGE_INITIATOR:case Me.MESSAGE_RECEIVER:if(o.sourceReadableLength()>i)throw this._source.push({id:e.id,type:n===Me.MESSAGE_INITIATOR?Me.RESET_RECEIVER:Me.RESET_INITIATOR}),new K("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");o.sourcePush(e.data);break;case Me.CLOSE_INITIATOR:case Me.CLOSE_RECEIVER:o.remoteCloseWrite();break;case Me.RESET_INITIATOR:case Me.RESET_RECEIVER:o.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),o.abort(a)}}};var gH,yH;yH=Symbol.toStringTag,gH=Gt;var _A=class{constructor(e,t={}){l(this,"protocol","/mplex/6.7.0");l(this,"_init");l(this,"components");l(this,yH,"@libp2p/mplex");l(this,gH,["@libp2p/stream-multiplexing"]);this.components=e,this._init=t}createStreamMuxer(e={}){return new H5(this.components,{...e,...this._init})}};function AA(r={}){return e=>new _A(e,r)}function ioe(r){return r[Symbol.asyncIterator]!=null}function aoe(r){if(ioe(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var bH=aoe;var wH="1.0.0",xH="ping",EH="ipfs";var IA="ERR_WRONG_PING_ACK";var SH;SH=Symbol.toStringTag;var q5=class{constructor(e,t={}){l(this,"protocol");l(this,"components");l(this,"started");l(this,"timeout");l(this,"maxInboundStreams");l(this,"maxOutboundStreams");l(this,"runOnTransientConnection");l(this,"log");l(this,SH,"@libp2p/ping");this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??EH}/${xH}/${wH}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now();AbortSignal.timeout(this.timeout).addEventListener("abort",()=>{t?.abort(new K("ping timeout",u1))}),at(t,async function*(o){let i=0;for await(let a of o){if(i+=a.byteLength,i>32){t?.abort(new K("Too much data received",w3));return}yield a}},t).catch(o=>{this.log.error("incoming ping from %p failed with error",e.connection.remotePeer,o),t?.abort(o)}).finally(()=>{let o=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o)})}async ping(e,t={}){this.log("pinging %p",e);let n=Date.now(),s=ln(32),o=await this.components.connectionManager.openConnection(e,t),i,a=()=>{};if(t.signal==null){let c=AbortSignal.timeout(this.timeout);t={...t,signal:c}}try{i=await o.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),a=()=>{i?.abort(new K("ping timeout",u1))},t.signal?.addEventListener("abort",a,{once:!0});let c=await at([s],i,async f=>bH(f)),u=Date.now()-n;if(c==null)throw new K(`Did not receive a ping ack after ${u}ms`,IA);if(!j(s,c.subarray()))throw new K(`Received wrong ping ack after ${u}ms`,IA);return this.log("ping %p complete in %dms",o.remotePeer,u),u}catch(c){throw this.log.error("error while pinging %p",o.remotePeer,c),i?.abort(c),c}finally{t.signal?.removeEventListener("abort",a),i!=null&&await i.close()}}};function TA(r={}){return e=>new q5(e,r)}var _H="0.0.1",AH="fetch";var m2;(function(r){let e;r.codec=()=>(e==null&&(e=Ne((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identifier!=null&&t.identifier!==""&&(n.uint32(10),n.string(t.identifier)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={identifier:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();i>>>3===1?s.identifier=t.string():t.skipType(i&7)}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Le(t,r.codec())})(m2||(m2={}));var Bs;(function(r){let e;(function(s){s.OK="OK",s.NOT_FOUND="NOT_FOUND",s.ERROR="ERROR"})(e=r.StatusCode||(r.StatusCode={}));let t;(function(s){s[s.OK=0]="OK",s[s.NOT_FOUND=1]="NOT_FOUND",s[s.ERROR=2]="ERROR"})(t||(t={})),(function(s){s.codec=()=>Fn(t)})(e=r.StatusCode||(r.StatusCode={}));let n;r.codec=()=>(n==null&&(n=Ne((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.status!=null&&t[s.status]!==0&&(o.uint32(8),r.StatusCode.codec().encode(s.status,o)),s.data!=null&&s.data.byteLength>0&&(o.uint32(18),o.bytes(s.data)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={status:e.OK,data:new Uint8Array(0)},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.status=r.StatusCode.codec().decode(s);break;case 2:i.data=s.bytes();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>ke(s,r.codec()),r.decode=s=>Le(s,r.codec())})(Bs||(Bs={}));var IH=1e4,TH;TH=Symbol.toStringTag;var z5=class{constructor(e,t={}){l(this,"protocol");l(this,"components");l(this,"lookupFunctions");l(this,"started");l(this,"init");l(this,"log");l(this,TH,"@libp2p/fetch");this.log=e.logger.forComponent("libp2p:fetch"),this.started=!1,this.components=e,this.protocol=`/${t.protocolPrefix??"libp2p"}/${AH}/${_H}`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=t}async start(){await this.components.registrar.handle(this.protocol,e=>{this.handleMessage(e).then(async()=>{await e.stream.close()}).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(e,t,n={}){this.log("dialing %s to %p",this.protocol,e);let s=await this.components.connectionManager.openConnection(e,n),o=n.signal,i,a=()=>{};if(o==null){let c=this.init.timeout??IH;this.log("using default timeout of %d ms",c),o=AbortSignal.timeout(c),Ze(1/0,o)}try{i=await s.newStream(this.protocol,{signal:o}),a=()=>{i?.abort(new K("fetch timeout",u1))},o.addEventListener("abort",a,{once:!0}),this.log("fetch %s",t);let c=bt(i);await c.write({identifier:t},m2,n);let u=await c.read(Bs,n);switch(await c.unwrap().close(n),u.status){case Bs.StatusCode.OK:return this.log("received status for %s ok",t),u.data;case Bs.StatusCode.NOT_FOUND:{this.log("received status for %s not found",t);return}case Bs.StatusCode.ERROR:{this.log("received status for %s error",t);let f=z(u.data);throw new K("Error in fetch protocol response: "+f,XB)}default:throw this.log("received status for %s unknown",t),new K("Unknown response status",w3)}}catch(c){throw i?.abort(c),c}finally{o.removeEventListener("abort",a),i!=null&&await i.close()}}async handleMessage(e){let{stream:t}=e,n=AbortSignal.timeout(this.init.timeout??IH);try{let s=bt(t),o=await s.read(m2,{signal:n}),i,a=this._getLookupFunction(o.identifier);if(a!=null){this.log("look up data with identifier %s",o.identifier);let c=await a(o.identifier);c!=null?(this.log("sending status for %s ok",o.identifier),i={status:Bs.StatusCode.OK,data:c}):(this.log("sending status for %s not found",o.identifier),i={status:Bs.StatusCode.NOT_FOUND,data:new Uint8Array(0)})}else{this.log("sending status for %s error",o.identifier);let c=H(`No lookup function registered for key: ${o.identifier}`);i={status:Bs.StatusCode.ERROR,data:c}}await s.write(i,Bs,{signal:n}),await s.unwrap().close({signal:n})}catch(s){this.log("error answering fetch request",s),t.abort(s)}}_getLookupFunction(e){for(let t of this.lookupFunctions.keys())if(e.startsWith(t))return this.lookupFunctions.get(t)}registerLookupFunction(e,t){if(this.lookupFunctions.has(e))throw new K(`Fetch protocol handler for key prefix '${e}' already registered`,"ERR_KEY_ALREADY_EXISTS");this.lookupFunctions.set(e,t)}unregisterLookupFunction(e,t){t!=null&&this.lookupFunctions.get(e)!==t||this.lookupFunctions.delete(e)}};function RA(r={}){return e=>new z5(e,r)}window.Libp2p={createLibp2p:Bw,webRTC:jE,webRTCDirect:XE,webSockets:rv,wsFilters:j1,circuitRelayTransport:My,circuitRelayServer:Ty,identify:v_,noise:Z1,yamux:L_,gossipsub:K_,kadDHT:mA,removePrivateAddressesMapper:Xh,removePublicAddressesMapper:a5,bootstrap:gA,mplex:AA,ping:TA,fetch:RA,peerIdFromString:Qe,peerIdFromBytes:Wt,generateKeyPair:a6,multiaddr:xe};return kH(foe);})();
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2024 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

@noble/hashes/utils.js:
@noble/hashes/utils.js:
@noble/hashes/esm/utils.js:
@noble/hashes/utils.js:
@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
@noble/curves/esm/utils.js:
@noble/curves/esm/abstract/modular.js:
@noble/curves/esm/abstract/curve.js:
@noble/curves/esm/abstract/edwards.js:
@noble/curves/esm/abstract/montgomery.js:
@noble/curves/esm/ed25519.js:
@noble/curves/esm/abstract/weierstrass.js:
@noble/curves/esm/_shortw_utils.js:
@noble/curves/esm/secp256k1.js:
@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
